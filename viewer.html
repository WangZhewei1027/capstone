<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HTML Files Viewer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        margin: 0 auto;
      }

      h1 {
        text-align: center;
        color: white;
        margin-bottom: 30px;
        font-size: 2.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .workspace-selector {
        text-align: center;
        margin-bottom: 30px;
      }

      select {
        padding: 12px 20px;
        font-size: 16px;
        border: none;
        border-radius: 25px;
        background: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      select:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }

      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 20px;
        padding: 20px 0;
      }

      .html-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
      }

      .html-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      }

      .card-preview {
        width: 100%;
        height: 400px;
        border: none;
        background: #f8f9fa;
      }

      .card-info {
        padding: 20px;
      }

      .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        word-break: break-all;
      }

      .card-model {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 5px;
      }

      .card-timestamp {
        font-size: 0.8rem;
        color: #999;
      }

      .card-messages {
        margin-top: 10px;
        border-radius: 6px;
        font-size: 0.85rem;
      }

      .message-item {
        margin-bottom: 6px;
        padding: 4px 8px;
        border-radius: 4px;
      }

      .message-system {
        background: #e3f2fd;
        border-left: 3px solid #2196f3;
      }

      .message-user {
        background: #f3e5f5;
        border-left: 3px solid #9c27b0;
      }

      .message-role {
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        margin-bottom: 2px;
      }

      .message-content {
        font-size: 0.8rem;
        line-height: 1.3;
        word-break: break-word;
      }

      .no-files {
        text-align: center;
        color: white;
        font-size: 1.2rem;
        margin-top: 50px;
      }

      .loading {
        text-align: center;
        color: white;
        font-size: 1.1rem;
        margin-top: 30px;
      }

      .error {
        text-align: center;
        color: #ff6b6b;
        font-size: 1.1rem;
        margin-top: 30px;
        background: white;
        padding: 20px;
        border-radius: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>HTML Files Viewer</h1>

      <div class="workspace-selector">
        <select id="workspaceSelect">
          <option value="">选择工作空间...</option>
        </select>
      </div>

      <div id="loadingMessage" class="loading" style="display: none">
        加载中...
      </div>

      <div id="errorMessage" class="error" style="display: none"></div>

      <div id="gridContainer" class="grid-container"></div>

      <div id="noFiles" class="no-files" style="display: none">
        当前工作空间没有HTML文件
      </div>
    </div>

    <script>
      let currentData = {};

      // 加载工作空间列表
      async function loadWorkspaces() {
        try {
          const response = await fetch("./workspace/");
          if (!response.ok) {
            throw new Error("无法访问workspace目录");
          }

          // 这里我们手动添加已知的工作空间，因为浏览器无法直接列出目录
          // 在实际使用中，你可能需要一个服务器端API来获取目录列表
          const workspaces = ["10-04", "test"];

          const select = document.getElementById("workspaceSelect");
          workspaces.forEach((workspace) => {
            const option = document.createElement("option");
            option.value = workspace;
            option.textContent = workspace;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("加载工作空间失败:", error);
          // 备用方案：手动添加已知工作空间
          const select = document.getElementById("workspaceSelect");
          const workspaces = ["10-04", "test"];
          workspaces.forEach((workspace) => {
            const option = document.createElement("option");
            option.value = workspace;
            option.textContent = workspace;
            select.appendChild(option);
          });
        }
      }

      // 加载指定工作空间的数据
      async function loadWorkspaceData(workspace) {
        if (!workspace) return;

        showLoading(true);
        hideError();

        try {
          // 加载数据文件
          const dataResponse = await fetch(
            `./workspace/${workspace}/data/data.json`
          );
          if (!dataResponse.ok) {
            throw new Error(`无法加载 ${workspace} 的数据文件`);
          }

          const data = await dataResponse.json();
          currentData = {};

          // 将数据按ID索引
          data.forEach((item) => {
            currentData[item.id] = item;
          });

          // 获取HTML文件列表（这里我们根据数据推断）
          const htmlFiles = data.map((item) => item.id);

          displayHtmlFiles(workspace, htmlFiles);
        } catch (error) {
          showError(error.message);
          console.error("加载数据失败:", error);
        } finally {
          showLoading(false);
        }
      }

      // 显示HTML文件网格
      function displayHtmlFiles(workspace, htmlFiles) {
        const container = document.getElementById("gridContainer");
        const noFiles = document.getElementById("noFiles");

        if (htmlFiles.length === 0) {
          container.innerHTML = "";
          noFiles.style.display = "block";
          return;
        }

        noFiles.style.display = "none";
        container.innerHTML = "";

        htmlFiles.forEach((fileId) => {
          const data = currentData[fileId];
          if (!data) return;

          const card = document.createElement("div");
          card.className = "html-card";
          card.onclick = () => openHtmlFile(workspace, fileId);

          // 构建 messages 显示
          const messagesHtml = data.messages
            ? data.messages
                .map((msg) => {
                  const roleClass = `message-${msg.role}`;
                  const roleText =
                    msg.role === "system"
                      ? "系统"
                      : msg.role === "user"
                      ? "用户"
                      : msg.role;
                  return `
              <div class="message-item ${roleClass}">
                <div class="message-role">${roleText}</div>
                <div class="message-content">${msg.content}</div>
              </div>
            `;
                })
                .join("")
            : "";

          card.innerHTML = `
                    <iframe class="card-preview" src="./workspace/${workspace}/html/${fileId}.html" scrolling="no"></iframe>
                    <div class="card-info">
                        <div class="card-title">${fileId}</div>
                        <div class="card-model">模型: ${data.model}</div>
                        <div class="card-timestamp">${new Date(
                          data.timestamp
                        ).toLocaleString("zh-CN")}</div>
                        ${
                          messagesHtml
                            ? `<div class="card-messages">${messagesHtml}</div>`
                            : ""
                        }
                    </div>
                `;

          container.appendChild(card);
        });
      }

      // 打开HTML文件
      function openHtmlFile(workspace, fileId) {
        window.open(`./workspace/${workspace}/html/${fileId}.html`, "_blank");
      }

      // 显示/隐藏加载状态
      function showLoading(show) {
        document.getElementById("loadingMessage").style.display = show
          ? "block"
          : "none";
      }

      // 显示错误信息
      function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
      }

      // 隐藏错误信息
      function hideError() {
        document.getElementById("errorMessage").style.display = "none";
      }

      // 工作空间选择变化事件
      document
        .getElementById("workspaceSelect")
        .addEventListener("change", (e) => {
          loadWorkspaceData(e.target.value);
        });

      // 页面加载完成后初始化
      document.addEventListener("DOMContentLoaded", () => {
        loadWorkspaces();
      });
    </script>
  </body>
</html>
