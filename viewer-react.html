<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HTML Files Viewer - React Edition</title>

    <!-- React CDN -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- D3.js for graph visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        text-align: center;
        color: white;
        margin-bottom: 30px;
        font-size: 2.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .workspace-selector {
        text-align: center;
        margin-bottom: 30px;
      }

      select {
        padding: 12px 20px;
        font-size: 16px;
        border: none;
        border-radius: 25px;
        background: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      select:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }

      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        padding: 20px 0;
      }

      .html-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
      }

      .html-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      }

      .card-preview {
        width: 100%;
        height: 200px;
        border: none;
        background: #f8f9fa;
      }

      .card-info {
        padding: 12px;
      }

      .card-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }

      .card-btn {
        flex: 1;
        padding: 6px 12px;
        font-size: 0.8rem;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .card-btn.view {
        background: #4caf50;
        color: white;
      }

      .card-btn.fsm {
        background: #2196f3;
        color: white;
      }

      .card-btn.evaluation {
        background: #ff9800;
        color: white;
      }

      .card-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .card-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .card-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        word-break: break-all;
      }

      .card-model {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 5px;
      }

      .card-timestamp {
        font-size: 0.8rem;
        color: #999;
      }

      .card-messages {
        margin-top: 10px;
        font-size: 0.85rem;
      }

      .message-item {
        margin-bottom: 6px;
        padding: 4px 8px;
        border-radius: 4px;
      }

      .message-system {
        background: #e3f2fd;
        border-left: 3px solid #2196f3;
      }

      .message-user {
        background: #f3e5f5;
        border-left: 3px solid #9c27b0;
      }

      .message-role {
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        margin-bottom: 2px;
      }

      .message-content {
        font-size: 0.8rem;
        line-height: 1.3;
        word-break: break-word;
      }

      .loading {
        text-align: center;
        color: white;
        font-size: 1.1rem;
        margin-top: 30px;
      }

      .error {
        text-align: center;
        color: #ff6b6b;
        font-size: 1.1rem;
        margin-top: 30px;
        background: white;
        padding: 20px;
        border-radius: 10px;
      }

      .no-files {
        text-align: center;
        color: white;
        font-size: 1.2rem;
        margin-top: 50px;
      }

      .filters-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
      }

      .filters-title {
        color: white;
        font-size: 1.2rem;
        margin-bottom: 15px;
        text-align: center;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .filter-label {
        color: white;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .filter-select,
      .filter-input {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        background: white;
        font-size: 0.9rem;
        cursor: pointer;
      }

      .filter-input {
        cursor: text;
      }

      .filter-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
      }

      .filter-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        background: white;
        color: #333;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-btn:hover {
        background: #f0f0f0;
        transform: translateY(-1px);
      }

      .filter-btn.clear {
        background: #ff6b6b;
        color: white;
      }

      .filter-btn.clear:hover {
        background: #ff5252;
      }

      .results-count {
        color: white;
        text-align: center;
        margin-bottom: 10px;
        font-size: 0.9rem;
      }

      .filters-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
      }

      .filters-title {
        color: white;
        font-size: 1.2rem;
        margin-bottom: 15px;
        text-align: center;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .filter-label {
        color: white;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .filter-select,
      .filter-input {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        background: white;
        font-size: 0.9rem;
        cursor: pointer;
      }

      .filter-input {
        cursor: text;
      }

      .filter-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
      }

      .filter-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        background: white;
        color: #333;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-btn:hover {
        background: #f0f0f0;
        transform: translateY(-1px);
      }

      .filter-btn.clear {
        background: #ff6b6b;
        color: white;
      }

      .filter-btn.clear:hover {
        background: #ff5252;
      }

      .results-count {
        color: white;
        text-align: center;
        margin-bottom: 10px;
        font-size: 0.9rem;
      }

      /* FSM Visualizer Modal Styles */
      .fsm-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        display: none;
        overflow: auto;
      }

      .fsm-modal.show {
        display: block;
      }

      .fsm-modal-content {
        background: white;
        margin: 20px;
        border-radius: 15px;
        min-height: calc(100vh - 40px);
        position: relative;
      }

      .fsm-modal-header {
        padding: 20px;
        border-bottom: 2px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0;
      }

      .fsm-modal-title {
        font-size: 1.5rem;
        font-weight: 600;
      }

      .fsm-close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 1.8rem;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .fsm-close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .fsm-modal-body {
        padding: 20px;
      }

      .fsm-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .info-panel {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #4caf50;
      }

      .info-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        font-size: 1.1rem;
      }

      .info-content {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .graph-container {
        width: 100%;
        height: 600px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        background: #fafafa;
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
      }

      /* FSM Node Styles */
      .state-node {
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .state-node:hover {
        filter: brightness(1.1);
      }

      .node-idle {
        fill: #4caf50;
        stroke: #2e7d32;
      }

      .node-atomic {
        fill: #2196f3;
        stroke: #1565c0;
      }

      .node-composite {
        fill: #ff9800;
        stroke: #ef6c00;
      }

      .node-error {
        fill: #f44336;
        stroke: #c62828;
      }

      .node-final {
        fill: #607d8b;
        stroke: #455a64;
      }

      /* Edge Styles */
      .edge {
        fill: none;
        stroke: #666;
        stroke-width: 2;
        marker-end: url(#arrowhead);
        transition: all 0.3s ease;
      }

      .edge:hover {
        stroke: #4caf50;
        stroke-width: 3;
      }

      /* Graph Legend Styles */
      .graph-legend {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        padding: 15px;
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 100;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        min-width: 140px;
      }

      .legend-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: #333;
        font-size: 0.9rem;
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        font-size: 0.8rem;
      }

      .legend-color {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        margin-right: 8px;
        border: 2px solid #333;
      }

      /* Tooltip Styles */
      .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        pointer-events: none;
        font-size: 12px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.2s;
        max-width: 200px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .tooltip.show {
        opacity: 1;
      }

      .screenshot-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        z-index: 3000;
        max-width: 80vw;
        max-height: 80vh;
        overflow: auto;
        display: none;
      }

      .screenshot-panel.show {
        display: block;
      }

      .screenshot-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .screenshot-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
      }

      .screenshot-content {
        padding: 20px;
      }

      .screenshot-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .screenshot-item {
        text-align: center;
      }

      .screenshot-img {
        width: 100%;
        max-width: 400px;
        border: 2px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .screenshot-img:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .screenshot-caption {
        margin-top: 10px;
        font-size: 0.9rem;
        color: #666;
        font-weight: 500;
      }

      /* Evaluation Modal Styles */
      .evaluation-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 3000;
        display: none;
        overflow: auto;
      }

      .evaluation-modal.show {
        display: block;
      }

      .evaluation-modal-content {
        background: white;
        margin: 40px auto;
        max-width: 800px;
        border-radius: 15px;
        max-height: calc(100vh - 80px);
        overflow-y: auto;
      }

      .evaluation-modal-header {
        padding: 20px;
        border-bottom: 2px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        color: white;
        border-radius: 15px 15px 0 0;
      }

      .evaluation-modal-title {
        font-size: 1.5rem;
        font-weight: 600;
      }

      .evaluation-close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 1.8rem;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .evaluation-close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .evaluation-modal-body {
        padding: 30px;
      }

      .evaluation-scores {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .score-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        border-left: 4px solid #ff9800;
      }

      .score-label {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 10px;
        font-weight: 500;
      }

      .score-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #ff9800;
        margin-bottom: 5px;
      }

      .score-max {
        font-size: 0.8rem;
        color: #999;
      }

      .evaluation-section {
        margin-bottom: 25px;
      }

      .evaluation-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        border-bottom: 2px solid #ff9800;
        padding-bottom: 5px;
      }

      .evaluation-analysis {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        line-height: 1.6;
        color: #333;
        white-space: pre-wrap;
      }

      .evaluation-list {
        list-style: none;
        padding: 0;
      }

      .evaluation-list li {
        padding: 8px 0;
        padding-left: 20px;
        position: relative;
        color: #333;
      }

      .evaluation-list.strengths li:before {
        content: "‚úì";
        color: #4caf50;
        font-weight: bold;
        position: absolute;
        left: 0;
      }

      .evaluation-list.weaknesses li:before {
        content: "‚ö†";
        color: #f44336;
        font-weight: bold;
        position: absolute;
        left: 0;
      }

      .evaluation-list.recommendations li:before {
        content: "üí°";
        position: absolute;
        left: 0;
      }

      .evaluation-metadata {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        font-size: 0.9rem;
        color: #666;
      }

      .evaluation-screenshots {
        margin-top: 25px;
      }

      .screenshots-section {
        margin-bottom: 20px;
      }

      .screenshots-section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 2px solid #ff9800;
      }

      .screenshots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .screenshot-item {
        text-align: center;
      }

      .screenshot-img {
        width: 100%;
        max-width: 250px;
        border: 2px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .screenshot-img:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        border-color: #ff9800;
      }

      .screenshot-caption {
        margin-top: 8px;
        font-size: 0.85rem;
        color: #666;
        font-weight: 500;
      }

      .screenshot-category {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 4px;
      }

      .category-initial {
        background: #e8f5e8;
        color: #2e7d32;
      }

      .category-interaction {
        background: #e3f2fd;
        color: #1565c0;
      }

      .category-complete {
        background: #fff3e0;
        color: #ef6c00;
      }

      .evaluation-loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .evaluation-error {
        background: #ffebee;
        color: #c62828;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #f44336;
      }

      .evaluation-actions {
        text-align: center;
        margin-bottom: 20px;
      }

      .evaluation-btn {
        background: #ff9800;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .evaluation-btn:hover {
        background: #f57c00;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
      }

      .evaluation-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2999;
        display: none;
      }

      .overlay.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // FSMÁä∂ÊÄÅÈÖçËâ≤ÊñπÊ°à - ÊåâÂäüËÉΩÂàÜÁ±ª
      const STATE_COLORS = {
        // ÂºÄÂßãÁä∂ÊÄÅ - ÁªøËâ≤Á≥ª
        idle: "#4caf50",

        // ËæìÂÖ•È™åËØÅ - Ê©ôËâ≤Á≥ª
        validating_input: "#ff9800",
        validating_front_input: "#ff9800",
        validating_back_input: "#ffb74d",

        // ÊâßË°åÂä®‰Ωú - ËìùËâ≤Á≥ª
        inserting_node: "#2196f3",
        adding_to_front: "#1976d2",
        adding_to_back: "#42a5f5",
        removing_from_front: "#ff5722",
        removing_from_back: "#ff7043",
        performing_front_removal: "#ff5722",
        performing_back_removal: "#ff7043",

        // ÊòæÁ§∫Êõ¥Êñ∞ - Á¥´Ëâ≤Á≥ª
        drawing_tree: "#9c27b0",
        updating_display: "#ab47bc",
        clearing_input: "#ba68c8",

        // ÈîôËØØÂ§ÑÁêÜ - Á∫¢Ëâ≤Á≥ª
        error_alert: "#f44336",

        // ÁªìÊùüÁä∂ÊÄÅ - ÁÅ∞Ëâ≤Á≥ª
        tree_resetting: "#607d8b",
      };

      // Ëé∑ÂèñÁä∂ÊÄÅÁ±ªÂûãÁöÑÂáΩÊï∞
      const getStateCategory = (stateName) => {
        const name = stateName.toLowerCase();
        if (name.includes("idle") || name.includes("initial")) return "start";
        if (name.includes("validating") || name.includes("input"))
          return "input";
        if (
          name.includes("adding") ||
          name.includes("removing") ||
          name.includes("inserting") ||
          name.includes("performing")
        )
          return "action";
        if (
          name.includes("updating") ||
          name.includes("drawing") ||
          name.includes("display") ||
          name.includes("clearing")
        )
          return "display";
        if (name.includes("error") || name.includes("alert")) return "error";
        if (
          name.includes("resetting") ||
          name.includes("done") ||
          name.includes("complete")
        )
          return "end";
        return "action";
      };

      // Êô∫ËÉΩÊà™Âõæ-Áä∂ÊÄÅÂåπÈÖçÂáΩÊï∞
      const isScreenshotForState = (screenshot, stateName) => {
        // Áõ¥Êé•Áä∂ÊÄÅÂåπÈÖç
        if (screenshot.state === stateName) {
          return true;
        }

        const filename = screenshot.filename.toLowerCase();
        const state = stateName.toLowerCase();

        // Áõ¥Êé•Êñá‰ª∂ÂêçÂåπÈÖç
        if (filename.includes(state)) {
          return true;
        }

        // ÁâπÊÆäÁä∂ÊÄÅÊò†Â∞ÑËßÑÂàô
        const stateMapping = {
          idle: ["initial", "empty", "idle"],
          validating_front_input: ["validating", "front", "input"],
          validating_back_input: ["validating", "back", "input"],
          adding_to_front: ["add_front", "front", "unshift"],
          adding_to_back: ["add_back", "back", "push"],
          removing_from_front: ["remove_front", "front", "shift"],
          removing_from_back: ["remove_back", "back", "pop"],
          performing_front_removal: ["remove_front", "front", "shift"],
          performing_back_removal: ["remove_back", "back", "pop"],
          updating_display: ["complete", "update", "display"],
          clearing_input: ["clear", "input"],
          // ‰º†ÁªüBSTÁä∂ÊÄÅ
          validating_input: ["validating", "input"],
          error_alert: ["error", "alert"],
          inserting_node: ["inserting", "node", "tree_node"],
          drawing_tree: ["drawing", "tree", "tree_with"],
          tree_resetting: ["resetting", "reset"],
        };

        const keywords = stateMapping[state] || [state];
        return keywords.some((keyword) => filename.includes(keyword));
      };

      // ScreenshotPanel Component
      const ScreenshotPanel = ({
        show,
        onClose,
        selectedState,
        screenshots,
      }) => {
        if (!show) return null;

        // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©ÁâπÂÆöÁä∂ÊÄÅÔºåÊòæÁ§∫ÊâÄÊúâÊà™Âõæ
        let stateScreenshots = screenshots;

        if (selectedState) {
          // ‰ΩøÁî®ÂêåÊ†∑ÁöÑÊô∫ËÉΩÂåπÈÖçÂáΩÊï∞
          stateScreenshots = screenshots.filter((imgItem) => {
            return isScreenshotForState(imgItem, selectedState);
          });
        }

        return (
          <>
            <div
              className={`overlay ${show ? "show" : ""}`}
              onClick={onClose}
            ></div>
            <div className={`screenshot-panel ${show ? "show" : ""}`}>
              <div className="screenshot-header">
                <div className="screenshot-title">
                  {selectedState ? `Áä∂ÊÄÅÊà™Âõæ: ${selectedState}` : "ÊâÄÊúâÊà™Âõæ"}
                </div>
                <button className="fsm-close-btn" onClick={onClose}>
                  √ó
                </button>
              </div>
              <div className="screenshot-content">
                {stateScreenshots.length > 0 ? (
                  <div className="screenshot-grid">
                    {stateScreenshots.map((screenshot, index) => (
                      <div key={index} className="screenshot-item">
                        <img
                          src={`http://localhost:3000${screenshot.url}`}
                          alt={`${selectedState || "State"} screenshot ${
                            index + 1
                          }`}
                          className="screenshot-img"
                          onError={(e) => {
                            e.target.style.display = "none";
                          }}
                        />
                        <div className="screenshot-caption">
                          {screenshot.filename.replace(".png", "")}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div
                    style={{
                      textAlign: "center",
                      color: "#666",
                      padding: "40px",
                    }}
                  >
                    {selectedState
                      ? `ÊöÇÊó† ${selectedState} Áä∂ÊÄÅÁöÑÊà™Âõæ`
                      : "ÊöÇÊó†Êà™Âõæ"}
                  </div>
                )}
              </div>
            </div>
          </>
        );
      };

      // EvaluationModal Component
      const EvaluationModal = ({ show, onClose, fileId, workspace }) => {
        const [evaluation, setEvaluation] = useState(null);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);
        const [evaluating, setEvaluating] = useState(false);
        const [screenshots, setScreenshots] = useState([]);

        // Ëé∑ÂèñËØÑ‰º∞Êï∞ÊçÆ
        const fetchEvaluation = async () => {
          if (!fileId || !workspace) return;

          setLoading(true);
          setError(null);

          try {
            const response = await fetch(
              `http://localhost:3000/api/evaluation/${workspace}/${fileId}.html`
            );

            if (response.ok) {
              const data = await response.json();
              setEvaluation(data);
            } else if (response.status === 404) {
              setEvaluation(null);
            } else {
              throw new Error("Failed to fetch evaluation");
            }
          } catch (err) {
            setError("Ëé∑ÂèñËØÑ‰º∞Êï∞ÊçÆÂ§±Ë¥•: " + err.message);
          } finally {
            setLoading(false);
          }
        };

        // Ëé∑ÂèñÊà™ÂõæÊï∞ÊçÆ
        const fetchScreenshots = async () => {
          if (!fileId || !workspace) return;

          try {
            const response = await fetch(
              `http://localhost:3000/api/screenshots/${workspace}/${fileId}.html`
            );
            if (response.ok) {
              const screenshotData = await response.json();
              setScreenshots(screenshotData);
            }
          } catch (err) {
            console.warn("Ëé∑ÂèñÊà™ÂõæÂ§±Ë¥•:", err.message);
            setScreenshots([]);
          }
        };

        // ÊâßË°åÊñ∞ÁöÑËØÑ‰º∞
        const runEvaluation = async (e) => {
          e.preventDefault(); // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
          e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°

          if (!fileId || !workspace) return;

          setEvaluating(true);
          setError(null);

          try {
            const response = await fetch(
              `http://localhost:3000/api/evaluation/${workspace}/${fileId}.html`,
              { method: "POST" }
            );

            if (response.ok) {
              const result = await response.json();
              setEvaluation(result.evaluation);
            } else {
              const errorData = await response.json();
              throw new Error(errorData.error || "Evaluation failed");
            }
          } catch (err) {
            setError("ÊâßË°åËØÑ‰º∞Â§±Ë¥•: " + err.message);
          } finally {
            setEvaluating(false);
          }
        };

        // ÂΩìÊ®°ÊÄÅÊ°ÜÊòæÁ§∫Êó∂Ëé∑ÂèñËØÑ‰º∞Êï∞ÊçÆÂíåÊà™Âõæ
        useEffect(() => {
          if (show && fileId && workspace) {
            fetchEvaluation();
            fetchScreenshots();
          }
        }, [show, fileId, workspace]);

        // ÂàÜÁ±ªÊà™ÂõæÂáΩÊï∞
        const categorizeScreenshots = (screenshots, usedScreenshots) => {
          if (!screenshots || screenshots.length === 0)
            return { initial: [], interaction: [], complete: [] };

          // Â¶ÇÊûúÊúâËØÑ‰º∞Êï∞ÊçÆÔºå‰ºòÂÖàÊòæÁ§∫ËØÑ‰º∞‰∏≠‰ΩøÁî®ÁöÑÊà™Âõæ
          let targetScreenshots = screenshots;
          if (usedScreenshots && usedScreenshots.length > 0) {
            targetScreenshots = screenshots.filter((screenshot) =>
              usedScreenshots.includes(screenshot.filename)
            );
          }

          const categories = {
            initial: [],
            interaction: [],
            complete: [],
          };

          targetScreenshots.forEach((screenshot) => {
            const filename = screenshot.filename.toLowerCase();

            if (
              filename.includes("initial") ||
              filename.includes("idle") ||
              filename.includes("empty")
            ) {
              categories.initial.push(screenshot);
            } else if (
              filename.includes("complete") ||
              filename.includes("final") ||
              filename.includes("done")
            ) {
              categories.complete.push(screenshot);
            } else {
              categories.interaction.push(screenshot);
            }
          });

          return categories;
        };

        // Ëé∑ÂèñÊà™ÂõæÁöÑÂÆåÊï¥URL
        const getScreenshotUrl = (screenshot) => {
          return `./workspace/${workspace}/visuals/${fileId}/${screenshot.filename}`;
        };

        if (!show) return null;

        return (
          <>
            <div
              className={`overlay ${show ? "show" : ""}`}
              onClick={onClose}
            ></div>
            <div className={`evaluation-modal ${show ? "show" : ""}`}>
              <div className="evaluation-modal-content">
                <div className="evaluation-modal-header">
                  <div className="evaluation-modal-title">
                    ËßÜËßâËØÑ‰º∞Êä•Âëä - {fileId}
                  </div>
                  <button className="evaluation-close-btn" onClick={onClose}>
                    √ó
                  </button>
                </div>
                <div className="evaluation-modal-body">
                  {loading && (
                    <div className="evaluation-loading">
                      Ê≠£Âú®Âä†ËΩΩËØÑ‰º∞Êï∞ÊçÆ...
                    </div>
                  )}

                  {error && <div className="evaluation-error">{error}</div>}

                  {!loading && !evaluation && !error && (
                    <div className="evaluation-actions">
                      <p>ËøòÊ≤°ÊúâËØÑ‰º∞Êä•ÂëäÔºåÁÇπÂáª‰∏ãÊñπÊåâÈíÆÂºÄÂßãËØÑ‰º∞</p>
                      <button
                        className="evaluation-btn"
                        onClick={runEvaluation}
                        disabled={evaluating}
                      >
                        {evaluating ? "Ê≠£Âú®ËØÑ‰º∞..." : "ÂºÄÂßãËØÑ‰º∞"}
                      </button>
                    </div>
                  )}

                  {evaluation && (
                    <>
                      <div className="evaluation-actions">
                        <button
                          className="evaluation-btn"
                          onClick={runEvaluation}
                          disabled={evaluating}
                        >
                          {evaluating ? "Ê≠£Âú®ÈáçÊñ∞ËØÑ‰º∞..." : "ÈáçÊñ∞ËØÑ‰º∞"}
                        </button>
                      </div>

                      <div className="evaluation-scores">
                        <div className="score-card">
                          <div className="score-label">ÊÄª‰ΩìËØÑÂàÜ</div>
                          <div className="score-value">
                            {evaluation.overall_score?.toFixed(1) || "N/A"}
                          </div>
                          <div className="score-max">/ 10.0</div>
                        </div>
                        <div className="score-card">
                          <div className="score-label">Â∏ÉÂ±ÄË¥®Èáè</div>
                          <div className="score-value">
                            {evaluation.layout_quality?.toFixed(1) || "N/A"}
                          </div>
                          <div className="score-max">/ 10.0</div>
                        </div>
                        <div className="score-card">
                          <div className="score-label">ÂÜÖÂÆπ‰∏∞ÂØåÂ∫¶</div>
                          <div className="score-value">
                            {evaluation.content_richness?.toFixed(1) || "N/A"}
                          </div>
                          <div className="score-max">/ 10.0</div>
                        </div>
                        <div className="score-card">
                          <div className="score-label">‰∫§‰∫íÈÄªËæë</div>
                          <div className="score-value">
                            {evaluation.interaction_logic?.toFixed(1) || "N/A"}
                          </div>
                          <div className="score-max">/ 10.0</div>
                        </div>
                      </div>

                      {evaluation.analysis && (
                        <div className="evaluation-section">
                          <div className="evaluation-section-title">
                            ËØ¶ÁªÜÂàÜÊûê
                          </div>
                          <div className="evaluation-analysis">
                            {evaluation.analysis}
                          </div>
                        </div>
                      )}

                      {evaluation.strengths &&
                        evaluation.strengths.length > 0 && (
                          <div className="evaluation-section">
                            <div className="evaluation-section-title">‰ºòÁÇπ</div>
                            <ul className="evaluation-list strengths">
                              {evaluation.strengths.map((strength, index) => (
                                <li key={index}>{strength}</li>
                              ))}
                            </ul>
                          </div>
                        )}

                      {evaluation.weaknesses &&
                        evaluation.weaknesses.length > 0 && (
                          <div className="evaluation-section">
                            <div className="evaluation-section-title">
                              ÂæÖÊîπËøõ‰πãÂ§Ñ
                            </div>
                            <ul className="evaluation-list weaknesses">
                              {evaluation.weaknesses.map((weakness, index) => (
                                <li key={index}>{weakness}</li>
                              ))}
                            </ul>
                          </div>
                        )}

                      {evaluation.recommendations &&
                        evaluation.recommendations.length > 0 && (
                          <div className="evaluation-section">
                            <div className="evaluation-section-title">
                              ÊîπËøõÂª∫ËÆÆ
                            </div>
                            <ul className="evaluation-list recommendations">
                              {evaluation.recommendations.map(
                                (recommendation, index) => (
                                  <li key={index}>{recommendation}</li>
                                )
                              )}
                            </ul>
                          </div>
                        )}

                      {evaluation.metadata && (
                        <div className="evaluation-metadata">
                          <strong>ËØÑ‰º∞‰ø°ÊÅØ:</strong>
                          <br />
                          ËØÑ‰º∞Êó∂Èó¥:{" "}
                          {new Date(
                            evaluation.metadata.evaluatedAt
                          ).toLocaleString("zh-CN")}
                          <br />
                          ‰ΩøÁî®Êà™Âõæ:{" "}
                          {evaluation.metadata.screenshotsUsed
                            ? evaluation.metadata.screenshotsUsed.join(", ")
                            : evaluation.metadata.screenshotUsed || "Êó†"}
                          <br />
                          ÊÄªÊà™ÂõæÊï∞:{" "}
                          {evaluation.metadata.totalScreenshots ||
                            evaluation.metadata.screenshotCount}
                          <br />
                          Â∫îÁî®Ê†áÈ¢ò: {evaluation.metadata.appTitle || "Êú™Áü•"}
                          <br />
                          ÂåÖÂê´FSM: {evaluation.metadata.hasFSM ? "ÊòØ" : "Âê¶"}
                          <br />
                          ‰∫§‰∫íÂÖÉÁ¥†:{" "}
                          {evaluation.metadata.interactionElements || 0} ‰∏™
                        </div>
                      )}

                      {/* Êà™ÂõæÂ±ïÁ§∫ÈÉ®ÂàÜ */}
                      {screenshots.length > 0 && (
                        <div className="evaluation-section">
                          <div className="evaluation-section-title">
                            üì∏ ËØÑ‰º∞Êà™Âõæ
                          </div>
                          <div className="evaluation-screenshots">
                            {(() => {
                              const usedScreenshots =
                                evaluation?.metadata?.screenshotsUsed ||
                                (evaluation?.metadata?.screenshotUsed
                                  ? [evaluation.metadata.screenshotUsed]
                                  : []);
                              const categorized = categorizeScreenshots(
                                screenshots,
                                usedScreenshots
                              );

                              return (
                                <>
                                  {categorized.initial.length > 0 && (
                                    <div className="screenshots-section">
                                      <div className="screenshots-section-title">
                                        üöÄ ÂàùÂßãÁä∂ÊÄÅ
                                      </div>
                                      <div className="screenshots-grid">
                                        {categorized.initial.map(
                                          (screenshot, index) => (
                                            <div
                                              key={index}
                                              className="screenshot-item"
                                            >
                                              <img
                                                src={getScreenshotUrl(
                                                  screenshot
                                                )}
                                                alt={screenshot.filename}
                                                className="screenshot-img"
                                                onClick={() =>
                                                  window.open(
                                                    getScreenshotUrl(
                                                      screenshot
                                                    ),
                                                    "_blank"
                                                  )
                                                }
                                              />
                                              <div className="screenshot-caption">
                                                {screenshot.filename}
                                              </div>
                                              <div className="screenshot-category category-initial">
                                                ÂàùÂßãÁä∂ÊÄÅ
                                              </div>
                                            </div>
                                          )
                                        )}
                                      </div>
                                    </div>
                                  )}

                                  {categorized.interaction.length > 0 && (
                                    <div className="screenshots-section">
                                      <div className="screenshots-section-title">
                                        üîÑ ‰∫§‰∫íËøáÁ®ã
                                      </div>
                                      <div className="screenshots-grid">
                                        {categorized.interaction.map(
                                          (screenshot, index) => (
                                            <div
                                              key={index}
                                              className="screenshot-item"
                                            >
                                              <img
                                                src={getScreenshotUrl(
                                                  screenshot
                                                )}
                                                alt={screenshot.filename}
                                                className="screenshot-img"
                                                onClick={() =>
                                                  window.open(
                                                    getScreenshotUrl(
                                                      screenshot
                                                    ),
                                                    "_blank"
                                                  )
                                                }
                                              />
                                              <div className="screenshot-caption">
                                                {screenshot.filename}
                                              </div>
                                              <div className="screenshot-category category-interaction">
                                                ‰∫§‰∫íËøáÁ®ã
                                              </div>
                                            </div>
                                          )
                                        )}
                                      </div>
                                    </div>
                                  )}

                                  {categorized.complete.length > 0 && (
                                    <div className="screenshots-section">
                                      <div className="screenshots-section-title">
                                        ‚úÖ ÂÆåÊàêÁä∂ÊÄÅ
                                      </div>
                                      <div className="screenshots-grid">
                                        {categorized.complete.map(
                                          (screenshot, index) => (
                                            <div
                                              key={index}
                                              className="screenshot-item"
                                            >
                                              <img
                                                src={getScreenshotUrl(
                                                  screenshot
                                                )}
                                                alt={screenshot.filename}
                                                className="screenshot-img"
                                                onClick={() =>
                                                  window.open(
                                                    getScreenshotUrl(
                                                      screenshot
                                                    ),
                                                    "_blank"
                                                  )
                                                }
                                              />
                                              <div className="screenshot-caption">
                                                {screenshot.filename}
                                              </div>
                                              <div className="screenshot-category category-complete">
                                                ÂÆåÊàêÁä∂ÊÄÅ
                                              </div>
                                            </div>
                                          )
                                        )}
                                      </div>
                                    </div>
                                  )}

                                  {usedScreenshots.length > 0 && (
                                    <div
                                      style={{
                                        marginTop: "15px",
                                        padding: "10px",
                                        background: "#f0f8ff",
                                        borderRadius: "8px",
                                        fontSize: "0.9rem",
                                        color: "#666",
                                      }}
                                    >
                                      <strong>üí° ÊèêÁ§∫:</strong>{" "}
                                      ‰ª•‰∏äÊòæÁ§∫ÁöÑÊòØAIËØÑ‰º∞‰∏≠ÂÆûÈôÖ‰ΩøÁî®ÁöÑÊà™Âõæ (
                                      {usedScreenshots.length} Âº†)
                                    </div>
                                  )}
                                </>
                              );
                            })()}
                          </div>
                        </div>
                      )}
                    </>
                  )}
                </div>
              </div>
            </div>
          </>
        );
      };

      // Universal FSMGraph Component
      const FSMGraph = ({ fsmData, screenshots, onStateClick }) => {
        const svgRef = useRef();
        const [graphData, setGraphData] = useState({ nodes: [], links: [] });

        useEffect(() => {
          if (!fsmData) return;

          // Build graph data from the new JSON structure, with fallbacks for old format
          let nodes = [];
          let links = [];

          // Handle new JSON structure
          if (fsmData.states && Array.isArray(fsmData.states)) {
            nodes = fsmData.states.map((state) => ({
              id: state.id || state.name || state.label,
              label: state.label || state.name || state.id,
              type: state.type || "atomic",
              entryActions: state.entry_actions || state.onEnter || [],
              exitActions: state.exit_actions || state.onExit || [],
              hasScreenshots: screenshots.some((img) => {
                const stateIdentifier = state.id || state.name || state.label;
                return isScreenshotForState(img, stateIdentifier);
              }),
            }));
          }
          // Handle old XState format as fallback
          else if (fsmData.states && typeof fsmData.states === "object") {
            nodes = Object.entries(fsmData.states).map(([key, state]) => ({
              id: key,
              label: state.meta?.label || key,
              type: state.type || "atomic",
              entryActions: state.onEnter || [],
              exitActions: state.onExit || [],
              hasScreenshots: screenshots.some((img) =>
                isScreenshotForState(img, key)
              ),
            }));
          }

          // Handle transitions for new format
          if (fsmData.transitions && Array.isArray(fsmData.transitions)) {
            links = fsmData.transitions.map((transition) => ({
              source: transition.from,
              target: transition.to,
              event: transition.event,
              guard: transition.guard,
              actions: transition.actions || [],
              timeout: transition.timeout,
            }));
          }
          // Handle old format transitions
          else if (fsmData.states) {
            const stateEntries = Array.isArray(fsmData.states)
              ? fsmData.states.map((s) => [s.id, s])
              : Object.entries(fsmData.states);

            stateEntries.forEach(([stateKey, state]) => {
              if (state.on || state.transitions) {
                const transitions = state.on || state.transitions || {};
                Object.entries(transitions).forEach(([event, target]) => {
                  if (typeof target === "string") {
                    links.push({
                      source: stateKey,
                      target: target,
                      event: event,
                    });
                  } else if (target && target.target) {
                    links.push({
                      source: stateKey,
                      target: target.target,
                      event: event,
                      guard: target.cond,
                      actions: target.actions || [],
                    });
                  }
                });
              }
            });
          }

          setGraphData({ nodes, links });
        }, [fsmData, screenshots]);

        useEffect(() => {
          if (!graphData.nodes.length) return;

          const svg = d3.select(svgRef.current);
          svg.selectAll("*").remove();

          // Validate that we have nodes and at least try to render
          if (graphData.nodes.length === 0) {
            svg
              .append("text")
              .attr("x", 500)
              .attr("y", 300)
              .attr("text-anchor", "middle")
              .attr("fill", "#666")
              .attr("font-size", "16px")
              .text("ÊöÇÊó†FSMÊï∞ÊçÆÂèØÊòæÁ§∫");
            return;
          }

          const width = 1000;
          const height = 550;

          // Define arrow markers
          svg
            .append("defs")
            .append("marker")
            .attr("id", "arrowhead")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 30)
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("fill", "#666");

          const simulation = d3
            .forceSimulation(graphData.nodes)
            .force(
              "link",
              d3
                .forceLink(graphData.links)
                .id((d) => d.id)
                .distance(150)
            )
            .force("charge", d3.forceManyBody().strength(-800))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(60))
            .alpha(0.1)
            .alphaDecay(0.1)
            .velocityDecay(0.9);

          // Smart node positioning by state type and semantic analysis
          const layoutNodesByType = (nodes, width, height) => {
            const categories = {
              idle: [],
              atomic: [],
              composite: [],
              error: [],
              final: [],
            };

            nodes.forEach((node) => {
              const type = node.type.toLowerCase();
              const label = (node.label || node.id).toLowerCase();

              // Categorize by type first, then by semantic meaning
              if (
                type === "idle" ||
                label.includes("idle") ||
                label.includes("initial") ||
                label.includes("start")
              ) {
                categories.idle.push(node);
              } else if (
                type === "error" ||
                label.includes("error") ||
                label.includes("alert") ||
                label.includes("exception")
              ) {
                categories.error.push(node);
              } else if (
                label.includes("final") ||
                label.includes("complete") ||
                label.includes("reset") ||
                label.includes("done") ||
                label.includes("end") ||
                label.includes("finish")
              ) {
                categories.final.push(node);
              } else if (
                type === "composite" ||
                label.includes("composite") ||
                label.includes("complex")
              ) {
                categories.composite.push(node);
              } else {
                // Default to atomic for processing states
                categories.atomic.push(node);
              }
            });

            // Enhanced layouts with better spacing
            const layouts = {
              idle: {
                x: width * 0.15,
                y: height * 0.5,
                spread: 80,
                color: "#4caf50",
              },
              atomic: {
                x: width * 0.5,
                y: height * 0.5,
                spread: 160,
                color: "#2196f3",
              },
              composite: {
                x: width * 0.75,
                y: height * 0.35,
                spread: 100,
                color: "#ff9800",
              },
              error: {
                x: width * 0.25,
                y: height * 0.8,
                spread: 80,
                color: "#f44336",
              },
              final: {
                x: width * 0.85,
                y: height * 0.65,
                spread: 80,
                color: "#607d8b",
              },
            };

            Object.keys(categories).forEach((category) => {
              const categoryNodes = categories[category];
              const layout = layouts[category];

              if (categoryNodes.length === 0) return;

              categoryNodes.forEach((node, i) => {
                if (categoryNodes.length === 1) {
                  node.x = layout.x + (Math.random() - 0.5) * 30;
                  node.y = layout.y + (Math.random() - 0.5) * 30;
                } else if (categoryNodes.length === 2) {
                  // Two nodes: place them vertically or horizontally
                  const isVertical =
                    category === "atomic" || category === "composite";
                  if (isVertical) {
                    node.x = layout.x + (Math.random() - 0.5) * 40;
                    node.y = layout.y + (i - 0.5) * 80;
                  } else {
                    node.x = layout.x + (i - 0.5) * 100;
                    node.y = layout.y + (Math.random() - 0.5) * 40;
                  }
                } else {
                  // Multiple nodes: circular or grid arrangement
                  const angle = (i / categoryNodes.length) * 2 * Math.PI;
                  const radius = layout.spread / 3 + (Math.random() - 0.5) * 20;
                  node.x = layout.x + Math.cos(angle) * radius;
                  node.y = layout.y + Math.sin(angle) * radius;
                }
                node.color = layout.color;
              });
            });
          };

          layoutNodesByType(graphData.nodes, width, height);

          // Add category background areas
          const addGroupBackgrounds = () => {
            const groupAreas = [
              {
                name: "Ëµ∑ÂßãÁä∂ÊÄÅ",
                x: width * 0.05,
                y: height * 0.35,
                w: width * 0.2,
                h: height * 0.3,
                color: "#4caf50",
                opacity: 0.1,
              },
              {
                name: "ÂéüÂ≠êÁä∂ÊÄÅ",
                x: width * 0.4,
                y: height * 0.3,
                w: width * 0.2,
                h: height * 0.4,
                color: "#2196f3",
                opacity: 0.1,
              },
              {
                name: "ÁªÑÂêàÁä∂ÊÄÅ",
                x: width * 0.65,
                y: width * 0.2,
                w: width * 0.2,
                h: height * 0.3,
                color: "#ff9800",
                opacity: 0.1,
              },
              {
                name: "ÈîôËØØÁä∂ÊÄÅ",
                x: width * 0.15,
                y: height * 0.65,
                w: width * 0.2,
                h: height * 0.25,
                color: "#f44336",
                opacity: 0.1,
              },
              {
                name: "ÁªìÊùüÁä∂ÊÄÅ",
                x: width * 0.75,
                y: height * 0.5,
                w: width * 0.2,
                h: height * 0.3,
                color: "#607d8b",
                opacity: 0.1,
              },
            ];

            svg
              .append("g")
              .attr("class", "group-backgrounds")
              .selectAll("rect")
              .data(groupAreas)
              .enter()
              .append("rect")
              .attr("x", (d) => d.x)
              .attr("y", (d) => d.y)
              .attr("width", (d) => d.w)
              .attr("height", (d) => d.h)
              .attr("fill", (d) => d.color)
              .attr("opacity", (d) => d.opacity)
              .attr("rx", 15)
              .attr("ry", 15)
              .attr("stroke", (d) => d.color)
              .attr("stroke-width", 1)
              .attr("stroke-opacity", 0.3);

            svg
              .append("g")
              .attr("class", "group-labels")
              .selectAll("text")
              .data(groupAreas)
              .enter()
              .append("text")
              .attr("x", (d) => d.x + 10)
              .attr("y", (d) => d.y + 20)
              .attr("font-size", "11px")
              .attr("font-weight", "bold")
              .attr("fill", (d) => d.color)
              .attr("opacity", 0.7)
              .text((d) => d.name);
          };

          addGroupBackgrounds();
          simulation.stop();

          // Create links (only if we have valid transitions)
          let link, linkLabel;
          if (graphData.links && graphData.links.length > 0) {
            link = svg
              .append("g")
              .selectAll("path")
              .data(graphData.links)
              .join("path")
              .attr("class", "edge")
              .attr("stroke", "#666")
              .attr("stroke-width", 2)
              .attr("fill", "none")
              .attr("marker-end", "url(#arrowhead)");

            // Create link labels
            linkLabel = svg
              .append("g")
              .selectAll("text")
              .data(graphData.links)
              .join("text")
              .attr("font-size", "10px")
              .attr("text-anchor", "middle")
              .attr("fill", "#333")
              .attr("font-weight", "bold")
              .text((d) => d.event || "transition");
          } else {
            // Create empty groups to prevent errors
            link = svg.append("g").selectAll("path");
            linkLabel = svg.append("g").selectAll("text");
          }

          // Create nodes
          const node = svg
            .append("g")
            .selectAll("g")
            .data(graphData.nodes)
            .join("g")
            .attr("class", "state-node")
            .style("cursor", "pointer");

          // Node circles with type-based styling
          node
            .append("circle")
            .attr("r", (d) => (d.hasScreenshots ? 35 : 30))
            .attr("fill", (d) => d.color || "#666")
            .attr("stroke", (d) => (d.hasScreenshots ? "#fff" : "none"))
            .attr("stroke-width", (d) => (d.hasScreenshots ? 3 : 0))
            .attr("opacity", 0.9);

          // Screenshot indicator
          node
            .filter((d) => d.hasScreenshots)
            .append("circle")
            .attr("r", 8)
            .attr("cx", 25)
            .attr("cy", -25)
            .attr("fill", "#ff6b6b")
            .attr("stroke", "#fff")
            .attr("stroke-width", 2);

          node
            .filter((d) => d.hasScreenshots)
            .append("text")
            .attr("x", 25)
            .attr("y", -25)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "central")
            .attr("fill", "white")
            .attr("font-size", "10px")
            .attr("font-weight", "bold")
            .text("üì∑");

          // Node labels - split long labels
          node.each(function (d) {
            const nodeGroup = d3.select(this);
            const label = d.label || d.id;

            if (label.length > 12) {
              // Split long labels into multiple lines
              const words = label.split(/(?=[A-Z])|_|-/);
              const lines = [];
              let currentLine = "";

              words.forEach((word) => {
                if (
                  (currentLine + word).length > 10 &&
                  currentLine.length > 0
                ) {
                  lines.push(currentLine);
                  currentLine = word;
                } else {
                  currentLine += word;
                }
              });
              if (currentLine) lines.push(currentLine);

              lines.forEach((line, i) => {
                nodeGroup
                  .append("text")
                  .attr("font-size", "10px")
                  .attr("font-weight", "600")
                  .attr("fill", "white")
                  .attr("text-anchor", "middle")
                  .attr("y", (i - (lines.length - 1) / 2) * 12)
                  .text(line);
              });
            } else {
              nodeGroup
                .append("text")
                .attr("font-size", "11px")
                .attr("font-weight", "600")
                .attr("fill", "white")
                .attr("text-anchor", "middle")
                .text(label);
            }
          });

          // Node interactions with tooltips
          node
            .on("click", (event, d) => {
              node
                .select("circle")
                .attr("stroke-width", (d) => (d.hasScreenshots ? 3 : 0));

              d3.select(event.currentTarget)
                .select("circle")
                .attr("stroke", "#ff6b6b")
                .attr("stroke-width", 5);

              onStateClick(d.id);
            })
            .on("mouseover", (event, d) => {
              // Create tooltip
              const tooltip = d3
                .select("body")
                .selectAll(".fsm-tooltip")
                .data([1]);

              const tooltipEnter = tooltip
                .enter()
                .append("div")
                .attr("class", "tooltip fsm-tooltip");

              const tooltipUpdate = tooltipEnter.merge(tooltip);

              tooltipUpdate
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 10 + "px")
                .style("opacity", 1).html(`
                  <div><strong>${d.label || d.id}</strong></div>
                  <div>Á±ªÂûã: ${d.type}</div>
                  ${
                    d.entryActions.length > 0
                      ? `<div>ÂÖ•Âè£Âä®‰Ωú: ${d.entryActions
                          .slice(0, 2)
                          .join(", ")}${
                          d.entryActions.length > 2 ? "..." : ""
                        }</div>`
                      : ""
                  }
                  ${d.hasScreenshots ? "<div>üì∑ ÊúâÊà™ÂõæÂèØÊü•Áúã</div>" : ""}
                `);
            })
            .on("mouseout", () => {
              d3.select(".fsm-tooltip").style("opacity", 0);
            });

          // Position update function
          const updatePositions = () => {
            // Update links only if they exist
            if (link && !link.empty()) {
              link.attr("d", (d) => {
                const dx = d.target.x - d.source.x;
                const dy = d.target.y - d.source.y;
                const dr = Math.sqrt(dx * dx + dy * dy);

                if (dr === 0)
                  return `M${d.source.x},${d.source.y}L${d.source.x},${d.source.y}`;

                const sourceX = d.source.x + (dx * 35) / dr;
                const sourceY = d.source.y + (dy * 35) / dr;
                const targetX = d.target.x - (dx * 35) / dr;
                const targetY = d.target.y - (dy * 35) / dr;

                return `M${sourceX},${sourceY}L${targetX},${targetY}`;
              });
            }

            // Update link labels only if they exist
            if (linkLabel && !linkLabel.empty()) {
              linkLabel
                .attr("x", (d) => (d.source.x + d.target.x) / 2)
                .attr("y", (d) => (d.source.y + d.target.y) / 2 - 5);
            }

            // Always update nodes
            node.attr("transform", (d) => `translate(${d.x},${d.y})`);
          };

          // Drag functionality
          const drag = d3
            .drag()
            .on("start", (event, d) => {
              simulation.alpha(0.1).restart();
              d.fx = d.x;
              d.fy = d.y;
            })
            .on("drag", (event, d) => {
              d.fx = event.x;
              d.fy = event.y;
              updatePositions();
            })
            .on("end", (event, d) => {
              simulation.alpha(0);
              d.fx = null;
              d.fy = null;
            });

          node.call(drag);
          updatePositions();
          simulation.on("tick", updatePositions);
        }, [graphData, onStateClick]);

        return (
          <div className="graph-container">
            <svg ref={svgRef} width="100%" height="100%"></svg>
            <div className="graph-legend">
              <div className="legend-title">Áä∂ÊÄÅÁ±ªÂûã</div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{
                    backgroundColor: "#4caf50",
                    marginRight: "8px",
                    borderRadius: "3px",
                  }}
                ></div>
                <span>Á©∫Èó≤Áä∂ÊÄÅ</span>
              </div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{
                    backgroundColor: "#2196f3",
                    marginRight: "8px",
                    borderRadius: "3px",
                  }}
                ></div>
                <span>ÂéüÂ≠êÁä∂ÊÄÅ</span>
              </div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{
                    backgroundColor: "#ff9800",
                    marginRight: "8px",
                    borderRadius: "3px",
                  }}
                ></div>
                <span>ÁªÑÂêàÁä∂ÊÄÅ</span>
              </div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{
                    backgroundColor: "#f44336",
                    marginRight: "8px",
                    borderRadius: "3px",
                  }}
                ></div>
                <span>ÈîôËØØÁä∂ÊÄÅ</span>
              </div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{
                    backgroundColor: "#607d8b",
                    marginRight: "8px",
                    borderRadius: "3px",
                  }}
                ></div>
                <span>ÁªìÊùüÁä∂ÊÄÅ</span>
              </div>
              <div
                style={{ marginTop: "8px", fontSize: "0.75rem", color: "#666" }}
              >
                üì∑ = ÊúâÊà™Âõæ
              </div>
            </div>
            <div className="legend">
              <div className="legend-title">Áä∂ÊÄÅÂàÜÁ±ªÂ∏ÉÂ±Ä</div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{ backgroundColor: "#4caf50" }}
                ></div>
                <span>ÂºÄÂßãÁä∂ÊÄÅ (Â∑¶‰æß)</span>
              </div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{ backgroundColor: "#ff9800" }}
                ></div>
                <span>ËæìÂÖ•È™åËØÅ (Â∑¶‰∏ä)</span>
              </div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{ backgroundColor: "#2196f3" }}
                ></div>
                <span>ÊâßË°åÂä®‰Ωú (‰∏≠ÂøÉ)</span>
              </div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{ backgroundColor: "#9c27b0" }}
                ></div>
                <span>ÊòæÁ§∫Êõ¥Êñ∞ (Âè≥‰∏ã)</span>
              </div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{ backgroundColor: "#f44336" }}
                ></div>
                <span>ÈîôËØØÂ§ÑÁêÜ (Â∑¶‰∏ã)</span>
              </div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{ backgroundColor: "#607d8b" }}
                ></div>
                <span>ÁªìÊùüÁä∂ÊÄÅ (Âè≥‰æß)</span>
              </div>
              <div
                className="legend-item"
                style={{ marginTop: "10px", fontSize: "11px" }}
              >
                <span>üì∑ = ÊúâÊà™ÂõæÂèØÊü•Áúã</span>
              </div>
              <div
                className="legend-item"
                style={{ fontSize: "10px", color: "#666" }}
              >
                <span>ÊãñÊãΩËäÇÁÇπÂèØË∞ÉÊï¥‰ΩçÁΩÆ</span>
              </div>
            </div>
          </div>
        );
      };

      // FSMVisualizerModal Component
      const FSMVisualizerModal = ({ show, onClose, fileId, workspace }) => {
        const [fsmData, setFsmData] = useState(null);
        const [screenshots, setScreenshots] = useState([]);
        const [selectedState, setSelectedState] = useState("");
        const [showScreenshots, setShowScreenshots] = useState(false);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");

        useEffect(() => {
          if (show && fileId && workspace) {
            loadFSMData();
          }
        }, [show, fileId, workspace]);

        const loadFSMData = async () => {
          setLoading(true);
          setError("");

          try {
            console.log("Loading FSM data for:", { workspace, fileId });

            // Use the correct API endpoint for FSM JSON files
            const fsmApiEndpoint = `http://localhost:3000/api/fsm/${workspace}/${fileId}`;
            console.log("Trying FSM API endpoint:", fsmApiEndpoint);

            const fsmResponse = await fetch(fsmApiEndpoint);

            if (fsmResponse.ok) {
              const fsm = await fsmResponse.json();
              console.log("FSM data loaded successfully:", fsm);
              setFsmData(fsm);
            } else {
              const errorText = await fsmResponse.text();
              throw new Error(
                `Êó†Ê≥ïÂä†ËΩΩFSMÊï∞ÊçÆ (${fsmResponse.status}): ${errorText}`
              );
            }

            // Load screenshots (optional)
            try {
              const screenshotEndpoints = [
                `http://localhost:3000/api/screenshots/${workspace}/${fileId}`,
                `http://localhost:3000/workspace/${workspace}/screenshots/${fileId}/`,
                `workspace/${workspace}/screenshots/${fileId}/`,
              ];

              let screenshotResponse = null;
              for (const endpoint of screenshotEndpoints) {
                try {
                  screenshotResponse = await fetch(endpoint);
                  if (screenshotResponse.ok) break;
                } catch (e) {
                  // Continue to next endpoint
                }
              }

              if (screenshotResponse && screenshotResponse.ok) {
                const screenshots = await screenshotResponse.json();
                setScreenshots(screenshots);
              } else {
                console.warn(
                  "Could not load screenshots, continuing without them"
                );
                setScreenshots([]);
              }
            } catch (screenshotError) {
              console.warn("Screenshot loading failed:", screenshotError);
              setScreenshots([]);
            }
          } catch (error) {
            setError(error.message);
            console.error("Âä†ËΩΩFSMÊï∞ÊçÆÂ§±Ë¥•:", error);
          } finally {
            setLoading(false);
          }
        };

        const handleStateClick = (stateName) => {
          setSelectedState(stateName);
          setShowScreenshots(true);
        };

        const closeScreenshots = () => {
          setShowScreenshots(false);
          setSelectedState("");
        };

        if (!show) return null;

        return (
          <div className="fsm-modal show">
            <div className="fsm-modal-content">
              <div className="fsm-modal-header">
                <div className="fsm-modal-title">
                  üîÑ FSM State Machine: {fileId}
                </div>
                <button className="fsm-close-btn" onClick={onClose}>
                  √ó
                </button>
              </div>

              <div className="fsm-modal-body">
                {error && (
                  <div className="error" style={{ marginBottom: "20px" }}>
                    {error}
                  </div>
                )}

                {loading && (
                  <div
                    className="loading"
                    style={{ textAlign: "center", padding: "40px" }}
                  >
                    Âä†ËΩΩ‰∏≠...
                  </div>
                )}

                {fsmData && (
                  <>
                    <div className="fsm-info">
                      <div className="info-panel">
                        <div className="info-title">üìã FSM ‰ø°ÊÅØ</div>
                        <div className="info-content">
                          <strong>Ê¶ÇÂøµ:</strong>{" "}
                          {fsmData.meta?.concept || "N/A"}
                          <br />
                          <strong>‰∏ªÈ¢ò:</strong>{" "}
                          {fsmData.meta?.topic || fsmData.topic || "N/A"}
                          <br />
                          <strong>Áä∂ÊÄÅÊï∞:</strong> {fsmData.states?.length || 0}
                          <br />
                          <strong>‰∫ã‰ª∂Êï∞:</strong> {fsmData.events?.length || 0}
                          <br />
                          <strong>ËΩ¨Êç¢Êï∞:</strong>{" "}
                          {fsmData.transitions?.length || 0}
                          <br />
                          <strong>ÁªÑ‰ª∂Êï∞:</strong>{" "}
                          {fsmData.components?.length || 0}
                          <br />
                          <strong>Êà™ÂõæÊï∞:</strong> {screenshots.length}
                        </div>
                      </div>
                      <div className="info-panel">
                        <div className="info-title">üí° Êìç‰ΩúËØ¥Êòé</div>
                        <div className="info-content">
                          ‚Ä¢ ÁÇπÂáªÁä∂ÊÄÅËäÇÁÇπÊü•ÁúãÂØπÂ∫îÊà™Âõæ
                          <br />
                          ‚Ä¢ ÊãñÊãΩËäÇÁÇπË∞ÉÊï¥Â∏ÉÂ±Ä
                          <br />
                          ‚Ä¢ ÁÆ≠Â§¥Ë°®Á§∫Áä∂ÊÄÅËΩ¨Êç¢
                          <br />‚Ä¢ üì∑ Ë°®Á§∫ËØ•Áä∂ÊÄÅÊúâÊà™Âõæ
                        </div>
                      </div>
                    </div>

                    <FSMGraph
                      fsmData={fsmData}
                      screenshots={screenshots}
                      onStateClick={handleStateClick}
                    />

                    {screenshots.length > 0 && (
                      <div style={{ textAlign: "center", marginTop: "20px" }}>
                        <button
                          className="card-btn view"
                          onClick={() => setShowScreenshots(true)}
                          style={{ padding: "10px 20px", fontSize: "1rem" }}
                        >
                          Êü•ÁúãÊâÄÊúâÊà™Âõæ ({screenshots.length})
                        </button>
                      </div>
                    )}
                  </>
                )}
              </div>
            </div>

            <ScreenshotPanel
              show={showScreenshots}
              onClose={closeScreenshots}
              selectedState={selectedState}
              screenshots={screenshots}
            />
          </div>
        );
      };

      // FilterControls Component
      const FilterControls = ({
        filters,
        onFilterChange,
        onClearFilters,
        allData,
      }) => {
        // Ëé∑ÂèñÊâÄÊúâÂèØÁî®ÁöÑÊ®°Âûã
        const availableModels = [
          ...new Set(Object.values(allData).map((item) => item.model)),
        ].sort();

        // Ëé∑ÂèñÊâÄÊúâÂèØÁî®ÁöÑÊ†áÁ≠æ
        const availableTags = [
          ...new Set(Object.values(allData).flatMap((item) => item.tags || [])),
        ].sort();

        return (
          <div className="filters-container">
            <div className="filters-title">üîç Á≠õÈÄâÂô®</div>

            <div className="filters-grid">
              <div className="filter-group">
                <div className="filter-label">Ê®°Âûã</div>
                <select
                  className="filter-select"
                  value={filters.model}
                  onChange={(e) => onFilterChange("model", e.target.value)}
                >
                  <option value="">ÊâÄÊúâÊ®°Âûã</option>
                  {availableModels.map((model) => (
                    <option key={model} value={model}>
                      {model}
                    </option>
                  ))}
                </select>
              </div>

              <div className="filter-group">
                <div className="filter-label">Ê†áÁ≠æ</div>
                <select
                  className="filter-select"
                  value={filters.tag}
                  onChange={(e) => onFilterChange("tag", e.target.value)}
                >
                  <option value="">ÊâÄÊúâÊ†áÁ≠æ</option>
                  {availableTags.map((tag) => (
                    <option key={tag} value={tag}>
                      {tag}
                    </option>
                  ))}
                </select>
              </div>

              <div className="filter-group">
                <div className="filter-label">ÈóÆÈ¢òÂÖ≥ÈîÆËØç</div>
                <input
                  type="text"
                  className="filter-input"
                  placeholder="ËæìÂÖ•ÂÖ≥ÈîÆËØç..."
                  value={filters.question}
                  onChange={(e) => onFilterChange("question", e.target.value)}
                />
              </div>

              <div className="filter-group">
                <div className="filter-label">Êó•ÊúüËåÉÂõ¥</div>
                <select
                  className="filter-select"
                  value={filters.dateRange}
                  onChange={(e) => onFilterChange("dateRange", e.target.value)}
                >
                  <option value="">ÊâÄÊúâÊó∂Èó¥</option>
                  <option value="today">‰ªäÂ§©</option>
                  <option value="week">Ëøë‰∏ÄÂë®</option>
                  <option value="month">Ëøë‰∏ÄÊúà</option>
                </select>
              </div>
            </div>

            <div className="filter-buttons">
              <button className="filter-btn clear" onClick={onClearFilters}>
                Ê∏ÖÈô§Á≠õÈÄâ
              </button>
            </div>
          </div>
        );
      };

      // WorkspaceSelector Component
      const WorkspaceSelector = ({
        onWorkspaceChange,
        workspaces,
        loading,
        error,
      }) => {
        return (
          <div className="workspace-selector">
            <select
              onChange={(e) => onWorkspaceChange(e.target.value)}
              disabled={loading}
            >
              <option value="">ÈÄâÊã©Â∑•‰ΩúÁ©∫Èó¥...</option>
              {workspaces.map((workspace) => (
                <option
                  key={workspace.name}
                  value={workspace.name}
                  disabled={!workspace.hasData}
                >
                  {workspace.name}
                  {workspace.hasData ? "" : " (Êï∞ÊçÆ‰∏çÂÆåÊï¥)"}
                </option>
              ))}
            </select>
            {error && (
              <div className="error" style={{ marginTop: "10px" }}>
                {error}
              </div>
            )}
          </div>
        );
      };

      // Message Component
      const Message = ({ message }) => {
        const roleClass = `message-${message.role}`;
        const roleText =
          message.role === "system"
            ? "Á≥ªÁªü"
            : message.role === "user"
            ? "Áî®Êà∑"
            : message.role;

        return (
          <div className={`message-item ${roleClass}`}>
            <div className="message-role">{roleText}</div>
            <div className="message-content">{message.content}</div>
          </div>
        );
      };

      // HtmlCard Component
      const HtmlCard = ({
        data,
        workspace,
        fileId,
        onFSMClick,
        onEvaluationClick,
      }) => {
        const handleViewClick = () => {
          window.open(`./workspace/${workspace}/html/${fileId}.html`, "_blank");
        };

        const handleFSMClick = (e) => {
          e.stopPropagation();
          onFSMClick(fileId);
        };

        const handleEvaluationClick = (e) => {
          e.stopPropagation();
          onEvaluationClick(fileId);
        };

        return (
          <div className="html-card">
            <iframe
              className="card-preview"
              src={`./workspace/${workspace}/html/${fileId}.html`}
              scrolling="no"
              title={`Preview of ${fileId}`}
            />
            <div className="card-info">
              <div className="card-buttons">
                <button className="card-btn view" onClick={handleViewClick}>
                  Êü•ÁúãÈ°µÈù¢
                </button>
                <button className="card-btn fsm" onClick={handleFSMClick}>
                  FSM ÂèØËßÜÂåñ
                </button>
                <button
                  className="card-btn evaluation"
                  onClick={handleEvaluationClick}
                >
                  ËßÜËßâËØÑ‰º∞
                </button>
              </div>
              <div className="card-title">{fileId}</div>
              <div className="card-model">Ê®°Âûã: {data.model}</div>
              <div className="card-timestamp">
                {new Date(data.timestamp).toLocaleString("zh-CN")}
              </div>
              {data.messages && data.messages.length > 0 && (
                <div className="card-messages">
                  {data.messages.map((message, index) => (
                    <Message key={index} message={message} />
                  ))}
                </div>
              )}
            </div>
          </div>
        );
      };

      // GridContainer Component
      const GridContainer = ({
        htmlFiles,
        currentData,
        workspace,
        loading,
        totalCount,
        onFSMClick,
        onEvaluationClick,
      }) => {
        if (loading) {
          return <div className="loading">Âä†ËΩΩ‰∏≠...</div>;
        }

        if (htmlFiles.length === 0 && totalCount > 0) {
          return <div className="no-files">Ê≤°ÊúâÁ¨¶ÂêàÁ≠õÈÄâÊù°‰ª∂ÁöÑÊñá‰ª∂</div>;
        }

        if (htmlFiles.length === 0) {
          return <div className="no-files">ÂΩìÂâçÂ∑•‰ΩúÁ©∫Èó¥Ê≤°ÊúâHTMLÊñá‰ª∂</div>;
        }

        const filteredCount = htmlFiles.filter(
          (fileId) => currentData[fileId]
        ).length;

        return (
          <>
            {totalCount > 0 && (
              <div className="results-count">
                ÊòæÁ§∫ {filteredCount} / {totalCount} ‰∏™Êñá‰ª∂
              </div>
            )}
            <div className="grid-container">
              {htmlFiles.map((fileId) => {
                const data = currentData[fileId];
                if (!data) return null;

                return (
                  <HtmlCard
                    key={fileId}
                    data={data}
                    workspace={workspace}
                    fileId={fileId}
                    onFSMClick={onFSMClick}
                    onEvaluationClick={onEvaluationClick}
                  />
                );
              })}
            </div>
          </>
        );
      };

      // Main App Component
      const App = () => {
        const [workspaces, setWorkspaces] = useState([]);
        const [currentWorkspace, setCurrentWorkspace] = useState("");
        const [currentData, setCurrentData] = useState({});
        const [htmlFiles, setHtmlFiles] = useState([]);
        const [allFiles, setAllFiles] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");
        const [filters, setFilters] = useState({
          model: "",
          tag: "",
          question: "",
          dateRange: "",
        });

        // FSMÁõ∏ÂÖ≥Áä∂ÊÄÅ
        const [showFSMModal, setShowFSMModal] = useState(false);
        const [currentFSMFile, setCurrentFSMFile] = useState("");

        // ËØÑ‰º∞Áõ∏ÂÖ≥Áä∂ÊÄÅ
        const [showEvaluationModal, setShowEvaluationModal] = useState(false);
        const [currentEvaluationFile, setCurrentEvaluationFile] = useState("");

        // Load workspaces on mount
        useEffect(() => {
          loadWorkspaces();
        }, []);

        const loadWorkspaces = async () => {
          try {
            // Â∞ùËØï‰ªéAPIËé∑ÂèñÂ∑•‰ΩúÁ©∫Èó¥ÂàóË°®
            const response = await fetch(
              "http://localhost:3000/api/workspaces"
            );
            if (!response.ok) {
              throw new Error("APIÊúçÂä°Âô®Êú™ÂêØÂä®ÊàñÊó†Ê≥ïËÆøÈóÆ");
            }

            const workspaceData = await response.json();
            setWorkspaces(workspaceData);
            console.log(`‚úÖ ÊàêÂäüÂä†ËΩΩ ${workspaceData.length} ‰∏™Â∑•‰ΩúÁ©∫Èó¥`);
          } catch (apiError) {
            console.warn("API‰∏çÂèØÁî®Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à:", apiError.message);

            // Â§áÁî®ÊñπÊ°àÔºöÊâãÂä®Ê∑ªÂä†Â∑≤Áü•Â∑•‰ΩúÁ©∫Èó¥
            const fallbackWorkspaces = [
              { name: "10-04", hasData: true },
              { name: "test", hasData: true },
            ];
            setWorkspaces(fallbackWorkspaces);

            setError(
              "APIÊúçÂä°Âô®Êú™ÂêØÂä®Ôºå‰ΩøÁî®Á¶ªÁ∫øÊ®°Âºè„ÄÇËØ∑ËøêË°å 'node api.mjs' ÂêØÂä®ÊúçÂä°Âô®‰ª•Ëé∑ÂæóÂÆåÊï¥ÂäüËÉΩ„ÄÇ"
            );
          }
        };

        const loadWorkspaceData = async (workspace) => {
          if (!workspace) {
            setHtmlFiles([]);
            setCurrentData({});
            return;
          }

          setLoading(true);
          setError("");

          try {
            // È¶ñÂÖàÂ∞ùËØï‰ªéAPIËé∑ÂèñÊï∞ÊçÆ
            let data;
            try {
              const apiResponse = await fetch(
                `http://localhost:3000/api/workspaces/${workspace}/data`
              );
              if (apiResponse.ok) {
                data = await apiResponse.json();
                console.log(`‚úÖ ‰ªéAPIÂä†ËΩΩÂ∑•‰ΩúÁ©∫Èó¥ ${workspace} ÁöÑÊï∞ÊçÆ`);
              } else {
                throw new Error("APIÂìçÂ∫îÂ§±Ë¥•");
              }
            } catch (apiError) {
              console.warn("API‰∏çÂèØÁî®Ôºå‰ΩøÁî®Áõ¥Êé•ËÆøÈóÆ:", apiError.message);
              // Â§áÁî®ÊñπÊ°àÔºöÁõ¥Êé•ËÆøÈóÆÊñá‰ª∂
              const dataResponse = await fetch(
                `./workspace/${workspace}/data/data.json`
              );
              if (!dataResponse.ok) {
                throw new Error(`Êó†Ê≥ïÂä†ËΩΩ ${workspace} ÁöÑÊï∞ÊçÆÊñá‰ª∂`);
              }
              data = await dataResponse.json();
            }

            const newCurrentData = {};
            // Â∞ÜÊï∞ÊçÆÊåâIDÁ¥¢Âºï
            data.forEach((item) => {
              newCurrentData[item.id] = item;
            });

            setCurrentData(newCurrentData);
            // Ëé∑ÂèñHTMLÊñá‰ª∂ÂàóË°®ÔºàÊ†πÊçÆÊï∞ÊçÆÊé®Êñ≠Ôºâ
            const fileIds = data.map((item) => item.id);
            setAllFiles(fileIds);
            setHtmlFiles(fileIds);

            // ÊòæÁ§∫ÁªüËÆ°‰ø°ÊÅØÔºàÂ¶ÇÊûúAPIÂèØÁî®Ôºâ
            try {
              const statsResponse = await fetch(
                `http://localhost:3000/api/workspaces/${workspace}/stats`
              );
              if (statsResponse.ok) {
                const stats = await statsResponse.json();
                console.log(`üìä Â∑•‰ΩúÁ©∫Èó¥ÁªüËÆ°:`, stats);
              }
            } catch (statsError) {
              // ÁªüËÆ°‰ø°ÊÅØËé∑ÂèñÂ§±Ë¥•‰∏çÂΩ±Âìç‰∏ªË¶ÅÂäüËÉΩ
            }
          } catch (error) {
            setError(error.message);
            console.error("Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:", error);
          } finally {
            setLoading(false);
          }
        };

        const handleWorkspaceChange = (workspace) => {
          setCurrentWorkspace(workspace);
          loadWorkspaceData(workspace);
          // ÈáçÁΩÆÁ≠õÈÄâÂô®
          setFilters({
            model: "",
            tag: "",
            question: "",
            dateRange: "",
          });
        };

        // Á≠õÈÄâÂäüËÉΩ
        const applyFilters = (data, filterOptions) => {
          return data.filter((fileId) => {
            const item = currentData[fileId];
            if (!item) return false;

            // Ê®°ÂûãÁ≠õÈÄâ
            if (filterOptions.model && item.model !== filterOptions.model) {
              return false;
            }

            // Ê†áÁ≠æÁ≠õÈÄâ
            if (
              filterOptions.tag &&
              (!item.tags || !item.tags.includes(filterOptions.tag))
            ) {
              return false;
            }

            // ÈóÆÈ¢òÂÖ≥ÈîÆËØçÁ≠õÈÄâ
            if (
              filterOptions.question &&
              !item.question
                .toLowerCase()
                .includes(filterOptions.question.toLowerCase())
            ) {
              return false;
            }

            // Êó•ÊúüËåÉÂõ¥Á≠õÈÄâ
            if (filterOptions.dateRange) {
              const itemDate = new Date(item.timestamp);
              const now = new Date();
              const diffTime = Math.abs(now - itemDate);
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

              switch (filterOptions.dateRange) {
                case "today":
                  if (diffDays > 1) return false;
                  break;
                case "week":
                  if (diffDays > 7) return false;
                  break;
                case "month":
                  if (diffDays > 30) return false;
                  break;
              }
            }

            return true;
          });
        };

        // Â§ÑÁêÜÁ≠õÈÄâÂô®ÂèòÂåñ
        const handleFilterChange = (key, value) => {
          const newFilters = { ...filters, [key]: value };
          setFilters(newFilters);

          // Â∫îÁî®Á≠õÈÄâ
          const filteredFiles = applyFilters(allFiles, newFilters);
          setHtmlFiles(filteredFiles);
        };

        // Ê∏ÖÈô§Á≠õÈÄâ
        const handleClearFilters = () => {
          const emptyFilters = {
            model: "",
            tag: "",
            question: "",
            dateRange: "",
          };
          setFilters(emptyFilters);
          setHtmlFiles(allFiles);
        };

        // FSMÁõ∏ÂÖ≥Â§ÑÁêÜÂáΩÊï∞
        const handleFSMClick = (fileId) => {
          setCurrentFSMFile(fileId);
          setShowFSMModal(true);
        };

        const closeFSMModal = () => {
          setShowFSMModal(false);
          setCurrentFSMFile("");
        };

        // ËØÑ‰º∞Áõ∏ÂÖ≥Â§ÑÁêÜÂáΩÊï∞
        const handleEvaluationClick = (fileId) => {
          setCurrentEvaluationFile(fileId);
          setShowEvaluationModal(true);
        };

        const closeEvaluationModal = () => {
          setShowEvaluationModal(false);
          setCurrentEvaluationFile("");
        };

        return (
          <div className="container">
            <h1>HTML Files Viewer - React Edition</h1>

            <WorkspaceSelector
              onWorkspaceChange={handleWorkspaceChange}
              workspaces={workspaces}
              loading={loading}
              error={error}
            />

            {currentWorkspace && Object.keys(currentData).length > 0 && (
              <FilterControls
                filters={filters}
                onFilterChange={handleFilterChange}
                onClearFilters={handleClearFilters}
                allData={currentData}
              />
            )}

            <GridContainer
              htmlFiles={htmlFiles}
              currentData={currentData}
              workspace={currentWorkspace}
              loading={loading}
              totalCount={allFiles.length}
              onFSMClick={handleFSMClick}
              onEvaluationClick={handleEvaluationClick}
            />

            <FSMVisualizerModal
              show={showFSMModal}
              onClose={closeFSMModal}
              fileId={currentFSMFile}
              workspace={currentWorkspace}
            />

            <EvaluationModal
              show={showEvaluationModal}
              onClose={closeEvaluationModal}
              fileId={currentEvaluationFile}
              workspace={currentWorkspace}
            />
          </div>
        );
      };

      // Render the app
      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
