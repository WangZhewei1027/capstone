<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HTML Files Viewer - React Edition</title>

    <!-- React CDN -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        text-align: center;
        color: white;
        margin-bottom: 30px;
        font-size: 2.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .workspace-selector {
        text-align: center;
        margin-bottom: 30px;
      }

      select {
        padding: 12px 20px;
        font-size: 16px;
        border: none;
        border-radius: 25px;
        background: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      select:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }

      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        padding: 20px 0;
      }

      .html-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
      }

      .html-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      }

      .card-preview {
        width: 100%;
        height: 200px;
        border: none;
        background: #f8f9fa;
      }

      .card-info {
        padding: 12px;
      }

      .card-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        word-break: break-all;
      }

      .card-model {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 5px;
      }

      .card-timestamp {
        font-size: 0.8rem;
        color: #999;
      }

      .card-messages {
        margin-top: 10px;
        font-size: 0.85rem;
      }

      .message-item {
        margin-bottom: 6px;
        padding: 4px 8px;
        border-radius: 4px;
      }

      .message-system {
        background: #e3f2fd;
        border-left: 3px solid #2196f3;
      }

      .message-user {
        background: #f3e5f5;
        border-left: 3px solid #9c27b0;
      }

      .message-role {
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        margin-bottom: 2px;
      }

      .message-content {
        font-size: 0.8rem;
        line-height: 1.3;
        word-break: break-word;
      }

      .loading {
        text-align: center;
        color: white;
        font-size: 1.1rem;
        margin-top: 30px;
      }

      .error {
        text-align: center;
        color: #ff6b6b;
        font-size: 1.1rem;
        margin-top: 30px;
        background: white;
        padding: 20px;
        border-radius: 10px;
      }

      .no-files {
        text-align: center;
        color: white;
        font-size: 1.2rem;
        margin-top: 50px;
      }

      .filters-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
      }

      .filters-title {
        color: white;
        font-size: 1.2rem;
        margin-bottom: 15px;
        text-align: center;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .filter-label {
        color: white;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .filter-select,
      .filter-input {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        background: white;
        font-size: 0.9rem;
        cursor: pointer;
      }

      .filter-input {
        cursor: text;
      }

      .filter-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
      }

      .filter-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        background: white;
        color: #333;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-btn:hover {
        background: #f0f0f0;
        transform: translateY(-1px);
      }

      .filter-btn.clear {
        background: #ff6b6b;
        color: white;
      }

      .filter-btn.clear:hover {
        background: #ff5252;
      }

      .results-count {
        color: white;
        text-align: center;
        margin-bottom: 10px;
        font-size: 0.9rem;
      }

      .filters-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
      }

      .filters-title {
        color: white;
        font-size: 1.2rem;
        margin-bottom: 15px;
        text-align: center;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .filter-label {
        color: white;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .filter-select,
      .filter-input {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        background: white;
        font-size: 0.9rem;
        cursor: pointer;
      }

      .filter-input {
        cursor: text;
      }

      .filter-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
      }

      .filter-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        background: white;
        color: #333;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-btn:hover {
        background: #f0f0f0;
        transform: translateY(-1px);
      }

      .filter-btn.clear {
        background: #ff6b6b;
        color: white;
      }

      .filter-btn.clear:hover {
        background: #ff5252;
      }

      .results-count {
        color: white;
        text-align: center;
        margin-bottom: 10px;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // FilterControls Component
      const FilterControls = ({
        filters,
        onFilterChange,
        onClearFilters,
        allData,
      }) => {
        // Ëé∑ÂèñÊâÄÊúâÂèØÁî®ÁöÑÊ®°Âûã
        const availableModels = [
          ...new Set(Object.values(allData).map((item) => item.model)),
        ].sort();

        // Ëé∑ÂèñÊâÄÊúâÂèØÁî®ÁöÑÊ†áÁ≠æ
        const availableTags = [
          ...new Set(Object.values(allData).flatMap((item) => item.tags || [])),
        ].sort();

        return (
          <div className="filters-container">
            <div className="filters-title">üîç Á≠õÈÄâÂô®</div>

            <div className="filters-grid">
              <div className="filter-group">
                <div className="filter-label">Ê®°Âûã</div>
                <select
                  className="filter-select"
                  value={filters.model}
                  onChange={(e) => onFilterChange("model", e.target.value)}
                >
                  <option value="">ÊâÄÊúâÊ®°Âûã</option>
                  {availableModels.map((model) => (
                    <option key={model} value={model}>
                      {model}
                    </option>
                  ))}
                </select>
              </div>

              <div className="filter-group">
                <div className="filter-label">Ê†áÁ≠æ</div>
                <select
                  className="filter-select"
                  value={filters.tag}
                  onChange={(e) => onFilterChange("tag", e.target.value)}
                >
                  <option value="">ÊâÄÊúâÊ†áÁ≠æ</option>
                  {availableTags.map((tag) => (
                    <option key={tag} value={tag}>
                      {tag}
                    </option>
                  ))}
                </select>
              </div>

              <div className="filter-group">
                <div className="filter-label">ÈóÆÈ¢òÂÖ≥ÈîÆËØç</div>
                <input
                  type="text"
                  className="filter-input"
                  placeholder="ËæìÂÖ•ÂÖ≥ÈîÆËØç..."
                  value={filters.question}
                  onChange={(e) => onFilterChange("question", e.target.value)}
                />
              </div>

              <div className="filter-group">
                <div className="filter-label">Êó•ÊúüËåÉÂõ¥</div>
                <select
                  className="filter-select"
                  value={filters.dateRange}
                  onChange={(e) => onFilterChange("dateRange", e.target.value)}
                >
                  <option value="">ÊâÄÊúâÊó∂Èó¥</option>
                  <option value="today">‰ªäÂ§©</option>
                  <option value="week">Ëøë‰∏ÄÂë®</option>
                  <option value="month">Ëøë‰∏ÄÊúà</option>
                </select>
              </div>
            </div>

            <div className="filter-buttons">
              <button className="filter-btn clear" onClick={onClearFilters}>
                Ê∏ÖÈô§Á≠õÈÄâ
              </button>
            </div>
          </div>
        );
      };

      // WorkspaceSelector Component
      const WorkspaceSelector = ({
        onWorkspaceChange,
        workspaces,
        loading,
        error,
      }) => {
        return (
          <div className="workspace-selector">
            <select
              onChange={(e) => onWorkspaceChange(e.target.value)}
              disabled={loading}
            >
              <option value="">ÈÄâÊã©Â∑•‰ΩúÁ©∫Èó¥...</option>
              {workspaces.map((workspace) => (
                <option
                  key={workspace.name}
                  value={workspace.name}
                  disabled={!workspace.hasData}
                >
                  {workspace.name}
                  {workspace.hasData ? "" : " (Êï∞ÊçÆ‰∏çÂÆåÊï¥)"}
                </option>
              ))}
            </select>
            {error && (
              <div className="error" style={{ marginTop: "10px" }}>
                {error}
              </div>
            )}
          </div>
        );
      };

      // Message Component
      const Message = ({ message }) => {
        const roleClass = `message-${message.role}`;
        const roleText =
          message.role === "system"
            ? "Á≥ªÁªü"
            : message.role === "user"
            ? "Áî®Êà∑"
            : message.role;

        return (
          <div className={`message-item ${roleClass}`}>
            <div className="message-role">{roleText}</div>
            <div className="message-content">{message.content}</div>
          </div>
        );
      };

      // HtmlCard Component
      const HtmlCard = ({ data, workspace, fileId }) => {
        const handleClick = () => {
          window.open(`./workspace/${workspace}/html/${fileId}.html`, "_blank");
        };

        return (
          <div className="html-card" onClick={handleClick}>
            <iframe
              className="card-preview"
              src={`./workspace/${workspace}/html/${fileId}.html`}
              scrolling="no"
              title={`Preview of ${fileId}`}
            />
            <div className="card-info">
              <div className="card-title">{fileId}</div>
              <div className="card-model">Ê®°Âûã: {data.model}</div>
              <div className="card-timestamp">
                {new Date(data.timestamp).toLocaleString("zh-CN")}
              </div>
              {data.messages && data.messages.length > 0 && (
                <div className="card-messages">
                  {data.messages.map((message, index) => (
                    <Message key={index} message={message} />
                  ))}
                </div>
              )}
            </div>
          </div>
        );
      };

      // GridContainer Component
      const GridContainer = ({
        htmlFiles,
        currentData,
        workspace,
        loading,
        totalCount,
      }) => {
        if (loading) {
          return <div className="loading">Âä†ËΩΩ‰∏≠...</div>;
        }

        if (htmlFiles.length === 0 && totalCount > 0) {
          return <div className="no-files">Ê≤°ÊúâÁ¨¶ÂêàÁ≠õÈÄâÊù°‰ª∂ÁöÑÊñá‰ª∂</div>;
        }

        if (htmlFiles.length === 0) {
          return <div className="no-files">ÂΩìÂâçÂ∑•‰ΩúÁ©∫Èó¥Ê≤°ÊúâHTMLÊñá‰ª∂</div>;
        }

        const filteredCount = htmlFiles.filter(
          (fileId) => currentData[fileId]
        ).length;

        return (
          <>
            {totalCount > 0 && (
              <div className="results-count">
                ÊòæÁ§∫ {filteredCount} / {totalCount} ‰∏™Êñá‰ª∂
              </div>
            )}
            <div className="grid-container">
              {htmlFiles.map((fileId) => {
                const data = currentData[fileId];
                if (!data) return null;

                return (
                  <HtmlCard
                    key={fileId}
                    data={data}
                    workspace={workspace}
                    fileId={fileId}
                  />
                );
              })}
            </div>
          </>
        );
      };

      // Main App Component
      const App = () => {
        const [workspaces, setWorkspaces] = useState([]);
        const [currentWorkspace, setCurrentWorkspace] = useState("");
        const [currentData, setCurrentData] = useState({});
        const [htmlFiles, setHtmlFiles] = useState([]);
        const [allFiles, setAllFiles] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");
        const [filters, setFilters] = useState({
          model: "",
          tag: "",
          question: "",
          dateRange: "",
        });

        // Load workspaces on mount
        useEffect(() => {
          loadWorkspaces();
        }, []);

        const loadWorkspaces = async () => {
          try {
            // Â∞ùËØï‰ªéAPIËé∑ÂèñÂ∑•‰ΩúÁ©∫Èó¥ÂàóË°®
            const response = await fetch(
              "http://localhost:3000/api/workspaces"
            );
            if (!response.ok) {
              throw new Error("APIÊúçÂä°Âô®Êú™ÂêØÂä®ÊàñÊó†Ê≥ïËÆøÈóÆ");
            }

            const workspaceData = await response.json();
            setWorkspaces(workspaceData);
            console.log(`‚úÖ ÊàêÂäüÂä†ËΩΩ ${workspaceData.length} ‰∏™Â∑•‰ΩúÁ©∫Èó¥`);
          } catch (apiError) {
            console.warn("API‰∏çÂèØÁî®Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à:", apiError.message);

            // Â§áÁî®ÊñπÊ°àÔºöÊâãÂä®Ê∑ªÂä†Â∑≤Áü•Â∑•‰ΩúÁ©∫Èó¥
            const fallbackWorkspaces = [
              { name: "10-04", hasData: true },
              { name: "test", hasData: true },
            ];
            setWorkspaces(fallbackWorkspaces);

            setError(
              "APIÊúçÂä°Âô®Êú™ÂêØÂä®Ôºå‰ΩøÁî®Á¶ªÁ∫øÊ®°Âºè„ÄÇËØ∑ËøêË°å 'node api.mjs' ÂêØÂä®ÊúçÂä°Âô®‰ª•Ëé∑ÂæóÂÆåÊï¥ÂäüËÉΩ„ÄÇ"
            );
          }
        };

        const loadWorkspaceData = async (workspace) => {
          if (!workspace) {
            setHtmlFiles([]);
            setCurrentData({});
            return;
          }

          setLoading(true);
          setError("");

          try {
            // È¶ñÂÖàÂ∞ùËØï‰ªéAPIËé∑ÂèñÊï∞ÊçÆ
            let data;
            try {
              const apiResponse = await fetch(
                `http://localhost:3000/api/workspaces/${workspace}/data`
              );
              if (apiResponse.ok) {
                data = await apiResponse.json();
                console.log(`‚úÖ ‰ªéAPIÂä†ËΩΩÂ∑•‰ΩúÁ©∫Èó¥ ${workspace} ÁöÑÊï∞ÊçÆ`);
              } else {
                throw new Error("APIÂìçÂ∫îÂ§±Ë¥•");
              }
            } catch (apiError) {
              console.warn("API‰∏çÂèØÁî®Ôºå‰ΩøÁî®Áõ¥Êé•ËÆøÈóÆ:", apiError.message);
              // Â§áÁî®ÊñπÊ°àÔºöÁõ¥Êé•ËÆøÈóÆÊñá‰ª∂
              const dataResponse = await fetch(
                `./workspace/${workspace}/data/data.json`
              );
              if (!dataResponse.ok) {
                throw new Error(`Êó†Ê≥ïÂä†ËΩΩ ${workspace} ÁöÑÊï∞ÊçÆÊñá‰ª∂`);
              }
              data = await dataResponse.json();
            }

            const newCurrentData = {};
            // Â∞ÜÊï∞ÊçÆÊåâIDÁ¥¢Âºï
            data.forEach((item) => {
              newCurrentData[item.id] = item;
            });

            setCurrentData(newCurrentData);
            // Ëé∑ÂèñHTMLÊñá‰ª∂ÂàóË°®ÔºàÊ†πÊçÆÊï∞ÊçÆÊé®Êñ≠Ôºâ
            const fileIds = data.map((item) => item.id);
            setAllFiles(fileIds);
            setHtmlFiles(fileIds);

            // ÊòæÁ§∫ÁªüËÆ°‰ø°ÊÅØÔºàÂ¶ÇÊûúAPIÂèØÁî®Ôºâ
            try {
              const statsResponse = await fetch(
                `http://localhost:3000/api/workspaces/${workspace}/stats`
              );
              if (statsResponse.ok) {
                const stats = await statsResponse.json();
                console.log(`üìä Â∑•‰ΩúÁ©∫Èó¥ÁªüËÆ°:`, stats);
              }
            } catch (statsError) {
              // ÁªüËÆ°‰ø°ÊÅØËé∑ÂèñÂ§±Ë¥•‰∏çÂΩ±Âìç‰∏ªË¶ÅÂäüËÉΩ
            }
          } catch (error) {
            setError(error.message);
            console.error("Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:", error);
          } finally {
            setLoading(false);
          }
        };

        const handleWorkspaceChange = (workspace) => {
          setCurrentWorkspace(workspace);
          loadWorkspaceData(workspace);
          // ÈáçÁΩÆÁ≠õÈÄâÂô®
          setFilters({
            model: "",
            tag: "",
            question: "",
            dateRange: "",
          });
        };

        // Á≠õÈÄâÂäüËÉΩ
        const applyFilters = (data, filterOptions) => {
          return data.filter((fileId) => {
            const item = currentData[fileId];
            if (!item) return false;

            // Ê®°ÂûãÁ≠õÈÄâ
            if (filterOptions.model && item.model !== filterOptions.model) {
              return false;
            }

            // Ê†áÁ≠æÁ≠õÈÄâ
            if (
              filterOptions.tag &&
              (!item.tags || !item.tags.includes(filterOptions.tag))
            ) {
              return false;
            }

            // ÈóÆÈ¢òÂÖ≥ÈîÆËØçÁ≠õÈÄâ
            if (
              filterOptions.question &&
              !item.question
                .toLowerCase()
                .includes(filterOptions.question.toLowerCase())
            ) {
              return false;
            }

            // Êó•ÊúüËåÉÂõ¥Á≠õÈÄâ
            if (filterOptions.dateRange) {
              const itemDate = new Date(item.timestamp);
              const now = new Date();
              const diffTime = Math.abs(now - itemDate);
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

              switch (filterOptions.dateRange) {
                case "today":
                  if (diffDays > 1) return false;
                  break;
                case "week":
                  if (diffDays > 7) return false;
                  break;
                case "month":
                  if (diffDays > 30) return false;
                  break;
              }
            }

            return true;
          });
        };

        // Â§ÑÁêÜÁ≠õÈÄâÂô®ÂèòÂåñ
        const handleFilterChange = (key, value) => {
          const newFilters = { ...filters, [key]: value };
          setFilters(newFilters);

          // Â∫îÁî®Á≠õÈÄâ
          const filteredFiles = applyFilters(allFiles, newFilters);
          setHtmlFiles(filteredFiles);
        };

        // Ê∏ÖÈô§Á≠õÈÄâ
        const handleClearFilters = () => {
          const emptyFilters = {
            model: "",
            tag: "",
            question: "",
            dateRange: "",
          };
          setFilters(emptyFilters);
          setHtmlFiles(allFiles);
        };

        return (
          <div className="container">
            <h1>HTML Files Viewer - React Edition</h1>

            <WorkspaceSelector
              onWorkspaceChange={handleWorkspaceChange}
              workspaces={workspaces}
              loading={loading}
              error={error}
            />

            {currentWorkspace && Object.keys(currentData).length > 0 && (
              <FilterControls
                filters={filters}
                onFilterChange={handleFilterChange}
                onClearFilters={handleClearFilters}
                allData={currentData}
              />
            )}

            <GridContainer
              htmlFiles={htmlFiles}
              currentData={currentData}
              workspace={currentWorkspace}
              loading={loading}
              totalCount={allFiles.length}
            />
          </div>
        );
      };

      // Render the app
      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
