<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HTML Files Viewer - React Edition</title>

    <!-- React CDN -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- D3.js for graph visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        text-align: center;
        color: white;
        margin-bottom: 30px;
        font-size: 2.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .workspace-selector {
        text-align: center;
        margin-bottom: 30px;
      }

      select {
        padding: 12px 20px;
        font-size: 16px;
        border: none;
        border-radius: 25px;
        background: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      select:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }

      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        padding: 20px 0;
      }

      .html-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
      }

      .html-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      }

      .card-preview {
        width: 100%;
        height: 200px;
        border: none;
        background: #f8f9fa;
      }

      .card-info {
        padding: 12px;
      }

      .card-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }

      .card-btn {
        flex: 1;
        padding: 6px 12px;
        font-size: 0.8rem;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .card-btn.view {
        background: #4caf50;
        color: white;
      }

      .card-btn.fsm {
        background: #2196f3;
        color: white;
      }

      .card-btn.evaluation {
        background: #ff9800;
        color: white;
      }

      .card-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .card-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .card-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        word-break: break-all;
      }

      .card-model {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 5px;
      }

      .card-timestamp {
        font-size: 0.8rem;
        color: #999;
      }

      .card-messages {
        margin-top: 10px;
        font-size: 0.85rem;
      }

      .message-item {
        margin-bottom: 6px;
        padding: 4px 8px;
        border-radius: 4px;
      }

      .message-system {
        background: #e3f2fd;
        border-left: 3px solid #2196f3;
      }

      .message-user {
        background: #f3e5f5;
        border-left: 3px solid #9c27b0;
      }

      .message-role {
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        margin-bottom: 2px;
      }

      .message-content {
        font-size: 0.8rem;
        line-height: 1.3;
        word-break: break-word;
      }

      .loading {
        text-align: center;
        color: white;
        font-size: 1.1rem;
        margin-top: 30px;
      }

      .error {
        text-align: center;
        color: #ff6b6b;
        font-size: 1.1rem;
        margin-top: 30px;
        background: white;
        padding: 20px;
        border-radius: 10px;
      }

      .no-files {
        text-align: center;
        color: white;
        font-size: 1.2rem;
        margin-top: 50px;
      }

      .filters-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
      }

      .filters-title {
        color: white;
        font-size: 1.2rem;
        margin-bottom: 15px;
        text-align: center;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .filter-label {
        color: white;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .filter-select,
      .filter-input {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        background: white;
        font-size: 0.9rem;
        cursor: pointer;
      }

      .filter-input {
        cursor: text;
      }

      .filter-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
      }

      .filter-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        background: white;
        color: #333;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-btn:hover {
        background: #f0f0f0;
        transform: translateY(-1px);
      }

      .filter-btn.clear {
        background: #ff6b6b;
        color: white;
      }

      .filter-btn.clear:hover {
        background: #ff5252;
      }

      .results-count {
        color: white;
        text-align: center;
        margin-bottom: 10px;
        font-size: 0.9rem;
      }

      .filters-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
      }

      .filters-title {
        color: white;
        font-size: 1.2rem;
        margin-bottom: 15px;
        text-align: center;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .filter-label {
        color: white;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .filter-select,
      .filter-input {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        background: white;
        font-size: 0.9rem;
        cursor: pointer;
      }

      .filter-input {
        cursor: text;
      }

      .filter-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
      }

      .filter-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        background: white;
        color: #333;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-btn:hover {
        background: #f0f0f0;
        transform: translateY(-1px);
      }

      .filter-btn.clear {
        background: #ff6b6b;
        color: white;
      }

      .filter-btn.clear:hover {
        background: #ff5252;
      }

      .results-count {
        color: white;
        text-align: center;
        margin-bottom: 10px;
        font-size: 0.9rem;
      }

      /* FSM Visualizer Modal Styles */
      .fsm-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        display: none;
        overflow: auto;
      }

      .fsm-modal.show {
        display: block;
      }

      .fsm-modal-content {
        background: white;
        margin: 20px;
        border-radius: 15px;
        min-height: calc(100vh - 40px);
        position: relative;
      }

      .fsm-modal-header {
        padding: 20px;
        border-bottom: 2px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0;
      }

      .fsm-modal-title {
        font-size: 1.5rem;
        font-weight: 600;
      }

      .fsm-close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 1.8rem;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .fsm-close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .fsm-modal-body {
        padding: 20px;
      }

      .fsm-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .info-panel {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #4caf50;
      }

      .info-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        font-size: 1.1rem;
      }

      .info-content {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .graph-container {
        width: 100%;
        height: 600px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        background: #fafafa;
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
      }

      .state-node {
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .state-node:hover {
        filter: brightness(1.1);
      }

      .edge {
        fill: none;
        stroke: #666;
        stroke-width: 2;
        marker-end: url(#arrowhead);
        transition: all 0.3s ease;
      }

      .edge:hover {
        stroke: #4caf50;
        stroke-width: 3;
      }

      .legend {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        padding: 15px;
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 100;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .legend-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: #333;
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        font-size: 0.85rem;
      }

      .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 8px;
        border: 2px solid #333;
      }

      .screenshot-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        z-index: 3000;
        max-width: 80vw;
        max-height: 80vh;
        overflow: auto;
        display: none;
      }

      .screenshot-panel.show {
        display: block;
      }

      .screenshot-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .screenshot-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
      }

      .screenshot-content {
        padding: 20px;
      }

      .screenshot-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .screenshot-item {
        text-align: center;
      }

      .screenshot-img {
        width: 100%;
        max-width: 400px;
        border: 2px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .screenshot-img:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .screenshot-caption {
        margin-top: 10px;
        font-size: 0.9rem;
        color: #666;
        font-weight: 500;
      }

      /* Evaluation Modal Styles */
      .evaluation-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 3000;
        display: none;
        overflow: auto;
      }

      .evaluation-modal.show {
        display: block;
      }

      .evaluation-modal-content {
        background: white;
        margin: 40px auto;
        max-width: 800px;
        border-radius: 15px;
        max-height: calc(100vh - 80px);
        overflow-y: auto;
      }

      .evaluation-modal-header {
        padding: 20px;
        border-bottom: 2px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        color: white;
        border-radius: 15px 15px 0 0;
      }

      .evaluation-modal-title {
        font-size: 1.5rem;
        font-weight: 600;
      }

      .evaluation-close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 1.8rem;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .evaluation-close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .evaluation-modal-body {
        padding: 30px;
      }

      .evaluation-scores {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .score-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        border-left: 4px solid #ff9800;
      }

      .score-label {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 10px;
        font-weight: 500;
      }

      .score-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #ff9800;
        margin-bottom: 5px;
      }

      .score-max {
        font-size: 0.8rem;
        color: #999;
      }

      .evaluation-section {
        margin-bottom: 25px;
      }

      .evaluation-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        border-bottom: 2px solid #ff9800;
        padding-bottom: 5px;
      }

      .evaluation-analysis {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        line-height: 1.6;
        color: #333;
        white-space: pre-wrap;
      }

      .evaluation-list {
        list-style: none;
        padding: 0;
      }

      .evaluation-list li {
        padding: 8px 0;
        padding-left: 20px;
        position: relative;
        color: #333;
      }

      .evaluation-list.strengths li:before {
        content: "✓";
        color: #4caf50;
        font-weight: bold;
        position: absolute;
        left: 0;
      }

      .evaluation-list.weaknesses li:before {
        content: "⚠";
        color: #f44336;
        font-weight: bold;
        position: absolute;
        left: 0;
      }

      .evaluation-list.recommendations li:before {
        content: "💡";
        position: absolute;
        left: 0;
      }

      .evaluation-metadata {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        font-size: 0.9rem;
        color: #666;
      }

      .evaluation-screenshots {
        margin-top: 25px;
      }

      .screenshots-section {
        margin-bottom: 20px;
      }

      .screenshots-section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 2px solid #ff9800;
      }

      .screenshots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .screenshot-item {
        text-align: center;
      }

      .screenshot-img {
        width: 100%;
        max-width: 250px;
        border: 2px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .screenshot-img:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        border-color: #ff9800;
      }

      .screenshot-caption {
        margin-top: 8px;
        font-size: 0.85rem;
        color: #666;
        font-weight: 500;
      }

      .screenshot-category {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 4px;
      }

      .category-initial {
        background: #e8f5e8;
        color: #2e7d32;
      }

      .category-interaction {
        background: #e3f2fd;
        color: #1565c0;
      }

      .category-complete {
        background: #fff3e0;
        color: #ef6c00;
      }

      .evaluation-loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .evaluation-error {
        background: #ffebee;
        color: #c62828;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #f44336;
      }

      .evaluation-actions {
        text-align: center;
        margin-bottom: 20px;
      }

      .evaluation-btn {
        background: #ff9800;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .evaluation-btn:hover {
        background: #f57c00;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
      }

      .evaluation-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2999;
        display: none;
      }

      .overlay.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // FSM状态配色方案 - 按功能分类
      const STATE_COLORS = {
        // 开始状态 - 绿色系
        idle: "#4caf50",

        // 输入验证 - 橙色系
        validating_input: "#ff9800",
        validating_front_input: "#ff9800",
        validating_back_input: "#ffb74d",

        // 执行动作 - 蓝色系
        inserting_node: "#2196f3",
        adding_to_front: "#1976d2",
        adding_to_back: "#42a5f5",
        removing_from_front: "#ff5722",
        removing_from_back: "#ff7043",
        performing_front_removal: "#ff5722",
        performing_back_removal: "#ff7043",

        // 显示更新 - 紫色系
        drawing_tree: "#9c27b0",
        updating_display: "#ab47bc",
        clearing_input: "#ba68c8",

        // 错误处理 - 红色系
        error_alert: "#f44336",

        // 结束状态 - 灰色系
        tree_resetting: "#607d8b",
      };

      // 获取状态类型的函数
      const getStateCategory = (stateName) => {
        const name = stateName.toLowerCase();
        if (name.includes("idle") || name.includes("initial")) return "start";
        if (name.includes("validating") || name.includes("input"))
          return "input";
        if (
          name.includes("adding") ||
          name.includes("removing") ||
          name.includes("inserting") ||
          name.includes("performing")
        )
          return "action";
        if (
          name.includes("updating") ||
          name.includes("drawing") ||
          name.includes("display") ||
          name.includes("clearing")
        )
          return "display";
        if (name.includes("error") || name.includes("alert")) return "error";
        if (
          name.includes("resetting") ||
          name.includes("done") ||
          name.includes("complete")
        )
          return "end";
        return "action";
      };

      // 智能截图-状态匹配函数
      const isScreenshotForState = (screenshot, stateName) => {
        // 直接状态匹配
        if (screenshot.state === stateName) {
          return true;
        }

        const filename = screenshot.filename.toLowerCase();
        const state = stateName.toLowerCase();

        // 直接文件名匹配
        if (filename.includes(state)) {
          return true;
        }

        // 特殊状态映射规则
        const stateMapping = {
          idle: ["initial", "empty", "idle"],
          validating_front_input: ["validating", "front", "input"],
          validating_back_input: ["validating", "back", "input"],
          adding_to_front: ["add_front", "front", "unshift"],
          adding_to_back: ["add_back", "back", "push"],
          removing_from_front: ["remove_front", "front", "shift"],
          removing_from_back: ["remove_back", "back", "pop"],
          performing_front_removal: ["remove_front", "front", "shift"],
          performing_back_removal: ["remove_back", "back", "pop"],
          updating_display: ["complete", "update", "display"],
          clearing_input: ["clear", "input"],
          // 传统BST状态
          validating_input: ["validating", "input"],
          error_alert: ["error", "alert"],
          inserting_node: ["inserting", "node", "tree_node"],
          drawing_tree: ["drawing", "tree", "tree_with"],
          tree_resetting: ["resetting", "reset"],
        };

        const keywords = stateMapping[state] || [state];
        return keywords.some((keyword) => filename.includes(keyword));
      };

      // ScreenshotPanel Component
      const ScreenshotPanel = ({
        show,
        onClose,
        selectedState,
        screenshots,
      }) => {
        if (!show) return null;

        // 如果没有选择特定状态，显示所有截图
        let stateScreenshots = screenshots;

        if (selectedState) {
          // 使用同样的智能匹配函数
          stateScreenshots = screenshots.filter((imgItem) => {
            return isScreenshotForState(imgItem, selectedState);
          });
        }

        return (
          <>
            <div
              className={`overlay ${show ? "show" : ""}`}
              onClick={onClose}
            ></div>
            <div className={`screenshot-panel ${show ? "show" : ""}`}>
              <div className="screenshot-header">
                <div className="screenshot-title">
                  {selectedState ? `状态截图: ${selectedState}` : "所有截图"}
                </div>
                <button className="fsm-close-btn" onClick={onClose}>
                  ×
                </button>
              </div>
              <div className="screenshot-content">
                {stateScreenshots.length > 0 ? (
                  <div className="screenshot-grid">
                    {stateScreenshots.map((screenshot, index) => (
                      <div key={index} className="screenshot-item">
                        <img
                          src={`http://localhost:3000${screenshot.url}`}
                          alt={`${selectedState || "State"} screenshot ${
                            index + 1
                          }`}
                          className="screenshot-img"
                          onError={(e) => {
                            e.target.style.display = "none";
                          }}
                        />
                        <div className="screenshot-caption">
                          {screenshot.filename.replace(".png", "")}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div
                    style={{
                      textAlign: "center",
                      color: "#666",
                      padding: "40px",
                    }}
                  >
                    {selectedState
                      ? `暂无 ${selectedState} 状态的截图`
                      : "暂无截图"}
                  </div>
                )}
              </div>
            </div>
          </>
        );
      };

      // EvaluationModal Component
      const EvaluationModal = ({ show, onClose, fileId, workspace }) => {
        const [evaluation, setEvaluation] = useState(null);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);
        const [evaluating, setEvaluating] = useState(false);
        const [screenshots, setScreenshots] = useState([]);

        // 获取评估数据
        const fetchEvaluation = async () => {
          if (!fileId || !workspace) return;

          setLoading(true);
          setError(null);

          try {
            const response = await fetch(
              `http://localhost:3000/api/evaluation/${workspace}/${fileId}.html`
            );

            if (response.ok) {
              const data = await response.json();
              setEvaluation(data);
            } else if (response.status === 404) {
              setEvaluation(null);
            } else {
              throw new Error("Failed to fetch evaluation");
            }
          } catch (err) {
            setError("获取评估数据失败: " + err.message);
          } finally {
            setLoading(false);
          }
        };

        // 获取截图数据
        const fetchScreenshots = async () => {
          if (!fileId || !workspace) return;

          try {
            const response = await fetch(
              `http://localhost:3000/api/screenshots/${workspace}/${fileId}.html`
            );
            if (response.ok) {
              const screenshotData = await response.json();
              setScreenshots(screenshotData);
            }
          } catch (err) {
            console.warn("获取截图失败:", err.message);
            setScreenshots([]);
          }
        };

        // 执行新的评估
        const runEvaluation = async (e) => {
          e.preventDefault(); // 阻止默认行为
          e.stopPropagation(); // 阻止事件冒泡

          if (!fileId || !workspace) return;

          setEvaluating(true);
          setError(null);

          try {
            const response = await fetch(
              `http://localhost:3000/api/evaluation/${workspace}/${fileId}.html`,
              { method: "POST" }
            );

            if (response.ok) {
              const result = await response.json();
              setEvaluation(result.evaluation);
            } else {
              const errorData = await response.json();
              throw new Error(errorData.error || "Evaluation failed");
            }
          } catch (err) {
            setError("执行评估失败: " + err.message);
          } finally {
            setEvaluating(false);
          }
        };

        // 当模态框显示时获取评估数据和截图
        useEffect(() => {
          if (show && fileId && workspace) {
            fetchEvaluation();
            fetchScreenshots();
          }
        }, [show, fileId, workspace]);

        // 分类截图函数
        const categorizeScreenshots = (screenshots, usedScreenshots) => {
          if (!screenshots || screenshots.length === 0)
            return { initial: [], interaction: [], complete: [] };

          // 如果有评估数据，优先显示评估中使用的截图
          let targetScreenshots = screenshots;
          if (usedScreenshots && usedScreenshots.length > 0) {
            targetScreenshots = screenshots.filter((screenshot) =>
              usedScreenshots.includes(screenshot.filename)
            );
          }

          const categories = {
            initial: [],
            interaction: [],
            complete: [],
          };

          targetScreenshots.forEach((screenshot) => {
            const filename = screenshot.filename.toLowerCase();

            if (
              filename.includes("initial") ||
              filename.includes("idle") ||
              filename.includes("empty")
            ) {
              categories.initial.push(screenshot);
            } else if (
              filename.includes("complete") ||
              filename.includes("final") ||
              filename.includes("done")
            ) {
              categories.complete.push(screenshot);
            } else {
              categories.interaction.push(screenshot);
            }
          });

          return categories;
        };

        // 获取截图的完整URL
        const getScreenshotUrl = (screenshot) => {
          return `./workspace/${workspace}/visuals/${fileId}/${screenshot.filename}`;
        };

        if (!show) return null;

        return (
          <>
            <div
              className={`overlay ${show ? "show" : ""}`}
              onClick={onClose}
            ></div>
            <div className={`evaluation-modal ${show ? "show" : ""}`}>
              <div className="evaluation-modal-content">
                <div className="evaluation-modal-header">
                  <div className="evaluation-modal-title">
                    视觉评估报告 - {fileId}
                  </div>
                  <button className="evaluation-close-btn" onClick={onClose}>
                    ×
                  </button>
                </div>
                <div className="evaluation-modal-body">
                  {loading && (
                    <div className="evaluation-loading">
                      正在加载评估数据...
                    </div>
                  )}

                  {error && <div className="evaluation-error">{error}</div>}

                  {!loading && !evaluation && !error && (
                    <div className="evaluation-actions">
                      <p>还没有评估报告，点击下方按钮开始评估</p>
                      <button
                        className="evaluation-btn"
                        onClick={runEvaluation}
                        disabled={evaluating}
                      >
                        {evaluating ? "正在评估..." : "开始评估"}
                      </button>
                    </div>
                  )}

                  {evaluation && (
                    <>
                      <div className="evaluation-actions">
                        <button
                          className="evaluation-btn"
                          onClick={runEvaluation}
                          disabled={evaluating}
                        >
                          {evaluating ? "正在重新评估..." : "重新评估"}
                        </button>
                      </div>

                      <div className="evaluation-scores">
                        <div className="score-card">
                          <div className="score-label">总体评分</div>
                          <div className="score-value">
                            {evaluation.overall_score?.toFixed(1) || "N/A"}
                          </div>
                          <div className="score-max">/ 10.0</div>
                        </div>
                        <div className="score-card">
                          <div className="score-label">布局质量</div>
                          <div className="score-value">
                            {evaluation.layout_quality?.toFixed(1) || "N/A"}
                          </div>
                          <div className="score-max">/ 10.0</div>
                        </div>
                        <div className="score-card">
                          <div className="score-label">内容丰富度</div>
                          <div className="score-value">
                            {evaluation.content_richness?.toFixed(1) || "N/A"}
                          </div>
                          <div className="score-max">/ 10.0</div>
                        </div>
                        <div className="score-card">
                          <div className="score-label">交互逻辑</div>
                          <div className="score-value">
                            {evaluation.interaction_logic?.toFixed(1) || "N/A"}
                          </div>
                          <div className="score-max">/ 10.0</div>
                        </div>
                      </div>

                      {evaluation.analysis && (
                        <div className="evaluation-section">
                          <div className="evaluation-section-title">
                            详细分析
                          </div>
                          <div className="evaluation-analysis">
                            {evaluation.analysis}
                          </div>
                        </div>
                      )}

                      {evaluation.strengths &&
                        evaluation.strengths.length > 0 && (
                          <div className="evaluation-section">
                            <div className="evaluation-section-title">优点</div>
                            <ul className="evaluation-list strengths">
                              {evaluation.strengths.map((strength, index) => (
                                <li key={index}>{strength}</li>
                              ))}
                            </ul>
                          </div>
                        )}

                      {evaluation.weaknesses &&
                        evaluation.weaknesses.length > 0 && (
                          <div className="evaluation-section">
                            <div className="evaluation-section-title">
                              待改进之处
                            </div>
                            <ul className="evaluation-list weaknesses">
                              {evaluation.weaknesses.map((weakness, index) => (
                                <li key={index}>{weakness}</li>
                              ))}
                            </ul>
                          </div>
                        )}

                      {evaluation.recommendations &&
                        evaluation.recommendations.length > 0 && (
                          <div className="evaluation-section">
                            <div className="evaluation-section-title">
                              改进建议
                            </div>
                            <ul className="evaluation-list recommendations">
                              {evaluation.recommendations.map(
                                (recommendation, index) => (
                                  <li key={index}>{recommendation}</li>
                                )
                              )}
                            </ul>
                          </div>
                        )}

                      {evaluation.metadata && (
                        <div className="evaluation-metadata">
                          <strong>评估信息:</strong>
                          <br />
                          评估时间:{" "}
                          {new Date(
                            evaluation.metadata.evaluatedAt
                          ).toLocaleString("zh-CN")}
                          <br />
                          使用截图:{" "}
                          {evaluation.metadata.screenshotsUsed
                            ? evaluation.metadata.screenshotsUsed.join(", ")
                            : evaluation.metadata.screenshotUsed || "无"}
                          <br />
                          总截图数:{" "}
                          {evaluation.metadata.totalScreenshots ||
                            evaluation.metadata.screenshotCount}
                          <br />
                          应用标题: {evaluation.metadata.appTitle || "未知"}
                          <br />
                          包含FSM: {evaluation.metadata.hasFSM ? "是" : "否"}
                          <br />
                          交互元素:{" "}
                          {evaluation.metadata.interactionElements || 0} 个
                        </div>
                      )}

                      {/* 截图展示部分 */}
                      {screenshots.length > 0 && (
                        <div className="evaluation-section">
                          <div className="evaluation-section-title">
                            📸 评估截图
                          </div>
                          <div className="evaluation-screenshots">
                            {(() => {
                              const usedScreenshots =
                                evaluation?.metadata?.screenshotsUsed ||
                                (evaluation?.metadata?.screenshotUsed
                                  ? [evaluation.metadata.screenshotUsed]
                                  : []);
                              const categorized = categorizeScreenshots(
                                screenshots,
                                usedScreenshots
                              );

                              return (
                                <>
                                  {categorized.initial.length > 0 && (
                                    <div className="screenshots-section">
                                      <div className="screenshots-section-title">
                                        🚀 初始状态
                                      </div>
                                      <div className="screenshots-grid">
                                        {categorized.initial.map(
                                          (screenshot, index) => (
                                            <div
                                              key={index}
                                              className="screenshot-item"
                                            >
                                              <img
                                                src={getScreenshotUrl(
                                                  screenshot
                                                )}
                                                alt={screenshot.filename}
                                                className="screenshot-img"
                                                onClick={() =>
                                                  window.open(
                                                    getScreenshotUrl(
                                                      screenshot
                                                    ),
                                                    "_blank"
                                                  )
                                                }
                                              />
                                              <div className="screenshot-caption">
                                                {screenshot.filename}
                                              </div>
                                              <div className="screenshot-category category-initial">
                                                初始状态
                                              </div>
                                            </div>
                                          )
                                        )}
                                      </div>
                                    </div>
                                  )}

                                  {categorized.interaction.length > 0 && (
                                    <div className="screenshots-section">
                                      <div className="screenshots-section-title">
                                        🔄 交互过程
                                      </div>
                                      <div className="screenshots-grid">
                                        {categorized.interaction.map(
                                          (screenshot, index) => (
                                            <div
                                              key={index}
                                              className="screenshot-item"
                                            >
                                              <img
                                                src={getScreenshotUrl(
                                                  screenshot
                                                )}
                                                alt={screenshot.filename}
                                                className="screenshot-img"
                                                onClick={() =>
                                                  window.open(
                                                    getScreenshotUrl(
                                                      screenshot
                                                    ),
                                                    "_blank"
                                                  )
                                                }
                                              />
                                              <div className="screenshot-caption">
                                                {screenshot.filename}
                                              </div>
                                              <div className="screenshot-category category-interaction">
                                                交互过程
                                              </div>
                                            </div>
                                          )
                                        )}
                                      </div>
                                    </div>
                                  )}

                                  {categorized.complete.length > 0 && (
                                    <div className="screenshots-section">
                                      <div className="screenshots-section-title">
                                        ✅ 完成状态
                                      </div>
                                      <div className="screenshots-grid">
                                        {categorized.complete.map(
                                          (screenshot, index) => (
                                            <div
                                              key={index}
                                              className="screenshot-item"
                                            >
                                              <img
                                                src={getScreenshotUrl(
                                                  screenshot
                                                )}
                                                alt={screenshot.filename}
                                                className="screenshot-img"
                                                onClick={() =>
                                                  window.open(
                                                    getScreenshotUrl(
                                                      screenshot
                                                    ),
                                                    "_blank"
                                                  )
                                                }
                                              />
                                              <div className="screenshot-caption">
                                                {screenshot.filename}
                                              </div>
                                              <div className="screenshot-category category-complete">
                                                完成状态
                                              </div>
                                            </div>
                                          )
                                        )}
                                      </div>
                                    </div>
                                  )}

                                  {usedScreenshots.length > 0 && (
                                    <div
                                      style={{
                                        marginTop: "15px",
                                        padding: "10px",
                                        background: "#f0f8ff",
                                        borderRadius: "8px",
                                        fontSize: "0.9rem",
                                        color: "#666",
                                      }}
                                    >
                                      <strong>💡 提示:</strong>{" "}
                                      以上显示的是AI评估中实际使用的截图 (
                                      {usedScreenshots.length} 张)
                                    </div>
                                  )}
                                </>
                              );
                            })()}
                          </div>
                        </div>
                      )}
                    </>
                  )}
                </div>
              </div>
            </div>
          </>
        );
      };

      // FSMGraph Component
      const FSMGraph = ({ fsmData, screenshots, onStateClick }) => {
        const svgRef = useRef();
        const [graphData, setGraphData] = useState({ nodes: [], links: [] });

        useEffect(() => {
          if (!fsmData) return;

          // 构建图数据
          const nodes = fsmData.states.map((state) => ({
            id: state.name,
            name: state.name,
            onEnter: state.onEnter,
            color: STATE_COLORS[state.name] || "#666",
            hasScreenshots: screenshots.some((img) => {
              // 更智能的截图-状态匹配
              return isScreenshotForState(img, state.name);
            }),
          }));

          const links = [];
          fsmData.states.forEach((state) => {
            if (state.on) {
              Object.entries(state.on).forEach(([event, target]) => {
                links.push({
                  source: state.name,
                  target: target,
                  event: event,
                });
              });
            }
          });

          setGraphData({ nodes, links });
        }, [fsmData, screenshots]);

        useEffect(() => {
          if (!graphData.nodes.length) return;

          const svg = d3.select(svgRef.current);
          svg.selectAll("*").remove();

          const width = 1000;
          const height = 550;

          // 定义箭头标记
          svg
            .append("defs")
            .append("marker")
            .attr("id", "arrowhead")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 25)
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("fill", "#666");

          const simulation = d3
            .forceSimulation(graphData.nodes)
            .force(
              "link",
              d3
                .forceLink(graphData.links)
                .id((d) => d.id)
                .distance(150)
            )
            .force("charge", d3.forceManyBody().strength(-800))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(60))
            .alpha(0.1) // 降低初始能量，减少动画
            .alphaDecay(0.1) // 快速衰减
            .velocityDecay(0.9); // 增加阻尼

          // 智能布局节点位置 - 根据状态类型分组
          const layoutNodesByType = (nodes, width, height) => {
            // 根据状态名称分类
            const categories = {
              start: [], // 开始状态
              input: [], // 输入处理
              action: [], // 执行动作
              display: [], // 显示更新
              error: [], // 错误处理
              end: [], // 结束状态
            };

            nodes.forEach((node) => {
              const name = node.name.toLowerCase();
              if (name.includes("idle") || name.includes("initial")) {
                categories.start.push(node);
              } else if (
                name.includes("validating") ||
                name.includes("input")
              ) {
                categories.input.push(node);
              } else if (
                name.includes("adding") ||
                name.includes("removing") ||
                name.includes("inserting") ||
                name.includes("performing")
              ) {
                categories.action.push(node);
              } else if (
                name.includes("updating") ||
                name.includes("drawing") ||
                name.includes("display") ||
                name.includes("clearing")
              ) {
                categories.display.push(node);
              } else if (name.includes("error") || name.includes("alert")) {
                categories.error.push(node);
              } else if (
                name.includes("resetting") ||
                name.includes("done") ||
                name.includes("complete")
              ) {
                categories.end.push(node);
              } else {
                // 默认放入action分类
                categories.action.push(node);
              }
            });

            // 定义各分类的布局区域
            const layouts = {
              start: { x: width * 0.15, y: height * 0.5, spread: 80 },
              input: { x: width * 0.35, y: height * 0.25, spread: 100 },
              action: { x: width * 0.5, y: height * 0.5, spread: 140 },
              display: { x: width * 0.75, y: height * 0.65, spread: 100 },
              error: { x: width * 0.25, y: height * 0.8, spread: 80 },
              end: { x: width * 0.85, y: height * 0.4, spread: 80 },
            };

            // 为每个分类中的节点分配位置
            Object.keys(categories).forEach((category) => {
              const categoryNodes = categories[category];
              const layout = layouts[category];

              if (categoryNodes.length === 0) return;

              if (categoryNodes.length === 1) {
                // 单个节点放在中心，添加轻微随机偏移
                categoryNodes[0].x = layout.x + (Math.random() - 0.5) * 30;
                categoryNodes[0].y = layout.y + (Math.random() - 0.5) * 30;
              } else {
                // 多个节点按照优化的分布
                categoryNodes.forEach((node, i) => {
                  if (categoryNodes.length === 2) {
                    // 两个节点水平或垂直排列
                    const isVertical =
                      category === "input" || category === "display";
                    if (isVertical) {
                      node.x = layout.x + (Math.random() - 0.5) * 40;
                      node.y = layout.y + (i - 0.5) * 60;
                    } else {
                      node.x = layout.x + (i - 0.5) * 80;
                      node.y = layout.y + (Math.random() - 0.5) * 40;
                    }
                  } else if (categoryNodes.length === 3) {
                    // 三个节点三角形排列
                    const angles = [0, (2 * Math.PI) / 3, (4 * Math.PI) / 3];
                    const radius = 50;
                    node.x = layout.x + Math.cos(angles[i]) * radius;
                    node.y = layout.y + Math.sin(angles[i]) * radius;
                  } else {
                    // 多个节点小圆形排列，添加随机偏移
                    const angle = (i / categoryNodes.length) * 2 * Math.PI;
                    const radius =
                      layout.spread / 3 + (Math.random() - 0.5) * 20;
                    node.x = layout.x + Math.cos(angle) * radius;
                    node.y = layout.y + Math.sin(angle) * radius;
                  }
                });
              }
            });
          };

          // 应用智能布局
          layoutNodesByType(graphData.nodes, width, height);

          // 添加分组背景区域
          const addGroupBackgrounds = () => {
            const groupAreas = [
              {
                name: "开始",
                x: width * 0.05,
                y: height * 0.35,
                w: width * 0.2,
                h: height * 0.3,
                color: "#4caf50",
                opacity: 0.1,
              },
              {
                name: "输入验证",
                x: width * 0.25,
                y: height * 0.1,
                w: width * 0.2,
                h: height * 0.3,
                color: "#ff9800",
                opacity: 0.1,
              },
              {
                name: "执行动作",
                x: width * 0.4,
                y: height * 0.3,
                w: width * 0.2,
                h: height * 0.4,
                color: "#2196f3",
                opacity: 0.1,
              },
              {
                name: "显示更新",
                x: width * 0.65,
                y: height * 0.45,
                w: width * 0.2,
                h: height * 0.3,
                color: "#9c27b0",
                opacity: 0.1,
              },
              {
                name: "错误处理",
                x: width * 0.15,
                y: height * 0.65,
                w: width * 0.2,
                h: height * 0.25,
                color: "#f44336",
                opacity: 0.1,
              },
              {
                name: "结束状态",
                x: width * 0.75,
                y: height * 0.25,
                w: width * 0.2,
                h: height * 0.3,
                color: "#607d8b",
                opacity: 0.1,
              },
            ];

            // 添加背景矩形
            svg
              .append("g")
              .attr("class", "group-backgrounds")
              .selectAll("rect")
              .data(groupAreas)
              .enter()
              .append("rect")
              .attr("x", (d) => d.x)
              .attr("y", (d) => d.y)
              .attr("width", (d) => d.w)
              .attr("height", (d) => d.h)
              .attr("fill", (d) => d.color)
              .attr("opacity", (d) => d.opacity)
              .attr("rx", 15)
              .attr("ry", 15)
              .attr("stroke", (d) => d.color)
              .attr("stroke-width", 1)
              .attr("stroke-opacity", 0.3);

            // 添加分组标签
            svg
              .append("g")
              .attr("class", "group-labels")
              .selectAll("text")
              .data(groupAreas)
              .enter()
              .append("text")
              .attr("x", (d) => d.x + 10)
              .attr("y", (d) => d.y + 20)
              .attr("font-size", "11px")
              .attr("font-weight", "bold")
              .attr("fill", (d) => d.color)
              .attr("opacity", 0.7)
              .text((d) => d.name);
          };

          addGroupBackgrounds();

          // 立即停止模拟以固定位置
          simulation.stop();

          // 创建连线
          const link = svg
            .append("g")
            .selectAll("path")
            .data(graphData.links)
            .join("path")
            .attr("class", "edge")
            .attr("stroke", "#666")
            .attr("stroke-width", 2)
            .attr("fill", "none")
            .attr("marker-end", "url(#arrowhead)");

          // 创建连线标签
          const linkLabel = svg
            .append("g")
            .selectAll("text")
            .data(graphData.links)
            .join("text")
            .attr("font-size", "10px")
            .attr("text-anchor", "middle")
            .attr("fill", "#333")
            .text((d) => d.event);

          // 创建节点
          const node = svg
            .append("g")
            .selectAll("g")
            .data(graphData.nodes)
            .join("g")
            .attr("class", "state-node")
            .style("cursor", "pointer");

          // 节点圆圈
          node
            .append("circle")
            .attr("r", (d) => (d.hasScreenshots ? 35 : 30))
            .attr("fill", (d) => d.color)
            .attr("stroke", (d) => (d.hasScreenshots ? "#fff" : "none"))
            .attr("stroke-width", (d) => (d.hasScreenshots ? 3 : 0))
            .attr("opacity", 0.9);

          // 截图指示器
          node
            .filter((d) => d.hasScreenshots)
            .append("circle")
            .attr("r", 8)
            .attr("cx", 25)
            .attr("cy", -25)
            .attr("fill", "#ff6b6b")
            .attr("stroke", "#fff")
            .attr("stroke-width", 2);

          node
            .filter((d) => d.hasScreenshots)
            .append("text")
            .attr("x", 25)
            .attr("y", -25)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "central")
            .attr("fill", "white")
            .attr("font-size", "10px")
            .attr("font-weight", "bold")
            .text("📷");

          // 节点标签
          node
            .append("text")
            .attr("font-size", "11px")
            .attr("font-weight", "600")
            .attr("fill", "white")
            .attr("text-anchor", "middle")
            .text((d) => d.name);

          // 节点交互
          node.on("click", (event, d) => {
            // 重置所有节点样式
            node
              .select("circle")
              .attr("stroke-width", (d) => (d.hasScreenshots ? 3 : 0));

            // 高亮当前节点
            d3.select(event.currentTarget)
              .select("circle")
              .attr("stroke", "#ff6b6b")
              .attr("stroke-width", 5);

            onStateClick(d.name);
          });

          // 立即更新位置函数
          const updatePositions = () => {
            link.attr("d", (d) => {
              const dx = d.target.x - d.source.x;
              const dy = d.target.y - d.source.y;
              const dr = Math.sqrt(dx * dx + dy * dy);

              // 计算圆圈边缘的点
              const sourceX = d.source.x + (dx * 35) / dr;
              const sourceY = d.source.y + (dy * 35) / dr;
              const targetX = d.target.x - (dx * 35) / dr;
              const targetY = d.target.y - (dy * 35) / dr;

              return `M${sourceX},${sourceY}L${targetX},${targetY}`;
            });

            linkLabel
              .attr("x", (d) => (d.source.x + d.target.x) / 2)
              .attr("y", (d) => (d.source.y + d.target.y) / 2);

            node.attr("transform", (d) => `translate(${d.x},${d.y})`);
          };

          // 拖拽功能（优化为静态模式）
          const drag = d3
            .drag()
            .on("start", (event, d) => {
              // 仅在拖拽时启动微弱的模拟
              simulation.alpha(0.1).restart();
              d.fx = d.x;
              d.fy = d.y;
            })
            .on("drag", (event, d) => {
              d.fx = event.x;
              d.fy = event.y;
              // 立即更新位置
              updatePositions();
            })
            .on("end", (event, d) => {
              // 停止模拟并释放固定位置
              simulation.alpha(0);
              d.fx = null;
              d.fy = null;
            });

          node.call(drag);

          // 立即更新位置，无动画
          updatePositions();

          // 只在拖拽时使用tick更新
          simulation.on("tick", updatePositions);
        }, [graphData, onStateClick]);

        return (
          <div className="graph-container">
            <svg ref={svgRef} width="100%" height="100%"></svg>
            <div className="legend">
              <div className="legend-title">状态分类布局</div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{ backgroundColor: "#4caf50" }}
                ></div>
                <span>开始状态 (左侧)</span>
              </div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{ backgroundColor: "#ff9800" }}
                ></div>
                <span>输入验证 (左上)</span>
              </div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{ backgroundColor: "#2196f3" }}
                ></div>
                <span>执行动作 (中心)</span>
              </div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{ backgroundColor: "#9c27b0" }}
                ></div>
                <span>显示更新 (右下)</span>
              </div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{ backgroundColor: "#f44336" }}
                ></div>
                <span>错误处理 (左下)</span>
              </div>
              <div className="legend-item">
                <div
                  className="legend-color"
                  style={{ backgroundColor: "#607d8b" }}
                ></div>
                <span>结束状态 (右侧)</span>
              </div>
              <div
                className="legend-item"
                style={{ marginTop: "10px", fontSize: "11px" }}
              >
                <span>📷 = 有截图可查看</span>
              </div>
              <div
                className="legend-item"
                style={{ fontSize: "10px", color: "#666" }}
              >
                <span>拖拽节点可调整位置</span>
              </div>
            </div>
          </div>
        );
      };

      // FSMVisualizerModal Component
      const FSMVisualizerModal = ({ show, onClose, fileId, workspace }) => {
        const [fsmData, setFsmData] = useState(null);
        const [screenshots, setScreenshots] = useState([]);
        const [selectedState, setSelectedState] = useState("");
        const [showScreenshots, setShowScreenshots] = useState(false);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");

        useEffect(() => {
          if (show && fileId && workspace) {
            loadFSMData();
          }
        }, [show, fileId, workspace]);

        const loadFSMData = async () => {
          setLoading(true);
          setError("");

          try {
            // 加载FSM数据
            const fsmResponse = await fetch(
              `http://localhost:3000/api/fsm-data/${workspace}/${fileId}.html`
            );
            if (fsmResponse.ok) {
              const fsm = await fsmResponse.json();
              setFsmData(fsm);
            } else {
              throw new Error("无法加载FSM数据");
            }

            // 加载截图
            const screenshotResponse = await fetch(
              `http://localhost:3000/api/screenshots/${workspace}/${fileId}.html`
            );
            if (screenshotResponse.ok) {
              const screenshots = await screenshotResponse.json();
              setScreenshots(screenshots);
            }
          } catch (error) {
            setError(error.message);
            console.error("加载FSM数据失败:", error);
          } finally {
            setLoading(false);
          }
        };

        const handleStateClick = (stateName) => {
          setSelectedState(stateName);
          setShowScreenshots(true);
        };

        const closeScreenshots = () => {
          setShowScreenshots(false);
          setSelectedState("");
        };

        if (!show) return null;

        return (
          <div className="fsm-modal show">
            <div className="fsm-modal-content">
              <div className="fsm-modal-header">
                <div className="fsm-modal-title">
                  🔄 FSM State Machine: {fileId}
                </div>
                <button className="fsm-close-btn" onClick={onClose}>
                  ×
                </button>
              </div>

              <div className="fsm-modal-body">
                {error && (
                  <div className="error" style={{ marginBottom: "20px" }}>
                    {error}
                  </div>
                )}

                {loading && (
                  <div
                    className="loading"
                    style={{ textAlign: "center", padding: "40px" }}
                  >
                    加载中...
                  </div>
                )}

                {fsmData && (
                  <>
                    <div className="fsm-info">
                      <div className="info-panel">
                        <div className="info-title">📋 FSM 信息</div>
                        <div className="info-content">
                          <strong>主题:</strong> {fsmData.topic}
                          <br />
                          <strong>状态数:</strong> {fsmData.states?.length || 0}
                          <br />
                          <strong>事件数:</strong> {fsmData.events?.length || 0}
                          <br />
                          <strong>截图数:</strong> {screenshots.length}
                        </div>
                      </div>
                      <div className="info-panel">
                        <div className="info-title">💡 操作说明</div>
                        <div className="info-content">
                          • 点击状态节点查看对应截图
                          <br />
                          • 拖拽节点调整布局
                          <br />
                          • 箭头表示状态转换
                          <br />• 📷 表示该状态有截图
                        </div>
                      </div>
                    </div>

                    <FSMGraph
                      fsmData={fsmData}
                      screenshots={screenshots}
                      onStateClick={handleStateClick}
                    />

                    {screenshots.length > 0 && (
                      <div style={{ textAlign: "center", marginTop: "20px" }}>
                        <button
                          className="card-btn view"
                          onClick={() => setShowScreenshots(true)}
                          style={{ padding: "10px 20px", fontSize: "1rem" }}
                        >
                          查看所有截图 ({screenshots.length})
                        </button>
                      </div>
                    )}
                  </>
                )}
              </div>
            </div>

            <ScreenshotPanel
              show={showScreenshots}
              onClose={closeScreenshots}
              selectedState={selectedState}
              screenshots={screenshots}
            />
          </div>
        );
      };

      // FilterControls Component
      const FilterControls = ({
        filters,
        onFilterChange,
        onClearFilters,
        allData,
      }) => {
        // 获取所有可用的模型
        const availableModels = [
          ...new Set(Object.values(allData).map((item) => item.model)),
        ].sort();

        // 获取所有可用的标签
        const availableTags = [
          ...new Set(Object.values(allData).flatMap((item) => item.tags || [])),
        ].sort();

        return (
          <div className="filters-container">
            <div className="filters-title">🔍 筛选器</div>

            <div className="filters-grid">
              <div className="filter-group">
                <div className="filter-label">模型</div>
                <select
                  className="filter-select"
                  value={filters.model}
                  onChange={(e) => onFilterChange("model", e.target.value)}
                >
                  <option value="">所有模型</option>
                  {availableModels.map((model) => (
                    <option key={model} value={model}>
                      {model}
                    </option>
                  ))}
                </select>
              </div>

              <div className="filter-group">
                <div className="filter-label">标签</div>
                <select
                  className="filter-select"
                  value={filters.tag}
                  onChange={(e) => onFilterChange("tag", e.target.value)}
                >
                  <option value="">所有标签</option>
                  {availableTags.map((tag) => (
                    <option key={tag} value={tag}>
                      {tag}
                    </option>
                  ))}
                </select>
              </div>

              <div className="filter-group">
                <div className="filter-label">问题关键词</div>
                <input
                  type="text"
                  className="filter-input"
                  placeholder="输入关键词..."
                  value={filters.question}
                  onChange={(e) => onFilterChange("question", e.target.value)}
                />
              </div>

              <div className="filter-group">
                <div className="filter-label">日期范围</div>
                <select
                  className="filter-select"
                  value={filters.dateRange}
                  onChange={(e) => onFilterChange("dateRange", e.target.value)}
                >
                  <option value="">所有时间</option>
                  <option value="today">今天</option>
                  <option value="week">近一周</option>
                  <option value="month">近一月</option>
                </select>
              </div>
            </div>

            <div className="filter-buttons">
              <button className="filter-btn clear" onClick={onClearFilters}>
                清除筛选
              </button>
            </div>
          </div>
        );
      };

      // WorkspaceSelector Component
      const WorkspaceSelector = ({
        onWorkspaceChange,
        workspaces,
        loading,
        error,
      }) => {
        return (
          <div className="workspace-selector">
            <select
              onChange={(e) => onWorkspaceChange(e.target.value)}
              disabled={loading}
            >
              <option value="">选择工作空间...</option>
              {workspaces.map((workspace) => (
                <option
                  key={workspace.name}
                  value={workspace.name}
                  disabled={!workspace.hasData}
                >
                  {workspace.name}
                  {workspace.hasData ? "" : " (数据不完整)"}
                </option>
              ))}
            </select>
            {error && (
              <div className="error" style={{ marginTop: "10px" }}>
                {error}
              </div>
            )}
          </div>
        );
      };

      // Message Component
      const Message = ({ message }) => {
        const roleClass = `message-${message.role}`;
        const roleText =
          message.role === "system"
            ? "系统"
            : message.role === "user"
            ? "用户"
            : message.role;

        return (
          <div className={`message-item ${roleClass}`}>
            <div className="message-role">{roleText}</div>
            <div className="message-content">{message.content}</div>
          </div>
        );
      };

      // HtmlCard Component
      const HtmlCard = ({
        data,
        workspace,
        fileId,
        onFSMClick,
        onEvaluationClick,
      }) => {
        const handleViewClick = () => {
          window.open(`./workspace/${workspace}/html/${fileId}.html`, "_blank");
        };

        const handleFSMClick = (e) => {
          e.stopPropagation();
          onFSMClick(fileId);
        };

        const handleEvaluationClick = (e) => {
          e.stopPropagation();
          onEvaluationClick(fileId);
        };

        return (
          <div className="html-card">
            <iframe
              className="card-preview"
              src={`./workspace/${workspace}/html/${fileId}.html`}
              scrolling="no"
              title={`Preview of ${fileId}`}
            />
            <div className="card-info">
              <div className="card-buttons">
                <button className="card-btn view" onClick={handleViewClick}>
                  查看页面
                </button>
                <button className="card-btn fsm" onClick={handleFSMClick}>
                  FSM 可视化
                </button>
                <button
                  className="card-btn evaluation"
                  onClick={handleEvaluationClick}
                >
                  视觉评估
                </button>
              </div>
              <div className="card-title">{fileId}</div>
              <div className="card-model">模型: {data.model}</div>
              <div className="card-timestamp">
                {new Date(data.timestamp).toLocaleString("zh-CN")}
              </div>
              {data.messages && data.messages.length > 0 && (
                <div className="card-messages">
                  {data.messages.map((message, index) => (
                    <Message key={index} message={message} />
                  ))}
                </div>
              )}
            </div>
          </div>
        );
      };

      // GridContainer Component
      const GridContainer = ({
        htmlFiles,
        currentData,
        workspace,
        loading,
        totalCount,
        onFSMClick,
        onEvaluationClick,
      }) => {
        if (loading) {
          return <div className="loading">加载中...</div>;
        }

        if (htmlFiles.length === 0 && totalCount > 0) {
          return <div className="no-files">没有符合筛选条件的文件</div>;
        }

        if (htmlFiles.length === 0) {
          return <div className="no-files">当前工作空间没有HTML文件</div>;
        }

        const filteredCount = htmlFiles.filter(
          (fileId) => currentData[fileId]
        ).length;

        return (
          <>
            {totalCount > 0 && (
              <div className="results-count">
                显示 {filteredCount} / {totalCount} 个文件
              </div>
            )}
            <div className="grid-container">
              {htmlFiles.map((fileId) => {
                const data = currentData[fileId];
                if (!data) return null;

                return (
                  <HtmlCard
                    key={fileId}
                    data={data}
                    workspace={workspace}
                    fileId={fileId}
                    onFSMClick={onFSMClick}
                    onEvaluationClick={onEvaluationClick}
                  />
                );
              })}
            </div>
          </>
        );
      };

      // Main App Component
      const App = () => {
        const [workspaces, setWorkspaces] = useState([]);
        const [currentWorkspace, setCurrentWorkspace] = useState("");
        const [currentData, setCurrentData] = useState({});
        const [htmlFiles, setHtmlFiles] = useState([]);
        const [allFiles, setAllFiles] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");
        const [filters, setFilters] = useState({
          model: "",
          tag: "",
          question: "",
          dateRange: "",
        });

        // FSM相关状态
        const [showFSMModal, setShowFSMModal] = useState(false);
        const [currentFSMFile, setCurrentFSMFile] = useState("");

        // 评估相关状态
        const [showEvaluationModal, setShowEvaluationModal] = useState(false);
        const [currentEvaluationFile, setCurrentEvaluationFile] = useState("");

        // Load workspaces on mount
        useEffect(() => {
          loadWorkspaces();
        }, []);

        const loadWorkspaces = async () => {
          try {
            // 尝试从API获取工作空间列表
            const response = await fetch(
              "http://localhost:3000/api/workspaces"
            );
            if (!response.ok) {
              throw new Error("API服务器未启动或无法访问");
            }

            const workspaceData = await response.json();
            setWorkspaces(workspaceData);
            console.log(`✅ 成功加载 ${workspaceData.length} 个工作空间`);
          } catch (apiError) {
            console.warn("API不可用，使用备用方案:", apiError.message);

            // 备用方案：手动添加已知工作空间
            const fallbackWorkspaces = [
              { name: "10-04", hasData: true },
              { name: "test", hasData: true },
            ];
            setWorkspaces(fallbackWorkspaces);

            setError(
              "API服务器未启动，使用离线模式。请运行 'node api.mjs' 启动服务器以获得完整功能。"
            );
          }
        };

        const loadWorkspaceData = async (workspace) => {
          if (!workspace) {
            setHtmlFiles([]);
            setCurrentData({});
            return;
          }

          setLoading(true);
          setError("");

          try {
            // 首先尝试从API获取数据
            let data;
            try {
              const apiResponse = await fetch(
                `http://localhost:3000/api/workspaces/${workspace}/data`
              );
              if (apiResponse.ok) {
                data = await apiResponse.json();
                console.log(`✅ 从API加载工作空间 ${workspace} 的数据`);
              } else {
                throw new Error("API响应失败");
              }
            } catch (apiError) {
              console.warn("API不可用，使用直接访问:", apiError.message);
              // 备用方案：直接访问文件
              const dataResponse = await fetch(
                `./workspace/${workspace}/data/data.json`
              );
              if (!dataResponse.ok) {
                throw new Error(`无法加载 ${workspace} 的数据文件`);
              }
              data = await dataResponse.json();
            }

            const newCurrentData = {};
            // 将数据按ID索引
            data.forEach((item) => {
              newCurrentData[item.id] = item;
            });

            setCurrentData(newCurrentData);
            // 获取HTML文件列表（根据数据推断）
            const fileIds = data.map((item) => item.id);
            setAllFiles(fileIds);
            setHtmlFiles(fileIds);

            // 显示统计信息（如果API可用）
            try {
              const statsResponse = await fetch(
                `http://localhost:3000/api/workspaces/${workspace}/stats`
              );
              if (statsResponse.ok) {
                const stats = await statsResponse.json();
                console.log(`📊 工作空间统计:`, stats);
              }
            } catch (statsError) {
              // 统计信息获取失败不影响主要功能
            }
          } catch (error) {
            setError(error.message);
            console.error("加载数据失败:", error);
          } finally {
            setLoading(false);
          }
        };

        const handleWorkspaceChange = (workspace) => {
          setCurrentWorkspace(workspace);
          loadWorkspaceData(workspace);
          // 重置筛选器
          setFilters({
            model: "",
            tag: "",
            question: "",
            dateRange: "",
          });
        };

        // 筛选功能
        const applyFilters = (data, filterOptions) => {
          return data.filter((fileId) => {
            const item = currentData[fileId];
            if (!item) return false;

            // 模型筛选
            if (filterOptions.model && item.model !== filterOptions.model) {
              return false;
            }

            // 标签筛选
            if (
              filterOptions.tag &&
              (!item.tags || !item.tags.includes(filterOptions.tag))
            ) {
              return false;
            }

            // 问题关键词筛选
            if (
              filterOptions.question &&
              !item.question
                .toLowerCase()
                .includes(filterOptions.question.toLowerCase())
            ) {
              return false;
            }

            // 日期范围筛选
            if (filterOptions.dateRange) {
              const itemDate = new Date(item.timestamp);
              const now = new Date();
              const diffTime = Math.abs(now - itemDate);
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

              switch (filterOptions.dateRange) {
                case "today":
                  if (diffDays > 1) return false;
                  break;
                case "week":
                  if (diffDays > 7) return false;
                  break;
                case "month":
                  if (diffDays > 30) return false;
                  break;
              }
            }

            return true;
          });
        };

        // 处理筛选器变化
        const handleFilterChange = (key, value) => {
          const newFilters = { ...filters, [key]: value };
          setFilters(newFilters);

          // 应用筛选
          const filteredFiles = applyFilters(allFiles, newFilters);
          setHtmlFiles(filteredFiles);
        };

        // 清除筛选
        const handleClearFilters = () => {
          const emptyFilters = {
            model: "",
            tag: "",
            question: "",
            dateRange: "",
          };
          setFilters(emptyFilters);
          setHtmlFiles(allFiles);
        };

        // FSM相关处理函数
        const handleFSMClick = (fileId) => {
          setCurrentFSMFile(fileId);
          setShowFSMModal(true);
        };

        const closeFSMModal = () => {
          setShowFSMModal(false);
          setCurrentFSMFile("");
        };

        // 评估相关处理函数
        const handleEvaluationClick = (fileId) => {
          setCurrentEvaluationFile(fileId);
          setShowEvaluationModal(true);
        };

        const closeEvaluationModal = () => {
          setShowEvaluationModal(false);
          setCurrentEvaluationFile("");
        };

        return (
          <div className="container">
            <h1>HTML Files Viewer - React Edition</h1>

            <WorkspaceSelector
              onWorkspaceChange={handleWorkspaceChange}
              workspaces={workspaces}
              loading={loading}
              error={error}
            />

            {currentWorkspace && Object.keys(currentData).length > 0 && (
              <FilterControls
                filters={filters}
                onFilterChange={handleFilterChange}
                onClearFilters={handleClearFilters}
                allData={currentData}
              />
            )}

            <GridContainer
              htmlFiles={htmlFiles}
              currentData={currentData}
              workspace={currentWorkspace}
              loading={loading}
              totalCount={allFiles.length}
              onFSMClick={handleFSMClick}
              onEvaluationClick={handleEvaluationClick}
            />

            <FSMVisualizerModal
              show={showFSMModal}
              onClose={closeFSMModal}
              fileId={currentFSMFile}
              workspace={currentWorkspace}
            />

            <EvaluationModal
              show={showEvaluationModal}
              onClose={closeEvaluationModal}
              fileId={currentEvaluationFile}
              workspace={currentWorkspace}
            />
          </div>
        );
      };

      // Render the app
      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
