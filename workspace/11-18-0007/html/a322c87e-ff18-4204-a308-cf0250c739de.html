<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubble Sort Visualization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #arrayDisplay {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 200px;
            margin: 20px;
        }
        .bar {
            width: 20px;
            margin: 0 5px;
            background-color: #4CAF50;
            transition: background-color 0.5s, transform 0.5s;
        }
        .highlight {
            background-color: yellow;
        }
        .sorted {
            background-color: green;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #status {
            margin: 10px 0;
        }
        #error {
            color: red;
        }
    </style>
</head>
<body data-state="idle">

    <h1>Bubble Sort Visualization</h1>
    <div id="arrayDisplay" data-testid="data-testid-array"></div>
    <input type="text" id="inputField" data-testid="data-testid-input" aria-label="Input array values" placeholder="Enter numbers separated by commas">
    <button id="startButton" data-testid="data-testid-start" data-action="START" aria-label="Start sorting">Start</button>
    <button id="pauseButton" data-testid="data-testid-pause" data-action="PAUSE" aria-label="Pause sorting" disabled>Pause</button>
    <button id="resetButton" data-testid="data-testid-reset" data-action="RESET" aria-label="Reset sorting" disabled>Reset</button>
    <div id="status" role="status">Ready to start</div>
    <div id="error"></div>

    <script>
        window.appState = { current: 'idle', array: [5, 3, 8, 4, 2], index: 0, sorted: false };
        
        function renderArray() {
            const arrayDisplay = document.getElementById('arrayDisplay');
            arrayDisplay.innerHTML = '';
            window.appState.array.forEach((value, idx) => {
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${value * 2}px`;
                if (window.appState.sorted) {
                    bar.classList.add('sorted');
                } else if (idx === window.appState.index || idx === window.appState.index + 1) {
                    bar.classList.add('highlight');
                }
                arrayDisplay.appendChild(bar);
            });
        }

        function updateUI() {
            const startButton = document.getElementById('startButton');
            const pauseButton = document.getElementById('pauseButton');
            const resetButton = document.getElementById('resetButton');
            const inputField = document.getElementById('inputField');
            const status = document.getElementById('status');

            switch (window.appState.current) {
                case 'idle':
                    startButton.disabled = false;
                    pauseButton.disabled = true;
                    resetButton.disabled = true;
                    inputField.disabled = false;
                    status.textContent = 'Ready to start';
                    break;
                case 'running':
                    startButton.disabled = true;
                    pauseButton.disabled = false;
                    resetButton.disabled = false;
                    inputField.disabled = true;
                    status.textContent = 'Sorting in progress';
                    break;
                case 'paused':
                    startButton.disabled = false;
                    pauseButton.disabled = true;
                    resetButton.disabled = false;
                    inputField.disabled = true;
                    status.textContent = 'Paused';
                    break;
                case 'completed':
                    startButton.disabled = true;
                    pauseButton.disabled = true;
                    resetButton.disabled = false;
                    inputField.disabled = false;
                    status.textContent = 'Sorting complete';
                    break;
            }
        }

        function validateInput(input) {
            const values = input.split(',').map(Number);
            if (values.length === 0) {
                return 'Input cannot be empty';
            }
            if (values.some(isNaN) || values.some(value => value < 0 || value > 100)) {
                return 'Input must be integers between 0 and 100';
            }
            if (values.length > 20) {
                return 'Input exceeds maximum size of 20';
            }
            return null;
        }

        function setState(newState) {
            window.appState.current = newState;
            document.body.setAttribute('data-state', newState);
            window.dispatchEvent(new CustomEvent('statechange', { detail: window.appState }));
            updateUI();
        }

        function getState() {
            return window.appState.current;
        }

        function reset() {
            window.appState = { current: 'idle', array: [5, 3, 8, 4, 2], index: 0, sorted: false };
            renderArray();
            setState('idle');
        }

        function bubbleSortStep() {
            if (window.appState.index >= window.appState.array.length - 1) {
                window.appState.index = 0;
                window.appState.sorted = true;
                setState('completed');
                return;
            }
            const array = window.appState.array;
            if (array[window.appState.index] > array[window.appState.index + 1]) {
                [array[window.appState.index], array[window.appState.index + 1]] = [array[window.appState.index + 1], array[window.appState.index]];
            }
            window.appState.index++;
            renderArray();
            if (!window.appState.sorted) {
                setTimeout(bubbleSortStep, 500);
            }
        }

        document.getElementById('startButton').addEventListener('click', () => {
            const error = validateInput(document.getElementById('inputField').value);
            if (error) {
                document.getElementById('error').textContent = error;
                return;
            }
            document.getElementById('error').textContent = '';
            window.appState.array = document.getElementById('inputField').value.split(',').map(Number);
            window.appState.index = 0;
            window.appState.sorted = false;
            setState('running');
            bubbleSortStep();
        });

        document.getElementById('pauseButton').addEventListener('click', () => {
            setState('paused');
        });

        document.getElementById('resetButton').addEventListener('click', () => {
            reset();
        });

        document.getElementById('inputField').addEventListener('input', () => {
            const error = validateInput(document.getElementById('inputField').value);
            if (error) {
                document.getElementById('error').textContent = error;
                return;
            }
            document.getElementById('error').textContent = '';
            window.appState.array = document.getElementById('inputField').value.split(',').map(Number);
            renderArray();
            setState('idle');
        });

        window.getState = getState;
        window.setState = setState;
        window.reset = reset;

        renderArray();
        updateUI();
    </script>
</body>
</html>