{
  "topic": "Recursion Explorer Interaction",
  "description": "Models the interactive control and playback lifecycle of the Recursion Explorer app: preparing simulations (factorial/fibonacci), stepping through generated call/return events, auto-playing the animation, pausing, resetting, and UI option toggles.",
  "states": [
    {
      "name": "prepared",
      "onEnter": "prepareSimulation",
      "onExit": null,
      "on": {
        "RUN": "playing",
        "START_PLAY": "playing",
        "STEP_FORWARD": "prepared",
        "STEP_BACK": "prepared",
        "RESET": "reset",
        "SELECT_EXAMPLE": "prepared",
        "CHANGE_INPUT_N": "prepared",
        "TOGGLE_SHOW_RETURNS": "prepared",
        "TOGGLE_AUTO_EXPAND": "prepared",
        "SPEED_CHANGE": "prepared",
        "KEY_SPACE": "playing",
        "KEY_ARROW_RIGHT": "prepared",
        "KEY_ARROW_LEFT": "prepared",
        "RESIZE": "prepared",
        "PREPARE": "prepared",
        "INPUT_TOO_LARGE": "prepared"
      }
    },
    {
      "name": "playing",
      "onEnter": "startPlaying",
      "onExit": "stopPlaying",
      "on": {
        "STOP_PLAY": "prepared",
        "STEP_FORWARD": "prepared",
        "STEP_BACK": "prepared",
        "SPEED_CHANGE": "playing",
        "RESET": "reset",
        "PLAYBACK_FINISHED": "finished",
        "TOGGLE_SHOW_RETURNS": "playing",
        "TOGGLE_AUTO_EXPAND": "playing",
        "KEY_SPACE": "prepared",
        "KEY_ARROW_RIGHT": "prepared",
        "KEY_ARROW_LEFT": "prepared",
        "RESIZE": "playing",
        "PREPARE": "prepared"
      }
    },
    {
      "name": "finished",
      "onEnter": "stopPlaying",
      "onExit": null,
      "on": {
        "STEP_FORWARD": "finished",
        "STEP_BACK": "prepared",
        "RUN": "playing",
        "START_PLAY": "playing",
        "RESET": "reset",
        "SELECT_EXAMPLE": "prepared",
        "CHANGE_INPUT_N": "prepared",
        "TOGGLE_SHOW_RETURNS": "finished",
        "TOGGLE_AUTO_EXPAND": "finished",
        "KEY_SPACE": "playing",
        "KEY_ARROW_RIGHT": "finished",
        "KEY_ARROW_LEFT": "prepared",
        "RESIZE": "finished",
        "PREPARE": "prepared"
      }
    },
    {
      "name": "reset",
      "onEnter": "resetAction",
      "onExit": null,
      "on": {
        "PREPARE": "prepared",
        "SELECT_EXAMPLE": "prepared",
        "CHANGE_INPUT_N": "prepared",
        "RUN": "playing",
        "START_PLAY": "playing",
        "TOGGLE_SHOW_RETURNS": "reset",
        "TOGGLE_AUTO_EXPAND": "reset",
        "KEY_SPACE": "playing",
        "RESIZE": "reset"
      }
    }
  ],
  "events": [
    "PREPARE",
    "RUN",
    "START_PLAY",
    "STOP_PLAY",
    "STEP_FORWARD",
    "STEP_BACK",
    "RESET",
    "SELECT_EXAMPLE",
    "CHANGE_INPUT_N",
    "SPEED_CHANGE",
    "TOGGLE_SHOW_RETURNS",
    "TOGGLE_AUTO_EXPAND",
    "KEY_SPACE",
    "KEY_ARROW_RIGHT",
    "KEY_ARROW_LEFT",
    "RESIZE",
    "PLAYBACK_FINISHED",
    "INPUT_TOO_LARGE"
  ],
  "notes": "State actions and side effects derived from implementation:\n- prepareSimulation: generates events for the selected example (generateFactorialEvents or generateFibonacciEvents), builds node map, renders the SVG tree (renderTreeStructure), clears stack UI and sets currentIndex = -1. Called on initial load and whenever Example or Input n changes. The UI may display a warning (INPUT_TOO_LARGE) when Fibonacci input is clamped.\n- startPlaying: sets playingInterval using speedRange value and begins auto-advancing by calling stepForward on each tick. Sets status text to 'Playing...'.\n- stopPlaying: clears playingInterval and sets playingInterval = null.\n- stepForward / stepBack: increment/decrement currentIndex and call applyEventsToIndex(currentIndex) which updates stack frames (push/pop), updates node classes (node-current/node-returned), and shows return values according to show-returns option. step actions do not necessarily change the 'prepared' state (they are manual controls implemented as self-transitions in the FSM).\n- resetAction: stops playback, clears highlights and return texts, empties stack UI, and sets status to 'Reset'.\n- SPEED_CHANGE: when in playing, the implementation restarts playback (stopPlaying then startPlaying) so interval uses new speed. When not playing it is a no-op except updating stored speed.\n- TOGGLE_SHOW_RETURNS: updates visible return texts immediately (no state change). TOGGLE_AUTO_EXPAND affects renderTreeStructure behavior during render.\n- Keyboard mapping: Space toggles play/pause (KEY_SPACE maps to START_PLAY or STOP_PLAY depending on state). ArrowRight and ArrowLeft map to STEP_FORWARD and STEP_BACK respectively; in playing these keys stop playback first then perform the step (the FSM models this by transitioning to 'prepared' and invoking the step action).\n- RESIZE: causes re-render of tree positions and re-application of currentIndex (recalculate layout and reapply node/frame classes); it does not change overall playback state (handled as self-transitions in each state).\n- PLAYBACK_FINISHED: produced internally when auto-play reaches the end; implementation calls stopPlaying() and sets status 'Finished'. The FSM transitions to 'finished' to reflect that playback reached end-of-events.\n- The FSM intentionally treats 'prepared' and 'paused' as a single state where manual stepping is allowed. 'prepared' is the normal interactive idle/ready state after preparing events. 'reset' means the UI has been cleared by the Reset action. 'finished' represents the terminal playback-complete UI until further user input (step back, reset or re-prepare) occurs.\n- Transition side-effect details (which JS functions are invoked for each event) are described above but are not encoded per-transition in the FSM to keep states concise: typical side effects are prepareSimulation (on PREPARE), startPlaying (on entering playing), stopPlaying (on exiting playing), stepForward/stepBack (on STEP_FORWARD/STEP_BACK), resetAction (on RESET), and re-render on RESIZE."
}