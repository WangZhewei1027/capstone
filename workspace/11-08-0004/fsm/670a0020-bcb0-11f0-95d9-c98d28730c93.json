{
  "topic": "Bubble Sort Interactive Module",
  "description": "Models the interactive UI/stateflow of a bubble-sort visualization: loading arrays, running/pausing the automatic animation, stepping comparisons, swapping animation, drag/reorder interactions, and completion.",
  "states": [
    {
      "name": "idle",
      "onEnter": "renderBars / updateCounters / announce('Array loaded. Ready to sort.')",
      "onExit": "",
      "on": {
        "START": "running",
        "STEP": "comparing",
        "APPLY_ARRAY": "idle",
        "SHUFFLE": "idle",
        "RANDOMIZE": "idle",
        "RESET": "idle",
        "DIR_SET_ASC": "idle",
        "DIR_SET_DESC": "idle",
        "SPEED_CHANGE": "idle",
        "DRAG_START": "dragging",
        "KEY_SPACE": "running",
        "KEY_S": "comparing",
        "KEY_R": "idle",
        "RESIZE": "idle"
      }
    },
    {
      "name": "running",
      "onEnter": "startInterval (set running=true, set start button pressed, announce('Sorting started.'))",
      "onExit": "stopInterval (set running=false, set start button unpressed)",
      "on": {
        "PAUSE": "idle",
        "ANIMATE_TICK": "comparing",
        "STEP": "comparing",
        "SPEED_CHANGE": "running",
        "DIR_SET_ASC": "running",
        "DIR_SET_DESC": "running",
        "DRAG_START": "dragging",
        "SHUFFLE": "idle",
        "RANDOMIZE": "idle",
        "APPLY_ARRAY": "idle",
        "RESET": "idle",
        "KEY_SPACE": "idle",
        "KEY_S": "comparing",
        "KEY_R": "idle",
        "RESIZE": "running"
      }
    },
    {
      "name": "comparing",
      "onEnter": "compareAndMaybeSwap (increments comparisons, highlightCompare, announce compare result)",
      "onExit": "clear compare highlight (if any)",
      "on": {
        "COMPARE_RESULT_SWAP": "swapping",
        "COMPARE_RESULT_NO_SWAP": "compare_next_or_pass",
        "PASS_COMPLETE": "pass_complete",
        "SORT_COMPLETE": "done",
        "DRAG_START": "dragging",
        "RESET": "idle",
        "SHUFFLE": "idle",
        "APPLY_ARRAY": "idle",
        "RANDOMIZE": "idle"
      }
    },
    {
      "name": "swapping",
      "onEnter": "performSwapAndAnimate (swap model values, update DOM dataset indices, schedule SWAP_ANIMATION_DONE after ~120ms, increment swaps)",
      "onExit": "updateCounters / remove compare highlight",
      "on": {
        "SWAP_ANIMATION_DONE": "compare_next_or_pass",
        "SORT_COMPLETE": "done",
        "DRAG_START": "dragging",
        "RESET": "idle",
        "SHUFFLE": "idle",
        "APPLY_ARRAY": "idle",
        "RANDOMIZE": "idle"
      }
    },
    {
      "name": "compare_next_or_pass",
      "onEnter": "advance indices after a compare (increment j; if j >= n-i-1 => emit PASS_COMPLETE; if i >= n-1 => emit SORT_COMPLETE; else continue comparing)",
      "onExit": "",
      "on": {
        "CONTINUE_COMPARE": "comparing",
        "PASS_COMPLETE": "pass_complete",
        "SORT_COMPLETE": "done",
        "DRAG_START": "dragging",
        "RESET": "idle",
        "SHUFFLE": "idle",
        "APPLY_ARRAY": "idle",
        "RANDOMIZE": "idle"
      }
    },
    {
      "name": "pass_complete",
      "onEnter": "markSorted (mark n-i-1 as sorted), increment pass and i, announce('Pass X complete.')",
      "onExit": "",
      "on": {
        "NEXT_COMPARE": "comparing",
        "SORT_COMPLETE": "done",
        "DRAG_START": "dragging",
        "RESET": "idle",
        "SHUFFLE": "idle",
        "APPLY_ARRAY": "idle",
        "RANDOMIZE": "idle"
      }
    },
    {
      "name": "dragging",
      "onEnter": "beginDrag (set dragging=true, add dragging class, capture pointer, store barRects)",
      "onExit": "finalizeDrag (compute new order, set array and initialArray, renderBars, stopInterval, announce('Array reordered by dragging. Algorithm reset.'), updateCounters)",
      "on": {
        "DRAG_MOVE": "dragging",
        "DRAG_END": "idle",
        "DRAG_CANCEL": "idle",
        "RESET": "idle",
        "SHUFFLE": "idle",
        "APPLY_ARRAY": "idle",
        "RANDOMIZE": "idle"
      }
    },
    {
      "name": "done",
      "onEnter": "announce('Sorting complete.'), markAllSorted, stopInterval",
      "onExit": "",
      "on": {
        "RESET": "idle",
        "SHUFFLE": "idle",
        "APPLY_ARRAY": "idle",
        "RANDOMIZE": "idle",
        "START": "running",
        "DRAG_START": "dragging",
        "KEY_SPACE": "running"
      }
    }
  ],
  "events": [
    "START",
    "PAUSE",
    "STEP",
    "ANIMATE_TICK",
    "COMPARE_RESULT_SWAP",
    "COMPARE_RESULT_NO_SWAP",
    "SWAP_ANIMATION_DONE",
    "PASS_COMPLETE",
    "SORT_COMPLETE",
    "CONTINUE_COMPARE",
    "NEXT_COMPARE",
    "APPLY_ARRAY",
    "SHUFFLE",
    "RANDOMIZE",
    "RESET",
    "SPEED_CHANGE",
    "DIR_SET_ASC",
    "DIR_SET_DESC",
    "DRAG_START",
    "DRAG_MOVE",
    "DRAG_END",
    "DRAG_CANCEL",
    "KEY_SPACE",
    "KEY_S",
    "KEY_R",
    "RESIZE"
  ],
  "notes": "Mapping and explanation of key actions and events:\n- startInterval / stopInterval: start/clear the setInterval that emits ANIMATE_TICK at the 'speed' interval. startInterval sets running=true and updates Start button UI; stopInterval clears interval and sets running=false.\n- compareAndMaybeSwap: runs a single comparison between indices j and j+1, increments comparisons, highlights bars, announces outcome. It emits COMPARE_RESULT_SWAP if a swap is needed, otherwise COMPARE_RESULT_NO_SWAP. If swap is needed it increments swaps and performs model swap immediately and schedules a DOM animation (SWAP_ANIMATION_DONE) after ~120ms.\n- performSwapAndAnimate: performs swap on the model, updates dataset indices on the two DOM bars and sets their left positions so CSS transitions animate their movement; schedules SWAP_ANIMATION_DONE when animation completes.\n- compare_next_or_pass is a transitional state representing logic that advances j and i: it will lead back to comparing (CONTINUE_COMPARE) or to pass_complete (PASS_COMPLETE) or done (SORT_COMPLETE) depending on indices.\n- dragging captures pointer events: pointerdown -> DRAG_START transitions to dragging, pointermove -> DRAG_MOVE updates provisional positions, pointerup -> DRAG_END finalizes reordering, updates model (array and initialArray), re-renders bars, stops any running animation and resets counters/UI where appropriate.\n- Controls mapping: Apply/Shuffling/Randomize/Reset all call init(...) and transition to idle. Speed change updates speed; if running the implementation restarts the interval (stop then start) to apply the new interval.\n- Keyboard shortcuts: Space toggles START/PAUSE, 's' triggers STEP, 'r' triggers RESET. Window resize triggers re-render of bars.\n- The FSM uses explicit result events (COMPARE_RESULT_SWAP / COMPARE_RESULT_NO_SWAP / SWAP_ANIMATION_DONE) to model asynchronous highlights and animations that occur during a step.\n- This FSM intentionally separates 'comparing' and 'swapping' to capture highlight vs animated-swap phases, and includes 'pass_complete' and 'done' to represent end-of-pass and overall completion states."
}