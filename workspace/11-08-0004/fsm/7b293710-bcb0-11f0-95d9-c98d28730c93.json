{
  "topic": "Quick Sort Interactive Module",
  "description": "FSM for the interactive Quick Sort visualization: user controls, pre-run bar selection/swapping, generator-driven step events (compare/swap/pivot/place/range/info), playback (play/pause/step/stop) and completion.",
  "states": [
    {
      "name": "idle",
      "onEnter": "renderArray / enable UI controls (play enabled, pause disabled, stop disabled, step enabled)",
      "onExit": "none",
      "on": {
        "PLAY": "playing",
        "STEP": "stepping",
        "RANDOMIZE": "idle",
        "RESET": "idle",
        "APPLY_CUSTOM": "idle",
        "SIZE_CHANGE": "idle",
        "SPEED_CHANGE": "idle",
        "PIVOT_CHANGE": "idle",
        "SELECT_BAR": "idle",
        "DESELECT_BAR": "idle",
        "SWAP_BARS": "idle",
        "TOGGLE_STACK": "idle",
        "KEY_PLAY": "playing",
        "KEY_PAUSE": "paused",
        "KEY_STEP": "stepping",
        "KEY_RANDOMIZE": "idle"
      }
    },
    {
      "name": "playing",
      "onEnter": "onPlay(): set running=true, paused=false, isProcessing=false; disable play button; enable pause & stop; ensure generator exists (create quicksortGenerator if null) and start runAuto()",
      "onExit": "clear running flag (running=false) if not already; isProcessing may be cleared by processing flow",
      "on": {
        "PAUSE": "paused",
        "STOP": "stopped",
        "EVT_RANGE": "processing_event",
        "EVT_PIVOT": "processing_event",
        "EVT_COMPARE": "processing_event",
        "EVT_SWAP": "processing_event",
        "EVT_PLACE": "processing_event",
        "EVT_INFO": "processing_event",
        "EVT_DONE": "done",
        "KEY_PAUSE": "paused"
      }
    },
    {
      "name": "paused",
      "onEnter": "onPause(): set paused=true, running=false; enable play button; disable pause button",
      "onExit": "clear paused flag",
      "on": {
        "PLAY": "playing",
        "STOP": "stopped",
        "STEP": "stepping",
        "RANDOMIZE": "paused",
        "RESET": "paused",
        "APPLY_CUSTOM": "paused",
        "SIZE_CHANGE": "paused",
        "PIVOT_CHANGE": "paused"
      }
    },
    {
      "name": "stepping",
      "onEnter": "onStep(): if no generator create quicksortGenerator(arr, pivotStrategy); set isProcessing=true; generator.next() and handle single yielded event",
      "onExit": "set isProcessing=false (if not finished); leave generator intact for subsequent steps",
      "on": {
        "EVT_RANGE": "processing_event",
        "EVT_PIVOT": "processing_event",
        "EVT_COMPARE": "processing_event",
        "EVT_SWAP": "processing_event",
        "EVT_PLACE": "processing_event",
        "EVT_INFO": "processing_event",
        "EVT_DONE": "done",
        "PROCESS_COMPLETE": "idle",
        "PROCESS_COMPLETE_STEP": "idle",
        "STOP": "stopped"
      }
    },
    {
      "name": "processing_event",
      "onEnter": "handleEvent(evt): perform visual actions for the yielded event (highlightCode, markPivot, markCompare, animateSwap, markPlaced, updateStack), await animation/sleep delays; set/clear isProcessing as appropriate",
      "onExit": "clear temporary visual marks as appropriate (clearCompareMarks / clearPivotMarks) and small inter-event pause",
      "on": {
        "PROCESS_COMPLETE": "playing",
        "PROCESS_COMPLETE_STEP": "idle",
        "EVT_DONE": "done",
        "STOP": "stopped"
      }
    },
    {
      "name": "stopped",
      "onEnter": "onStop(): set running=false, paused=false; generator=null; enable play button; disable pause & stop; clear highlights, updateBarsFromArray(), updateStack([]), clear code highlight, isProcessing=false",
      "onExit": "none",
      "on": {
        "PLAY": "playing",
        "RANDOMIZE": "idle",
        "RESET": "idle",
        "APPLY_CUSTOM": "idle",
        "SIZE_CHANGE": "idle",
        "PIVOT_CHANGE": "idle"
      }
    },
    {
      "name": "done",
      "onEnter": "finishRun(): running=false; isProcessing=false; generator=null; mark all bars sorted (add 'sorted'); updateStack([]); clear code highlight; set play enabled, pause disabled, stop disabled",
      "onExit": "none",
      "on": {
        "PLAY": "playing",
        "RANDOMIZE": "idle",
        "RESET": "idle",
        "APPLY_CUSTOM": "idle",
        "SIZE_CHANGE": "idle",
        "PIVOT_CHANGE": "idle"
      }
    }
  ],
  "events": [
    "PLAY",
    "PAUSE",
    "STEP",
    "STOP",
    "RANDOMIZE",
    "RESET",
    "APPLY_CUSTOM",
    "SIZE_CHANGE",
    "SPEED_CHANGE",
    "PIVOT_CHANGE",
    "TOGGLE_STACK",
    "SELECT_BAR",
    "DESELECT_BAR",
    "SWAP_BARS",
    "KEY_PLAY",
    "KEY_PAUSE",
    "KEY_STEP",
    "KEY_RANDOMIZE",
    "EVT_RANGE",
    "EVT_PIVOT",
    "EVT_COMPARE",
    "EVT_SWAP",
    "EVT_PLACE",
    "EVT_INFO",
    "EVT_DONE",
    "PROCESS_COMPLETE",
    "PROCESS_COMPLETE_STEP"
  ],
  "notes": "High-level model: the module has a pre-run interactive idle mode where users can randomize, edit, size-change, select and swap bars. Running is driven by a generator (quicksortGenerator) that yields visualization events: 'range' (stack/frame update), 'pivot', 'compare', 'swap', 'place', 'info' and final 'done'. Playing (automatic) repeatedly consumes yielded events; each yielded event transitions to a processing state where visual actions (highlighting, animateSwap, marking placed/sorted) and sleep/delay occur. After processing completes, either the playing loop continues (PROCESS_COMPLETE) or, if the event originated from a single Step invocation, control returns to idle (PROCESS_COMPLETE_STEP). Stopping clears the generator and restores UI. Pausing stops automatic playback but preserves the generator so the user can Step while paused. The FSM intentionally models processing of generator events as a distinct state so visual/animation side effects are captured as onEnter/onExit actions. Button and keyboard handlers map to the PLAY/PAUSE/STEP/STOP/RANDOMIZE events listed above."
}