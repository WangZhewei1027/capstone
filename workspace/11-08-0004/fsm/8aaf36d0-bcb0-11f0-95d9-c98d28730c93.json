{
  "topic": "Fibonacci Sequence â€” Interactive Module",
  "description": "Models the interactive states and transitions of the Fibonacci visualization app: seed/application, stepping, playing (auto-stepping), highlight selection, resets, range changes and canvas redraw/animation lifecycle.",
  "states": [
    {
      "name": "init",
      "onEnter": "initSequence + autorefillToRange + updateUI + drawAll",
      "onExit": "",
      "on": {
        "INIT_COMPLETE": "idle"
      }
    },
    {
      "name": "idle",
      "onEnter": "updateUI + drawAll (ensure UI reflects seq, formula boxes and sequence list)",
      "onExit": "",
      "on": {
        "STEP": "stepping",
        "PLAY_TOGGLE": "playing",
        "APPLY_SEEDS": "applyingSeeds",
        "RESET": "resetting",
        "RANGE_CHANGE": "idle",
        "TERM_CLICK": "highlighting",
        "RESIZE": "resizing"
      }
    },
    {
      "name": "playing",
      "onEnter": "startPlay (set playing=true, set aria-pressed, change label, start interval)",
      "onExit": "stopPlay (clear interval, set playing=false, restore label)",
      "on": {
        "PLAY_TOGGLE": "idle",
        "STEP": "stepping",
        "PLAY_STOP": "idle",
        "APPLY_SEEDS": "applyingSeeds",
        "RESET": "resetting",
        "RANGE_CHANGE": "playing",
        "RESIZE": "resizing"
      }
    },
    {
      "name": "stepping",
      "onEnter": "stepOnce (compute next term, push to seq) + animateNewTerm (draw highlight, pulse valNew, schedule animation end)",
      "onExit": "updateUI + drawAll (finalize new term visuals)",
      "on": {
        "ANIMATION_END": "idle",
        "APPLY_SEEDS": "applyingSeeds",
        "RESET": "resetting",
        "RANGE_CHANGE": "idle",
        "RESIZE": "resizing"
      }
    },
    {
      "name": "highlighting",
      "onEnter": "highlightIndex (drawAll with highlight index; set DOM aria-selected for term)",
      "onExit": "drawAll (clear highlight) or updateUI (when selection cleared)",
      "on": {
        "TERM_CLICK": "highlighting",
        "STEP": "stepping",
        "APPLY_SEEDS": "applyingSeeds",
        "RESET": "resetting",
        "RANGE_CHANGE": "idle",
        "RESIZE": "resizing"
      }
    },
    {
      "name": "applyingSeeds",
      "onEnter": "stopPlay + initSequence(seedA, seedB) + updateUI + drawAll",
      "onExit": "",
      "on": {
        "APPLY_SEEDS_COMPLETE": "idle",
        "RESIZE": "resizing"
      }
    },
    {
      "name": "resetting",
      "onEnter": "stopPlay + set seq = [seedA, seedB] + updateUI + drawAll",
      "onExit": "",
      "on": {
        "RESET_COMPLETE": "idle",
        "RESIZE": "resizing"
      }
    },
    {
      "name": "resizing",
      "onEnter": "resizeCanvas (debounced) + drawAll",
      "onExit": "",
      "on": {
        "RESIZE_COMPLETE": "idle"
      }
    }
  ],
  "events": [
    "INIT",
    "INIT_COMPLETE",
    "STEP",
    "PLAY_TOGGLE",
    "PLAY_START",
    "PLAY_STOP",
    "APPLY_SEEDS",
    "APPLY_SEEDS_COMPLETE",
    "RESET",
    "RESET_COMPLETE",
    "RANGE_CHANGE",
    "TERM_CLICK",
    "ANIMATION_END",
    "RESIZE",
    "RESIZE_COMPLETE",
    "AUTOFILL"
  ],
  "notes": "Important behavioral details and conditional transitions:\n- The UI is initialized on load: the script calls initSequence(0,1) and autorefillToRange(), which corresponds to the 'init' state onEnter actions; then the FSM enters 'idle'.\n- startPlay sets an interval that repeatedly triggers stepOnce (modeled as STEP events while in 'playing'). stopPlay clears that interval.\n- animateNewTerm triggers a short highlight/visual animation and sets a timeout; when that timeout completes the code effectively ends the animation (modeled as ANIMATION_END). After ANIMATION_END the FSM returns to 'idle'. If the global playing flag is true (i.e., play is active), the effective behavior is to continue allowing the interval to fire more STEP events; in other words, after ANIMATION_END the app continues operating in 'playing' mode. This conditional continuation is implemented in runtime by checking the 'playing' variable; in this FSM model ANIMATION_END transitions to 'idle' and the notes indicate the conditional return to 'playing' when applicable.\n- TERM_CLICK selects/highlights a term in the sequence list; the code sets aria-selected and calls highlightIndex which redraws with the highlight. Selection is cleared by operations that rebuild the list (updateUI) such as STEP, APPLY_SEEDS, RESET or RANGE_CHANGE.\n- RANGE_CHANGE updates maxDisplayTerms and redraws UI; if the user reduces the range while playing, the playing interval checks seq.length >= maxDisplayTerms on its next tick and will call stopPlay if the target length has been reached (modeled by PLAY_STOP or by the playing state handling RANGE_CHANGE and subsequent PLAY_STOP).\n- RESIZE is debounced; resizeCanvas recalculates sizes and calls drawAll. The FSM models resizing as a transient state that returns to 'idle' when the resize/draw completes.\n- The FSM omits an explicit 'maxedOut' state; the code comments suggest preventing steps when seq.length >= maxTerms, but the implementation still computes next term. If desired, a guard can be added: STEP transitions from 'idle' or 'playing' only when seq.length < maxTerms; otherwise remain in 'idle'.\n- onEnter/onExit action names correspond to the functions and behaviors in the source: initSequence, autorefillToRange, updateUI, drawAll, startPlay, stopPlay, stepOnce, animateNewTerm, highlightIndex, resizeCanvas.\n- This FSM models user interactions and animation lifecycle; it intentionally treats transient operations (applying seeds, resetting, resizing, animating) as short-lived states that perform their actions onEnter and then return to idle or playing as appropriate."
}