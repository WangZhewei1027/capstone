{
  "topic": "Heap Sort Interactive Module",
  "description": "Models the interactive states and transitions of a heap sort visualization (array bars + tree) with controls for randomize, reset, step, play/pause, speed/size changes, custom array input, and per-step generator actions (compare, swap, markSorted, done).",
  "states": [
    {
      "name": "idle",
      "onEnter": "init / renderAll / resetAlgorithmState",
      "onExit": "clearHighlights",
      "on": {
        "PLAY_TOGGLE": "playing",
        "STEP_CLICK": "processing",
        "RANDOM_CLICK": "idle",
        "RESET_CLICK": "idle",
        "APPLY_ARRAY": "idle",
        "SIZE_CHANGE": "idle",
        "SPEED_CHANGE": "idle",
        "BAR_EDIT_OPEN": "editing"
      }
    },
    {
      "name": "playing",
      "onEnter": "startAutoPlay; startGeneratorIfNeeded",
      "onExit": "stopAutoPlay",
      "on": {
        "PLAY_TOGGLE": "paused",
        "STEP_CLICK": "paused_then_process",
        "ACTION_COMPARE": "comparing",
        "ACTION_SWAP": "swapping",
        "ACTION_MARK_SORTED": "marking_sorted",
        "ACTION_DONE": "done",
        "RANDOM_CLICK": "idle",
        "RESET_CLICK": "idle",
        "APPLY_ARRAY": "idle",
        "SIZE_CHANGE": "idle",
        "SPEED_CHANGE": "playing",
        "BAR_EDIT_OPEN": "editing"
      }
    },
    {
      "name": "paused",
      "onEnter": "stopAutoPlay",
      "onExit": null,
      "on": {
        "PLAY_TOGGLE": "playing",
        "STEP_CLICK": "processing",
        "RANDOM_CLICK": "idle",
        "RESET_CLICK": "idle",
        "APPLY_ARRAY": "idle",
        "SIZE_CHANGE": "idle",
        "SPEED_CHANGE": "paused",
        "BAR_EDIT_OPEN": "editing"
      }
    },
    {
      "name": "processing",
      "onEnter": "stepOnce (advance generator / obtain next action)",
      "onExit": null,
      "on": {
        "ACTION_COMPARE": "comparing",
        "ACTION_SWAP": "swapping",
        "ACTION_MARK_SORTED": "marking_sorted",
        "ACTION_DONE": "done",
        "NO_ACTION": "paused"
      }
    },
    {
      "name": "paused_then_process",
      "onEnter": "stopAutoPlay; stepOnce",
      "onExit": null,
      "on": {
        "ACTION_COMPARE": "comparing",
        "ACTION_SWAP": "swapping",
        "ACTION_MARK_SORTED": "marking_sorted",
        "ACTION_DONE": "done",
        "NO_ACTION": "paused"
      }
    },
    {
      "name": "comparing",
      "onEnter": "clearHighlights; highlightPair(type=compare); updateStatus",
      "onExit": "clearHighlights",
      "on": {
        "STEP_CLICK": "processing",
        "SCHEDULE_NEXT": "processing",
        "PLAY_TOGGLE": "paused",
        "RANDOM_CLICK": "idle",
        "RESET_CLICK": "idle",
        "APPLY_ARRAY": "idle",
        "ACTION_SWAP": "swapping",
        "ACTION_MARK_SORTED": "marking_sorted",
        "ACTION_DONE": "done"
      }
    },
    {
      "name": "swapping",
      "onEnter": "clearHighlights; highlightPair(type=swap); performSwapVisualization (animates swap, relayoutBars/tree); updateStatus",
      "onExit": "clearHighlights; update nodes text",
      "on": {
        "SWAP_ANIMATION_END": "after_swap",
        "PLAY_TOGGLE": "paused",
        "RANDOM_CLICK": "idle",
        "RESET_CLICK": "idle",
        "APPLY_ARRAY": "idle"
      }
    },
    {
      "name": "after_swap",
      "onEnter": "if autoPlay then scheduleNextStep else return_to_paused",
      "onExit": null,
      "on": {
        "SCHEDULE_NEXT": "processing",
        "NO_SCHEDULE": "paused"
      }
    },
    {
      "name": "marking_sorted",
      "onEnter": "markSorted (visual 'sorted' class); updateStatus",
      "onExit": null,
      "on": {
        "STEP_CLICK": "processing",
        "SCHEDULE_NEXT": "processing",
        "PLAY_TOGGLE": "paused",
        "ACTION_SWAP": "swapping",
        "ACTION_DONE": "done",
        "RANDOM_CLICK": "idle",
        "RESET_CLICK": "idle",
        "APPLY_ARRAY": "idle"
      }
    },
    {
      "name": "editing",
      "onEnter": "open prompt (synchronous) / or show input; stopAutoPlay",
      "onExit": "if applied -> init(vals) else renderAll",
      "on": {
        "BAR_EDIT_APPLY": "idle",
        "BAR_EDIT_CANCEL": "idle",
        "APPLY_ARRAY": "idle",
        "RANDOM_CLICK": "idle",
        "RESET_CLICK": "idle"
      }
    },
    {
      "name": "done",
      "onEnter": "clearHighlights; updateStatus('Heap sort complete.'); markAllSorted; stopAutoPlay; btnPlay.text='Play'",
      "onExit": null,
      "on": {
        "RANDOM_CLICK": "idle",
        "RESET_CLICK": "idle",
        "APPLY_ARRAY": "idle",
        "PLAY_TOGGLE": "playing",
        "STEP_CLICK": "processing",
        "SIZE_CHANGE": "idle"
      }
    }
  ],
  "events": [
    "RANDOM_CLICK",
    "RESET_CLICK",
    "PLAY_TOGGLE",
    "STEP_CLICK",
    "SIZE_CHANGE",
    "SPEED_CHANGE",
    "APPLY_ARRAY",
    "BAR_EDIT_OPEN",
    "BAR_EDIT_APPLY",
    "BAR_EDIT_CANCEL",
    "KEY_SPACE",
    "KEY_N",
    "KEY_R",
    "GEN_STARTED",
    "ACTION_COMPARE",
    "ACTION_SWAP",
    "ACTION_MARK_SORTED",
    "ACTION_DONE",
    "SWAP_ANIMATION_END",
    "SCHEDULE_NEXT",
    "NO_SCHEDULE",
    "NO_ACTION",
    "RESIZE"
  ],
  "notes": "States map to UI modes and generator-driven algorithm steps. The generator (heapSortGenerator) yields actions (compare, swap, markSorted, done). 'processing' is a transient state entered when invoking stepOnce or autoplay scheduling. compare highlights items; swap triggers performSwapVisualization which triggers a timeout; when that swap animation completes SWAP_ANIMATION_END (implemented via setTimeout) drives continuation. startAutoPlay / stopAutoPlay toggle autoPlay and change the Play button label. UI control events (Random, Reset, Apply, Size, Speed) reinitialize or relayout and reset the algorithm state. Editing a bar uses a synchronous prompt in the implementation; modeled here as an 'editing' state with apply/cancel transitions. The actual implementation sometimes mixes scheduling (scheduleNextStep) only after swaps; this FSM models the intended flow: autoplay repeatedly advances through generator steps, whereas step advances a single step. Resizes trigger relayout (layoutBars / layoutTree) but are considered orthogonal and do not change algorithm state."
}