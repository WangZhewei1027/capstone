{
  "topic": "Interactive Heap (Min/Max) Explorer",
  "description": "Models the UI/animation and operation flow of an interactive heap visualizer that supports insert (bubble-up), extract (sift-down), remove-at-index, build/heapify, mode toggle (min/max), step-mode pauses, and animated comparisons/swaps.",
  "states": [
    {
      "name": "idle",
      "onEnter": "setStatus('Ready — heap is empty.') / renderAllNodes",
      "on": {
        "INSERT_CLICK": "busy.inserting",
        "INPUT_ENTER": "busy.inserting",
        "EXTRACT_CLICK": "busy.extracting",
        "RANDOMIZE_CLICK": "busy.building",
        "CLEAR_CLICK": "clearing",
        "MODE_TOGGLE": "togglingMode",
        "NODE_CLICK": "busy.removing",
        "ARRAY_CLICK": "busy.removing",
        "STEP_TOGGLE_ON": "idle",
        "STEP_TOGGLE_OFF": "idle",
        "WINDOW_RESIZE": "idle"
      }
    },
    {
      "name": "togglingMode",
      "onEnter": "toggleMode (set isMaxHeap, update UI, enqueue buildHeapAnimated(heap.slice()))",
      "onExit": "none",
      "on": {
        "BUILD_STARTED": "busy.building",
        "BUILD_COMPLETE": "idle",
        "OP_CANCEL": "idle"
      }
    },
    {
      "name": "clearing",
      "onEnter": "clearAll / setStatus('Cleared.')",
      "onExit": "renderAllNodes",
      "on": {
        "OP_COMPLETE": "idle"
      }
    },
    {
      "name": "busy.inserting",
      "onEnter": "insertValue (createNodeElement, push model, nodesDOM push, position, renderAllNodes) - start bubble-up loop",
      "onExit": "renderAllNodes / setStatus('Inserted (or appropriate message)')",
      "on": {
        "NEED_COMPARE": "comparing",
        "COMPARE_NO_SWAP": "OP_CONTINUE",
        "COMPARE_SWAP": "swapping",
        "SWAP_DONE": "OP_CONTINUE",
        "OP_COMPLETE": "idle",
        "OP_CANCEL": "idle"
      }
    },
    {
      "name": "busy.extracting",
      "onEnter": "extractRoot (handle empty/one-element special cases; otherwise animateSwap(0,last) then pop then start sift-down loop)",
      "onExit": "renderAllNodes / setStatus('Extraction complete or heap emptied')",
      "on": {
        "START_SWAP": "swapping",
        "NEED_COMPARE": "comparing",
        "COMPARE_NO_SWAP": "OP_CONTINUE",
        "COMPARE_SWAP": "swapping",
        "SWAP_DONE": "OP_CONTINUE",
        "OP_COMPLETE": "idle",
        "OP_CANCEL": "idle"
      }
    },
    {
      "name": "busy.removing",
      "onEnter": "removeAtIndex (swap with last, pop, then bubble-up or sift-down as needed)",
      "onExit": "renderAllNodes / setStatus('Removed')",
      "on": {
        "START_SWAP": "swapping",
        "NEED_COMPARE": "comparing",
        "COMPARE_SWAP": "swapping",
        "COMPARE_NO_SWAP": "OP_CONTINUE",
        "SWAP_DONE": "OP_CONTINUE",
        "OP_COMPLETE": "idle",
        "OP_CANCEL": "idle"
      }
    },
    {
      "name": "busy.building",
      "onEnter": "buildHeapAnimated (clearAll, create nodes for values, run bottom-up sift-downs with comparisons/swaps)",
      "onExit": "renderAllNodes / setStatus('Heap built.')",
      "on": {
        "NEED_COMPARE": "comparing",
        "COMPARE_SWAP": "swapping",
        "COMPARE_NO_SWAP": "OP_CONTINUE",
        "SWAP_DONE": "OP_CONTINUE",
        "BUILD_COMPLETE": "idle",
        "OP_CANCEL": "idle"
      }
    },
    {
      "name": "comparing",
      "onEnter": "highlightCompare(i,j) (set animating=true, add .compare classes to nodes, updateArrayView({compare:[i,j]}), setStatus('Comparing...'))",
      "onExit": "remove .compare classes / updateArrayView() / animating=false",
      "on": {
        "STEP_PAUSE": "paused",
        "COMPARE_SWAP": "swapping",
        "COMPARE_NO_SWAP": "OP_CONTINUE",
        "COMPARE_RESOLVED": "OP_CONTINUE",
        "OP_CANCEL": "idle"
      }
    },
    {
      "name": "swapping",
      "onEnter": "animateSwap(i,j) (set animating=true, setStatus('Swapping...'), swap heap model values, add .swap classes, move DOM nodes by setting left/top, await transitionend, swap nodesDOM references)",
      "onExit": "remove .swap classes / animating=false / renderAllNodes / setStatus('Swapped')",
      "on": {
        "SWAP_DONE": "OP_CONTINUE",
        "OP_CANCEL": "idle"
      }
    },
    {
      "name": "paused",
      "onEnter": "enable nextStepBtn/skipBtn; set stepResolve to resume function in highlightCompare; setStatus('Paused — waiting for Next or Run to End')",
      "onExit": "disable nextStepBtn/skipBtn; clear stepResolve",
      "on": {
        "NEXT_STEP": "COMPARE_RESOLVED",
        "SKIP": "COMPARE_RESOLVED",
        "OP_CANCEL": "idle"
      }
    }
  ],
  "events": [
    "INSERT_CLICK",
    "INPUT_ENTER",
    "EXTRACT_CLICK",
    "RANDOMIZE_CLICK",
    "CLEAR_CLICK",
    "MODE_TOGGLE",
    "NODE_CLICK",
    "ARRAY_CLICK",
    "STEP_TOGGLE_ON",
    "STEP_TOGGLE_OFF",
    "NEXT_STEP",
    "SKIP",
    "NEED_COMPARE",
    "COMPARE_SWAP",
    "COMPARE_NO_SWAP",
    "COMPARE_RESOLVED",
    "START_SWAP",
    "SWAP_DONE",
    "BUILD_STARTED",
    "BUILD_COMPLETE",
    "OP_COMPLETE",
    "OP_CONTINUE",
    "OP_CANCEL",
    "WINDOW_RESIZE",
    "INVALID_VALUE"
  ],
  "notes": "Implementation mapping and important behaviors:\n- The FSM models both user-driven events (button clicks, toggles, node/array clicks, keyboard enter) and internal animation/algorithm steps (comparisons and swaps).\n- Operations are enqueued and executed sequentially via animationQueue; the 'busy.*' states represent an in-progress operation that may repeatedly trigger comparing and swapping sub-states.\n- comparing:onEnter corresponds to highlightCompare(...) which sets animating=true, updates UI and — if stepMode is enabled — sets stepResolve and enables Next/Run buttons; when stepMode is active, comparing transitions to 'paused' (STEP_PAUSE) and only resumes on NEXT_STEP or SKIP.\n- swapping:onEnter corresponds to animateSwap(...): the model values are swapped immediately, DOM elements are animated by changing left/top, and the state resolves after transitionend (or fallback timeout). On exit, nodesDOM references are updated and renderAllNodes is called.\n- insertValue, extractRoot, removeAtIndex and buildHeapAnimated orchestrate loops of NEED_COMPARE → comparing → (COMPARE_SWAP → swapping → SWAP_DONE → OP_CONTINUE) or (COMPARE_NO_SWAP → OP_CONTINUE) until the operation's condition completes, then emits OP_COMPLETE to transition back to idle.\n- toggling mode triggers a rebuild: toggleMode sets isMaxHeap and enqueues a build (togglingMode -> busy.building).\n- clearAll is immediate but still modeled as 'clearing' to allow sequencing with animations if present.\n- UI/UX side-effects (setStatus messages, enabling/disabling buttons, CSS class toggles) are represented in onEnter/onExit actions (names map to functions in the source: setStatus, renderAllNodes, highlightCompare, animateSwap, createNodeElement, buildHeapAnimated, clearAll, toggleMode).\n- The FSM intentionally exposes abstract events (NEED_COMPARE, COMPARE_SWAP, COMPARE_NO_SWAP, SWAP_DONE, OP_COMPLETE) to represent algorithm/animation outcomes rather than low-level timers or DOM transition events; the implementation maps these internal outcomes to Promise resolutions and event dispatching within animationQueue.\n- Window resize triggers re-render (WINDOW_RESIZE handled in idle by calling renderAllNodes in implementation)."
}