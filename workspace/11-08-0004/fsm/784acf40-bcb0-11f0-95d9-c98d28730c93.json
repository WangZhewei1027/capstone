{
  "topic": "Breadth-First Search (BFS) Interactive Module",
  "description": "Models the interactive states and transitions of a BFS visualization/editor: editing the graph (adding/moving nodes, connecting edges, toggles), selecting start/target nodes, and running BFS either step-by-step or in play/auto mode until completion.",
  "states": [
    {
      "name": "edit_idle",
      "onEnter": "render",
      "onExit": "",
      "on": {
        "CLICK_STAGE_ADD_NODE": "edit_idle",
        "ADD_NODE_BUTTON": "edit_idle",
        "NODE_POINTER_DOWN": "dragging",
        "NODE_DOUBLE_CLICK": "edit_idle",
        "CONNECT_TOGGLE_ON": "connect_idle",
        "DIRECTED_TOGGLE_ON": "edit_idle",
        "DIRECTED_TOGGLE_OFF": "edit_idle",
        "SET_START_CLICK": "pending_set_start",
        "SET_TARGET_CLICK": "pending_set_target",
        "STEP": "ready_to_run",
        "PLAY_TOGGLE": "playing",
        "FAST_TOGGLE": "edit_idle",
        "UNDO": "edit_idle",
        "CLEAR_GRAPH": "edit_idle",
        "RESET_RUN": "edit_idle"
      }
    },
    {
      "name": "connect_idle",
      "onEnter": "setModeDisplay (connectMode=true)",
      "onExit": "clear connectBuffer; setModeDisplay",
      "on": {
        "NODE_POINTER_DOWN": "connect_selected",
        "CONNECT_TOGGLE_OFF": "edit_idle",
        "CLICK_STAGE_ADD_NODE": "connect_idle",
        "ADD_NODE_BUTTON": "connect_idle",
        "DIRECTED_TOGGLE_ON": "connect_idle",
        "DIRECTED_TOGGLE_OFF": "connect_idle",
        "UNDO": "connect_idle",
        "CLEAR_GRAPH": "edit_idle",
        "SET_START_CLICK": "pending_set_start",
        "SET_TARGET_CLICK": "pending_set_target",
        "STEP": "ready_to_run",
        "PLAY_TOGGLE": "playing"
      }
    },
    {
      "name": "connect_selected",
      "onEnter": "mark node selected (connectBuffer set); modeDisplay update",
      "onExit": "clear selected mark; clear connectBuffer",
      "on": {
        "NODE_POINTER_DOWN_ON_OTHER_NODE": "connect_idle",
        "ADD_EDGE": "connect_idle",
        "CONNECT_TOGGLE_OFF": "edit_idle",
        "CLICK_STAGE_ADD_NODE": "connect_selected",
        "UNDO": "connect_selected",
        "CLEAR_GRAPH": "edit_idle"
      }
    },
    {
      "name": "pending_set_start",
      "onEnter": "set pendingSet='start'; statusText update; attach one-time node click handler",
      "onExit": "clear pendingSet; remove attached node handlers; render",
      "on": {
        "PENDING_NODE_SELECTED": "edit_idle",
        "CLEAR_GRAPH": "edit_idle",
        "UNDO": "pending_set_start"
      }
    },
    {
      "name": "pending_set_target",
      "onEnter": "set pendingSet='target'; statusText update; attach one-time node click handler",
      "onExit": "clear pendingSet; remove attached node handlers; render",
      "on": {
        "PENDING_NODE_SELECTED": "edit_idle",
        "CLEAR_GRAPH": "edit_idle",
        "UNDO": "pending_set_target"
      }
    },
    {
      "name": "dragging",
      "onEnter": "set dragState; capture pointer; set cursor grabbing",
      "onExit": "clear dragState; release pointer capture; set cursor grab; render",
      "on": {
        "NODE_DRAG_MOVE": "dragging",
        "NODE_POINTER_UP": "edit_idle",
        "CLEAR_GRAPH": "edit_idle"
      }
    },
    {
      "name": "ready_to_run",
      "onEnter": "prepareBFS (if startNode set) -> runState created; render; updateStatus",
      "onExit": "",
      "on": {
        "STEP": "running",
        "PLAY_TOGGLE": "playing",
        "RESET_RUN": "ready_to_run",
        "CLEAR_GRAPH": "edit_idle",
        "UNDO": "ready_to_run"
      }
    },
    {
      "name": "running",
      "onEnter": "ensure runState exists; call bfsStep once; render; updateStatus",
      "onExit": "",
      "on": {
        "STEP": "running",
        "BFS_ADDED_NEIGHBOR": "running",
        "BFS_PROGRESS": "running",
        "BFS_FOUND_PATH": "finished",
        "BFS_QUEUE_EMPTY": "finished",
        "PLAY_TOGGLE": "playing",
        "RESET_RUN": "ready_to_run",
        "CLEAR_GRAPH": "edit_idle"
      }
    },
    {
      "name": "playing",
      "onEnter": "startPlay: ensure runState exists; playing=true; schedule stepPlay via timeout",
      "onExit": "stopPlay: playing=false; clear timeout; update play button",
      "on": {
        "PLAY_TOGGLE": "running",
        "BFS_STEP_COMPLETE": "playing",
        "BFS_FOUND_PATH": "finished",
        "BFS_QUEUE_EMPTY": "finished",
        "RESET_RUN": "ready_to_run",
        "CLEAR_GRAPH": "edit_idle"
      }
    },
    {
      "name": "finished",
      "onEnter": "mark runState.finished=true; highlight path/edges; stopPlay; render; updateStatus",
      "onExit": "",
      "on": {
        "RESET_RUN": "ready_to_run",
        "CLEAR_GRAPH": "edit_idle",
        "UNDO": "finished"
      }
    }
  ],
  "events": [
    "CLICK_STAGE_ADD_NODE",
    "ADD_NODE_BUTTON",
    "NODE_POINTER_DOWN",
    "NODE_POINTER_UP",
    "NODE_DRAG_MOVE",
    "NODE_DOUBLE_CLICK",
    "NODE_POINTER_DOWN_ON_OTHER_NODE",
    "CONNECT_TOGGLE_ON",
    "CONNECT_TOGGLE_OFF",
    "DIRECTED_TOGGLE_ON",
    "DIRECTED_TOGGLE_OFF",
    "SET_START_CLICK",
    "SET_TARGET_CLICK",
    "PENDING_NODE_SELECTED",
    "ADD_EDGE",
    "UNDO",
    "CLEAR_GRAPH",
    "STEP",
    "PLAY_TOGGLE",
    "START_PLAY",
    "STOP_PLAY",
    "FAST_TOGGLE",
    "RESET_RUN",
    "BFS_ADDED_NEIGHBOR",
    "BFS_PROGRESS",
    "BFS_STEP_COMPLETE",
    "BFS_FOUND_PATH",
    "BFS_QUEUE_EMPTY"
  ],
  "notes": "High-level FSM that maps UI modes and run lifecycle. Key implementation actions: render(), setModeDisplay(), addNode(), addEdge(), prepareBFS(), bfsStep(), startPlay()/stopPlay(), pushHistory()/undoLast(), and pendingSet handlers. connectMode and directedMode are toggles; connectBuffer holds first selected node while in connect flow. Dragging uses pointer capture and updates node coordinates on NODE_DRAG_MOVE. runState (BFS) contains adj, visited, inQueue, dist, parent, q, current, finished and drives visual queue/edge highlighting. Play schedules repeated bfsStep via timeouts and is stopped when finished or toggled. Events like BFS_* are logical outcomes from bfsStep and play loop (e.g., found path or queue empty)."
}