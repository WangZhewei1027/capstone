{
  "topic": "K-Nearest Neighbors (KNN) Interactive Module",
  "description": "Models the interactive states and transitions of the KNN visualization: adding/removing points, dragging the query, updating controls, running the neighbor-search animation, and transient highlight actions.",
  "states": [
    {
      "name": "idle_no_points",
      "onEnter": "renderAll (shows 'No points' result)",
      "on": {
        "ADD_POINT": "idle_has_points",
        "RANDOMIZE": "idle_has_points",
        "CLEAR_POINTS": "idle_no_points",
        "CHANGE_K": "idle_no_points",
        "CHANGE_METRIC": "idle_no_points",
        "TOGGLE_WEIGHTED": "idle_no_points",
        "SELECT_CLASS": "idle_no_points",
        "ANIMATE_START": "idle_no_points",
        "DELETE_NEAREST": "idle_no_points",
        "POINTER_DOWN_ON_QUERY": "dragging",
        "HIGHLIGHT_NEIGHBOR": "idle_no_points"
      }
    },
    {
      "name": "idle_has_points",
      "onEnter": "renderAll (computeAndDisplayNeighbors)",
      "on": {
        "POINTER_DOWN_ON_QUERY": "dragging",
        "POINTER_DOWN_ON_PLOT": "idle_has_points",
        "ADD_POINT": "idle_has_points",
        "CHANGE_K": "idle_has_points",
        "CHANGE_METRIC": "idle_has_points",
        "TOGGLE_WEIGHTED": "idle_has_points",
        "SELECT_CLASS": "idle_has_points",
        "CLEAR_POINTS": "idle_no_points",
        "RANDOMIZE": "idle_has_points",
        "DELETE_NEAREST": "idle_has_points",
        "ANIMATE_START": "animating",
        "HIGHLIGHT_NEIGHBOR": "idle_has_points"
      }
    },
    {
      "name": "dragging",
      "onEnter": "startQueryDrag (set draggingQuery=true, capture pointer, attach pointermove/pointerup listeners)",
      "onExit": "endQueryDrag (release pointer capture, remove listeners, set draggingQuery=false)",
      "on": {
        "POINTER_MOVE": "dragging",
        "POINTER_UP": "idle_has_points",
        "CANCEL_DRAG": "idle_has_points",
        "CHANGE_K": "dragging",
        "CHANGE_METRIC": "dragging",
        "TOGGLE_WEIGHTED": "dragging",
        "SELECT_CLASS": "dragging",
        "ADD_POINT": "dragging",
        "DELETE_NEAREST": "dragging",
        "ANIMATE_START": "animating",
        "HIGHLIGHT_NEIGHBOR": "dragging"
      }
    },
    {
      "name": "animating",
      "onEnter": "animateNeighborSearch_start (sets animating=true, draws expanding circle and sequential neighbor lines)",
      "onExit": "animateNeighborSearch_end (cleanup animation artifacts, set animating=false)",
      "on": {
        "ANIMATE_FINISH": "idle_has_points",
        "CANCEL_ANIMATION": "idle_has_points",
        "ADD_POINT": "animating",
        "POINTER_DOWN_ON_PLOT": "animating",
        "POINTER_DOWN_ON_QUERY": "dragging",
        "DELETE_NEAREST": "animating",
        "CLEAR_POINTS": "animating",
        "RANDOMIZE": "animating",
        "CHANGE_K": "animating",
        "CHANGE_METRIC": "animating",
        "TOGGLE_WEIGHTED": "animating",
        "SELECT_CLASS": "animating",
        "HIGHLIGHT_NEIGHBOR": "animating"
      }
    }
  ],
  "events": [
    "POINTER_DOWN_ON_PLOT",
    "POINTER_DOWN_ON_QUERY",
    "ADD_POINT",
    "POINTER_MOVE",
    "POINTER_UP",
    "START_DRAG",
    "END_DRAG",
    "CANCEL_DRAG",
    "CHANGE_K",
    "CHANGE_METRIC",
    "TOGGLE_WEIGHTED",
    "SELECT_CLASS",
    "CLEAR_POINTS",
    "RANDOMIZE",
    "DELETE_NEAREST",
    "ANIMATE_START",
    "ANIMATE_FINISH",
    "CANCEL_ANIMATION",
    "HIGHLIGHT_NEIGHBOR",
    "KEY_SHORTCUT_A",
    "KEY_SHORTCUT_R",
    "KEY_SHORTCUT_D"
  ],
  "notes": "High-level modeling notes and mapping to implementation functions:\n- renderAll: redraws the SVG, draws training points and query, and calls computeAndDisplayNeighbors.\n- computeAndDisplayNeighbors: computes distances using selected metric, selects top-K neighbors, computes votes (weighted/unweighted), updates result display and neighbor list.\n- startQueryDrag / endQueryDrag / onQueryDrag: manage pointer capture and update query coordinates; these run synchronously and call renderAll while dragging.\n- addPoint: occurs when user clicks the plot away from the query; creates a new training point with the selectedClass and calls renderAll. Represented as ADD_POINT/POINTER_DOWN_ON_PLOT.\n- deleteNearest: removes the nearest training point to the query. If deletion empties the dataset, the FSM transitions to idle_no_points (implementation note: the code does this implicitly by re-rendering and showing 'No points'). For simplicity DELETE_NEAREST is modeled as staying in idle_has_points but the UI may switch to idle_no_points when points.length becomes 0.\n- scatterRandom: populates points with a demo distribution and moves the query slightly; mapped to RANDOMIZE.\n- animateNeighborSearch_start / animateNeighborSearch_end: the animation is asynchronous; animateNeighborSearch sets animating=true and draws an expanding circle and then neighbor lines, highlighting neighbors sequentially. The code allows many UI operations while animation runs; this FSM models animation as a distinct state but notes that many events (add/delete/clear/randomize/control changes) are permitted during animation and do not necessarily cancel it.\n- highlightNeighbor: triggered by clicking a neighbor row; briefly applies visual highlight (CSS classes) to the corresponding point. This is a transient action and returns to the prior state.\n- Keyboard shortcuts: KEY_SHORTCUT_A cycles selected class (SELECT_CLASS), KEY_SHORTCUT_R triggers RANDOMIZE, KEY_SHORTCUT_D triggers DELETE_NEAREST.\n- Initial application run calls scatterRandom(), so the app typically starts in idle_has_points. The FSM intentionally models a small set of concrete states (idle_no_points, idle_has_points, dragging, animating) and maps UI actions/events to transitions and named onEnter/onExit actions. Concurrent behaviors: dragging and animation can overlap in the real app; the FSM models dragging and animating as distinct states and allows transitions between them, but the implementation permits some concurrency (e.g., animation continues while adding points)."
}