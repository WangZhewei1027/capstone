<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Knapsack Problem — Interactive Module</title>
  <style>
    /* Safe area margins */
    html,body { height:100%; }
    body {
      margin: 0;
      padding: 24px; /* safe area margin */
      box-sizing: border-box;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#f7fbff,#ffffff);
      color: #0b2545;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Layout */
    .container {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 24px;
      align-items: start;
      min-height: 100vh;
    }
    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr; }
    }

    /* Card */
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 18px rgba(8,30,63,0.06);
    }

    header .title {
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 6px 0;
      color: #04203b;
    }
    header .subtitle {
      margin: 0 0 16px 0;
      font-size: 13px;
      color: #29507b;
    }

    /* Top explanation area */
    .info-grid {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .info-grid .info {
      flex: 1;
      min-width: 220px;
      background: linear-gradient(180deg, #ffffff, #fbfdff);
      border: 1px solid rgba(6,24,44,0.04);
      padding: 12px;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.3;
    }
    .info .label {
      font-weight: 700;
      font-size: 12px;
      color: #07305b;
      margin-bottom: 6px;
      display:block;
    }

    /* Main left column */
    .workspace {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Controls row */
    .controls {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    .controls .control {
      min-width: 180px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    label.small { font-size: 13px; color:#174; width:86px; display:inline-block; }

    input[type="range"] { width: 140px; }

    button {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: linear-gradient(180deg,#0b61ff,#0046d6);
      color: white;
      font-weight: 600;
      box-shadow: 0 6px 14px rgba(11,97,255,0.12);
      transition: transform .08s ease;
    }
    button.secondary {
      background: none;
      border: 1px solid rgba(6,24,44,0.08);
      color: #05213f;
      box-shadow: none;
      font-weight: 600;
    }
    button:active { transform: translateY(1px); }

    /* Items bank and knapsack layout */
    .bank, .knapsack {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .items-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .item {
      width: 120px;
      min-height: 64px;
      border-radius: 10px;
      padding: 8px;
      box-shadow: 0 6px 12px rgba(9,28,52,0.06);
      display: flex;
      gap: 8px;
      align-items: center;
      cursor: grab;
      user-select: none;
      transition: transform .18s cubic-bezier(.2,.9,.3,1), box-shadow .18s;
      background: linear-gradient(180deg,#fff,#fbfdff);
      border: 1px solid rgba(6,24,44,0.04);
    }
    .item:active { cursor: grabbing; transform: scale(.99); }
    .item .swatch {
      width: 36px;
      height: 36px;
      flex: 0 0 36px;
      border-radius: 8px;
      display: inline-block;
    }
    .item .meta {
      font-size: 13px;
      line-height: 1;
      color: #04203b;
    }
    .item .meta .name { font-weight:700; margin-bottom:6px; display:block; font-size:13px; }
    .item .meta .sub { font-size:12px; color:#234a6e; }

    /* Knapsack visual */
    .knapsack-visual {
      height: 220px;
      border-radius: 10px;
      border: 2px dashed rgba(4,32,65,0.06);
      display: flex;
      align-items: flex-end;
      padding: 12px;
      overflow: hidden;
      position: relative;
      transition: background .18s;
      background: linear-gradient(180deg,#f8fdff,#ffffff);
    }

    .bag {
      width: 100%;
      position: relative;
      min-height: 160px;
    }
    .progress {
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 12px;
      height: 18px;
      border-radius: 10px;
      background: rgba(6,24,44,0.06);
      overflow: hidden;
    }
    .progress .bar {
      height: 100%;
      width: 0%;
      transition: width 420ms cubic-bezier(.2,.9,.2,1);
      background: linear-gradient(90deg,#85e3ff,#2778ff);
    }
    .stats {
      display:flex;
      gap:12px;
      align-items:center;
      font-size:13px;
      color:#03243f;
      margin-top:8px;
    }

    .inbag {
      display:flex;
      gap:8px;
      align-items:flex-end;
      flex-wrap: wrap;
    }

    /* Animations and feedback */
    .shake {
      animation: shake .38s ease;
    }
    @keyframes shake {
      10% { transform: translateX(-6px); }
      30% { transform: translateX(4px); }
      50% { transform: translateX(-3px); }
      70% { transform: translateX(2px); }
      100% { transform: translateX(0); }
    }

    .ghost {
      opacity: 0.18;
      transform: scale(.94);
    }

    .highlight {
      box-shadow: 0 8px 20px rgba(8,30,63,0.12);
      transform: translateY(-4px);
    }

    /* DP table */
    .dp-area {
      margin-top: 12px;
      display: grid;
      gap: 8px;
      align-items: start;
    }
    .dp-controls {
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
    }
    .table-wrap {
      overflow:auto;
      max-width:100%;
      border-radius: 8px;
      border: 1px solid rgba(6,24,44,0.04);
      background: white;
      padding: 8px;
    }
    table.dp {
      border-collapse: collapse;
      font-family: monospace;
      font-size: 12px;
    }
    table.dp td, table.dp th {
      border: 1px solid rgba(6,24,44,0.06);
      padding: 6px 8px;
      text-align:center;
      min-width:36px;
      background: #fff;
    }
    table.dp td.active {
      background: linear-gradient(90deg,#e0f2ff,#d3ecff);
    }
    table.dp td.pick {
      background: linear-gradient(90deg,#e6fff0,#bff7d6);
      font-weight:700;
      color:#064d34;
    }

    /* Footer / legend */
    .legend {
      display:flex;
      gap:12px;
      align-items:center;
      margin-top:8px;
      font-size:13px;
      color:#234a6e;
    }
    .small {
      font-size:12px;
      color:#29507b;
    }

    /* Accessibility focus */
    .focusable:focus {
      outline: 3px solid rgba(38,125,255,0.16);
      outline-offset: 2px;
      border-radius: 8px;
    }

    /* Ensure min spacing between interactive elements */
    .bank .item, .knapsack .item, button, input[type="range"], input[type="number"] {
      margin: 0;
    }

  </style>
</head>
<body>
  <div class="container" role="main">
    <!-- Left column: explanation + interactive workspace -->
    <div>
      <div class="card" aria-labelledby="concept-title">
        <header>
          <h1 id="concept-title" class="title">Knapsack Problem — Interactive Exploration</h1>
          <p class="subtitle">Understand selection trade-offs between item value and weight using hands-on interaction and a dynamic solver.</p>
        </header>

        <div class="info-grid" aria-hidden="false">
          <div class="info" id="learning">
            <span class="label">Learning Objective</span>
            After interacting you will be able to: intuitively balance value vs. weight, compare a greedy heuristic to the optimal dynamic programming solution, and visualize how an optimal selection is constructed.
          </div>
          <div class="info" id="interaction">
            <span class="label">Interaction Design</span>
            Drag items into the knapsack or click + to add. Adjust capacity, randomize items, and run "Solve optimal" to animate the DP table and see the best selection. Visual feedback includes animated item moves, a filling capacity bar, and cell-by-cell DP animation.
          </div>
        </div>

        <div class="workspace" aria-live="polite">
          <!-- Controls -->
          <div class="controls" role="region" aria-label="Controls" >
            <div class="control">
              <label class="small" for="capacity">Capacity</label>
              <input id="capacity" type="range" min="10" max="60" value="30" aria-label="Knapsack capacity" />
              <input id="cap-num" type="number" min="10" max="60" value="30" style="width:62px;border-radius:8px;border:1px solid rgba(6,24,44,0.06);padding:8px;" aria-label="Capacity number" />
            </div>

            <div class="control" style="margin-left:auto;">
              <button id="randomize" class="secondary" title="Create new random items">Randomize items</button>
              <button id="reset" class="secondary" title="Reset knapsack">Reset</button>
              <button id="solve" title="Compute optimal selection">Solve optimal</button>
            </div>
          </div>

          <!-- Items bank -->
          <div class="card bank" aria-label="Items bank" style="padding:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <strong>Available Items</strong>
              <span class="small">Drag or press +</span>
            </div>
            <div id="itemsRow" class="items-row" role="list" aria-label="List of items"></div>
          </div>

          <!-- Knapsack visual -->
          <div class="card knapsack" style="padding:12px;" aria-label="Knapsack area">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <strong>Knapsack</strong>
              <div class="small">Drop items into the bag</div>
            </div>

            <div id="knapsackVisual" class="knapsack-visual" aria-dropeffect="move" tabindex="0">
              <div class="bag" id="bagInner" aria-label="Bag interior">
                <div id="inBag" class="inbag" aria-live="polite"></div>
              </div>

              <div class="progress" aria-hidden="false" title="Capacity usage">
                <div id="bar" class="bar" style="width:0%"></div>
              </div>
            </div>

            <div class="stats" aria-hidden="false">
              <div>Weight: <strong id="currentWeight">0</strong> / <strong id="capacityLabel">30</strong></div>
              <div>Value: <strong id="currentValue">0</strong></div>
              <div style="margin-left:auto" class="legend">
                <div style="display:flex;align-items:center;gap:6px;"><span style="width:12px;height:12px;background:#a8e6ff;border-radius:3px;display:inline-block"></span><span class="small">Items in bag</span></div>
              </div>
            </div>
          </div>

          <!-- DP visualization area -->
          <div class="card dp-area" aria-live="polite" style="padding:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <strong>Dynamic Programming Table</strong>
              <div style="display:flex;gap:8px;align-items:center;">
                <label class="small" for="speed">Speed</label>
                <input id="speed" type="range" min="15" max="300" value="90" title="Animation speed (ms per cell)" />
                <button id="showGreedy" class="secondary" title="Compare greedy heuristic">Show greedy</button>
              </div>
            </div>

            <div class="dp-controls">
              <button id="animateDP" class="secondary">Animate DP</button>
              <button id="applyOptimal" title="Apply computed optimal selection">Apply optimal to bag</button>
              <div style="margin-left:auto;font-size:13px;color:#224a6f;">DP shows max value achievable for each (item,count vs capacity)</div>
            </div>

            <div class="table-wrap" id="tableWrap" aria-hidden="false" tabindex="0">
              <div id="dpTablePlaceholder" class="small" style="padding:12px;color:#294a74;">No DP computed yet. Click "Animate DP" to build the table visually.</div>
            </div>
          </div>

        </div>
      </div>

      <!-- Small footer explaining layout -->
      <div style="height:16px"></div>
      <div class="small" style="color:#264a72; max-width:720px;">
        Layout notes: margins use a 24px safe area. Interactive elements are spaced by at least 16px. The interface is responsive and keyboard-accessible: each item has a + button for focus & activation.
      </div>

    </div>

    <!-- Right column: guidance and chosen items summary -->
    <aside>
      <div class="card" aria-labelledby="summary-title">
        <h2 id="summary-title" class="title" style="font-size:16px;margin-bottom:8px;">Selection Summary</h2>

        <div style="display:flex;flex-direction:column;gap:12px;">
          <div style="display:flex;justify-content:space-between;">
            <div>
              <div class="small">Capacity</div>
              <div style="font-weight:700;font-size:18px;" id="summaryCapacity">30</div>
            </div>
            <div>
              <div class="small">Current weight</div>
              <div style="font-weight:700;font-size:18px;" id="summaryWeight">0</div>
            </div>
            <div>
              <div class="small">Current value</div>
              <div style="font-weight:700;font-size:18px;color:#0a56a1;" id="summaryValue">0</div>
            </div>
          </div>

          <div>
            <div class="small" style="margin-bottom:8px;">Chosen items</div>
            <div id="summaryList" style="display:flex;flex-direction:column;gap:8px;"></div>
          </div>

          <div style="display:flex;flex-direction:column;gap:8px;">
            <div class="small">Tips</div>
            <ul style="margin:0 0 0 18px;padding:0 0 0 0;color:#29507b;">
              <li>Greedy (value/weight ratio) is quick but not always optimal.</li>
              <li>DP provides exact solution for small-to-moderate capacity sizes.</li>
              <li>Use "Animate DP" to see how choices are built up.</li>
            </ul>
          </div>
        </div>
      </div>

      <div style="height:16px"></div>

      <div class="card" aria-hidden="false">
        <strong style="display:block;margin-bottom:8px;">How to interact</strong>
        <ol style="margin:0 0 0 18px;padding:0;color:#234a6e;">
          <li>Drag items into the knapsack or click the + on an item.</li>
          <li>Adjust capacity with the slider or number input.</li>
          <li>Click "Animate DP" to compute & visualize the optimal solution.</li>
          <li>Click "Apply optimal to bag" to auto-place the best subset.</li>
        </ol>
      </div>
    </aside>
  </div>

  <script>
    /****************************************************************
     * Knapsack Interactive Module (Vanilla JS)
     *
     * Features:
     * - Drag & drop items into the knapsack, or add via button
     * - Adjustable capacity via range + number
     * - Randomize items
     * - Greedy heuristic vs DP optimal solver
     * - DP table animation and apply-optimal
     *
     * Accessibility:
     * - Buttons and elements focusable, keyboard add supported
     *
     ****************************************************************/

    // DOM refs
    const itemsRow = document.getElementById('itemsRow');
    const inBag = document.getElementById('inBag');
    const capacityRange = document.getElementById('capacity');
    const capNum = document.getElementById('cap-num');
    const capacityLabel = document.getElementById('capacityLabel');
    const bar = document.getElementById('bar');
    const currentWeightEl = document.getElementById('currentWeight');
    const currentValueEl = document.getElementById('currentValue');
    const randomizeBtn = document.getElementById('randomize');
    const resetBtn = document.getElementById('reset');
    const solveBtn = document.getElementById('solve');
    const animateDPBtn = document.getElementById('animateDP');
    const dpTablePlaceholder = document.getElementById('dpTablePlaceholder');
    const tableWrap = document.getElementById('tableWrap');
    const applyOptimalBtn = document.getElementById('applyOptimal');
    const showGreedyBtn = document.getElementById('showGreedy');
    const summaryCapacity = document.getElementById('summaryCapacity');
    const summaryWeight = document.getElementById('summaryWeight');
    const summaryValue = document.getElementById('summaryValue');
    const summaryList = document.getElementById('summaryList');
    const speedControl = document.getElementById('speed');

    // State
    let items = [];            // full list of items available
    let bagIds = new Set();    // ids of items currently in bag
    let capacity = parseInt(capacityRange.value,10);
    let dpResult = null;       // {table, selectedIndices, maxValue}

    // Utility to create sample items
    function randomItems(n = 8) {
      const generated = [];
      const names = ['A','B','C','D','E','F','G','H','I','J','K','L'];
      for (let i=0;i<n;i++) {
        const weight = Math.floor(Math.random()*12)+2; // 2..13
        const value = Math.floor(Math.random()*20)+3;  // 3..22
        const color = `hsl(${Math.floor(Math.random()*220+30)}, 85%, 65%)`;
        generated.push({
          id: 'it'+Math.random().toString(36).slice(2,8),
          name: names[i%names.length] + (i+1),
          weight, value, color
        });
      }
      return generated;
    }

    // Initialize
    function init() {
      items = randomItems(8);
      bagIds.clear();
      capacity = parseInt(capacityRange.value,10);
      capNum.value = capacity;
      capacityLabel.textContent = capacity;
      summaryCapacity.textContent = capacity;
      dpResult = null;
      renderItems();
      renderBag();
      clearDP();
    }

    // Render functions
    function renderItems() {
      itemsRow.innerHTML = '';
      items.forEach(item=>{
        const el = document.createElement('div');
        el.className = 'item focusable';
        el.tabIndex = 0;
        el.setAttribute('role','listitem');
        el.draggable = true;
        el.dataset.id = item.id;
        el.innerHTML = `
          <div class="swatch" style="background:${item.color}"></div>
          <div class="meta">
            <span class="name">${item.name}</span>
            <span class="sub">W:${item.weight}  V:${item.value}</span>
          </div>
        `;
        // Add small + button for keyboard users
        const btn = document.createElement('button');
        btn.textContent = '+';
        btn.title = 'Add to bag';
        btn.style.marginLeft = 'auto';
        btn.style.padding = '6px 8px';
        btn.style.borderRadius = '8px';
        btn.style.background = 'linear-gradient(180deg,#0b61ff,#0046d6)';
        btn.style.color = '#fff';
        btn.style.border = 'none';
        btn.style.fontWeight = '700';
        btn.style.cursor = 'pointer';
        btn.className = 'focusable';
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          tryAddToBag(item.id, true);
        });
        // keyboard add via Enter on item
        el.addEventListener('keydown', (ev)=>{
          if (ev.key === 'Enter' || ev.key === ' ') {
            ev.preventDefault();
            tryAddToBag(item.id, true);
          }
        });

        // drag handlers
        el.addEventListener('dragstart', (ev)=>{
          ev.dataTransfer.setData('text/plain', item.id);
          setTimeout(()=> el.classList.add('ghost'), 10);
        });
        el.addEventListener('dragend', ()=> el.classList.remove('ghost'));

        // Attach remove button overlay when item in bag
        el.appendChild(btn);
        itemsRow.appendChild(el);
      });
    }

    function renderBag() {
      inBag.innerHTML = '';
      const inBagItems = items.filter(it=> bagIds.has(it.id));
      inBagItems.forEach(item=>{
        const el = document.createElement('div');
        el.className = 'item focusable';
        el.tabIndex = 0;
        el.draggable = true;
        el.dataset.id = item.id;
        el.innerHTML = `
          <div class="swatch" style="background:${item.color}"></div>
          <div class="meta">
            <span class="name">${item.name}</span>
            <span class="sub">W:${item.weight} V:${item.value}</span>
          </div>
        `;
        // remove button
        const btn = document.createElement('button');
        btn.textContent = '−';
        btn.title = 'Remove from bag';
        btn.style.marginLeft = 'auto';
        btn.style.padding = '6px 8px';
        btn.style.borderRadius = '8px';
        btn.style.background = 'linear-gradient(180deg,#ffffff,#f2f4f8)';
        btn.style.color = '#062a4a';
        btn.style.border = '1px solid rgba(6,24,44,0.06)';
        btn.style.fontWeight = '700';
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          removeFromBag(item.id);
        });
        el.appendChild(btn);
        // drag to remove
        el.addEventListener('dragstart', (ev)=>{
          ev.dataTransfer.setData('text/plain', item.id);
          ev.dataTransfer.setData('remove', '1'); // indicate moving out
          setTimeout(()=> el.classList.add('ghost'), 10);
        });
        el.addEventListener('dragend', ()=> el.classList.remove('ghost'));

        // keyboard remove
        el.addEventListener('keydown', (ev)=>{
          if (ev.key === 'Enter' || ev.key === ' ') {
            ev.preventDefault();
            removeFromBag(item.id);
          }
        });

        inBag.appendChild(el);
      });
      updateStats();
    }

    function updateStats() {
      const selected = items.filter(it=> bagIds.has(it.id));
      const totalWeight = selected.reduce((s,it)=>s+it.weight,0);
      const totalValue = selected.reduce((s,it)=>s+it.value,0);
      currentWeightEl.textContent = totalWeight;
      currentValueEl.textContent = totalValue;
      capacityLabel.textContent = capacity;
      summaryCapacity.textContent = capacity;
      summaryWeight.textContent = totalWeight;
      summaryValue.textContent = totalValue;
      // summary chosen list
      summaryList.innerHTML = '';
      selected.forEach(it=>{
        const li = document.createElement('div');
        li.style.display='flex';
        li.style.justifyContent='space-between';
        li.style.fontSize='13px';
        li.style.color='#17324a';
        li.innerHTML = `<div>${it.name} (W:${it.weight})</div><div style="font-weight:700;color:#0a56a1">${it.value}</div>`;
        summaryList.appendChild(li);
      });

      // update progress bar
      const pct = Math.min(100, Math.round((totalWeight / capacity) * 100));
      bar.style.width = pct + '%';
      // if overweight, flash red and shake
      if (totalWeight > capacity) {
        bar.style.background = 'linear-gradient(90deg,#ffb1b1,#ff6a6a)';
        document.getElementById('knapsackVisual').classList.add('shake');
        setTimeout(()=>document.getElementById('knapsackVisual').classList.remove('shake'),420);
      } else {
        bar.style.background = 'linear-gradient(90deg,#85e3ff,#2778ff)';
      }
    }

    // Try to add item to bag with optional animation
    function tryAddToBag(id, animate=false) {
      const item = items.find(it=>it.id===id);
      if (!item) return;
      const currentWeight = items.filter(it=> bagIds.has(it.id)).reduce((s,it)=>s+it.weight,0);
      if (currentWeight + item.weight > capacity) {
        // reject and shake visual
        const target = [...itemsRow.children].find(e=>e.dataset.id===id);
        if (target) {
          target.classList.add('shake');
          setTimeout(()=>target.classList.remove('shake'),420);
        }
        // hint
        currentWeightEl.parentElement.classList.add('shake');
        setTimeout(()=> currentWeightEl.parentElement.classList.remove('shake'),420);
        return;
      }
      bagIds.add(id);
      renderBag();
      if (animate) {
        // animate the item card highlight
        const src = [...itemsRow.children].find(e=>e.dataset.id===id);
        if (src) {
          src.classList.add('highlight');
          setTimeout(()=>src.classList.remove('highlight'),420);
        }
      }
    }

    function removeFromBag(id) {
      bagIds.delete(id);
      renderBag();
    }

    // Drag & Drop handlers for bag visual and items area
    const bagVisual = document.getElementById('knapsackVisual');
    bagVisual.addEventListener('dragover', (ev)=> {
      ev.preventDefault();
      bagVisual.style.borderColor = 'rgba(39,120,255,0.18)';
    });
    bagVisual.addEventListener('dragleave', ()=> {
      bagVisual.style.borderColor = 'rgba(4,32,65,0.06)';
    });
    bagVisual.addEventListener('drop', (ev)=>{
      ev.preventDefault();
      bagVisual.style.borderColor = 'rgba(4,32,65,0.06)';
      const id = ev.dataTransfer.getData('text/plain');
      if (!id) return;
      tryAddToBag(id, true);
    });

    // Allow dropping items out by dragging from bag onto itemsRow area
    itemsRow.addEventListener('dragover', (ev)=> { ev.preventDefault(); });
    itemsRow.addEventListener('drop', (ev)=>{
      ev.preventDefault();
      const id = ev.dataTransfer.getData('text/plain');
      const removeFlag = ev.dataTransfer.getData('remove');
      if (removeFlag && id) {
        removeFromBag(id);
      }
    });

    // Controls actions
    randomizeBtn.addEventListener('click', ()=>{
      items = randomItems(8);
      bagIds.clear();
      dpResult = null;
      renderItems();
      renderBag();
      clearDP();
    });

    resetBtn.addEventListener('click', ()=>{
      bagIds.clear();
      renderBag();
      dpResult = null;
      clearDP();
    });

    capacityRange.addEventListener('input', (ev)=>{
      capacity = parseInt(ev.target.value,10);
      capNum.value = capacity;
      capacityLabel.textContent = capacity;
      summaryCapacity.textContent = capacity;
      updateStats();
      dpResult = null;
      clearDP();
    });
    capNum.addEventListener('change', (ev)=>{
      let v = parseInt(ev.target.value,10) || capacity;
      v = Math.max(10, Math.min(60, v));
      capacity = v;
      capacityRange.value = v;
      capNum.value = v;
      capacityLabel.textContent = v;
      summaryCapacity.textContent = v;
      updateStats();
      dpResult = null;
      clearDP();
    });

    // Greedy heuristic
    function greedySelection(itemsList, cap) {
      const sorted = [...itemsList].sort((a,b)=>{
        const ra = a.value / a.weight;
        const rb = b.value / b.weight;
        return rb - ra;
      });
      let w=0, v=0;
      const chosen = [];
      for (let it of sorted) {
        if (w + it.weight <= cap) {
          chosen.push(it.id);
          w+=it.weight; v+=it.value;
        }
      }
      return {chosen, weight:w, value:v};
    }

    showGreedyBtn.addEventListener('click', ()=>{
      const res = greedySelection(items, capacity);
      // Highlight chosen items in bank temporarily
      [...itemsRow.children].forEach(el=>{
        if (res.chosen.includes(el.dataset.id)) {
          el.classList.add('highlight');
          setTimeout(()=>el.classList.remove('highlight'),900);
        } else {
          el.classList.add('ghost');
          setTimeout(()=>el.classList.remove('ghost'),900);
        }
      });
      // Also display a quick summary
      alert(`Greedy selection (by value/weight ratio):\nItems: ${res.chosen.length}\nTotal weight: ${res.weight}\nTotal value: ${res.value}\nNote: may not be optimal.`);
    });

    // Dynamic Programming solver (0/1 knapsack)
    function knapsackDP(itemsList, cap) {
      const n = itemsList.length;
      // table of size (n+1) x (cap+1)
      const table = Array.from({length: n+1}, ()=> new Array(cap+1).fill(0));
      for (let i = 1; i <= n; i++) {
        const wi = itemsList[i-1].weight;
        const vi = itemsList[i-1].value;
        for (let w = 0; w <= cap; w++) {
          if (wi > w) {
            table[i][w] = table[i-1][w];
          } else {
            const take = table[i-1][w-wi] + vi;
            const notTake = table[i-1][w];
            table[i][w] = Math.max(notTake, take);
          }
        }
      }
      // backtrack to find chosen items
      let w = cap;
      const chosenIndices = [];
      for (let i = n; i > 0; i--) {
        if (table[i][w] !== table[i-1][w]) {
          chosenIndices.push(i-1);
          w -= itemsList[i-1].weight;
        }
      }
      return {table, chosenIndices: chosenIndices.reverse(), maxValue: table[n][cap]};
    }

    // Animate DP: build table and show active cells
    async function animateDP(itemsList, cap, speedMs = 90) {
      dpTablePlaceholder.innerHTML = ''; // clear placeholder
      const n = itemsList.length;
      // create HTML table representation
      const tbl = document.createElement('table');
      tbl.className = 'dp';
      const thead = document.createElement('thead');
      const thr = document.createElement('tr');
      thr.appendChild(document.createElement('th')); // blank top-left
      for (let w=0; w<=cap; w++) {
        const th = document.createElement('th');
        th.textContent = w;
        thr.appendChild(th);
      }
      thead.appendChild(thr);
      tbl.appendChild(thead);

      const tbody = document.createElement('tbody');
      for (let i=0;i<=n;i++) {
        const row = document.createElement('tr');
        const th = document.createElement('th');
        th.textContent = i===0 ? '0' : itemsList[i-1].name;
        row.appendChild(th);
        for (let w=0; w<=cap; w++) {
          const td = document.createElement('td');
          td.textContent = '0';
          row.appendChild(td);
        }
        tbody.appendChild(row);
      }
      tbl.appendChild(tbody);
      dpTablePlaceholder.appendChild(tbl);

      // Perform DP with incremental updates
      const table = Array.from({length: n+1}, ()=> new Array(cap+1).fill(0));
      for (let i = 1; i <= n; i++) {
        const wi = itemsList[i-1].weight;
        const vi = itemsList[i-1].value;
        for (let w = 0; w <= cap; w++) {
          // highlight current cell visually
          const cell = tbody.children[i].children[w+1];
          cell.classList.add('active');
          await sleep(speedMs);
          if (wi > w) {
            table[i][w] = table[i-1][w];
          } else {
            const take = table[i-1][w-wi] + vi;
            const notTake = table[i-1][w];
            table[i][w] = Math.max(notTake, take);
          }
          cell.textContent = String(table[i][w]);
          cell.classList.remove('active');
        }
      }

      // Backtrack to find chosen
      let w = cap;
      const chosen = [];
      for (let i = n; i > 0; i--) {
        const cell = tbody.children[i].children[w+1];
        if (table[i][w] !== table[i-1][w]) {
          // mark as chosen
          chosen.push(i-1);
          cell.classList.add('pick');
          w -= itemsList[i-1].weight;
        }
      }
      dpResult = {table, chosenIndices: chosen.reverse(), maxValue: table[n][cap]};
      return dpResult;
    }

    function clearDP() {
      dpTablePlaceholder.innerHTML = '<div class="small" style="padding:12px;color:#294a74;">No DP computed yet. Click "Animate DP" to build the table visually.</div>';
    }

    animateDPBtn.addEventListener('click', async ()=>{
      if (items.length === 0) return;
      animateDPBtn.disabled = true;
      dpTablePlaceholder.innerHTML = '';
      const speed = parseInt(speedControl.value,10) || 90;
      try {
        await animateDP(items, capacity, speed);
        alert(`DP complete. Optimal value: ${dpResult.maxValue}. Selected ${dpResult.chosenIndices.length} item(s).`);
      } catch (e) {
        console.error(e);
      } finally {
        animateDPBtn.disabled = false;
      }
    });

    // Solve immediately (non-animated) and show summary
    solveBtn.addEventListener('click', ()=>{
      const res = knapsackDP(items, capacity);
      dpResult = res;
      // create compact textual table summary
      let chosenNames = res.chosenIndices.map(i=>items[i].name).join(', ');
      if (chosenNames === '') chosenNames = '(none)';
      alert(`Optimal value: ${res.maxValue}\nItems chosen: ${chosenNames}`);
    });

    applyOptimalBtn.addEventListener('click', ()=>{
      if (!dpResult) {
        alert('No DP result available. Click "Animate DP" or "Solve optimal" first.');
        return;
      }
      // set bag to optimal selection
      bagIds.clear();
      dpResult.chosenIndices.forEach(idx => bagIds.add(items[idx].id));
      renderBag();
    });

    // small sleep helper for animation
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Initialize on load
    init();

    // Make sure itemsRow is a drop target to remove items
    // Allow double-click to toggle add/remove
    itemsRow.addEventListener('dblclick', (ev)=>{
      const el = ev.target.closest('.item');
      if (!el) return;
      const id = el.dataset.id;
      if (bagIds.has(id)) removeFromBag(id);
      else tryAddToBag(id,true);
    });

    // Keyboard: pressing 'g' runs greedy, 'd' runs animateDP quick
    document.addEventListener('keydown', (ev)=>{
      if (ev.key === 'g') {
        showGreedyBtn.click();
      } else if (ev.key === 'd') {
        animateDPBtn.click();
      }
    });

    // Small enhancement: when window resizes or content changes, ensure at least 16px gap remains
    // (CSS handles spacing; this is just a guard)
    window.addEventListener('resize', ()=> {
      // nothing needed; layout is responsive
    });

    // Ensure focus outlines for accessibility when keyboard navigating
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Tab') document.body.classList.add('using-keyboard');
    });

    // Prevent default on drag image for better visuals
    document.addEventListener('dragstart', (ev)=>{
      if (ev.dataTransfer.setDragImage) {
        const crt = document.createElement('canvas');
        crt.width = 1; crt.height = 1;
        ev.dataTransfer.setDragImage(crt, 0, 0);
      }
    });

  </script>
</body>
</html>