<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Binary Search — Interactive Module</title>
  <style>
    :root{
      --safe-margin: 24px;
      --gap: 16px;
      --bg: #0f1724;
      --panel: #0b1220;
      --accent: #38bdf8;
      --accent-2: #60a5fa;
      --ok: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;
      --muted: #94a3b8;
      --card: #071020;
      --radius: 10px;
      --transition: 300ms cubic-bezier(.2,.9,.3,1);
    }

    html,body{
      height:100%;
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #071022 0%, #07132a 100%);
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .safe-area{
      padding: var(--safe-margin);
      box-sizing: border-box;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      gap: var(--gap);
    }

    header.module-header{
      display:flex;
      gap:var(--gap);
      align-items:flex-start;
      flex-wrap:wrap;
    }

    .title-block{
      min-width:0;
      flex:1 1 420px;
    }

    h1{
      margin:0 0 8px 0;
      font-size:20px;
      letter-spacing:-0.2px;
    }

    p.lead{
      margin:0;
      color:var(--muted);
      font-size:14px;
      line-height:1.35;
    }

    .meta{
      display:flex;
      gap:var(--gap);
      align-items:center;
      margin-left:auto;
    }

    .chip{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.04);
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      color:var(--muted);
    }

    main.content{
      display:flex;
      gap:var(--gap);
      align-items:flex-start;
      width:100%;
    }

    /* Left: instructions + controls */
    .controls{
      width:360px;
      min-width:260px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: var(--radius);
      padding:var(--gap);
      box-sizing:border-box;
      border:1px solid rgba(255,255,255,0.04);
      display:flex;
      flex-direction:column;
      gap:var(--gap);
    }

    .controls h2{
      margin:0;
      font-size:16px;
    }

    .controls p{
      margin:0;
      color:var(--muted);
      font-size:13px;
    }

    label.small{
      display:block;
      font-size:13px;
      margin-bottom:6px;
      color:var(--muted);
    }

    .row{
      display:flex;
      gap:var(--gap);
      align-items:center;
    }

    input[type="number"], input[type="text"], select{
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      color:var(--muted);
      padding:8px 10px;
      border-radius:8px;
      outline:none;
      transition: border-color var(--transition);
      min-width:0;
      font-size:13px;
    }

    input[type="number"]:focus, input[type="text"]:focus, select:focus{
      border-color:var(--accent);
      color: #e6eef8;
    }

    .btn{
      background:linear-gradient(180deg,var(--accent),var(--accent-2));
      color: #042135;
      padding:8px 12px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
      transition: transform 120ms ease, box-shadow 120ms;
      box-shadow: 0 6px 18px rgba(56,189,248,0.08);
      font-size:13px;
    }
    .btn.secondary{
      background:linear-gradient(180deg,#0b1220,#071022);
      color:var(--muted);
      border:1px solid rgba(255,255,255,0.04);
      box-shadow:none;
    }
    .btn:active{ transform:translateY(1px); }

    .controls .group{
      display:flex;
      gap:var(--gap);
      flex-direction:column;
    }

    .control-actions{
      display:flex;
      gap:var(--gap);
      flex-wrap:wrap;
    }

    /* Right: workspace */
    .workspace{
      flex:1 1 600px;
      min-width:320px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:var(--radius);
      padding:var(--gap);
      border:1px solid rgba(255,255,255,0.04);
      display:flex;
      flex-direction:column;
      gap:var(--gap);
    }

    .visual{
      display:flex;
      flex-direction:column;
      gap:var(--gap);
      padding:8px;
      align-items:stretch;
    }

    /* Array bar */
    .array-wrap{
      overflow:auto;
      padding:12px;
      border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border:1px dashed rgba(255,255,255,0.02);
    }

    .array{
      display:flex;
      gap:12px;
      align-items:end;
      min-height:160px;
      padding:8px;
    }

    .cell{
      width:56px;
      height:56px;
      background:linear-gradient(180deg,#0b1524,#071025);
      border:1px solid rgba(255,255,255,0.03);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      color:var(--muted);
      font-weight:700;
      transform-origin:center bottom;
      transition: transform var(--transition), background-color var(--transition), box-shadow var(--transition), border-color var(--transition);
      position:relative;
      min-width:56px;
    }

    .cell .index{
      font-size:11px;
      color:rgba(255,255,255,0.18);
      position:absolute;
      top:6px;
    }

    .cell.mid {
      background: linear-gradient(180deg, rgba(56,189,248,0.12), rgba(56,189,248,0.04));
      box-shadow:0 6px 18px rgba(56,189,248,0.06);
      color:var(--accent);
      border-color:rgba(56,189,248,0.18);
    }

    .cell.compare {
      animation: pulse 700ms ease;
    }

    @keyframes pulse{
      0%{ transform: translateY(-6px) scale(1); box-shadow:0 6px 18px rgba(56,189,248,0.06); }
      50%{ transform: translateY(-12px) scale(1.03); box-shadow:0 18px 26px rgba(56,189,248,0.08); }
      100%{ transform: translateY(-6px) scale(1); }
    }

    .boundary{
      position:relative;
      height:6px;
      background:transparent;
      margin-top:8px;
      display:flex;
      align-items:center;
    }

    .boundary .bar{
      height:6px;
      background:linear-gradient(90deg, rgba(99,102,241,0.18), rgba(96,165,250,0.12));
      border-radius:4px;
      transition: transform var(--transition), width var(--transition);
    }

    .indicators{
      display:flex;
      gap:var(--gap);
      align-items:center;
      justify-content:space-between;
      margin-top:6px;
    }

    .indicator{
      display:flex;
      gap:8px;
      align-items:center;
      color:var(--muted);
      font-size:13px;
    }

    .pointer{
      width:14px;
      height:14px;
      border-radius:50%;
      background:linear-gradient(180deg,#60a5fa,#38bdf8);
      display:inline-block;
      box-shadow:0 8px 20px rgba(56,189,248,0.12);
      border:2px solid rgba(255,255,255,0.04);
      transform:translateY(0);
      transition: transform var(--transition);
    }

    .status{
      display:flex;
      gap:var(--gap);
      align-items:center;
      flex-wrap:wrap;
    }

    .status .stat{
      background:rgba(255,255,255,0.02);
      padding:8px 12px;
      border-radius:8px;
      font-size:13px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,0.02);
    }

    /* pseudocode panel */
    .pseudocode{
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      padding:12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.02);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
      font-size:13px;
      color:var(--muted);
    }

    .code-line{
      padding:6px 8px;
      border-radius:6px;
    }
    .code-line.active{
      background:linear-gradient(90deg, rgba(56,189,248,0.08), rgba(96,165,250,0.03));
      color:var(--accent);
      font-weight:700;
    }

    /* responsiveness */
    @media (max-width:920px){
      main.content{ flex-direction:column; }
      .controls{ width:100%; }
      .workspace{ width:100%; }
      .array{ gap:10px; }
      .cell{ width:48px; height:48px; min-width:48px; }
    }

    /* small helper styles for accessibility */
    button[disabled]{
      opacity:0.5;
      cursor:not-allowed;
      transform:none !important;
      box-shadow:none;
    }

    footer.foot{
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:var(--gap);
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

  </style>
</head>
<body>
  <div class="safe-area" role="main">
    <header class="module-header" aria-labelledby="title">
      <div class="title-block">
        <h1 id="title">Binary Search — Interactive Module</h1>
        <p class="lead">Learn how binary search narrows a sorted array to find a target in O(log n) time — step through each comparison and see pointers, boundaries, and pseudocode update in real time.</p>
      </div>

      <div class="meta" aria-hidden="true">
        <div class="chip">Concept: Binary Search</div>
        <div class="chip">Safe margins: 24px</div>
      </div>
    </header>

    <!-- Informational panels requested by the design brief -->
    <section style="display:flex;gap:var(--gap);flex-wrap:wrap;">
      <div style="min-width:260px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);">
        <strong>Learning Objective</strong>
        <p style="margin:8px 0 0 0;color:var(--muted);font-size:13px;">
          After interacting you should be able to: visualize how low/high/mid change during each step, predict how many steps are required for a given array length, and link the algorithm's decisions to its logarithmic complexity.
        </p>
      </div>

      <div style="min-width:260px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);">
        <strong>Interaction Design (summary)</strong>
        <p style="margin:8px 0 0 0;color:var(--muted);font-size:13px;">
          Use controls to generate arrays, type a target, and press Step to advance one iteration (animated). Auto-Run continuously steps with adjustable speed. Visuals animate mid pointer movement, highlighted comparisons, and sliding low/high boundaries in response to user actions.
        </p>
      </div>

      <div style="min-width:260px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);">
        <strong>Layout Description (summary)</strong>
        <p style="margin:8px 0 0 0;color:var(--muted);font-size:13px;">
          Left column: controls & instructions; right column: workspace with array visualization, pointers, and pseudocode. Spacing respects 24px safe margins and 16px minimum gaps; responsive stacking at small widths.
        </p>
      </div>
    </section>

    <main class="content" aria-labelledby="title">
      <!-- Controls -->
      <aside class="controls" aria-label="Controls and settings">
        <div class="group">
          <h2>Array & Target</h2>
          <p>Generate a sorted array or enter custom values. Values must be numbers; custom entries should be comma-separated.</p>
          <label class="small">Array size</label>
          <div class="row">
            <select id="sizeSelect" aria-label="Array size">
              <option value="7">7</option>
              <option value="9" selected>9</option>
              <option value="11">11</option>
              <option value="15">15</option>
              <option value="21">21</option>
            </select>
            <button id="randomBtn" class="btn secondary" title="Generate sorted random array">Randomize</button>
            <button id="resetBtn" class="btn" title="Reset to a new array">Reset</button>
          </div>

          <label class="small" style="margin-top:8px;">Custom array (optional)</label>
          <input id="customArray" type="text" placeholder="e.g. 2,5,7,9,12" aria-label="Custom array input" />

          <label class="small" style="margin-top:8px;">Target value</label>
          <div class="row">
            <input id="targetInput" type="number" placeholder="Target number" aria-label="Target value"/>
            <button id="setTarget" class="btn secondary" title="Set target from input">Set</button>
          </div>
        </div>

        <div class="group">
          <h2>Controls</h2>
          <p>Step runs a single iteration with animation. Auto-run continuously steps.</p>
          <div class="control-actions">
            <button id="stepBtn" class="btn" title="Advance one iteration">Step</button>
            <button id="autoBtn" class="btn secondary" title="Toggle auto-run">Auto-Run</button>
            <button id="fastBtn" class="btn secondary" title="Complete search fast">Fast Complete</button>
            <button id="stopBtn" class="btn secondary" title="Stop auto-run" disabled>Stop</button>
          </div>

          <label class="small" style="margin-top:8px;">Speed (ms per step)</label>
          <div class="row">
            <input id="speed" type="number" min="100" max="2000" step="100" value="700" aria-label="Speed in milliseconds"/>
            <div style="font-size:13px;color:var(--muted);">Lower = faster</div>
          </div>
        </div>

        <div class="group">
          <h2>Explanation & Metrics</h2>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <div id="statusLive" aria-live="polite" class="status" style="flex-wrap:wrap;">
              <div class="stat">Low: <span id="lowVal">—</span></div>
              <div class="stat">Mid: <span id="midVal">—</span></div>
              <div class="stat">High: <span id="highVal">—</span></div>
              <div class="stat">Comparisons: <span id="cmpVal">0</span></div>
              <div class="stat">Steps (iter): <span id="stepsVal">0</span></div>
            </div>

            <div style="color:var(--muted);font-size:13px;">
              Complexity hint: Each step halves the search region. Max steps ≈ ceil(log2(n)).
            </div>
          </div>
        </div>

        <div class="group">
          <h2>Accessibility & Tips</h2>
          <p style="margin:0;color:var(--muted);font-size:13px;">
            Keyboard: focus "Step" and press Enter. Use Auto-Run to observe multiple steps. Use custom arrays to test edge cases.
          </p>
        </div>
      </aside>

      <!-- Workspace -->
      <section class="workspace" aria-label="Binary search workspace">
        <div class="visual" aria-hidden="false">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <strong>Array Visualization</strong>
            <div style="display:flex;gap:12px;align-items:center;">
              <div style="font-size:13px;color:var(--muted);">Target:</div>
              <div id="targetBadge" style="padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);min-width:44px;text-align:center;">—</div>
            </div>
          </div>

          <div class="array-wrap" role="region" aria-label="Array area">
            <div id="array" class="array" tabindex="0"></div>
            <div class="boundary" aria-hidden="true" style="margin-top:8px;">
              <div id="boundaryBar" class="bar" style="width:0;"></div>
            </div>
            <div class="indicators" aria-hidden="true">
              <div class="indicator"><span class="pointer" id="lowPointer" title="Low pointer"></span> low</div>
              <div class="indicator"><span class="pointer" id="midPointer" title="Mid pointer"></span> mid</div>
              <div class="indicator"><span class="pointer" id="highPointer" title="High pointer"></span> high</div>
            </div>
          </div>

          <div style="display:flex;gap:var(--gap);align-items:center;justify-content:space-between;margin-top:8px;">
            <div style="display:flex;gap:8px;align-items:center;">
              <div class="stat" id="resultMsg" aria-live="polite">Ready.</div>
            </div>
            <div style="display:flex;gap:12px;">
              <div style="font-size:13px;color:var(--muted);">Predicted max steps:</div>
              <div class="stat" id="predSteps">—</div>
            </div>
          </div>
        </div>

        <div class="pseudocode" aria-label="Pseudocode">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <strong>Pseudocode (highlighted during execution)</strong>
            <div style="font-size:13px;color:var(--muted);">Lines correspond to executed actions</div>
          </div>

          <div id="code">
            <div class="code-line" data-line="1">1: low = 0; high = n - 1</div>
            <div class="code-line" data-line="2">2: while low <= high:</div>
            <div class="code-line" data-line="3">3: &nbsp;&nbsp;&nbsp;&nbsp;mid = floor((low + high) / 2)</div>
            <div class="code-line" data-line="4">4: &nbsp;&nbsp;&nbsp;&nbsp;if A[mid] == target: return mid</div>
            <div class="code-line" data-line="5">5: &nbsp;&nbsp;&nbsp;&nbsp;elif target < A[mid]: high = mid - 1</div>
            <div class="code-line" data-line="6">6: &nbsp;&nbsp;&nbsp;&nbsp;else: low = mid + 1</div>
            <div class="code-line" data-line="7">7: return -1  # not found</div>
          </div>
        </div>

        <footer class="foot" style="margin-top:8px;">
          <div style="display:flex;gap:8px;align-items:center;">
            <div style="font-size:13px;color:var(--muted);">Note:</div>
            <div style="font-size:13px;color:var(--muted);max-width:680px;">
              The visualization animates mid selection and boundary shifts to help connect each comparison to the algorithm's narrowing effect.
            </div>
          </div>
          <div style="font-size:13px;color:var(--muted);">Built with vanilla HTML/CSS/JS — no external libraries.</div>
        </footer>
      </section>
    </main>
  </div>

  <script>
    /* Binary Search Interactive Module
       - Self-contained
       - Adheres to spacing and accessibility constraints
    */

    // DOM references
    const arrayEl = document.getElementById('array');
    const boundaryBar = document.getElementById('boundaryBar');
    const lowValEl = document.getElementById('lowVal');
    const midValEl = document.getElementById('midVal');
    const highValEl = document.getElementById('highVal');
    const cmpValEl = document.getElementById('cmpVal');
    const stepsValEl = document.getElementById('stepsVal');
    const predStepsEl = document.getElementById('predSteps');
    const resultMsgEl = document.getElementById('resultMsg');
    const targetBadge = document.getElementById('targetBadge');

    const sizeSelect = document.getElementById('sizeSelect');
    const randomBtn = document.getElementById('randomBtn');
    const resetBtn = document.getElementById('resetBtn');
    const customArray = document.getElementById('customArray');

    const targetInput = document.getElementById('targetInput');
    const setTargetBtn = document.getElementById('setTarget');

    const stepBtn = document.getElementById('stepBtn');
    const autoBtn = document.getElementById('autoBtn');
    const fastBtn = document.getElementById('fastBtn');
    const stopBtn = document.getElementById('stopBtn');
    const speedInput = document.getElementById('speed');

    const codeLines = document.querySelectorAll('.code-line');

    // State
    let arr = [];
    let low = 0;
    let high = -1;
    let mid = -1;
    let target = null;
    let comparisons = 0;
    let iterations = 0;
    let running = false;
    let autoInterval = null;
    let animating = false;

    // Utility functions
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
    function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

    function generateSortedRandom(n){
      // generate n unique random numbers in [1,99], sorted
      const pool = new Set();
      while(pool.size < n){
        pool.add(Math.floor(Math.random()*99)+1);
      }
      return Array.from(pool).sort((a,b)=>a-b);
    }

    function parseCustomArray(text){
      if(!text) return null;
      const parts = text.split(',').map(s => s.trim()).filter(Boolean);
      const nums = parts.map(s=>Number(s)).filter(x=>!Number.isNaN(x));
      if(nums.length !== parts.length){
        return null;
      }
      return nums.slice().sort((a,b)=>a-b);
    }

    function renderArray(){
      arrayEl.innerHTML = '';
      for(let i=0;i<arr.length;i++){
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.index = i;
        cell.setAttribute('role','button');
        cell.setAttribute('aria-label','Index '+i+' Value '+arr[i]);
        const idx = document.createElement('div');
        idx.className = 'index';
        idx.textContent = i;
        const val = document.createElement('div');
        val.className = 'value';
        val.textContent = arr[i];
        cell.appendChild(idx);
        cell.appendChild(val);
        arrayEl.appendChild(cell);
      }
      updatePointersVisual();
      updatePredicted();
    }

    function updatePredicted(){
      if(arr.length>0){
        predStepsEl.textContent = Math.ceil(Math.log2(arr.length+1));
      } else predStepsEl.textContent = '—';
    }

    function updatePointersVisual(){
      // highlight cells between low..high, highlight mid, animate boundary bar width & position
      const cells = Array.from(document.querySelectorAll('.cell'));
      cells.forEach(c => {
        c.classList.remove('mid','compare');
        c.style.opacity = 1;
      });

      // boundary bar - we position by computing left and right relative percentages
      if(arr.length === 0 || low > high){
        boundaryBar.style.width = '0%';
      } else {
        const totalW = arrayEl.scrollWidth;
        // compute left offset based on element positions
        const firstCell = cells[0];
        const lastCell = cells[cells.length-1];
        const rectFirst = firstCell.getBoundingClientRect();
        const rectLast = lastCell.getBoundingClientRect();
        // simpler: compute width fraction = (high - low + 1) / n
        const frac = (high - low + 1) / arr.length;
        const pct = Math.max(0, Math.min(100, frac * 100));
        boundaryBar.style.width = pct + '%';
        // transform to position - translateX by low/n * 100%
        const offsetPct = (low / arr.length) * 100;
        boundaryBar.style.transform = `translateX(${offsetPct}%)`;
      }

      // update stat text
      lowValEl.textContent = low >= 0 ? low : '—';
      midValEl.textContent = mid >= 0 ? mid : '—';
      highValEl.textContent = high >= 0 ? high : '—';
      cmpValEl.textContent = comparisons;
      stepsValEl.textContent = iterations;

      // highlight mid if valid
      if(mid >= 0 && mid < arr.length){
        const midCell = cells[mid];
        if(midCell) midCell.classList.add('mid');
      }

      // show target badge
      targetBadge.textContent = target !== null ? target : '—';
    }

    // pseudocode highlight helper
    function highlightLine(num){
      codeLines.forEach(line => {
        if(Number(line.dataset.line) === num) line.classList.add('active');
        else line.classList.remove('active');
      });
    }

    // Core: perform one iteration with animation (compute mid, compare, update low/high)
    async function stepIteration(animated=true){
      if(animating) return;
      if(low > high){
        // already ended
        resultMsgEl.textContent = 'Search complete: not found.';
        highlightLine(7);
        return;
      }
      if(target === null){
        resultMsgEl.textContent = 'Set a target value first.';
        return;
      }

      animating = true;
      iterations++;
      highlightLine(2);
      updatePointersVisual();
      await sleep(140);

      // compute mid
      highlightLine(3);
      mid = Math.floor((low + high) / 2);
      updatePointersVisual();
      // animate mid cell "compare" pulse
      const midCell = document.querySelector(`.cell[data-index="${mid}"]`);
      if(midCell){
        midCell.classList.add('compare');
      }
      await sleep(animated ? 500 : 0);

      // comparison
      comparisons++;
      cmpValEl.textContent = comparisons;
      highlightLine(4);
      updatePointersVisual();

      const val = arr[mid];
      if(val === target){
        // found
        if(midCell){
          midCell.classList.add('mid');
          midCell.style.background = 'linear-gradient(180deg, rgba(16,185,129,0.12), rgba(16,185,129,0.04))';
          midCell.style.color = 'var(--ok)';
        }
        resultMsgEl.textContent = 'Found at index ' + mid + '.';
        highlightLine(4);
        animating = false;
        stopAuto();
        return;
      }

      // not equal -> move boundary
      if(target < val){
        // target is left
        highlightLine(5);
        // update high = mid - 1 with animation (shrink)
        high = mid - 1;
        updatePointersVisual();
      } else {
        highlightLine(6);
        low = mid + 1;
        updatePointersVisual();
      }

      // small animation pause to show boundary shift
      await sleep(animated ? Math.max(100, Number(speedInput.value) - 200) : 0);

      // after update check termination
      if(low > high){
        highlightLine(7);
        resultMsgEl.textContent = 'Not found — search ended.';
        updatePointersVisual();
        animating = false;
        stopAuto();
        return;
      }

      resultMsgEl.textContent = 'Step complete — continuing.';
      animating = false;
    }

    // Auto-run control
    function startAuto(){
      if(running) return;
      running = true;
      autoBtn.textContent = 'Auto-Running';
      stopBtn.disabled = false;
      stepBtn.disabled = true;
      let ms = Math.max(100, Number(speedInput.value) || 700);
      autoInterval = setInterval(async () => {
        if(low > high){
          stopAuto();
          return;
        }
        await stepIteration(true);
      }, Math.max(150, ms));
    }
    function stopAuto(){
      running = false;
      autoBtn.textContent = 'Auto-Run';
      stopBtn.disabled = true;
      stepBtn.disabled = false;
      if(autoInterval) {
        clearInterval(autoInterval);
        autoInterval = null;
      }
    }
    function toggleAuto(){
      if(running) stopAuto(); else startAuto();
    }

    // Fast complete: complete search instantly without animation (use pure algorithm)
    function fastComplete(){
      if(target === null){
        resultMsgEl.textContent = 'Set a target before fast completion.';
        return;
      }
      let l = 0, h = arr.length - 1;
      while(l <= h){
        const m = Math.floor((l+h)/2);
        comparisons++;
        if(arr[m] === target){
          low = l; high = h; mid = m;
          iterations++;
          updatePointersVisual();
          resultMsgEl.textContent = 'Found at index ' + m + ' (fast).';
          highlightLine(4);
          stopAuto();
          return;
        }
        if(target < arr[m]) h = m - 1;
        else l = m + 1;
        iterations++;
      }
      low = l; high = h; mid = -1;
      updatePointersVisual();
      resultMsgEl.textContent = 'Not found (fast).';
      highlightLine(7);
      stopAuto();
    }

    // Initialization & event wiring
    function resetState(newArr){
      arr = newArr.slice();
      low = 0;
      high = arr.length - 1;
      mid = -1;
      comparisons = 0;
      iterations = 0;
      target = null;
      running = false;
      animating = false;
      if(autoInterval){ clearInterval(autoInterval); autoInterval = null; }
      stepBtn.disabled = false;
      stopBtn.disabled = true;
      autoBtn.textContent = 'Auto-Run';
      resultMsgEl.textContent = 'Array reset. Set target and step through.';
      updatePredicted();
      renderArray();
      highlightLine(1);
      targetBadge.textContent = '—';
      cmpValEl.textContent = 0;
      stepsValEl.textContent = 0;
    }

    // create initial array
    function init(){
      const initial = generateSortedRandom(Number(sizeSelect.value));
      resetState(initial);
    }

    // attach event listeners
    randomBtn.addEventListener('click', () => {
      const n = Number(sizeSelect.value);
      const a = generateSortedRandom(n);
      resetState(a);
      customArray.value = '';
    });

    resetBtn.addEventListener('click', () => {
      init();
      customArray.value = '';
    });

    sizeSelect.addEventListener('change', () => {
      // regenerate by size
      const n = Number(sizeSelect.value);
      const a = generateSortedRandom(n);
      resetState(a);
    });

    setTargetBtn.addEventListener('click', () => {
      const v = Number(targetInput.value);
      if(Number.isNaN(v)){
        resultMsgEl.textContent = 'Enter a valid numeric target.';
        return;
      }
      target = v;
      targetBadge.textContent = target;
      resultMsgEl.textContent = 'Target set to ' + target + '. Use Step to begin.';
      // reset comparisons/iterations for fresh search on same array
      comparisons = 0;
      iterations = 0;
      low = 0; high = arr.length - 1; mid = -1;
      cmpValEl.textContent = comparisons;
      stepsValEl.textContent = iterations;
      highlightLine(1);
      updatePointersVisual();
    });

    customArray.addEventListener('change', () => {
      const parsed = parseCustomArray(customArray.value);
      if(parsed === null || parsed.length === 0){
        resultMsgEl.textContent = 'Invalid custom array. Use comma-separated numbers.';
        return;
      }
      resetState(parsed);
      resultMsgEl.textContent = 'Custom array set (sorted).';
    });

    stepBtn.addEventListener('click', async () => {
      // single step
      await stepIteration(true);
    });

    // keyboard accessibility: Enter on Step when focused
    stepBtn.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); stepBtn.click(); }
    });

    autoBtn.addEventListener('click', () => {
      toggleAuto();
    });

    stopBtn.addEventListener('click', () => {
      stopAuto();
    });

    fastBtn.addEventListener('click', () => {
      fastComplete();
    });

    speedInput.addEventListener('change', () => {
      if(running){
        // restart auto with new speed
        stopAuto();
        startAuto();
      }
    });

    // Initialize ready
    init();

    // Small enhancement: clicking a cell sets target to that value
    arrayEl.addEventListener('click', (e) => {
      const cell = e.target.closest('.cell');
      if(!cell) return;
      const idx = Number(cell.dataset.index);
      if(Number.isFinite(idx)){
        target = arr[idx];
        targetBadge.textContent = target;
        targetInput.value = target;
        resultMsgEl.textContent = 'Target set to ' + target + ' (by clicking array).';
        comparisons = 0; iterations = 0; low = 0; high = arr.length - 1; mid = -1;
        cmpValEl.textContent = comparisons; stepsValEl.textContent = iterations;
        highlightLine(1);
        updatePointersVisual();
      }
    });

    // Ensure boundary bar realigns on window resize
    window.addEventListener('resize', () => {
      updatePointersVisual();
    });

    // Provide initial accessible focus
    stepBtn.focus();
  </script>
</body>
</html>