<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quick Sort Interactive Module</title>
  <style>
    :root{
      --safe-margin:24px;
      --gap:16px;
      --bg:#0f1724;
      --panel:#0b1220;
      --accent:#06b6d4;
      --muted:#94a3b8;
      --success:#10b981;
      --danger:#ef4444;
      --surface:#0b1220;
      --white:#ecfeff;
      --bar-color:#60a5fa;
      --bar-compare:#f59e0b;
      --bar-pivot:#ef4444;
      --bar-sorted:#10b981;
      --shadow: 0 6px 18px rgba(2,6,23,0.6);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      padding:var(--safe-margin);
      background:linear-gradient(180deg,var(--bg),#071022 120%);
      color:var(--white);
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }

    /* Container */
    .module{
      width:100%;
      max-width:1200px;
      display:grid;
      grid-template-columns:360px 1fr;
      gap:var(--gap);
      align-items:start;
    }

    /* Responsive: stack */
    @media (max-width:900px){
      .module{grid-template-columns:1fr; padding-bottom:40px}
    }

    /* Left panel: info + controls */
    .panel{
      background:linear-gradient(180deg,var(--panel),#071425);
      border-radius:12px;
      padding:20px;
      box-shadow:var(--shadow);
      min-height:320px;
      display:flex;
      flex-direction:column;
      gap:var(--gap);
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .title h1{
      margin:0;
      font-size:18px;
      letter-spacing:0.2px;
      color:var(--white);
    }
    .subtitle{
      margin:0;
      font-size:13px;
      color:var(--muted);
    }

    .info{
      background:rgba(255,255,255,0.02);
      padding:12px;
      border-radius:8px;
      font-size:13px;
      color:var(--muted);
      line-height:1.4;
    }

    .controls{
      display:flex;
      flex-direction:column;
      gap:var(--gap);
    }

    .row{
      display:flex;
      gap:var(--gap);
      align-items:center;
      flex-wrap:wrap;
    }

    label{font-size:13px;color:var(--muted);min-width:80px}

    .btn{
      appearance:none;
      border:0;
      background:linear-gradient(180deg,var(--accent),#0596a6);
      color:#012529;
      padding:10px 12px;
      border-radius:8px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 6px 16px rgba(3,105,118,0.16);
    }
    .btn.secondary{
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      color:var(--white);
      padding:8px 10px;
      font-weight:600;
    }
    .btn:disabled{opacity:0.5;cursor:not-allowed}

    .small{
      font-size:13px;
      color:var(--muted);
      background:rgba(255,255,255,0.02);
      padding:8px;
      border-radius:8px;
    }

    input[type="range"]{
      width:160px;
      accent-color:var(--accent);
    }

    select, input[type="number"], textarea{
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      color:var(--white);
      padding:8px;
      border-radius:8px;
      font-size:13px;
    }
    textarea{min-height:64px;resize:vertical}

    .footer-notes{
      font-size:12px;
      color:var(--muted);
      margin-top:auto;
    }

    /* Right: visualization */
    .stage{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius:12px;
      padding:16px;
      min-height:480px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:var(--gap);
    }

    .viz-top{
      display:flex;
      gap:var(--gap);
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .legend{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:13px}
    .legend .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:rgba(255,255,255,0.02);
      padding:8px 10px;
      border-radius:999px;
      font-size:13px;
      color:var(--muted);
    }
    .chip .dot{
      width:12px;height:12px;border-radius:3px;
    }

    /* Array container */
    .array-wrap{
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      padding:12px;
      border-radius:8px;
      min-height:260px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .bars{
      display:flex;
      gap:8px;
      align-items:end;
      height:260px;
      padding:8px;
      overflow-x:auto;
    }

    .bar{
      min-width:32px;
      width:48px;
      border-radius:6px 6px 4px 4px;
      background:linear-gradient(180deg,var(--bar-color),#2563eb);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      position:relative;
      transition:transform 300ms ease, background-color 200ms ease;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 6px 10px rgba(2,6,23,0.45);
    }

    .bar .val{
      color:rgba(255,255,255,0.95);
      font-size:12px;
      padding:6px 4px;
      transform:translateY(-6px);
    }

    .bar.compare{background:linear-gradient(180deg,var(--bar-compare),#b45309); transform:translateY(-6px)}
    .bar.pivot{background:linear-gradient(180deg,var(--bar-pivot),#b91c1c); transform:translateY(-10px)}
    .bar.sorted{background:linear-gradient(180deg,var(--bar-sorted),#059669); transform:translateY(-4px)}

    .pointer{
      position:absolute;
      top:-20px;
      font-size:12px;
      color:var(--muted);
      background:transparent;
      left:50%;
      transform:translateX(-50%);
    }

    /* Pseudocode */
    .pseudocode{
      background:rgba(255,255,255,0.02);
      padding:12px;
      border-radius:8px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
      font-size:13px;
      color:var(--muted);
      line-height:1.5;
    }
    .pseudocode pre{margin:0;white-space:pre-wrap}
    .pseudocode .line{display:block;padding:4px 8px;border-radius:6px}
    .pseudocode .active{background:linear-gradient(90deg, rgba(6,182,212,0.12), transparent); color:var(--white)}

    /* Recursion stack */
    .stack{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .stack .frame{
      background:rgba(255,255,255,0.02);
      padding:8px 10px;
      border-radius:8px;
      border:1px dashed rgba(255,255,255,0.03);
      color:var(--muted);
      font-size:13px;
    }

    /* helper */
    .muted{color:var(--muted)}
    .kbd{background:rgba(255,255,255,0.03);padding:4px 6px;border-radius:6px;font-size:12px}
    .control-row{display:flex;gap:var(--gap);align-items:center}
    .flex{flex:1}
    .vis-note{font-size:13px;color:var(--muted)}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <div class="module" role="application" aria-label="Quick Sort interactive module">
    <!-- Left Panel -->
    <aside class="panel" aria-labelledby="module-title">
      <div class="title">
        <h1 id="module-title">Quick Sort â€” Interactive Explorer</h1>
        <p class="subtitle">Visualize partitioning, pivot choice, and recursion with step-through control.</p>
      </div>

      <div class="info" aria-hidden="false">
        <strong>Concept Title:</strong> Quick Sort (Lomuto partition, with pivot strategies)
        <br><br>
        <strong>Learning Objective:</strong> After using this module you should be able to:
        <ul style="margin:8px 0 0 18px;color:var(--muted);">
          <li>Explain how partitioning around a pivot rearranges elements.</li>
          <li>Trace the recursive subdivisions Quick Sort makes.</li>
          <li>Observe how pivot choice affects comparisons and swaps.</li>
        </ul>
      </div>

      <div class="controls" aria-hidden="false">
        <div class="row control-row" style="align-items:center">
          <label for="size">Array size</label>
          <input id="size" type="range" min="5" max="30" value="12" aria-label="Array size slider" />
          <div class="small" id="size-val">12</div>
        </div>

        <div class="row" style="align-items:center">
          <label for="speed">Speed</label>
          <input id="speed" type="range" min="0.25" max="2.5" step="0.25" value="1" aria-label="Playback speed" />
          <div class="small" id="speed-val">1.0x</div>
        </div>

        <div class="row">
          <label for="pivot">Pivot</label>
          <select id="pivot" aria-label="Pivot strategy">
            <option value="last">Last element (Lomuto)</option>
            <option value="first">First element</option>
            <option value="random">Random</option>
            <option value="median">Median-of-three</option>
          </select>
        </div>

        <div class="row" style="align-items:center">
          <label>Array</label>
          <div style="display:flex;flex-direction:column;gap:8px;flex:1">
            <div style="display:flex;gap:8px">
              <button id="randomize" class="btn" aria-label="Randomize array">Randomize</button>
              <button id="reset" class="btn secondary" aria-label="Reset">Reset</button>
            </div>
            <div style="display:flex;gap:8px">
              <textarea id="custom" placeholder="Type comma-separated values e.g. 5,2,9,1" aria-label="Custom array input"></textarea>
              <button id="apply" class="btn secondary" aria-label="Apply custom array">Apply</button>
            </div>
            <div style="font-size:12px;color:var(--muted)">Tip: click two bars to swap them before starting to create a custom layout.</div>
          </div>
        </div>

        <div class="row" style="align-items:center">
          <label>Controls</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="play" class="btn" aria-label="Play animation">Play</button>
            <button id="pause" class="btn secondary" aria-label="Pause" disabled>Pause</button>
            <button id="step" class="btn secondary" aria-label="Step">Step</button>
            <button id="stop" class="btn secondary" aria-label="Stop" disabled>Stop</button>
          </div>
        </div>

        <div class="row">
          <label>Options</label>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="small" title="Show recursion frames">Show stack</label>
            <input type="checkbox" id="show-stack" checked aria-label="Toggle show recursion stack" />
          </div>
        </div>

      </div>

      <div class="footer-notes">
        Interaction design:
        <ul style="margin:8px 0 0 18px;color:var(--muted);">
          <li>Click a bar to select and click another to swap (pre-run).</li>
          <li>Use Step to advance one internal action (compare, swap, partition boundary).</li>
          <li>Pseudocode highlights current line to map visuals to code.</li>
        </ul>
      </div>
    </aside>

    <!-- Right Panel: Visualization -->
    <main class="stage" aria-live="polite">
      <div class="viz-top">
        <div class="legend" aria-hidden="true">
          <div class="chip"><span class="dot" style="background:var(--bar-pivot)"></span> Pivot</div>
          <div class="chip"><span class="dot" style="background:var(--bar-compare)"></span> Comparing</div>
          <div class="chip"><span class="dot" style="background:var(--bar-sorted)"></span> Placed / Sorted</div>
        </div>
        <div class="vis-note muted">Values shown inside bars. Hover or keyboard-focus bars for details.</div>
      </div>

      <section class="array-wrap" aria-label="Array visualization area">
        <div class="bars" id="bars" tabindex="0" role="list">
          <!-- Bars generated by JS -->
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="vis-note">Click two bars to swap before running. During run: bars animate on compare and swap.</div>
          <div class="vis-note muted">Pivot strategy: <span id="current-pivot">Last</span></div>
        </div>
      </section>

      <div style="display:grid;grid-template-columns:1fr 320px;gap:var(--gap);align-items:start">
        <div class="pseudocode" aria-label="Pseudocode" id="pseudocode" role="region">
          <strong style="display:block;margin-bottom:8px;color:var(--white)">Pseudocode (Lomuto)</strong>
          <pre id="code-block">
<span class="line" data-line="1">1 function quicksort(a, lo, hi)</span>
<span class="line" data-line="2">2   if lo &lt; hi:</span>
<span class="line" data-line="3">3     p = partition(a, lo, hi)</span>
<span class="line" data-line="4">4     quicksort(a, lo, p - 1)</span>
<span class="line" data-line="5">5     quicksort(a, p + 1, hi)</span>
<br>
<span class="line" data-line="6">6 function partition(a, lo, hi)</span>
<span class="line" data-line="7">7   pivot = a[hi]</span>
<span class="line" data-line="8">8   i = lo</span>
<span class="line" data-line="9">9   for j = lo to hi - 1:</span>
<span class="line" data-line="10">10    if a[j] &lt;= pivot:</span>
<span class="line" data-line="11">11      swap a[i], a[j]</span>
<span class="line" data-line="12">12      i = i + 1</span>
<span class="line" data-line="13">13  swap a[i], a[hi]</span>
<span class="line" data-line="14">14  return i</span>
          </pre>
        </div>

        <div style="display:flex;flex-direction:column;gap:var(--gap)">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong style="color:var(--white)">Recursion Stack</strong>
            <div class="muted">Active frames (lo..hi)</div>
          </div>
          <div class="stack" id="stack" aria-label="Recursion stack" role="list">
            <!-- frames -->
          </div>

          <div style="background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;color:var(--muted);font-size:13px">
            <strong>Interaction Design:</strong>
            <div style="margin-top:6px">
              - Play runs automatically; Pause stops; Step advances one internal action.
              <br>- Visual feedback: pivot (red), comparing (amber), and swaps animate movements.
              <br>- Pseudocode highlights the current operation to connect visual with code.
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    /*******************************************************************
     * Quick Sort Interactive Module
     * - Self-contained: vanilla JS, no external libraries
     * - Uses a generator to produce step events for visualization
     *******************************************************************/

    // DOM elements
    const barsEl = document.getElementById('bars');
    const sizeEl = document.getElementById('size');
    const sizeValEl = document.getElementById('size-val');
    const randomizeBtn = document.getElementById('randomize');
    const resetBtn = document.getElementById('reset');
    const applyBtn = document.getElementById('apply');
    const customEl = document.getElementById('custom');
    const playBtn = document.getElementById('play');
    const pauseBtn = document.getElementById('pause');
    const stepBtn = document.getElementById('step');
    const stopBtn = document.getElementById('stop');
    const speedEl = document.getElementById('speed');
    const speedVal = document.getElementById('speed-val');
    const pivotSelect = document.getElementById('pivot');
    const currentPivotSpan = document.getElementById('current-pivot');
    const pseudocode = document.getElementById('pseudocode');
    const codeLines = Array.from(document.querySelectorAll('.pseudocode .line'));
    const stackEl = document.getElementById('stack');
    const showStackEl = document.getElementById('show-stack');

    // State
    let array = [];
    let initialArray = [];
    let generator = null;
    let running = false;
    let paused = false;
    let stepMode = false;
    let speed = parseFloat(speedEl.value); // multiplier
    let pivotStrategy = pivotSelect.value;
    let selectedBarIndex = null;
    let isProcessing = false; // prevents control abuse
    let highlightTimeout = null;

    // config
    const baseDelay = 600; // ms per action at speed 1.0

    // Utilities
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    // Initialize
    function init(){
      sizeValEl.textContent = sizeEl.value;
      speedVal.textContent = parseFloat(speedEl.value).toFixed(2) + 'x';
      currentPivotSpan.textContent = pivotSelect.options[pivotSelect.selectedIndex].text;
      sizeEl.addEventListener('input', onSizeChange);
      speedEl.addEventListener('input', onSpeedChange);
      randomizeBtn.addEventListener('click', randomizeArray);
      resetBtn.addEventListener('click', resetArray);
      applyBtn.addEventListener('click', applyCustomArray);
      playBtn.addEventListener('click', onPlay);
      pauseBtn.addEventListener('click', onPause);
      stepBtn.addEventListener('click', onStep);
      stopBtn.addEventListener('click', onStop);
      pivotSelect.addEventListener('change', onPivotChange);
      showStackEl.addEventListener('change', () => { stackEl.style.display = showStackEl.checked ? 'flex':'none' });

      // initial array
      createRandomArray(parseInt(sizeEl.value,10));
      renderArray();
    }

    // Generate & render
    function createRandomArray(n){
      array = [];
      for(let i=0;i<n;i++){
        array.push(Math.floor(Math.random()*90)+5); // values 5..95
      }
      initialArray = array.slice();
    }

    function renderArray(){
      barsEl.innerHTML = '';
      barsEl.setAttribute('aria-label','Array with ' + array.length + ' elements');
      const maxVal = Math.max(...array, 1);
      array.forEach((v,i)=>{
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.setAttribute('role','listitem');
        bar.setAttribute('tabindex',0);
        bar.dataset.index = i;
        bar.style.height = ( (v / maxVal) * 100 ) + '%';
        bar.innerHTML = `<div class="pointer" aria-hidden="true"></div><div class="val">${v}</div>`;
        bar.title = 'Index: ' + i + ' Value: ' + v;
        bar.addEventListener('click', onBarClick);
        bar.addEventListener('keydown', e => { if(e.key==='Enter') onBarClick.call(bar,e); });
        barsEl.appendChild(bar);
      });
      clearHighlights();
      updateStack([]);
    }

    function updateBarsFromArray(){
      const maxVal = Math.max(...array, 1);
      const barEls = barsEl.querySelectorAll('.bar');
      barEls.forEach((bar,i)=>{
        const v = array[i];
        bar.style.height = ((v / maxVal) * 100) + '%';
        const valEl = bar.querySelector('.val');
        valEl.textContent = v;
        bar.title = 'Index: ' + i + ' Value: ' + v;
      });
    }

    // Controls handlers
    function onSizeChange(e){
      const n = parseInt(e.target.value,10);
      sizeValEl.textContent = n;
      createRandomArray(n);
      renderArray();
    }

    function onSpeedChange(e){
      speed = parseFloat(e.target.value);
      speedVal.textContent = speed.toFixed(2) + 'x';
    }

    function randomizeArray(){
      if(running) return;
      createRandomArray(parseInt(sizeEl.value,10));
      renderArray();
    }

    function resetArray(){
      if(running) return;
      array = initialArray.slice();
      renderArray();
    }

    function applyCustomArray(){
      if(running) return;
      const raw = customEl.value.trim();
      if(!raw) return;
      const parts = raw.split(',').map(s => parseInt(s.trim(),10)).filter(n => !isNaN(n));
      if(parts.length === 0) return;
      array = parts.slice(0, 60); // limit
      sizeEl.value = array.length;
      sizeValEl.textContent = array.length;
      initialArray = array.slice();
      renderArray();
    }

    function onPivotChange(){
      pivotStrategy = pivotSelect.value;
      currentPivotSpan.textContent = pivotSelect.options[pivotSelect.selectedIndex].text;
    }

    // Bar click: swap two selected bars before run
    function onBarClick(e){
      if(running) return; // do not allow swapping during run
      const idx = parseInt(this.dataset.index,10);
      if(selectedBarIndex === null){
        selectedBarIndex = idx;
        this.classList.add('pivot'); // highlight as chosen
      } else if(selectedBarIndex === idx){
        // deselect
        selectedBarIndex = null;
        this.classList.remove('pivot');
      } else {
        // swap values
        const a = selectedBarIndex, b = idx;
        [array[a], array[b]] = [array[b], array[a]];
        selectedBarIndex = null;
        renderArray();
      }
    }

    // Runner control
    function onPlay(){
      if(running) return;
      running = true;
      paused = false;
      isProcessing = false;
      playBtn.disabled = true;
      pauseBtn.disabled = false;
      stopBtn.disabled = false;
      stepBtn.disabled = false;
      runAuto();
    }

    function onPause(){
      if(!running) return;
      paused = true;
      running = false;
      playBtn.disabled = false;
      pauseBtn.disabled = true;
    }

    async function onStop(){
      // stops any run and resets to initial state
      running = false;
      paused = false;
      generator = null;
      playBtn.disabled = false;
      pauseBtn.disabled = true;
      stopBtn.disabled = true;
      stepBtn.disabled = false;
      // mark nothing as compared/pivot
      clearHighlights();
      updateBarsFromArray();
      updateStack([]);
      codeLines.forEach(l=>l.classList.remove('active'));
      isProcessing = false;
    }

    async function onStep(){
      // perform a single generator event
      if(isProcessing) return;
      if(!generator){
        // create new generator from current array
        generator = quicksortGenerator(array, pivotStrategy);
        updateStack([]); // will get updates from generator events
      }
      isProcessing = true;
      const res = generator.next();
      await handleEvent(res.value);
      if(res.done){
        finishRun();
      }
      isProcessing = false;
    }

    async function runAuto(){
      if(isProcessing) return;
      if(!generator){
        generator = quicksortGenerator(array, pivotStrategy);
        updateStack([]);
      }
      isProcessing = true;
      let next = generator.next();
      while(!next.done && running){
        await handleEvent(next.value);
        // respect pause flag
        if(!running) break;
        // delay between events based on speed; already included in handleEvent but add small gap
        next = generator.next();
      }
      if(next.done){
        finishRun();
      } else {
        isProcessing = false;
      }
    }

    function finishRun(){
      running = false;
      isProcessing = false;
      generator = null;
      playBtn.disabled = false;
      pauseBtn.disabled = true;
      stopBtn.disabled = true;
      stepBtn.disabled = false;
      // mark all as sorted
      const barEls = document.querySelectorAll('.bar');
      barEls.forEach(b => { b.classList.remove('compare','pivot'); b.classList.add('sorted'); });
      updateStack([]);
      highlightCode(null);
    }

    // Event handler for generator events
    async function handleEvent(evt){
      if(!evt) return;
      const delay = Math.max(60, baseDelay / (speed || 1));
      if(evt.type === 'info'){
        // update stack display
        if(evt.stack) updateStack(evt.stack);
      }
      if(evt.type === 'range'){
        updateStack(evt.stack);
        highlightCode(2); // quicksort condition line
        await sleep(Math.min(150, delay/4));
      }
      if(evt.type === 'pivot'){
        highlightCode(7);
        markPivot(evt.index);
        await sleep(delay/2);
      }
      if(evt.type === 'compare'){
        highlightCode(10);
        markCompare(evt.i, evt.j);
        await sleep(delay);
        clearCompare(evt.i, evt.j);
      }
      if(evt.type === 'swap'){
        highlightCode(11);
        await animateSwap(evt.i, evt.j, delay);
      }
      if(evt.type === 'place'){
        // when pivot is placed
        highlightCode(13);
        markPlaced(evt.index);
        await sleep(delay/1.2);
      }
      if(evt.type === 'done'){
        highlightCode(null);
      }
      // small pause between events
      await sleep(10);
    }

    // Visual helpers
    function clearHighlights(){
      const bars = barsEl.querySelectorAll('.bar');
      bars.forEach(b => b.classList.remove('compare','pivot','sorted'));
    }

    function markPivot(idx){
      clearCompareMarks();
      clearPivotMarks();
      const b = barsEl.querySelector('.bar[data-index="'+idx+'"]');
      if(b) b.classList.add('pivot');
    }
    function clearPivotMarks(){
      barsEl.querySelectorAll('.bar.pivot').forEach(b => b.classList.remove('pivot'));
    }
    function markCompare(i,j){
      const bi = barsEl.querySelector('.bar[data-index="'+i+'"]');
      const bj = barsEl.querySelector('.bar[data-index="'+j+'"]');
      if(bi) bi.classList.add('compare');
      if(bj) bj.classList.add('compare');
    }
    function clearCompareMarks(){
      barsEl.querySelectorAll('.bar.compare').forEach(b => b.classList.remove('compare'));
    }
    function clearCompare(i,j){
      if(typeof i !== 'undefined'){
        const bi = barsEl.querySelector('.bar[data-index="'+i+'"]');
        const bj = barsEl.querySelector('.bar[data-index="'+j+'"]');
        if(bi) bi.classList.remove('compare');
        if(bj) bj.classList.remove('compare');
      } else {
        clearCompareMarks();
      }
    }

    function markPlaced(idx){
      const b = barsEl.querySelector('.bar[data-index="'+idx+'"]');
      if(b){
        b.classList.remove('compare','pivot');
        b.classList.add('sorted');
      }
    }

    // Animate swapping two elements visually and in DOM array mapping
    async function animateSwap(i, j, delay){
      if(i===j) return;
      const barA = barsEl.querySelector('.bar[data-index="'+i+'"]');
      const barB = barsEl.querySelector('.bar[data-index="'+j+'"]');
      if(!barA || !barB) return;

      // For smooth animation we will swap heights and values rather than reorder DOM nodes.
      // Also swap in the underlying array.
      [array[i], array[j]] = [array[j], array[i]];

      // animate by applying transform bounce
      barA.classList.add('compare');
      barB.classList.add('compare');

      updateBarsFromArray();

      // small visual bounce
      barA.style.transform = 'translateY(-10px)';
      barB.style.transform = 'translateY(-10px)';
      await sleep(Math.min(200, delay/3));
      barA.style.transform = '';
      barB.style.transform = '';
      await sleep(Math.min(200, delay/3));
      clearCompareMarks();
    }

    // Pseudocode highlighting (line numbers correspond to data-line attributes)
    function highlightCode(lineNumber){
      codeLines.forEach(l=>{
        l.classList.toggle('active', parseInt(l.dataset.line,10) === lineNumber);
      });
    }

    // Stack display
    function updateStack(frames){
      stackEl.innerHTML = '';
      if(!showStackEl.checked) { stackEl.style.display = 'none'; return; }
      stackEl.style.display = 'flex';
      // frames is array of [lo,hi]
      for(let i=frames.length-1;i>=0;i--){
        const f = frames[i];
        const div = document.createElement('div');
        div.className = 'frame';
        div.textContent = '['+f[0]+' .. '+f[1]+']';
        stackEl.appendChild(div);
      }
      if(frames.length===0){
        const div = document.createElement('div');
        div.className = 'frame';
        div.textContent = '(empty)';
        stackEl.appendChild(div);
      }
    }

    /****************************************************************
     * Generator-based QuickSort implementation:
     * - Yields event objects describing operations for visualization.
     * - Uses Lomuto partition by default, but supports several pivot strategies.
     ****************************************************************/
    function* quicksortGenerator(arr, pivotStrategy){
      const n = arr.length;
      let stack = [[0, n-1]];
      // We'll maintain our own stack of frames to show to the UI.
      while(stack.length > 0){
        const [lo, hi] = stack.pop();
        // expose current stack for UI
        yield { type: 'range', stack: stack.concat([[lo,hi]]) };
        if(lo < hi){
          // perform partition, yield events
          const p = yield* partitionGenerator(arr, lo, hi, pivotStrategy);
          // after partition, push right and left
          stack.push([p+1, hi]);
          stack.push([lo, p-1]);
        }
        // small info yield
        yield { type: 'info', stack: stack.slice() };
      }
      yield { type: 'done' };
    }

    function* partitionGenerator(arr, lo, hi, pivotStrategy){
      // choose pivot index according to strategy
      let pivotIndex = choosePivotIndex(arr, lo, hi, pivotStrategy);
      // move chosen pivot to hi if it's not already hi (we'll treat pivot as arr[hi] in Lomuto)
      if(pivotIndex !== hi){
        // swap pivotIndex and hi
        yield { type: 'swap', i: pivotIndex, j: hi };
        // reflect swap in arr (happens in animateSwap as well)
      }
      yield { type: 'pivot', index: hi };
      let pivot = arr[hi];

      let i = lo;
      for(let j = lo; j <= hi - 1; j++){
        yield { type: 'compare', i: j, j: hi };
        if(arr[j] <= pivot){
          // swap arr[i] and arr[j]
          yield { type: 'swap', i: i, j: j };
          i++;
        }
      }
      // place pivot at index i
      yield { type: 'swap', i: i, j: hi };
      yield { type: 'place', index: i };
      return i;
    }

    function choosePivotIndex(arr, lo, hi, strategy){
      if(strategy === 'last') return hi;
      if(strategy === 'first') return lo;
      if(strategy === 'random') return lo + Math.floor(Math.random() * (hi - lo + 1));
      if(strategy === 'median'){
        const mid = lo + Math.floor((hi - lo) / 2);
        const trio = [
          {idx: lo, val: arr[lo]},
          {idx: mid, val: arr[mid]},
          {idx: hi, val: arr[hi]}
        ];
        trio.sort((a,b)=>a.val-b.val);
        return trio[1].idx;
      }
      return hi;
    }

    // Initialize module
    init();

    // Ensure keyboard accessibility for main actions
    document.addEventListener('keydown', (e)=>{
      if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
      if(e.key === ' ') { e.preventDefault(); onPlay(); }
      if(e.key === 'p') { onPause(); }
      if(e.key === 's') { onStep(); }
      if(e.key === 'r') { randomizeArray(); }
    });
  </script>
</body>
</html>