<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Quick Sort Visualizer</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --bg: #0f172a;
    --panel: #111827;
    --muted: #6b7280;
    --accent: #4e79a7;
    --pivot: #f28e2b;
    --swap: #e15759;
    --sorted: #59a14f;
    --i: #76b7b2;
    --j: #b07aa1;
    --faded: 0.2;
  }
  html, body {
    margin: 0;
    padding: 0;
    background: linear-gradient(180deg, #0b1021, #0e1222);
    color: #e5e7eb;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
  }
  .app {
    max-width: 1100px;
    margin: 24px auto;
    padding: 0 16px 40px;
  }
  header h1 {
    margin: 0 0 6px;
    font-weight: 700;
    letter-spacing: 0.2px;
  }
  header p {
    margin: 0 0 16px;
    color: var(--muted);
  }
  .controls {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }
  .panel {
    background: rgba(17, 24, 39, 0.7);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 10px;
    padding: 12px;
    backdrop-filter: blur(4px);
  }
  .panel h3 {
    margin: 0 0 10px;
    font-size: 15px;
    color: #cbd5e1;
  }
  .row {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }
  label {
    font-size: 13px;
    color: #cbd5e1;
  }
  input[type="text"] {
    flex: 1;
    min-width: 220px;
    background: #0b1220;
    border: 1px solid rgba(255,255,255,0.12);
    color: #e5e7eb;
    border-radius: 8px;
    padding: 8px 10px;
    outline: none;
  }
  input[type="number"] {
    width: 90px;
    background: #0b1220;
    border: 1px solid rgba(255,255,255,0.12);
    color: #e5e7eb;
    border-radius: 8px;
    padding: 7px 10px;
    outline: none;
  }
  select, input[type="range"] {
    background: #0b1220;
    border: 1px solid rgba(255,255,255,0.12);
    color: #e5e7eb;
    border-radius: 8px;
    padding: 6px 10px;
    outline: none;
  }
  .btn {
    appearance: none;
    background: linear-gradient(180deg, #0f1c34, #0c1528);
    border: 1px solid rgba(255,255,255,0.12);
    color: #e5e7eb;
    border-radius: 8px;
    padding: 8px 12px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 120ms ease, box-shadow 120ms ease, background 200ms ease;
  }
  .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.25);
  }
  .btn.primary {
    background: linear-gradient(180deg, #215a98, #174574);
    border-color: rgba(78,121,167,0.8);
  }
  .btn.warn {
    background: linear-gradient(180deg, #8c2c2d, #6c2122);
    border-color: rgba(225,87,89,0.8);
  }
  .btn.success {
    background: linear-gradient(180deg, #2c7f45, #226238);
    border-color: rgba(89,161,79,0.8);
  }
  .chart-wrapper {
    background: rgba(17, 24, 39, 0.7);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 10px;
    padding: 12px 12px 6px;
    margin-bottom: 16px;
  }
  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 2px 4px 8px;
  }
  .chart-header .title {
    font-size: 15px;
    color: #cbd5e1;
  }
  .chart-header .meta {
    font-size: 12px;
    color: var(--muted);
  }
  #chart {
    position: relative;
    height: 320px;
    width: 100%;
    background: radial-gradient(circle at 30% 20%, rgba(78,121,167,0.08), rgba(255,255,255,0.02));
    border-radius: 8px;
    overflow: hidden;
  }
  .bar {
    position: absolute;
    bottom: 0;
    width: 20px;
    border-radius: 6px 6px 0 0;
    background: var(--accent);
    box-shadow: 0 2px 8px rgba(78,121,167,0.35);
    transition: left 280ms ease, height 260ms ease, background-color 180ms ease, transform 120ms ease, opacity 180ms ease, border-color 180ms ease;
    border: 2px solid transparent;
  }
  .bar .label {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    color: #cbd5e1;
    white-space: nowrap;
    background: rgba(2,6,23,0.6);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 6px;
    padding: 2px 4px;
    pointer-events: none;
    opacity: 0.9;
  }
  .bar.pivot {
    background: var(--pivot);
    border-color: rgba(242,142,43,0.7);
    box-shadow: 0 2px 12px rgba(242,142,43,0.45);
  }
  .bar.i {
    outline: 2px dashed rgba(118,183,178,0.9);
    box-shadow: 0 2px 10px rgba(118,183,178,0.5);
  }
  .bar.j {
    outline: 2px dashed rgba(176,122,161,0.9);
    box-shadow: 0 2px 10px rgba(176,122,161,0.5);
  }
  .bar.swap {
    animation: pulse 300ms ease-in-out;
    border-color: rgba(225,87,89,0.9);
    background: var(--swap);
    box-shadow: 0 2px 12px rgba(225,87,89,0.6);
  }
  .bar.sorted {
    background: var(--sorted);
    border-color: rgba(89,161,79,0.8);
    box-shadow: 0 2px 12px rgba(89,161,79,0.55);
  }
  .bar.faded {
    opacity: var(--faded);
    filter: saturate(0.6);
  }
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  .legend {
    display: flex;
    flex-wrap: wrap;
    gap: 8px 16px;
    align-items: center;
    font-size: 12px;
    color: #cbd5e1;
    margin: 6px 4px 6px;
  }
  .legend .key {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .legend .dot {
    width: 14px; height: 14px; border-radius: 4px;
    display: inline-block;
    border: 2px solid transparent;
  }
  .dot.p { background: var(--pivot); border-color: rgba(242,142,43,0.7); }
  .dot.i { background: #0b1220; border-color: rgba(118,183,178,0.9); }
  .dot.j { background: #0b1220; border-color: rgba(176,122,161,0.9); }
  .dot.s { background: var(--sorted); border-color: rgba(89,161,79,0.8); }
  .dot.sw { background: var(--swap); border-color: rgba(225,87,89,0.9); }
  .stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .stat-panel {
    background: rgba(17, 24, 39, 0.7);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 10px;
    padding: 12px;
  }
  .stat-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 10px;
    font-size: 13px;
    color: #cbd5e1;
  }
  .value {
    font-weight: 700;
    color: #e5e7eb;
  }
  .code {
    background: #0a0f1f;
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px;
    padding: 10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 12px;
    line-height: 1.45;
    color: #cbd5e1;
    overflow: auto;
    max-height: 240px;
  }
  .code .hl {
    background: rgba(78,121,167,0.18);
    border-left: 3px solid rgba(78,121,167,0.7);
    padding-left: 6px;
    margin-left: -6px;
  }
  .footer {
    font-size: 12px;
    color: var(--muted);
    text-align: center;
    margin-top: 18px;
  }
</style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Quick Sort Visualizer</h1>
      <p>Interactively step through the Quick Sort algorithm (Lomuto partition) with pivot strategies and adjustable speed.</p>
    </header>

    <section class="controls">
      <div class="panel">
        <h3>Input</h3>
        <div class="row" style="margin-bottom:8px">
          <input id="inputArray" type="text" placeholder="Enter numbers separated by commas (e.g., 5, 3, 8, 2, 9)" />
        </div>
        <div class="row">
          <label for="randCount">Random size</label>
          <input id="randCount" type="number" min="5" max="60" value="20" />
          <button id="btnRandom" class="btn">Generate Random</button>
        </div>
      </div>

      <div class="panel">
        <h3>Settings</h3>
        <div class="row">
          <label for="pivotSelect">Pivot strategy</label>
          <select id="pivotSelect">
            <option value="last">Last element (Lomuto)</option>
            <option value="random">Random pivot</option>
          </select>
        </div>
        <div class="row">
          <label for="speedRange">Speed</label>
          <input id="speedRange" type="range" min="0.25" max="5" step="0.25" value="2" />
          <span id="speedLabel">2.0x</span>
        </div>
      </div>

      <div class="panel">
        <h3>Actions</h3>
        <div class="row">
          <button id="btnSort" class="btn primary">Build Steps</button>
          <button id="btnPlay" class="btn success">Play</button>
          <button id="btnStep" class="btn">Step</button>
          <button id="btnReset" class="btn warn">Reset</button>
        </div>
      </div>
    </section>

    <section class="chart-wrapper">
      <div class="chart-header">
        <div class="title">Array Visualization</div>
        <div class="meta"><span id="stepInfo">Step 0 / 0</span> • <span id="rangeInfo">Range: —</span> • <span id="pointerInfo">i: —, j: —, pivot: —</span></div>
      </div>
      <div id="chart" aria-label="Bars represent array values"></div>
      <div class="legend">
        <span class="key"><span class="dot p"></span> Pivot</span>
        <span class="key"><span class="dot i"></span> i pointer</span>
        <span class="key"><span class="dot j"></span> j pointer</span>
        <span class="key"><span class="dot sw"></span> Swap</span>
        <span class="key"><span class="dot s"></span> Sorted (final position)</span>
      </div>
    </section>

    <section class="stats">
      <div class="stat-panel">
        <h3>Run Stats</h3>
        <div class="stat-grid">
          <div>Comparisons<br><span class="value" id="cmpCount">0</span></div>
          <div>Swaps<br><span class="value" id="swapCount">0</span></div>
          <div>Size<br><span class="value" id="sizeInfo">0</span></div>
        </div>
      </div>
      <div class="stat-panel">
        <h3>Algorithm (Lomuto Partition)</h3>
        <pre class="code" id="codeBlock"><code>
function quickSort(A, low, high) {
  if (low &lt; high) {          // 1
    let p = partition(A, low, high); // 2
    quickSort(A, low, p - 1);        // 3
    quickSort(A, p + 1, high);       // 4
  }
}

function partition(A, low, high) {
  let pivot = A[high];       // 5
  let i = low;               // 6
  for (let j = low; j &lt; high; j++) { // 7
    if (A[j] &lt;= pivot) {     // 8
      swap(A, i, j);         // 9
      i++;                   // 10
    }
  }
  swap(A, i, high);          // 11
  return i;                  // 12
}
        </code></pre>
      </div>
    </section>

    <div class="footer">Tip: Click "Generate Random", then "Build Steps", then "Play" or "Step" through the sort. Resize the window to reflow bars.</div>
  </div>

<script>
(function() {
  const chart = document.getElementById('chart');
  const inputArrayEl = document.getElementById('inputArray');
  const randCountEl = document.getElementById('randCount');
  const btnRandom = document.getElementById('btnRandom');
  const btnSort = document.getElementById('btnSort');
  const btnPlay = document.getElementById('btnPlay');
  const btnStep = document.getElementById('btnStep');
  const btnReset = document.getElementById('btnReset');
  const pivotSelect = document.getElementById('pivotSelect');
  const speedRange = document.getElementById('speedRange');
  const speedLabel = document.getElementById('speedLabel');

  const stepInfo = document.getElementById('stepInfo');
  const rangeInfo = document.getElementById('rangeInfo');
  const pointerInfo = document.getElementById('pointerInfo');
  const cmpCountEl = document.getElementById('cmpCount');
  const swapCountEl = document.getElementById('swapCount');
  const sizeInfoEl = document.getElementById('sizeInfo');
  const codeBlock = document.getElementById('codeBlock');

  const app = {
    initialValues: [],
    objects: [],     // [{id, value}]
    state: [],       // working array of objects
    idMap: new Map(),// id => element
    steps: [],
    stepIndex: 0,
    playing: false,
    timer: null,
    speed: 2,
    pivotStrategy: 'last',
    layout: {gap: 6, step: 30, barWidth: 20, height: 320, minH: 16},
    counters: {comparisons: 0, swaps: 0},
    pointers: {i: null, j: null, pivot: null, range: null},
    minVal: 0,
    maxVal: 0
  };

  function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
  function randInt(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }

  function parseInput(str) {
    const parts = str.split(/[, \t\r\n]+/).filter(Boolean);
    const vals = [];
    for (const p of parts) {
      const num = Number(p);
      if (!Number.isFinite(num)) continue;
      vals.push(num);
    }
    return vals;
  }

  function generateRandom(count) {
    const n = clamp(Number(count) || 20, 5, 60);
    const vals = [];
    // allow duplicates; values range roughly 1..100
    for (let i = 0; i < n; i++) {
      vals.push(randInt(1, 100));
    }
    return vals;
  }

  function init(values) {
    stop();
    app.initialValues = values.slice();
    app.objects = values.map((v, idx) => ({ id: idx + 1, value: v }));
    app.state = app.objects.map(o => ({ id: o.id, value: o.value }));
    app.counters.comparisons = 0;
    app.counters.swaps = 0;
    app.steps = [];
    app.stepIndex = 0;
    app.pointers = {i: null, j: null, pivot: null, range: null};
    app.minVal = Math.min(...values);
    app.maxVal = Math.max(...values);
    sizeInfoEl.textContent = String(values.length);
    setupBars();
    updateUI();
    highlightCode(null);
  }

  function setupBars() {
    chart.innerHTML = '';
    app.idMap.clear();
    updateLayout();
    for (let idx = 0; idx < app.state.length; idx++) {
      const obj = app.state[idx];
      const bar = document.createElement('div');
      bar.className = 'bar';
      bar.dataset.id = String(obj.id);

      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = String(obj.value);
      bar.appendChild(label);

      chart.appendChild(bar);
      app.idMap.set(obj.id, bar);
    }
    updateBarsPos(true);
  }

  function updateLayout() {
    const w = chart.clientWidth;
    const n = Math.max(1, app.state.length);
    const gap = app.layout.gap;
    const step = w / n;
    const barWidth = clamp(step - gap, 8, 40);
    app.layout.step = step;
    app.layout.barWidth = barWidth;
    app.layout.height = chart.clientHeight || 320;
    applyBarSize();
  }

  function applyBarSize() {
    for (let idx = 0; idx < app.state.length; idx++) {
      const obj = app.state[idx];
      const el = app.idMap.get(obj.id);
      if (!el) continue;
      el.style.width = app.layout.barWidth + 'px';
    }
    updateBarsPos(false);
  }

  function valueToHeight(v) {
    const pad = 24;
    const H = app.layout.height - pad;
    const minV = app.minVal;
    const maxV = app.maxVal;
    const range = Math.max(1, maxV - minV);
    const norm = (v - minV) / range;
    return Math.max(app.layout.minH, Math.round(norm * H) + 8);
  }

  function updateBarsPos(initial = false) {
    for (let idx = 0; idx < app.state.length; idx++) {
      const obj = app.state[idx];
      const el = app.idMap.get(obj.id);
      if (!el) continue;
      const left = Math.round(idx * app.layout.step + (app.layout.step - app.layout.barWidth) / 2);
      el.style.left = left + 'px';
      el.style.height = valueToHeight(obj.value) + 'px';
      const label = el.querySelector('.label');
      if (label) label.textContent = String(obj.value);
      if (initial) {
        el.classList.remove('pivot','i','j','swap','sorted','faded');
      }
    }
  }

  function clearTransientHighlights() {
    for (const el of app.idMap.values()) {
      el.classList.remove('pivot','i','j','swap');
    }
  }

  function applyRangeShading() {
    const range = app.pointers.range;
    for (let idx = 0; idx < app.state.length; idx++) {
      const el = app.idMap.get(app.state[idx].id);
      if (!el) continue;
      if (range && (idx < range[0] || idx > range[1])) {
        el.classList.add('faded');
      } else {
        el.classList.remove('faded');
      }
    }
  }

  function markSortedIndex(index) {
    const obj = app.state[index];
    if (!obj) return;
    const el = app.idMap.get(obj.id);
    if (el) {
      el.classList.add('sorted');
      el.classList.remove('pivot','i','j','swap');
    }
  }

  function swapStateIndices(a, b) {
    if (a === b) return;
    const tmp = app.state[a];
    app.state[a] = app.state[b];
    app.state[b] = tmp;
    updateBarsPos(false);
  }

  function buildQuickSortSteps(values, pivotStrategy) {
    const arr = values.slice();
    const steps = [];

    function quickSort(low, high) {
      if (low >= high) {
        // Range of length 0 or 1 is trivially sorted; optionally mark
        if (low === high) steps.push({ type: 'sortedRange', low, high });
        return;
      }
      steps.push({ type: 'subrange', low, high });

      let pivotIndex = high;
      if (pivotStrategy === 'random') {
        const r = randInt(low, high);
        steps.push({ type: 'choosePivot', index: r });
        if (r !== high) {
          steps.push({ type: 'swap', a: r, b: high });
          const t = arr[r]; arr[r] = arr[high]; arr[high] = t;
        }
        pivotIndex = high;
      } else {
        steps.push({ type: 'choosePivot', index: pivotIndex });
      }

      const pivotVal = arr[pivotIndex];
      let i = low;
      steps.push({ type: 'iSet', index: i, origin: 'init' });
      for (let j = low; j < high; j++) {
        steps.push({ type: 'compare', j, pivotIndex });
        if (arr[j] <= pivotVal) {
          if (i !== j) {
            steps.push({ type: 'swap', a: i, b: j });
            const t = arr[i]; arr[i] = arr[j]; arr[j] = t;
          } else {
            steps.push({ type: 'touch', index: j });
          }
          i++;
          steps.push({ type: 'iSet', index: i, origin: 'inc' });
        }
      }
      steps.push({ type: 'finalSwap', a: i, b: high });
      const t2 = arr[i]; arr[i] = arr[high]; arr[high] = t2;
      steps.push({ type: 'pivotPlaced', index: i });

      quickSort(low, i - 1);
      quickSort(i + 1, high);
    }

    quickSort(0, arr.length - 1);
    steps.push({ type: 'done' });

    return steps;
  }

  function updateUI() {
    stepInfo.textContent = `Step ${app.stepIndex} / ${app.steps.length}`;
    rangeInfo.textContent = app.pointers.range ? `Range: [${app.pointers.range[0]}, ${app.pointers.range[1]}]` : 'Range: —';
    const p = app.pointers;
    pointerInfo.textContent = `i: ${p.i ?? '—'}, j: ${p.j ?? '—'}, pivot: ${p.pivot ?? '—'}`;
    cmpCountEl.textContent = String(app.counters.comparisons);
    swapCountEl.textContent = String(app.counters.swaps);
    btnPlay.textContent = app.playing ? 'Pause' : 'Play';
    btnStep.disabled = app.steps.length === 0 || app.stepIndex >= app.steps.length;
    btnPlay.disabled = app.steps.length === 0 || app.stepIndex >= app.steps.length;
  }

  function highlightCode(step) {
    // Remove previous highlights
    const lines = codeBlock.querySelectorAll('code');
    if (!lines.length) return;
    // We'll reconstruct by scanning text nodes; simpler: wrap based on indices known
    // Instead, we'll apply highlights by innerHTML manipulation once then use CSS classes.
    // To keep simple, we mark by replacing patterns each call. But avoid intense DOM work.
    // We'll maintain a map of line numbers to content. For brevity, we re-render once.
  }

  // Efficient code highlighting: pre-split lines once
  const codeLines = [
    'function quickSort(A, low, high) {',
    '  if (low < high) {          // 1',
    '    let p = partition(A, low, high); // 2',
    '    quickSort(A, low, p - 1);        // 3',
    '    quickSort(A, p + 1, high);       // 4',
    '  }',
    '}',
    '',
    'function partition(A, low, high) {',
    '  let pivot = A[high];       // 5',
    '  let i = low;               // 6',
    '  for (let j = low; j < high; j++) { // 7',
    '    if (A[j] <= pivot) {     // 8',
    '      swap(A, i, j);         // 9',
    '      i++;                   // 10',
    '    }',
    '  }',
    '  swap(A, i, high);          // 11',
    '  return i;                  // 12',
    '}'
  ];
  function renderCode(stepType) {
    const highlight = new Set();
    switch (stepType) {
      case 'subrange': highlight.add(1); break; // "if (low < high)"
      case 'choosePivot': highlight.add(9); highlight.add(10); break; // pivot and i init soon
      case 'iSet': highlight.add(10); break;
      case 'compare': highlight.add(11); highlight.add(12); break; // for and if
      case 'swap': highlight.add(13); break; // swap(A, i, j)
      case 'finalSwap': highlight.add(17); break; // swap(A, i, high)
      case 'pivotPlaced': highlight.add(2); break; // partition returns -> p
      case 'done': break;
      default: break;
    }
    const html = codeLines.map((ln, idx) => {
      const lineNo = idx + 1;
      return `<div class="${highlight.has(lineNo) ? 'hl' : ''}">${ln.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>`;
    }).join('');
    codeBlock.innerHTML = `<code>${html}</code>`;
  }

  function applyStep(step) {
    clearTransientHighlights();
    switch (step.type) {
      case 'subrange': {
        app.pointers.range = [step.low, step.high];
        applyRangeShading();
        app.pointers.i = null;
        app.pointers.j = null;
        app.pointers.pivot = null;
        renderCode('subrange');
        break;
      }
      case 'choosePivot': {
        app.pointers.pivot = step.index;
        const el = app.idMap.get(app.state[step.index].id);
        if (el) el.classList.add('pivot');
        renderCode('choosePivot');
        break;
      }
      case 'iSet': {
        app.pointers.i = step.index;
        const el = app.idMap.get(app.state[step.index]?.id);
        if (el) el.classList.add('i');
        renderCode('iSet');
        break;
      }
      case 'compare': {
        app.pointers.j = step.j;
        app.pointers.pivot = step.pivotIndex;
        app.counters.comparisons++;
        const jEl = app.idMap.get(app.state[step.j].id);
        if (jEl) jEl.classList.add('j');
        const pEl = app.idMap.get(app.state[step.pivotIndex].id);
        if (pEl) pEl.classList.add('pivot');
        renderCode('compare');
        break;
      }
      case 'swap': {
        app.counters.swaps++;
        swapStateIndices(step.a, step.b);
        const aEl = app.idMap.get(app.state[step.a].id);
        const bEl = app.idMap.get(app.state[step.b].id);
        if (aEl) aEl.classList.add('swap');
        if (bEl) bEl.classList.add('swap');
        renderCode('swap');
        break;
      }
      case 'finalSwap': {
        app.counters.swaps++;
        swapStateIndices(step.a, step.b);
        const aEl = app.idMap.get(app.state[step.a].id);
        const bEl = app.idMap.get(app.state[step.b].id);
        if (aEl) aEl.classList.add('swap');
        if (bEl) bEl.classList.add('swap');
        renderCode('finalSwap');
        break;
      }
      case 'pivotPlaced': {
        app.pointers.pivot = step.index;
        markSortedIndex(step.index);
        renderCode('pivotPlaced');
        break;
      }
      case 'sortedRange': {
        // If range length is 1, mark it sorted
        for (let idx = step.low; idx <= step.high; idx++) {
          markSortedIndex(idx);
        }
        break;
      }
      case 'touch': {
        // no-op, but highlight j
        const el = app.idMap.get(app.state[step.index]?.id);
        if (el) el.classList.add('j');
        break;
      }
      case 'done': {
        for (let i = 0; i < app.state.length; i++) {
          markSortedIndex(i);
        }
        stop();
        renderCode('done');
        break;
      }
      default:
        break;
    }
    app.stepIndex++;
    updateUI();
  }

  function nextStep() {
    if (!app.steps.length || app.stepIndex >= app.steps.length) {
      stop();
      return;
    }
    const step = app.steps[app.stepIndex];
    applyStep(step);
  }

  function play() {
    if (!app.steps.length || app.stepIndex >= app.steps.length) return;
    if (app.playing) return;
    app.playing = true;
    updateUI();
    const interval = Math.max(60, Math.round(1000 / app.speed));
    app.timer = setInterval(() => {
      if (app.stepIndex >= app.steps.length) {
        stop();
        return;
      }
      nextStep();
    }, interval);
  }

  function stop() {
    app.playing = false;
    if (app.timer) {
      clearInterval(app.timer);
      app.timer = null;
    }
    updateUI();
  }

  function reset() {
    stop();
    init(app.initialValues.slice());
    highlightCode(null);
    renderCode(null);
  }

  // Event bindings
  btnRandom.addEventListener('click', () => {
    const n = clamp(Number(randCountEl.value) || 20, 5, 60);
    const vals = generateRandom(n);
    inputArrayEl.value = vals.join(', ');
    init(vals);
  });

  btnSort.addEventListener('click', () => {
    const values = parseInput(inputArrayEl.value);
    if (!values.length) {
      alert('Please enter at least one valid number.');
      return;
    }
    init(values);
    app.pivotStrategy = pivotSelect.value;
    app.steps = buildQuickSortSteps(values, app.pivotStrategy);
    app.stepIndex = 0;
    updateUI();
    renderCode(null);
  });

  btnPlay.addEventListener('click', () => {
    if (app.playing) {
      stop();
    } else {
      play();
    }
  });

  btnStep.addEventListener('click', () => {
    stop();
    nextStep();
  });

  btnReset.addEventListener('click', () => {
    reset();
  });

  pivotSelect.addEventListener('change', () => {
    app.pivotStrategy = pivotSelect.value;
    if (app.initialValues.length) {
      // Rebuild steps for current initial values (not current state)
      app.steps = buildQuickSortSteps(app.initialValues.slice(), app.pivotStrategy);
      app.stepIndex = 0;
      app.state = app.initialValues.map((v, idx) => ({ id: idx + 1, value: v }));
      updateBarsPos(true);
      app.counters.comparisons = 0;
      app.counters.swaps = 0;
      app.pointers = {i: null, j: null, pivot: null, range: null};
      applyRangeShading();
      updateUI();
    }
  });

  speedRange.addEventListener('input', () => {
    app.speed = Number(speedRange.value);
    speedLabel.textContent = `${app.speed.toFixed(2)}x`;
    if (app.playing) {
      stop();
      play();
    }
  });

  window.addEventListener('resize', () => {
    updateLayout();
  });

  // Bootstrap with an initial random array
  const initialVals = generateRandom(randCountEl.value);
  inputArrayEl.value = initialVals.join(', ');
  init(initialVals);

  // Build initial steps (optional)
  app.steps = buildQuickSortSteps(initialVals, app.pivotStrategy);
  updateUI();
  renderCode(null);
})();
</script>
</body>
</html>