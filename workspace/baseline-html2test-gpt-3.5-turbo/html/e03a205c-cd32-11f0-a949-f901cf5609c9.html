<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Heap Sort Visualization</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f0f2f5;
  }
  h1 {
    text-align: center;
  }
  #arrayInput {
    width: 80%;
    padding: 8px;
    font-size: 16px;
  }
  #sortButton {
    padding: 8px 16px;
    font-size: 16px;
    margin-left: 10px;
    cursor: pointer;
  }
  #arrayContainer {
    margin-top: 30px;
    display: flex;
    justify-content: center;
    align-items: flex-end;
    height: 300px;
    gap: 5px;
    border: 1px solid #ccc;
    background: white;
    padding: 10px;
    border-radius: 5px;
  }
  .array-bar {
    background-color: #6495ed;
    width: 30px;
    margin: 0 2px;
    color: white;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: flex-end;
    border-radius: 4px 4px 0 0;
    user-select: none;
  }
  .highlight {
    background-color: #ff6347 !important;
  }
  .swapping {
    background-color: #3cb371 !important;
  }
  #log {
    margin-top: 20px;
    background: #fff;
    border: 1px solid #ccc;
    height: 150px;
    overflow-y: auto;
    padding: 10px;
    font-family: monospace;
    white-space: pre-wrap;
    border-radius: 5px;
  }
  #controls {
    text-align: center;
    margin-bottom: 10px;
  }
  #speedRange {
    width: 150px;
    margin-left: 10px;
  }
</style>
</head>
<body>
  <h1>Heap Sort Visualization</h1>
  <div id="controls">
    <input id="arrayInput" type="text" placeholder="Enter numbers separated by commas" value="5,3,8,4,2,7,1,10,6,9" />
    <button id="sortButton">Start Heap Sort</button>
    <label for="speedRange">Speed:
      <input type="range" id="speedRange" min="50" max="1500" value="500" step="50" />
    </label>
  </div>
  <div id="arrayContainer"></div>
  <div id="log"></div>

<script>
  const arrayInput = document.getElementById('arrayInput');
  const sortButton = document.getElementById('sortButton');
  const arrayContainer = document.getElementById('arrayContainer');
  const logElem = document.getElementById('log');
  const speedRange = document.getElementById('speedRange');

  let speed = parseInt(speedRange.value);

  speedRange.addEventListener('input', () => {
    speed = parseInt(speedRange.value);
  });

  function log(msg) {
    logElem.textContent += msg + "\n";
    logElem.scrollTop = logElem.scrollHeight;
  }

  function createBars(arr) {
    arrayContainer.innerHTML = '';
    for (let i = 0; i < arr.length; i++) {
      const bar = document.createElement('div');
      bar.classList.add('array-bar');
      bar.style.height = arr[i] * 20 + 'px';
      bar.textContent = arr[i];
      bar.dataset.index = i;
      arrayContainer.appendChild(bar);
    }
  }

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function swap(arr, i, j) {
    log(`Swapping index ${i} (${arr[i]}) and index ${j} (${arr[j]})`);
    // Swap in array
    [arr[i], arr[j]] = [arr[j], arr[i]];
    // Swap bars visually
    const bars = arrayContainer.children;
    bars[i].classList.add('swapping');
    bars[j].classList.add('swapping');

    // Animate swap by exchanging heights and text
    let heightI = bars[i].style.height;
    let heightJ = bars[j].style.height;
    let textI = bars[i].textContent;
    let textJ = bars[j].textContent;

    bars[i].style.height = heightJ;
    bars[j].style.height = heightI;
    bars[i].textContent = textJ;
    bars[j].textContent = textI;

    await sleep(speed);

    bars[i].classList.remove('swapping');
    bars[j].classList.remove('swapping');
  }

  async function heapify(arr, n, i) {
    let largest = i;
    let left = 2*i + 1;
    let right = 2*i + 2;

    const bars = arrayContainer.children;

    // Highlight current index i
    if(bars[i]) bars[i].classList.add('highlight');
    if(bars[left]) bars[left].classList.add('highlight');
    if(bars[right]) bars[right].classList.add('highlight');

    log(`Heapify called on index ${i} (value: ${arr[i]}) with left child index ${left} and right child index ${right}`);

    await sleep(speed);

    if (left < n) {
      log(`Compare left child arr[${left}] (${arr[left]}) with arr[${largest}] (${arr[largest]})`);
      if (arr[left] > arr[largest]) {
        largest = left;
      }
      await sleep(speed);
    }

    if (right < n) {
      log(`Compare right child arr[${right}] (${arr[right]}) with arr[${largest}] (${arr[largest]})`);
      if (arr[right] > arr[largest]) {
        largest = right;
      }
      await sleep(speed);
    }

    if (largest !== i) {
      if(bars[i]) bars[i].classList.remove('highlight');
      if(bars[left]) bars[left].classList.remove('highlight');
      if(bars[right]) bars[right].classList.remove('highlight');

      await swap(arr, i, largest);
      await heapify(arr, n, largest);
    } else {
      if(bars[i]) bars[i].classList.remove('highlight');
      if(bars[left]) bars[left].classList.remove('highlight');
      if(bars[right]) bars[right].classList.remove('highlight');
      log(`No swap needed at index ${i}`);
      await sleep(speed);
    }
  }

  async function heapSort(arr) {
    log("Building the heap...");
    let n = arr.length;

    // Build max heap
    for (let i = Math.floor(n/2) - 1; i >= 0; i--) {
      await heapify(arr, n, i);
    }

    log("Heap built. Extracting elements...");
    // One by one extract elements
    for (let i = n - 1; i > 0; i--) {
      await swap(arr, 0, i); // Move current root to end
      log(`Heapifying root after swap up to index ${i}`);
      await heapify(arr, i, 0);
    }
    log("Heap Sort completed!");
  }

  function parseInput(input) {
    try {
      return input.split(",").map(x => parseInt(x.trim())).filter(x => !isNaN(x));
    } catch {
      return [];
    }
  }

  sortButton.addEventListener('click', async () => {
    sortButton.disabled = true;
    arrayInput.disabled = true;
    logElem.textContent = '';
    let arr = parseInput(arrayInput.value);
    if(arr.length === 0) {
      alert("Please enter a valid list of numbers separated by commas.");
      sortButton.disabled = false;
      arrayInput.disabled = false;
      return;
    }
    createBars(arr);
    await heapSort(arr);
    sortButton.disabled = false;
    arrayInput.disabled = false;
  });

  // Initialize bars on page load
  window.onload = () => {
    let arr = parseInput(arrayInput.value);
    createBars(arr);
  };
</script>
</body>
</html>