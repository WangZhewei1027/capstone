<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Merge Sort Visualization</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 1rem;
    background: #f0f0f0;
  }
  h1 {
    text-align: center;
    margin-bottom: 0.5rem;
  }
  #controls {
    text-align: center;
    margin-bottom: 1rem;
  }
  input[type=number] {
    width: 5rem;
    font-size: 1rem;
    padding: 0.25rem;
    margin-right: 0.5rem;
  }
  button {
    font-size: 1rem;
    padding: 0.3rem 0.7rem;
    margin: 0 0.3rem;
    cursor: pointer;
  }
  #array {
    display: flex;
    justify-content: center;
    align-items: end;
    gap: 2px;
    height: 300px;
    margin-top: 1rem;
  }
  .bar {
    background-color: #3498db;
    width: 20px;
    border-radius: 3px 3px 0 0;
    display: flex;
    justify-content: center;
    align-items: flex-end;
    color: white;
    font-size: 0.7rem;
    user-select: none;
  }
  .bar.active {
    background-color: #e74c3c;
  }
  .bar.merging {
    background-color: #2ecc71;
  }
  #log {
    max-height: 150px;
    overflow-y: auto;
    background-color: #fff;
    border: 1px solid #ccc;
    margin-top: 1rem;
    padding: 0.5rem;
    font-family: monospace;
    font-size: 0.9rem;
  }
</style>
</head>
<body>
<h1>Merge Sort Visualization</h1>
<div id="controls">
  <label for="arraySize">Array Size:</label>
  <input type="number" id="arraySize" min="5" max="50" value="20" />
  <button id="generateBtn">Generate Array</button>
  <button id="sortBtn">Start Merge Sort</button>
  <button id="resetBtn">Reset</button>
</div>
<div id="array"></div>
<div id="log"></div>

<script>
  const arraySizeInput = document.getElementById('arraySize');
  const generateBtn = document.getElementById('generateBtn');
  const sortBtn = document.getElementById('sortBtn');
  const resetBtn = document.getElementById('resetBtn');
  const arrayContainer = document.getElementById('array');
  const logContainer = document.getElementById('log');

  let array = [];
  let bars = [];
  let sorting = false;

  function log(message) {
    const time = new Date().toLocaleTimeString();
    const entry = document.createElement('div');
    entry.textContent = `[${time}] ${message}`;
    logContainer.appendChild(entry);
    logContainer.scrollTop = logContainer.scrollHeight;
  }

  function generateRandomArray(size) {
    array = [];
    for (let i = 0; i < size; i++) {
      // Values between 5 and 100
      array.push(Math.floor(Math.random() * 96) + 5);
    }
  }

  function renderArray(highlightIndices = [], mergingIndices = []) {
    arrayContainer.innerHTML = '';
    bars = [];
    const maxVal = Math.max(...array);
    for (let i = 0; i < array.length; i++) {
      const bar = document.createElement('div');
      bar.classList.add('bar');
      bar.style.height = `${(array[i] / maxVal) * 100}%`;
      bar.textContent = array[i];
      if (highlightIndices.includes(i)) bar.classList.add('active');
      if (mergingIndices.includes(i)) bar.classList.add('merging');
      arrayContainer.appendChild(bar);
      bars.push(bar);
    }
  }

  // Sleep for ms milliseconds
  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function merge(array, start, mid, end) {
    log(`Merging subarrays [${start}..${mid}] and [${mid+1}..${end}]`);
    let left = array.slice(start, mid + 1);
    let right = array.slice(mid + 1, end + 1);
    let i = 0, j = 0, k = start;

    while(i < left.length && j < right.length) {
      renderArray(
        [k], // highlight the place we will write next
        [start + i, mid + 1 + j] // highlight the merging items
      );
      await sleep(300);
      if(left[i] <= right[j]) {
        array[k++] = left[i++];
      } else {
        array[k++] = right[j++];
      }
    }
    // Copy rest if any
    while(i < left.length) {
      renderArray([k], [start + i]);
      await sleep(300);
      array[k++] = left[i++];
    }
    while(j < right.length) {
      renderArray([k], [mid + 1 + j]);
      await sleep(300);
      array[k++] = right[j++];
    }
    renderArray();
    await sleep(300);
  }

  async function mergeSort(array, start, end) {
    if (start >= end) return;
    let mid = Math.floor((start + end) / 2);
    log(`Sorting left half [${start}..${mid}]`);
    await mergeSort(array, start, mid);
    log(`Sorting right half [${mid+1}..${end}]`);
    await mergeSort(array, mid + 1, end);
    await merge(array, start, mid, end);
  }

  function reset() {
    sorting = false;
    generateBtn.disabled = false;
    sortBtn.disabled = false;
    arraySizeInput.disabled = false;
    logContainer.innerHTML = '';
    generateRandomArray(parseInt(arraySizeInput.value));
    renderArray();
  }

  generateBtn.addEventListener('click', () => {
    if (sorting) return;
    reset();
  });

  sortBtn.addEventListener('click', async () => {
    if (sorting) return;
    sorting = true;
    generateBtn.disabled = true;
    sortBtn.disabled = true;
    arraySizeInput.disabled = true;
    log('Starting Merge Sort');
    await mergeSort(array, 0, array.length - 1);
    renderArray();
    log('Merge Sort Completed');
    sorting = false;
    generateBtn.disabled = false;
    sortBtn.disabled = false;
    arraySizeInput.disabled = false;
  });

  resetBtn.addEventListener('click', () => {
    if (sorting) return;
    reset();
  });

  // Initialize on load
  reset();
</script>
</body>
</html>