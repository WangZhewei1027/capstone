<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Linear Regression Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    h1 {
      text-align: center;
    }
    #container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
    }
    #plot {
      border: 1px solid #ccc;
      margin-top: 20px;
      background: #fff;
      cursor: crosshair;
    }
    #instructions {
      margin-top: 0;
      font-size: 14px;
      color: #666;
    }
    #controls {
      margin-top: 15px;
      text-align: center;
    }
    button {
      margin: 0 5px;
      background: #007bff;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background: #0056b3;
    }
    #result {
      margin-top: 15px;
      font-weight: bold;
      text-align: center;
      font-size: 16px;
    }
    #equation {
      margin-top: 5px;
      text-align: center;
      font-family: "Courier New", monospace;
      background: #eee;
      padding: 8px;
      border-radius: 4px;
      display: inline-block;
      user-select: all;
    }
    #clearTip {
      font-size: 12px;
      color: #999;
      text-align: center;
      margin-top: 10px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>Linear Regression Demo</h1>
    <p id="instructions">
      Click on the graph below to add data points. The line of best fit (linear regression) will update automatically.
    </p>
    <canvas id="plot" width="700" height="400" aria-label="Linear regression graph" role="img"></canvas>
    <div id="controls">
      <button id="btnClear">Clear Points</button>
      <button id="btnRandom">Add Random Points</button>
    </div>
    <div id="result"></div>
    <div id="equation" title="Regression equation and details"></div>
    <div id="clearTip">Tip: Click "Clear Points" to remove all points and start over.</div>
  </div>

  <script>
    (function () {
      const canvas = document.getElementById("plot");
      const ctx = canvas.getContext("2d");
      const width = canvas.width;
      const height = canvas.height;
      const margin = 50;
      const btnClear = document.getElementById("btnClear");
      const btnRandom = document.getElementById("btnRandom");
      const resultDiv = document.getElementById("result");
      const equationDiv = document.getElementById("equation");

      // Data points: array of {x, y} in plot coordinate space (0 to 100)
      let points = [];

      // Coordinate range for plotting:
      // We'll map x and y between 0 and 100 for convenience.
      const plotRange = { minX: 0, maxX: 100, minY: 0, maxY: 100 };

      // Converts plot coordinate (0-100) to canvas pixel coordinate
      function plotToCanvas(x, y) {
        let px = margin + ((x - plotRange.minX) / (plotRange.maxX - plotRange.minX)) * (width - 2 * margin);
        let py = height - margin - ((y - plotRange.minY) / (plotRange.maxY - plotRange.minY)) * (height - 2 * margin);
        return { px, py };
      }

      // Converts canvas pixel coordinate to plot coordinate (0-100)
      function canvasToPlot(px, py) {
        let x = ((px - margin) / (width - 2 * margin)) * (plotRange.maxX - plotRange.minX) + plotRange.minX;
        let y = ((height - margin - py) / (height - 2 * margin)) * (plotRange.maxY - plotRange.minY) + plotRange.minY;
        x = Math.min(Math.max(x, plotRange.minX), plotRange.maxX);
        y = Math.min(Math.max(y, plotRange.minY), plotRange.maxY);
        return { x, y };
      }

      // Draw axes and grid lines
      function drawAxes() {
        ctx.clearRect(0, 0, width, height);

        ctx.strokeStyle = "#888";
        ctx.lineWidth = 1;
        ctx.font = "12px Arial";
        ctx.fillStyle = "#333";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        // Draw grid lines and labels on X axis
        const xStep = 10;
        for (let x = plotRange.minX; x <= plotRange.maxX; x += xStep) {
          const { px, py } = plotToCanvas(x, plotRange.minY);
          ctx.beginPath();
          ctx.moveTo(px, margin);
          ctx.lineTo(px, height - margin);
          ctx.strokeStyle = x === 0 || x === plotRange.maxX ? "#444" : "#ddd";
          ctx.lineWidth = x === 0 || x === plotRange.maxX ? 2 : 1;
          ctx.stroke();
          ctx.fillStyle = "#333";
          ctx.fillText(x.toFixed(0), px, height - margin + 15);
        }

        // Draw grid lines and labels on Y axis
        const yStep = 10;
        for (let y = plotRange.minY; y <= plotRange.maxY; y += yStep) {
          const { px, py } = plotToCanvas(plotRange.minX, y);
          ctx.beginPath();
          ctx.moveTo(margin, py);
          ctx.lineTo(width - margin, py);
          ctx.strokeStyle = y === 0 || y === plotRange.maxY ? "#444" : "#ddd";
          ctx.lineWidth = y === 0 || y === plotRange.maxY ? 2 : 1;
          ctx.stroke();
          ctx.fillStyle = "#333";
          // Align right for Y labels
          ctx.textAlign = "right";
          ctx.fillText(y.toFixed(0), margin - 8, py);
          ctx.textAlign = "center";
        }

        // Axis labels
        ctx.fillStyle = "#000";
        ctx.font = "bold 14px Arial";
        ctx.fillText("X", width / 2, height - 10);
        ctx.save();
        ctx.translate(10, height / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText("Y", 0, 0);
        ctx.restore();
      }

      // Draw points on the canvas
      function drawPoints() {
        ctx.fillStyle = "#007bff";
        points.forEach(({ x, y }) => {
          const { px, py } = plotToCanvas(x, y);
          ctx.beginPath();
          ctx.arc(px, py, 6, 0, 2 * Math.PI);
          ctx.fill();
          ctx.strokeStyle = "#003d99";
          ctx.lineWidth = 1.5;
          ctx.stroke();
        });
      }

      // Calculate linear regression parameters: slope (m) and intercept (b)
      // y = m*x + b
      // Returns null if not enough points or zero variance in x
      function linearRegression(data) {
        if (data.length < 2) {
          return null;
        }
        const n = data.length;
        let sumX = 0,
          sumY = 0,
          sumXY = 0,
          sumX2 = 0;
        for (let i = 0; i < n; i++) {
          let { x, y } = data[i];
          sumX += x;
          sumY += y;
          sumXY += x * y;
          sumX2 += x * x;
        }
        const denominator = n * sumX2 - sumX * sumX;
        if (denominator === 0) {
          return null;
        }
        const m = (n * sumXY - sumX * sumY) / denominator;
        const b = (sumY - m * sumX) / n;

        // Calculate R^2 (coefficient of determination)
        let ssTot = 0,
          ssRes = 0;
        const meanY = sumY / n;
        for (let i = 0; i < n; i++) {
          let yi = data[i].y;
          let xi = data[i].x;
          let yPred = m * xi + b;
          ssTot += (yi - meanY) * (yi - meanY);
          ssRes += (yi - yPred) * (yi - yPred);
        }
        const r2 = 1 - ssRes / ssTot;

        return { m, b, r2 };
      }

      // Draw the regression line on the plot
      function drawRegressionLine(params) {
        if (!params) return;
        const { m, b } = params;

        // y = m*x + b
        // We draw line at minX and maxX
        const x1 = plotRange.minX;
        const y1 = m * x1 + b;
        const x2 = plotRange.maxX;
        const y2 = m * x2 + b;

        // Clip y within plot range:
        function clip(y) {
          return Math.min(Math.max(y, plotRange.minY), plotRange.maxY);
        }

        ctx.strokeStyle = "#e63946";
        ctx.lineWidth = 3;
        ctx.beginPath();
        let p1 = plotToCanvas(x1, clip(y1));
        let p2 = plotToCanvas(x2, clip(y2));
        ctx.moveTo(p1.px, p1.py);
        ctx.lineTo(p2.px, p2.py);
        ctx.stroke();
      }

      // Update all canvas drawing
      function updateCanvas() {
        drawAxes();
        drawPoints();
        let reg = linearRegression(points);
        drawRegressionLine(reg);

        if (reg) {
          resultDiv.textContent = `Regression line calculated for ${points.length} point${points.length > 1 ? "s" : ""}`;
          const { m, b, r2 } = reg;
          // Format numbers nicely
          const mStr = m.toFixed(3);
          const bStr = b >= 0 ? "+ " + b.toFixed(3) : "- " + Math.abs(b).toFixed(3);
          const r2Str = (r2 * 100).toFixed(2);
          equationDiv.textContent = `y = ${mStr} × x ${bStr}\nR² = ${r2Str}%`;
        } else if (points.length === 1) {
          resultDiv.textContent = "Add at least one more point to compute regression line.";
          equationDiv.textContent = "";
        } else {
          resultDiv.textContent = "Click on the graph to add data points.";
          equationDiv.textContent = "";
        }
      }

      // Add a point where user clicked on canvas
      canvas.addEventListener("click", (e) => {
        const rect = canvas.getBoundingClientRect();
        const px = e.clientX - rect.left;
        const py = e.clientY - rect.top;

        // Ignore clicks outside plotting area
        if (px < margin || px > width - margin || py < margin || py > height - margin) {
          return;
        }

        const { x, y } = canvasToPlot(px, py);
        points.push({ x, y });
        updateCanvas();
      });

      // Clear points button
      btnClear.addEventListener("click", () => {
        points = [];
        updateCanvas();
      });

      // Add random points for demo
      btnRandom.addEventListener("click", () => {
        const count = 10;
        points = [];
        // Generate random points roughly around y = 0.7x + 10 with noise
        for (let i = 0; i < count; i++) {
          let x = Math.random() * (plotRange.maxX - plotRange.minX) + plotRange.minX;
          let noise = (Math.random() - 0.5) * 15;
          let y = 0.7 * x + 10 + noise;
          y = Math.min(Math.max(y, plotRange.minY), plotRange.maxY);
          points.push({ x, y });
        }
        updateCanvas();
      });

      // Initialize
      updateCanvas();
    })();
  </script>
</body>
</html>