<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Nearest Neighbors Interactive Module</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f4f4;
        }
        header {
            margin: 24px 0;
            font-size: 24px;
            text-align: center;
        }
        #container {
            display: flex;
            justify-content: space-between;
            max-width: 880px;
            width: 100%;
            margin: 0 24px;
        }
        #plot {
            border: 2px solid #333;
            position: relative;
            width: 400px;
            height: 400px;
            background-color: white;
        }
        #controls {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            margin-left: 24px;
        }
        #k-slider {
            margin-bottom: 16px;
            width: 200px;
        }
        .point {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            cursor: pointer;
        }
        .info {
            margin-top: 8px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <header>Understanding K-Nearest Neighbors (KNN) Algorithm</header>
    <div id="container">
        <div id="plot"></div>
        <div id="controls">
            <input type="range" id="k-slider" min="1" max="10" value="3">
            <div class="info">Current K: <span id="current-k">3</span></div>
            <div class="info" id="classification-result"></div>
        </div>
    </div>
    <script>
        const plotArea = document.getElementById("plot");
        const kSlider = document.getElementById("k-slider");
        const currentKDisplay = document.getElementById("current-k");
        const classificationResult = document.getElementById("classification-result");

        let points = [];
        let neighbors = [];

        const getRandomColor = () => '#' + Math.floor(Math.random()*16777215).toString(16);

        function drawPoint(x, y, color) {
            const pointElement = document.createElement("div");
            pointElement.className = "point";
            pointElement.style.backgroundColor = color;
            pointElement.style.left = `${x}px`;
            pointElement.style.top = `${y}px`;
            pointElement.onclick = function() {
                drawNeighbors(x, y);
            };
            pointElement.onmousedown = function(e) {
                const movePoint = (moveEvent) => {
                    const newX = moveEvent.clientX - plotArea.getBoundingClientRect().left;
                    const newY = moveEvent.clientY - plotArea.getBoundingClientRect().top;
                    pointElement.style.left = `${newX}px`;
                    pointElement.style.top = `${newY}px`;
                    drawNeighbors(newX, newY);
                };
                document.addEventListener("mousemove", movePoint);
                document.onmouseup = () => document.removeEventListener("mousemove", movePoint);
            };
            plotArea.appendChild(pointElement);
            points.push({x, y, color});
            drawNeighbors(x, y);
        }

        function drawNeighbors(x, y) {
            console.log("Calculating neighbors...");
            neighbors = [];
            plotArea.querySelectorAll('.neighbor-line').forEach(l => l.remove());

            points.forEach(point => {
                const distance = Math.sqrt((x - point.x) ** 2 + (y - point.y) ** 2);
                neighbors.push({ point, distance });
            });

            neighbors.sort((a, b) => a.distance - b.distance);
          
            const k = parseInt(kSlider.value);
            const selectedNeighbors = neighbors.slice(0, k);

            selectedNeighbors.forEach(neighbor => {
                const line = document.createElement("div");
                line.className = "neighbor-line";
                const startX = x + 5; // offset for the point
                const startY = y + 5; // offset for the point
                const endX = neighbor.point.x + 5;
                const endY = neighbor.point.y + 5;

                line.style.position = "absolute";
                line.style.width = `${Math.sqrt((startX - endX) ** 2 + (startY - endY) ** 2)}px`;
                line.style.transformOrigin = "0 0";
                line.style.transform = `rotate(${Math.atan2(endY - startY, endX - startX) * (180/Math.PI)}deg)`;
                line.style.left = `${startX}px`;
                line.style.top = `${startY}px`;
                line.style.borderTop = "2px dashed gray";
                plotArea.appendChild(line);
            });

            const colors = selectedNeighbors.map(n => n.point.color);
            const predominantColor = colors.reduce((a,b)=> (colors.filter(v=>v===a).length>=colors.filter(v=>v===b).length ? a : b));
            
            classificationResult.textContent = `Predicted Class: ${predominantColor}`;
        }

        kSlider.oninput = function() {
            currentKDisplay.textContent = this.value;
        };

        plotArea.onclick = function(e) {
            const rect = plotArea.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            drawPoint(x, y, getRandomColor());
        };
    </script>
</body>
</html>