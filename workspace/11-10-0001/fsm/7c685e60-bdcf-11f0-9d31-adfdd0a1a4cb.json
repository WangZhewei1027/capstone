{
  "topic": "KNN Interactive Module",
  "description": "Finite state machine modeling user interactions for the K-Nearest Neighbors interactive canvas (modes, adding points, placing query, moving/draging/deleting points, animation, and control changes).",
  "states": [
    {
      "name": "mode_A",
      "onEnter": "updateModeUI",
      "onExit": "noop",
      "on": {
        "MODE_SELECT_B": "mode_B",
        "MODE_SELECT_Q": "mode_Q",
        "MODE_SELECT_MOVE": "mode_Move",
        "CANVAS_CLICK": "add_point",
        "ANIMATE_START": "animating",
        "CLEAR_ALL": "cleared",
        "K_CHANGE": "mode_A",
        "METRIC_CHANGE": "mode_A",
        "WEIGHTED_TOGGLE": "mode_A",
        "RESIZE": "mode_A"
      }
    },
    {
      "name": "mode_B",
      "onEnter": "updateModeUI",
      "onExit": "noop",
      "on": {
        "MODE_SELECT_A": "mode_A",
        "MODE_SELECT_Q": "mode_Q",
        "MODE_SELECT_MOVE": "mode_Move",
        "CANVAS_CLICK": "add_point",
        "ANIMATE_START": "animating",
        "CLEAR_ALL": "cleared",
        "K_CHANGE": "mode_B",
        "METRIC_CHANGE": "mode_B",
        "WEIGHTED_TOGGLE": "mode_B",
        "RESIZE": "mode_B"
      }
    },
    {
      "name": "mode_Q",
      "onEnter": "updateModeUI",
      "onExit": "noop",
      "on": {
        "MODE_SELECT_A": "mode_A",
        "MODE_SELECT_B": "mode_B",
        "MODE_SELECT_MOVE": "mode_Move",
        "CANVAS_CLICK": "place_query",
        "ANIMATE_START": "animating",
        "CLEAR_ALL": "cleared",
        "K_CHANGE": "mode_Q",
        "METRIC_CHANGE": "mode_Q",
        "WEIGHTED_TOGGLE": "mode_Q",
        "RESIZE": "mode_Q"
      }
    },
    {
      "name": "mode_Move",
      "onEnter": "updateModeUI",
      "onExit": "noop",
      "on": {
        "MODE_SELECT_A": "mode_A",
        "MODE_SELECT_B": "mode_B",
        "MODE_SELECT_Q": "mode_Q",
        "CANVAS_POINTER_DOWN_POINT": "dragging_point",
        "CANVAS_CLICK_POINT": "selected_point",
        "CANVAS_POINTER_DOWN_QUERY": "dragging_query",
        "ANIMATE_START": "animating",
        "CLEAR_ALL": "cleared",
        "K_CHANGE": "mode_Move",
        "METRIC_CHANGE": "mode_Move",
        "WEIGHTED_TOGGLE": "mode_Move",
        "RESIZE": "mode_Move"
      }
    },
    {
      "name": "add_point",
      "onEnter": "addTrainingPoint",
      "onExit": "draw",
      "on": {
        "POINT_ADDED": "mode_A",
        "POINT_ADDED_TO_B": "mode_B",
        "CANCEL": "mode_A",
        "RESIZE": "mode_A"
      }
    },
    {
      "name": "place_query",
      "onEnter": "placeQueryPoint",
      "onExit": "draw",
      "on": {
        "QUERY_PLACED": "mode_Q",
        "CANCEL": "mode_Q",
        "RESIZE": "mode_Q"
      }
    },
    {
      "name": "selected_point",
      "onEnter": "selectPoint",
      "onExit": "noop",
      "on": {
        "DELETE_KEY": "delete_point",
        "POINTER_DOWN": "dragging_point",
        "CANCEL": "mode_Move",
        "RESIZE": "mode_Move"
      }
    },
    {
      "name": "delete_point",
      "onEnter": "deleteSelectedPoint",
      "onExit": "draw",
      "on": {
        "POINT_DELETED": "mode_Move",
        "RESIZE": "mode_Move"
      }
    },
    {
      "name": "dragging_point",
      "onEnter": "startDraggingPoint",
      "onExit": "stopDraggingPoint",
      "on": {
        "POINTER_MOVE": "dragging_point",
        "POINTER_UP": "mode_Move",
        "DELETE_KEY": "delete_point",
        "RESIZE": "mode_Move"
      }
    },
    {
      "name": "dragging_query",
      "onEnter": "startDraggingQuery",
      "onExit": "stopDraggingQuery",
      "on": {
        "POINTER_MOVE": "dragging_query",
        "POINTER_UP": "mode_Move",
        "RESIZE": "mode_Move"
      }
    },
    {
      "name": "animating",
      "onEnter": "startAnimation",
      "onExit": "stopAnimation",
      "on": {
        "ANIMATION_STEP": "animating",
        "ANIMATION_END": "idle",
        "MODE_SELECT_A": "mode_A",
        "MODE_SELECT_B": "mode_B",
        "MODE_SELECT_Q": "mode_Q",
        "MODE_SELECT_MOVE": "mode_Move",
        "CLEAR_ALL": "cleared",
        "RESIZE": "animating"
      }
    },
    {
      "name": "cleared",
      "onEnter": "clearAll",
      "onExit": "draw",
      "on": {
        "CLEARED": "idle",
        "MODE_SELECT_A": "mode_A",
        "MODE_SELECT_B": "mode_B",
        "MODE_SELECT_Q": "mode_Q",
        "MODE_SELECT_MOVE": "mode_Move",
        "RESIZE": "idle"
      }
    },
    {
      "name": "idle",
      "onEnter": "noop",
      "onExit": "noop",
      "on": {
        "MODE_SELECT_A": "mode_A",
        "MODE_SELECT_B": "mode_B",
        "MODE_SELECT_Q": "mode_Q",
        "MODE_SELECT_MOVE": "mode_Move",
        "ANIMATE_START": "animating",
        "CLEAR_ALL": "cleared",
        "RESIZE": "idle"
      }
    }
  ],
  "events": [
    "MODE_SELECT_A",
    "MODE_SELECT_B",
    "MODE_SELECT_Q",
    "MODE_SELECT_MOVE",
    "CANVAS_CLICK",
    "CANVAS_CLICK_POINT",
    "CANVAS_POINTER_DOWN_POINT",
    "CANVAS_POINTER_DOWN_QUERY",
    "CANVAS_CLICK_QUERY",
    "POINTER_DOWN",
    "POINTER_MOVE",
    "POINTER_UP",
    "POINTER_MOVE_RAW",
    "K_CHANGE",
    "METRIC_CHANGE",
    "WEIGHTED_TOGGLE",
    "ANIMATE_START",
    "ANIMATION_STEP",
    "ANIMATION_END",
    "CLEAR_ALL",
    "DELETE_KEY",
    "POINT_ADDED",
    "POINT_ADDED_TO_B",
    "QUERY_PLACED",
    "POINT_DELETED",
    "CANCEL",
    "RESIZE",
    "DRAW_REQUEST"
  ],
  "notes": "This FSM models UI modes (Place Class A/B, Place Query, Move/Delete), transient actions (add_point, place_query, delete_point), drag interactions (dragging_point, dragging_query), and the animation sequence (animating). Transient states (add_point, place_query, delete_point) perform onEnter actions and then return to a mode. 'idle' is a neutral non-animating state. Events like CANVAS_CLICK_POINT vs CANVAS_CLICK are used to differentiate clicks on an existing training point, the query, or empty canvas. Some transitions are intentionally simplified (ANIMATION_END returns to 'idle'), representing returning to a settled non-animating UI; implementations track the current mode context to resume the precise mode when needed."
}