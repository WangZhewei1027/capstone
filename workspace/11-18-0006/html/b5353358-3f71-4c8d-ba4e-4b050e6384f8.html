<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubble Sort Visualization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #arrayDisplay {
            display: flex;
            margin: 20px 0;
        }
        .array-element {
            width: 30px;
            height: 30px;
            margin: 0 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: lightgray;
            transition: background-color 0.3s, transform 0.3s;
        }
        .highlight {
            background-color: yellow;
        }
        .sorted {
            background-color: green;
        }
        button {
            margin: 5px;
        }
        #status {
            margin-top: 20px;
        }
    </style>
</head>
<body data-state="idle">

    <h1>Bubble Sort Visualization</h1>
    <input type="text" id="inputField" data-testid="data-testid-input-field" aria-label="Input array" placeholder="Enter numbers separated by commas" value="5, 3, 8, 4, 2">
    <div id="arrayDisplay" data-testid="data-testid-array-display" aria-live="polite" role="status"></div>
    <button id="startButton" data-testid="data-testid-start-button" data-action="START" aria-label="Start sorting">Start</button>
    <button id="pauseButton" data-testid="data-testid-pause-button" data-action="PAUSE" aria-label="Pause sorting" disabled>Pause</button>
    <button id="resetButton" data-testid="data-testid-reset-button" data-action="RESET" aria-label="Reset sorting" disabled>Reset</button>
    <div id="status" role="status" aria-live="polite">Ready to start</div>

    <script>
        window.appState = { current: 'idle', array: [5, 3, 8, 4, 2] };

        const arrayDisplay = document.getElementById('arrayDisplay');
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const resetButton = document.getElementById('resetButton');
        const inputField = document.getElementById('inputField');
        const status = document.getElementById('status');

        function renderArray() {
            arrayDisplay.innerHTML = '';
            window.appState.array.forEach((value, index) => {
                const element = document.createElement('div');
                element.className = 'array-element';
                element.textContent = value;
                arrayDisplay.appendChild(element);
            });
        }

        function updateUI() {
            const state = window.appState.current;
            document.body.setAttribute('data-state', state);
            switch (state) {
                case 'idle':
                    startButton.disabled = false;
                    pauseButton.disabled = true;
                    resetButton.disabled = true;
                    status.textContent = 'Ready to start';
                    break;
                case 'running':
                    startButton.disabled = true;
                    pauseButton.disabled = false;
                    resetButton.disabled = false;
                    status.textContent = 'Sorting in progress';
                    break;
                case 'paused':
                    startButton.disabled = false;
                    pauseButton.disabled = true;
                    resetButton.disabled = false;
                    status.textContent = 'Paused';
                    break;
                case 'complete':
                    startButton.disabled = true;
                    pauseButton.disabled = true;
                    resetButton.disabled = false;
                    status.textContent = 'Sorting complete';
                    break;
                case 'error':
                    startButton.disabled = false;
                    pauseButton.disabled = true;
                    resetButton.disabled = false;
                    status.textContent = 'Error occurred';
                    break;
            }
        }

        function setState(newState) {
            window.appState.current = newState;
            updateUI();
            document.dispatchEvent(new CustomEvent('statechange', { detail: newState }));
        }

        function getState() {
            return window.appState.current;
        }

        function reset() {
            window.appState.array = [5, 3, 8, 4, 2];
            setState('idle');
            renderArray();
        }

        function validateInput(input) {
            const values = input.split(',').map(v => parseInt(v.trim(), 10));
            if (values.some(isNaN) || values.length > 10 || values.some(v => v < 0 || v > 100)) {
                return false;
            }
            return true;
        }

        function handleInputChange() {
            const input = inputField.value;
            if (validateInput(input)) {
                window.appState.array = input.split(',').map(v => parseInt(v.trim(), 10));
                renderArray();
                setState('idle');
            } else {
                setState('error');
            }
        }

        function bubbleSortStep() {
            let swapped = false;
            for (let i = 0; i < window.appState.array.length - 1; i++) {
                const elements = arrayDisplay.children;
                elements[i].classList.add('highlight');
                elements[i + 1].classList.add('highlight');
                if (window.appState.array[i] > window.appState.array[i + 1]) {
                    [window.appState.array[i], window.appState.array[i + 1]] = [window.appState.array[i + 1], window.appState.array[i]];
                    swapped = true;
                }
                setTimeout(() => {
                    elements[i].classList.remove('highlight');
                    elements[i + 1].classList.remove('highlight');
                    renderArray();
                }, 300);
            }
            if (!swapped) {
                setState('complete');
                Array.from(arrayDisplay.children).forEach(el => el.classList.add('sorted'));
            }
        }

        function startSorting() {
            if (window.appState.array.length === 0 || !validateInput(inputField.value)) {
                setState('error');
                return;
            }
            setState('running');
            const interval = setInterval(() => {
                if (getState() !== 'running') {
                    clearInterval(interval);
                    return;
                }
                bubbleSortStep();
            }, 1000);
        }

        startButton.addEventListener('click', () => {
            if (getState() === 'idle' || getState() === 'paused') {
                startSorting();
            }
        });

        pauseButton.addEventListener('click', () => {
            if (getState() === 'running') {
                setState('paused');
            }
        });

        resetButton.addEventListener('click', reset);
        inputField.addEventListener('input', handleInputChange);

        renderArray();
        updateUI();

        window.getState = getState;
        window.setState = setState;
        window.reset = reset;
    </script>
</body>
</html>