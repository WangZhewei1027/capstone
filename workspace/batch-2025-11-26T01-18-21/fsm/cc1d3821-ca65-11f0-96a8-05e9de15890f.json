{
  "meta": {
    "concept": "RedBlackTree",
    "topic": "Red-Black Tree Visualizer",
    "educational_goal": "Demonstrate Red-Black Tree insertions, deletions, rotations and recolorings with step-by-step animation and property inspection",
    "expected_interactions": [
      "insert",
      "insert_animated",
      "delete",
      "clear",
      "insert_random",
      "bulk_insert",
      "load_example",
      "adjust_speed"
    ]
  },
  "states": [
    {
      "id": "S0_Idle",
      "label": "idle",
      "type": "idle",
      "entry_actions": [
        "tree.updateVisualization()",
        "tree.setLast('Ready')",
        "enableUI()"
      ],
      "exit_actions": [
        "disableUI()"
      ]
    },
    {
      "id": "S1_InsertingInstant",
      "label": "inserting_instant",
      "type": "atomic",
      "entry_actions": [
        "captureInput('#insertVal')",
        "tree.insertValue(value,false)",
        "setRunningFlag(true)"
      ],
      "exit_actions": [
        "setRunningFlag(false)",
        "tree.updateVisualization()"
      ]
    },
    {
      "id": "S2_InsertingAnimated",
      "label": "inserting_animated",
      "type": "composite",
      "entry_actions": [
        "captureInput('#insertVal')",
        "setRunningFlag(true)",
        "tree.insertValue(value,true)"
      ],
      "exit_actions": [
        "setRunningFlag(false)",
        "tree.updateVisualization()"
      ]
    },
    {
      "id": "S3_InsertFixup",
      "label": "insert_fixup",
      "type": "atomic",
      "entry_actions": [
        "insertFixupStart()",
        "tree.updateVisualization()"
      ],
      "exit_actions": [
        "insertFixupDone()"
      ]
    },
    {
      "id": "S4_Rotating",
      "label": "rotating",
      "type": "atomic",
      "entry_actions": [
        "animateRotation()",
        "tree.updateVisualization()"
      ],
      "exit_actions": []
    },
    {
      "id": "S5_Recoloring",
      "label": "recoloring",
      "type": "atomic",
      "entry_actions": [
        "animateRecolor()",
        "tree.updateVisualization()"
      ],
      "exit_actions": []
    },
    {
      "id": "S6_DeletingAnimated",
      "label": "deleting",
      "type": "composite",
      "entry_actions": [
        "captureInput('#deleteVal')",
        "setRunningFlag(true)",
        "tree.deleteValue(value,true)"
      ],
      "exit_actions": [
        "setRunningFlag(false)",
        "tree.updateVisualization()"
      ]
    },
    {
      "id": "S7_DeleteFixup",
      "label": "delete_fixup",
      "type": "atomic",
      "entry_actions": [
        "deleteFixupStart()",
        "tree.updateVisualization()"
      ],
      "exit_actions": [
        "deleteFixupDone()"
      ]
    },
    {
      "id": "S8_Clearing",
      "label": "clearing",
      "type": "atomic",
      "entry_actions": [
        "tree.root = null",
        "tree.nodeMap.forEach(g=>{ if(g.parentNode) g.parentNode.removeChild(g); })",
        "tree.nodeMap.clear()",
        "Array.from(document.querySelectorAll('#svg .edge')).forEach(e=> e.parentNode.removeChild(e))",
        "tree.updateVisualization()",
        "tree.setLast('Cleared tree')"
      ],
      "exit_actions": []
    },
    {
      "id": "S9_BulkInserting",
      "label": "bulk_inserting",
      "type": "composite",
      "entry_actions": [
        "setRunningFlag(true)",
        "startBulkInsert(10)"
      ],
      "exit_actions": [
        "setRunningFlag(false)",
        "tree.updateVisualization()"
      ]
    },
    {
      "id": "S10_ExampleSequence",
      "label": "example_sequence",
      "type": "composite",
      "entry_actions": [
        "setRunningFlag(true)",
        "startExampleSequence([11,2,14,1,7,15,5,8,4])"
      ],
      "exit_actions": [
        "setRunningFlag(false)",
        "tree.updateVisualization()"
      ]
    },
    {
      "id": "S11_AdjustingSpeed",
      "label": "adjusting_speed",
      "type": "atomic",
      "entry_actions": [
        "readInputValue('#speed')",
        "tree.setSpeed(Number(document.getElementById('speed').value))",
        "document.getElementById('speedVal').textContent = String(Number(document.getElementById('speed').value))"
      ],
      "exit_actions": []
    },
    {
      "id": "S12_RandomInsert",
      "label": "random_insert",
      "type": "atomic",
      "entry_actions": [
        "const v = Math.floor(Math.random()*100)",
        "document.getElementById('insertVal').value = v",
        "setRunningFlag(true)",
        "tree.insertValue(v,true)"
      ],
      "exit_actions": [
        "setRunningFlag(false)",
        "tree.updateVisualization()"
      ]
    },
    {
      "id": "S13_BlockedWhileRunning",
      "label": "blocked_while_running",
      "type": "atomic",
      "entry_actions": [
        "noop()",
        "tree.setLast('Operation ignored: animation in progress')"
      ],
      "exit_actions": []
    }
  ],
  "events": [
    {
      "id": "USER_CLICK_BTN_INSERT",
      "event_type": "user_action",
      "description": "User clicks the Insert button (#btnInsert)"
    },
    {
      "id": "USER_CLICK_BTN_INSERT_STEP",
      "event_type": "user_action",
      "description": "User clicks the Insert (animated) button (#btnInsertStep)"
    },
    {
      "id": "USER_CLICK_BTN_RANDOM",
      "event_type": "user_action",
      "description": "User clicks the Insert Random button (#btnRandom)"
    },
    {
      "id": "USER_CLICK_BTN_BULK",
      "event_type": "user_action",
      "description": "User clicks the Bulk Insert button (#btnBulk)"
    },
    {
      "id": "USER_CLICK_BTN_DELETE",
      "event_type": "user_action",
      "description": "User clicks the Delete (animated) button (#btnDelete)"
    },
    {
      "id": "USER_CLICK_BTN_CLEAR",
      "event_type": "user_action",
      "description": "User clicks the Clear button (#btnClear)"
    },
    {
      "id": "USER_CLICK_BTN_EXAMPLE",
      "event_type": "user_action",
      "description": "User clicks the Load Example (classic) button (#btnExample)"
    },
    {
      "id": "USER_CHANGE_SPEED",
      "event_type": "user_action",
      "description": "User changes the animation speed input (#speed)"
    },
    {
      "id": "SYSTEM_INSERT_STARTED",
      "event_type": "system_event",
      "description": "insertValue started (tree.running set true)"
    },
    {
      "id": "SYSTEM_INSERT_FINISHED",
      "event_type": "system_event",
      "description": "insertValue finished (tree.running set false)"
    },
    {
      "id": "SYSTEM_DELETE_STARTED",
      "event_type": "system_event",
      "description": "deleteValue started (tree.running set true)"
    },
    {
      "id": "SYSTEM_DELETE_FINISHED",
      "event_type": "system_event",
      "description": "deleteValue finished (tree.running set false)"
    },
    {
      "id": "SYSTEM_ROTATION_PERFORMED",
      "event_type": "system_event",
      "description": "A rotation was performed (leftRotate or rightRotate) and updateVisualization was called"
    },
    {
      "id": "SYSTEM_RECOLOR_PERFORMED",
      "event_type": "system_event",
      "description": "A recoloring animation finished (animateRecolor)"
    },
    {
      "id": "SYSTEM_NODE_FLASHED",
      "event_type": "system_event",
      "description": "A node flash animation completed (animateFlashNode)"
    },
    {
      "id": "SYSTEM_TREE_CLEARED",
      "event_type": "system_event",
      "description": "Tree cleared and visualization updated"
    },
    {
      "id": "SYSTEM_BULK_STEP_COMPLETE",
      "event_type": "system_event",
      "description": "One step of bulk insert completed"
    },
    {
      "id": "SYSTEM_EXAMPLE_STEP_COMPLETE",
      "event_type": "system_event",
      "description": "One step of example sequence completed"
    },
    {
      "id": "SYSTEM_OPERATION_IGNORED",
      "event_type": "system_event",
      "description": "An operation was requested while tree.running === true and was ignored"
    }
  ],
  "transitions": [
    {
      "from": "S0_Idle",
      "to": "S1_InsertingInstant",
      "event": "USER_CLICK_BTN_INSERT",
      "guard": "inputIsFinite && tree.running === false",
      "actions": [
        "captureInput('#insertVal')",
        "tree.insertValue(Number(document.getElementById('insertVal').value), false)"
      ],
      "triggers": "#btnInsert",
      "expected_observables": [
        "dom:#btnInsert.click",
        "dom:#insertVal.value",
        "system:SYSTEM_INSERT_STARTED"
      ],
      "timeout": 3000
    },
    {
      "from": "S0_Idle",
      "to": "S2_InsertingAnimated",
      "event": "USER_CLICK_BTN_INSERT_STEP",
      "guard": "inputIsFinite && tree.running === false",
      "actions": [
        "captureInput('#insertVal')",
        "tree.insertValue(Number(document.getElementById('insertVal').value), true)"
      ],
      "triggers": "#btnInsertStep",
      "expected_observables": [
        "dom:#btnInsertStep.click",
        "dom:#insertVal.value",
        "system:SYSTEM_INSERT_STARTED"
      ],
      "timeout": 10000
    },
    {
      "from": "S0_Idle",
      "to": "S12_RandomInsert",
      "event": "USER_CLICK_BTN_RANDOM",
      "guard": "tree.running === false",
      "actions": [
        "generateRandom('#insertVal')",
        "tree.insertValue(Number(document.getElementById('insertVal').value), true)"
      ],
      "triggers": "#btnRandom",
      "expected_observables": [
        "dom:#btnRandom.click",
        "dom:#insertVal.value",
        "system:SYSTEM_INSERT_STARTED"
      ],
      "timeout": 5000
    },
    {
      "from": "S0_Idle",
      "to": "S9_BulkInserting",
      "event": "USER_CLICK_BTN_BULK",
      "guard": "tree.running === false",
      "actions": [
        "startBulkInsert(10)"
      ],
      "triggers": "#btnBulk",
      "expected_observables": [
        "dom:#btnBulk.click",
        "system:SYSTEM_BULK_STEP_COMPLETE"
      ],
      "timeout": 60000
    },
    {
      "from": "S9_BulkInserting",
      "to": "S9_BulkInserting",
      "event": "SYSTEM_BULK_STEP_COMPLETE",
      "guard": "moreBulkStepsRemaining",
      "actions": [
        "continueBulkInsertStep()"
      ],
      "triggers": "#btnBulk",
      "expected_observables": [
        "system:SYSTEM_INSERT_FINISHED",
        "dom:#insertVal.value"
      ],
      "timeout": 20000
    },
    {
      "from": "S9_BulkInserting",
      "to": "S0_Idle",
      "event": "SYSTEM_BULK_STEP_COMPLETE",
      "guard": "bulkComplete",
      "actions": [
        "finishBulkInsert()",
        "tree.updateVisualization()"
      ],
      "triggers": "#btnBulk",
      "expected_observables": [
        "system:SYSTEM_INSERT_FINISHED",
        "dom:#svg .node"
      ],
      "timeout": 1000
    },
    {
      "from": "S0_Idle",
      "to": "S6_DeletingAnimated",
      "event": "USER_CLICK_BTN_DELETE",
      "guard": "inputIsFinite && tree.running === false",
      "actions": [
        "captureInput('#deleteVal')",
        "tree.deleteValue(Number(document.getElementById('deleteVal').value), true)"
      ],
      "triggers": "#btnDelete",
      "expected_observables": [
        "dom:#btnDelete.click",
        "dom:#deleteVal.value",
        "system:SYSTEM_DELETE_STARTED"
      ],
      "timeout": 15000
    },
    {
      "from": "S6_DeletingAnimated",
      "to": "S7_DeleteFixup",
      "event": "SYSTEM_DELETE_STARTED",
      "guard": "deleteProceededToFixup",
      "actions": [
        "enterDeleteFixup()"
      ],
      "triggers": "#btnDelete",
      "expected_observables": [
        "system:SYSTEM_ROTATION_PERFORMED",
        "system:SYSTEM_RECOLOR_PERFORMED"
      ],
      "timeout": 20000
    },
    {
      "from": "S6_DeletingAnimated",
      "to": "S0_Idle",
      "event": "SYSTEM_DELETE_FINISHED",
      "guard": "true",
      "actions": [
        "tree.updateVisualization()",
        "tree.setLast('Delete finished')"
      ],
      "triggers": "#btnDelete",
      "expected_observables": [
        "dom:#svg .node",
        "system:SYSTEM_DELETE_FINISHED"
      ],
      "timeout": 1000
    },
    {
      "from": "S0_Idle",
      "to": "S8_Clearing",
      "event": "USER_CLICK_BTN_CLEAR",
      "guard": "true",
      "actions": [
        "clearTree()"
      ],
      "triggers": "#btnClear",
      "expected_observables": [
        "dom:#btnClear.click",
        "system:SYSTEM_TREE_CLEARED",
        "dom:#svg .node == 0"
      ],
      "timeout": 1000
    },
    {
      "from": "S8_Clearing",
      "to": "S0_Idle",
      "event": "SYSTEM_TREE_CLEARED",
      "guard": "true",
      "actions": [
        "tree.updateVisualization()",
        "tree.setLast('Cleared tree')"
      ],
      "triggers": "#btnClear",
      "expected_observables": [
        "dom:#svg .node == 0",
        "dom:#propContent.innerHTML includes 'Tree is empty'"
      ],
      "timeout": 500
    },
    {
      "from": "S0_Idle",
      "to": "S10_ExampleSequence",
      "event": "USER_CLICK_BTN_EXAMPLE",
      "guard": "tree.running === false",
      "actions": [
        "startExampleSequence([11,2,14,1,7,15,5,8,4])"
      ],
      "triggers": "#btnExample",
      "expected_observables": [
        "dom:#btnExample.click",
        "system:SYSTEM_EXAMPLE_STEP_COMPLETE"
      ],
      "timeout": 60000
    },
    {
      "from": "S10_ExampleSequence",
      "to": "S10_ExampleSequence",
      "event": "SYSTEM_EXAMPLE_STEP_COMPLETE",
      "guard": "moreExampleStepsRemaining",
      "actions": [
        "continueExampleStep()"
      ],
      "triggers": "#btnExample",
      "expected_observables": [
        "system:SYSTEM_INSERT_FINISHED",
        "dom:#svg .node"
      ],
      "timeout": 30000
    },
    {
      "from": "S10_ExampleSequence",
      "to": "S0_Idle",
      "event": "SYSTEM_EXAMPLE_STEP_COMPLETE",
      "guard": "exampleComplete",
      "actions": [
        "finishExampleSequence()",
        "tree.updateVisualization()"
      ],
      "triggers": "#btnExample",
      "expected_observables": [
        "dom:#svg .node",
        "system:SYSTEM_INSERT_FINISHED"
      ],
      "timeout": 1000
    },
    {
      "from": "S0_Idle",
      "to": "S11_AdjustingSpeed",
      "event": "USER_CHANGE_SPEED",
      "guard": "true",
      "actions": [
        "tree.setSpeed(Number(document.getElementById('speed').value))",
        "document.getElementById('speedVal').textContent = document.getElementById('speed').value"
      ],
      "triggers": "#speed",
      "expected_observables": [
        "dom:#speed.input",
        "dom:#speedVal.textContent changed"
      ],
      "timeout": 200
    },
    {
      "from": "S2_InsertingAnimated",
      "to": "S3_InsertFixup",
      "event": "SYSTEM_INSERT_STARTED",
      "guard": "insertMovedToFixup",
      "actions": [
        "enterInsertFixup()"
      ],
      "triggers": "#btnInsertStep,#btnInsert",
      "expected_observables": [
        "system:SYSTEM_ROTATION_PERFORMED",
        "system:SYSTEM_RECOLOR_PERFORMED"
      ],
      "timeout": 20000
    },
    {
      "from": "S3_InsertFixup",
      "to": "S4_Rotating",
      "event": "SYSTEM_ROTATION_PERFORMED",
      "guard": "rotationOccurred",
      "actions": [
        "tree.updateVisualization()",
        "animateRotation()"
      ],
      "triggers": ".node",
      "expected_observables": [
        "system:SYSTEM_ROTATION_PERFORMED",
        "dom:#svg .node"
      ],
      "timeout": 5000
    },
    {
      "from": "S3_InsertFixup",
      "to": "S5_Recoloring",
      "event": "SYSTEM_RECOLOR_PERFORMED",
      "guard": "recolorOccurred",
      "actions": [
        "tree.updateVisualization()",
        "animateRecolor()"
      ],
      "triggers": ".node",
      "expected_observables": [
        "system:SYSTEM_RECOLOR_PERFORMED",
        "dom:#svg .node"
      ],
      "timeout": 4000
    },
    {
      "from": "S4_Rotating",
      "to": "S3_InsertFixup",
      "event": "SYSTEM_ROTATION_PERFORMED",
      "guard": "true",
      "actions": [
        "completeRotation()",
        "tree.updateVisualization()"
      ],
      "triggers": ".node",
      "expected_observables": [
        "dom:#svg .node",
        "system:SYSTEM_ROTATION_PERFORMED"
      ],
      "timeout": 3000
    },
    {
      "from": "S5_Recoloring",
      "to": "S3_InsertFixup",
      "event": "SYSTEM_RECOLOR_PERFORMED",
      "guard": "true",
      "actions": [
        "completeRecolor()",
        "tree.updateVisualization()"
      ],
      "triggers": ".node",
      "expected_observables": [
        "dom:#svg .node",
        "system:SYSTEM_RECOLOR_PERFORMED"
      ],
      "timeout": 3000
    },
    {
      "from": "S3_InsertFixup",
      "to": "S0_Idle",
      "event": "SYSTEM_INSERT_FINISHED",
      "guard": "true",
      "actions": [
        "tree.updateVisualization()",
        "tree.setLast('Inserted')"
      ],
      "triggers": "#btnInsertStep,#btnInsert",
      "expected_observables": [
        "dom:#svg .node",
        "system:SYSTEM_INSERT_FINISHED"
      ],
      "timeout": 1000
    },
    {
      "from": "S0_Idle",
      "to": "S13_BlockedWhileRunning",
      "event": "USER_CLICK_BTN_INSERT",
      "guard": "tree.running === true",
      "actions": [
        "tree.setLast('Operation ignored: animation in progress')"
      ],
      "triggers": "#btnInsert,#btnInsertStep,#btnRandom,#btnBulk,#btnDelete,#btnExample",
      "expected_observables": [
        "system:SYSTEM_OPERATION_IGNORED"
      ],
      "timeout": 200
    }
  ],
  "components": [
    "#insertVal",
    "#deleteVal",
    "#speed",
    "#speedVal",
    "#btnInsert",
    "#btnInsertStep",
    "#btnRandom",
    "#btnBulk",
    "#btnDelete",
    "#btnClear",
    "#btnExample",
    "#svg",
    "#svgwrap",
    "#left",
    ".node",
    ".edge"
  ]
}