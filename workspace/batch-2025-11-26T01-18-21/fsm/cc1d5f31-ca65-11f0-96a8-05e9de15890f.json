{
  "meta": {
    "concept": "Graph",
    "topic": "Interactive Graph (Directed / Undirected)",
    "educational_goal": "Allow users to construct and edit directed or undirected graphs, view adjacency list/matrix, and interactively move/delete nodes and edges.",
    "expected_interactions": [
      "add_node",
      "add_edge",
      "move_node",
      "delete",
      "toggle_directed",
      "clear",
      "randomize",
      "inspect_adjacency"
    ]
  },
  "states": [
    {
      "id": "S0_AddNode",
      "label": "AddNodeMode",
      "type": "mode",
      "entry_actions": [
        "setMode('addnode')",
        "btnAddNode.classList.add('active')",
        "selectedForEdge = null",
        "canvas.style.cursor = (mode === 'move') ? 'grab' : 'crosshair'",
        "draw()",
        "updateInfo()"
      ],
      "exit_actions": [
        "/* leave addnode mode */"
      ]
    },
    {
      "id": "S1_AddEdge_Idle",
      "label": "AddEdgeMode_Idle",
      "type": "mode",
      "entry_actions": [
        "setMode('addedge')",
        "selectedForEdge = null",
        "btnAddEdge.classList.add('active')",
        "canvas.style.cursor = 'crosshair'",
        "draw()",
        "updateInfo()"
      ],
      "exit_actions": [
        "clearSelectedForEdge = () => { selectedForEdge = null; draw(); }"
      ]
    },
    {
      "id": "S2_AddEdge_SourceSelected",
      "label": "AddEdgeMode_SourceSelected",
      "type": "atomic",
      "entry_actions": [
        "selectedForEdge = clickedNode",
        "/* highlight selected source */",
        "draw()"
      ],
      "exit_actions": [
        "selectedForEdge = null",
        "/* clear highlight */",
        "draw()"
      ]
    },
    {
      "id": "S3_Move_Idle",
      "label": "MoveMode_Idle",
      "type": "mode",
      "entry_actions": [
        "setMode('move')",
        "btnMove.classList.add('active')",
        "canvas.style.cursor = 'grab'",
        "draw()",
        "updateInfo()"
      ],
      "exit_actions": [
        "draggingNode = null",
        "canvas.style.cursor = 'crosshair'"
      ]
    },
    {
      "id": "S4_Move_Dragging",
      "label": "MoveMode_Dragging",
      "type": "atomic",
      "entry_actions": [
        "draggingNode = clickedNode",
        "dragOffset = {x: pointerX - draggingNode.x, y: pointerY - draggingNode.y}",
        "canvas.setPointerCapture(pointerId)",
        "canvas.style.cursor = 'grabbing'",
        "draw()"
      ],
      "exit_actions": [
        "draggingNode = null",
        "canvas.releasePointerCapture(pointerId)",
        "canvas.style.cursor = 'grab'",
        "updateInfo()",
        "draw()"
      ]
    },
    {
      "id": "S5_Delete_Idle",
      "label": "DeleteMode_Idle",
      "type": "mode",
      "entry_actions": [
        "setMode('delete')",
        "btnDelete.classList.add('active')",
        "canvas.style.cursor = 'crosshair'",
        "draw()",
        "updateInfo()"
      ],
      "exit_actions": []
    },
    {
      "id": "S6_Clearing",
      "label": "Clearing",
      "type": "atomic",
      "entry_actions": [
        "nodes = []",
        "edges = []",
        "nextNodeId = 0",
        "selectedForEdge = null",
        "draw()",
        "updateInfo()"
      ],
      "exit_actions": []
    },
    {
      "id": "S7_Randomizing",
      "label": "Randomizing",
      "type": "atomic",
      "entry_actions": [
        "nodes = []; edges = []; nextNodeId = 0",
        "generateRandomGraph()",
        "draw()",
        "updateInfo()"
      ],
      "exit_actions": []
    },
    {
      "id": "S8_Directed_On",
      "label": "DirectedOn",
      "type": "atomic",
      "entry_actions": [
        "isDirected = true",
        "directedCheck.checked = true",
        "draw()",
        "updateInfo()"
      ],
      "exit_actions": []
    },
    {
      "id": "S9_Directed_Off",
      "label": "DirectedOff",
      "type": "atomic",
      "entry_actions": [
        "isDirected = false",
        "directedCheck.checked = false",
        "draw()",
        "updateInfo()"
      ],
      "exit_actions": []
    },
    {
      "id": "S10_Resizing",
      "label": "Resizing",
      "type": "atomic",
      "entry_actions": [
        "resizeCanvas()",
        "draw()"
      ],
      "exit_actions": []
    }
  ],
  "events": [
    {
      "id": "USER_CLICK_BTN_ADDNODE",
      "event_type": "user_action",
      "description": "User clicks the Add Node mode button (#btnAddNode)"
    },
    {
      "id": "USER_CLICK_BTN_ADDEDGE",
      "event_type": "user_action",
      "description": "User clicks the Add Edge mode button (#btnAddEdge)"
    },
    {
      "id": "USER_CLICK_BTN_MOVE",
      "event_type": "user_action",
      "description": "User clicks the Move mode button (#btnMove)"
    },
    {
      "id": "USER_CLICK_BTN_DELETE",
      "event_type": "user_action",
      "description": "User clicks the Delete mode button (#btnDelete)"
    },
    {
      "id": "USER_TOGGLE_DIRECTED",
      "event_type": "user_action",
      "description": "User toggles the Directed graph checkbox (#directedCheck)"
    },
    {
      "id": "USER_CHANGE_EDGE_WEIGHT",
      "event_type": "user_action",
      "description": "User changes the edge weight input (#edgeWeight)"
    },
    {
      "id": "USER_CLICK_CLEAR",
      "event_type": "user_action",
      "description": "User clicks the Clear button (#clearBtn)"
    },
    {
      "id": "USER_CLICK_RANDOM",
      "event_type": "user_action",
      "description": "User clicks the Random Graph button (#randomBtn)"
    },
    {
      "id": "CANVAS_POINTERDOWN",
      "event_type": "user_action",
      "description": "Pointerdown event on the canvas (#graphCanvas)"
    },
    {
      "id": "CANVAS_POINTERMOVE",
      "event_type": "user_action",
      "description": "Pointermove event on the canvas (#graphCanvas)"
    },
    {
      "id": "CANVAS_POINTERUP",
      "event_type": "user_action",
      "description": "Pointerup event on the canvas (#graphCanvas)"
    },
    {
      "id": "CANVAS_DBLCLICK",
      "event_type": "user_action",
      "description": "Double-click on the canvas to cancel edge selection (#graphCanvas)"
    },
    {
      "id": "KEY_ESCAPE",
      "event_type": "user_action",
      "description": "User presses Escape key (window)"
    },
    {
      "id": "KEY_DELETE_OR_BACKSPACE",
      "event_type": "user_action",
      "description": "User presses Delete or Backspace (window)"
    },
    {
      "id": "WINDOW_RESIZE",
      "event_type": "user_action",
      "description": "Window resize event (window)"
    }
  ],
  "transitions": [
    {
      "from": "S_ANY",
      "to": "S0_AddNode",
      "event": "USER_CLICK_BTN_ADDNODE",
      "guard": "true",
      "actions": [
        "setMode('addnode')",
        "draw()",
        "updateInfo()"
      ],
      "triggers": "#btnAddNode",
      "expected_observables": [
        "dom:#btnAddNode:click"
      ],
      "timeout": 500
    },
    {
      "from": "S_ANY",
      "to": "S1_AddEdge_Idle",
      "event": "USER_CLICK_BTN_ADDEDGE",
      "guard": "true",
      "actions": [
        "setMode('addedge')",
        "selectedForEdge = null",
        "draw()",
        "updateInfo()"
      ],
      "triggers": "#btnAddEdge",
      "expected_observables": [
        "dom:#btnAddEdge:click"
      ],
      "timeout": 500
    },
    {
      "from": "S_ANY",
      "to": "S3_Move_Idle",
      "event": "USER_CLICK_BTN_MOVE",
      "guard": "true",
      "actions": [
        "setMode('move')",
        "draw()",
        "updateInfo()"
      ],
      "triggers": "#btnMove",
      "expected_observables": [
        "dom:#btnMove:click"
      ],
      "timeout": 500
    },
    {
      "from": "S_ANY",
      "to": "S5_Delete_Idle",
      "event": "USER_CLICK_BTN_DELETE",
      "guard": "true",
      "actions": [
        "setMode('delete')",
        "draw()",
        "updateInfo()"
      ],
      "triggers": "#btnDelete",
      "expected_observables": [
        "dom:#btnDelete:click"
      ],
      "timeout": 500
    },
    {
      "from": "S_ANY",
      "to": "S_ANY",
      "event": "USER_TOGGLE_DIRECTED",
      "guard": "true",
      "actions": [
        "isDirected = directedCheck.checked",
        "draw()",
        "updateInfo()"
      ],
      "triggers": "#directedCheck",
      "expected_observables": [
        "dom:#directedCheck:change"
      ],
      "timeout": 300
    },
    {
      "from": "S_ANY",
      "to": "S_ANY",
      "event": "USER_CHANGE_EDGE_WEIGHT",
      "guard": "true",
      "actions": [
        "/* edge weight updated by reading #edgeWeight when adding an edge */"
      ],
      "triggers": "#edgeWeight",
      "expected_observables": [
        "dom:#edgeWeight:input",
        "dom:#edgeWeight:change"
      ],
      "timeout": 200
    },
    {
      "from": "S_ANY",
      "to": "S_ANY",
      "event": "USER_CLICK_CLEAR",
      "guard": "true",
      "actions": [
        "nodes = []",
        "edges = []",
        "nextNodeId = 0",
        "selectedForEdge = null",
        "draw()",
        "updateInfo()"
      ],
      "triggers": "#clearBtn",
      "expected_observables": [
        "dom:#clearBtn:click"
      ],
      "timeout": 500
    },
    {
      "from": "S_ANY",
      "to": "S_ANY",
      "event": "USER_CLICK_RANDOM",
      "guard": "true",
      "actions": [
        "/* generateRandomGraph implementation: populate nodes and edges randomly */",
        "draw()",
        "updateInfo()"
      ],
      "triggers": "#randomBtn",
      "expected_observables": [
        "dom:#randomBtn:click"
      ],
      "timeout": 1500
    },
    {
      "from": "S0_AddNode",
      "to": "S0_AddNode",
      "event": "CANVAS_POINTERDOWN",
      "guard": "pointerDown && mode==='addnode'",
      "actions": [
        "addNode(pointerX, pointerY)",
        "draw()",
        "updateInfo()"
      ],
      "triggers": "#graphCanvas",
      "expected_observables": [
        "dom:#graphCanvas:pointerdown"
      ],
      "timeout": 300
    },
    {
      "from": "S1_AddEdge_Idle",
      "to": "S2_AddEdge_SourceSelected",
      "event": "CANVAS_POINTERDOWN",
      "guard": "clickedOnNode",
      "actions": [
        "selectedForEdge = clickedNode",
        "draw()"
      ],
      "triggers": "#graphCanvas",
      "expected_observables": [
        "dom:#graphCanvas:pointerdown (on node)"
      ],
      "timeout": 300
    },
    {
      "from": "S2_AddEdge_SourceSelected",
      "to": "S1_AddEdge_Idle",
      "event": "CANVAS_POINTERDOWN",
      "guard": "clickedOnNode (target) || clickedOnSameNode (self-loop)",
      "actions": [
        "const weight = parseFloat(edgeWeight.value) || 1",
        "addEdgeInternal(selectedForEdge.id, clickedNode.id, weight)",
        "selectedForEdge = null",
        "draw()",
        "updateInfo()"
      ],
      "triggers": "#graphCanvas",
      "expected_observables": [
        "dom:#graphCanvas:pointerdown (on node target)"
      ],
      "timeout": 500
    },
    {
      "from": "S2_AddEdge_SourceSelected",
      "to": "S1_AddEdge_Idle",
      "event": "CANVAS_DBLCLICK",
      "guard": "true",
      "actions": [
        "selectedForEdge = null",
        "draw()"
      ],
      "triggers": "#graphCanvas",
      "expected_observables": [
        "dom:#graphCanvas:dblclick"
      ],
      "timeout": 200
    },
    {
      "from": "S2_AddEdge_SourceSelected",
      "to": "S1_AddEdge_Idle",
      "event": "KEY_ESCAPE",
      "guard": "true",
      "actions": [
        "selectedForEdge = null",
        "draw()"
      ],
      "triggers": "window",
      "expected_observables": [
        "dom:window:keydown (Escape)"
      ],
      "timeout": 200
    },
    {
      "from": "S3_Move_Idle",
      "to": "S4_Move_Dragging",
      "event": "CANVAS_POINTERDOWN",
      "guard": "clickedOnNode",
      "actions": [
        "draggingNode = clickedNode",
        "dragOffset = {x: pointerX - draggingNode.x, y: pointerY - draggingNode.y}",
        "canvas.setPointerCapture(pointerId)",
        "canvas.style.cursor = 'grabbing'",
        "draw()"
      ],
      "triggers": "#graphCanvas",
      "expected_observables": [
        "dom:#graphCanvas:pointerdown (on node)"
      ],
      "timeout": 1000
    },
    {
      "from": "S4_Move_Dragging",
      "to": "S4_Move_Dragging",
      "event": "CANVAS_POINTERMOVE",
      "guard": "draggingNode != null",
      "actions": [
        "draggingNode.x = pointerX - dragOffset.x",
        "draggingNode.y = pointerY - dragOffset.y",
        "draw()"
      ],
      "triggers": "#graphCanvas",
      "expected_observables": [
        "dom:#graphCanvas:pointermove"
      ],
      "timeout": 0
    },
    {
      "from": "S4_Move_Dragging",
      "to": "S3_Move_Idle",
      "event": "CANVAS_POINTERUP",
      "guard": "draggingNode != null",
      "actions": [
        "draggingNode = null",
        "canvas.releasePointerCapture(pointerId)",
        "canvas.style.cursor = 'grab'",
        "updateInfo()",
        "draw()"
      ],
      "triggers": "#graphCanvas",
      "expected_observables": [
        "dom:#graphCanvas:pointerup"
      ],
      "timeout": 300
    },
    {
      "from": "S5_Delete_Idle",
      "to": "S5_Delete_Idle",
      "event": "CANVAS_POINTERDOWN",
      "guard": "clickedOnNode || hitEdgeNear",
      "actions": [
        "if(clickedOnNode) { nodes = nodes.filter(nd=>nd.id!==clickedNode.id); edges = edges.filter(e=>e.from!==clickedNode.id && e.to!==clickedNode.id); }",
        "else if(hitEdgeNear) { if(isDirected) edges = edges.filter(e=>!(e.from===hit.from && e.to===hit.to)); else edges = edges.filter(e=>!((e.from===hit.from && e.to===hit.to)||(e.from===hit.to && e.to===hit.from))); }",
        "updateInfo()",
        "draw()"
      ],
      "triggers": "#graphCanvas",
      "expected_observables": [
        "dom:#graphCanvas:pointerdown (on node or near edge)"
      ],
      "timeout": 300
    },
    {
      "from": "S5_Delete_Idle",
      "to": "S5_Delete_Idle",
      "event": "KEY_DELETE_OR_BACKSPACE",
      "guard": "mode==='delete' && nodes.length>0",
      "actions": [
        "const last = nodes[nodes.length-1]; nodes = nodes.slice(0,-1); edges = edges.filter(e=>e.from!==last.id && e.to!==last.id); updateInfo(); draw();"
      ],
      "triggers": "window",
      "expected_observables": [
        "dom:window:keydown (Delete|Backspace)"
      ],
      "timeout": 300
    },
    {
      "from": "S_ANY",
      "to": "S10_Resizing",
      "event": "WINDOW_RESIZE",
      "guard": "true",
      "actions": [
        "dpr = window.devicePixelRatio || 1",
        "resizeCanvas()",
        "draw()"
      ],
      "triggers": "window",
      "expected_observables": [
        "dom:window:resize"
      ],
      "timeout": 1000
    }
  ],
  "components": [
    "#btnAddNode",
    "#btnAddEdge",
    "#btnMove",
    "#btnDelete",
    "#directedCheck",
    "#edgeWeight",
    "#clearBtn",
    "#randomBtn",
    "#infoNodes",
    "#infoEdges",
    "#adjList",
    "#adjMatrix",
    "#graphCanvas",
    ".modeBtn",
    ".modeBtn.active",
    ".modes",
    ".small",
    ".secondary",
    "#sidebar",
    "#canvasWrap"
  ]
}