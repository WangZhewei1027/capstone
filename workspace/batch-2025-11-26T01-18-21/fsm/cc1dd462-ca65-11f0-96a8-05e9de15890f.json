{
  "meta": {
    "concept": "QuickSort",
    "topic": "Quick Sort Visualization",
    "educational_goal": "Demonstrate Quick Sort (Lomuto partition) with pivot strategies, visualize comparisons, swaps, and recursion stack; allow play/pause/step/reset and configuration of array size and speed",
    "expected_interactions": [
      "generate",
      "shuffle",
      "start",
      "pause",
      "step",
      "reset",
      "change_size",
      "change_speed",
      "change_pivot",
      "toggle_showValues",
      "keyboard_shortcuts"
    ]
  },
  "states": [
    {
      "id": "S0_Idle",
      "label": "idle",
      "type": "idle",
      "entry_actions": [
        "renderArray()",
        "updateStats()",
        "stopTimer()",
        "ensureControlsEnabled()"
      ],
      "exit_actions": []
    },
    {
      "id": "S1_Generating",
      "label": "generating_array",
      "type": "atomic",
      "entry_actions": [
        "stop()",
        "generateArray(Number(sizeRange.value))",
        "renderArray()",
        "updateStats()"
      ],
      "exit_actions": []
    },
    {
      "id": "S2_Shuffling",
      "label": "shuffling_array",
      "type": "atomic",
      "entry_actions": [
        "stop()",
        "shuffleArray()",
        "renderArray()",
        "updateStats()"
      ],
      "exit_actions": []
    },
    {
      "id": "S3_Running",
      "label": "running_auto",
      "type": "composite",
      "entry_actions": [
        "running = true",
        "paused = false",
        "cmpCount = swapCount = stepCount = 0",
        "sortedIndices.clear()",
        "generator = quickSortGen(array, pivotSelect.value)",
        "runGenerator(true)"
      ],
      "exit_actions": [
        "stopTimer()"
      ]
    },
    {
      "id": "S4_Paused",
      "label": "paused",
      "type": "atomic",
      "entry_actions": [
        "paused = true",
        "stopTimer()"
      ],
      "exit_actions": [
        "paused = false"
      ]
    },
    {
      "id": "S5_StepMode",
      "label": "step_mode",
      "type": "atomic",
      "entry_actions": [
        "if(!running){ running=true; paused=true; sortedIndices.clear(); generator = quickSortGen(array, pivotSelect.value); }",
        "stopTimer()",
        "runGenerator(false)"
      ],
      "exit_actions": []
    },
    {
      "id": "S6_Resetting",
      "label": "resetting",
      "type": "atomic",
      "entry_actions": [
        "stop()",
        "generateArray(Number(sizeRange.value))",
        "renderArray()",
        "updateStats()"
      ],
      "exit_actions": []
    },
    {
      "id": "S7_ChangingSize",
      "label": "changing_size",
      "type": "atomic",
      "entry_actions": [
        "sizeVal.textContent = sizeRange.value"
      ],
      "exit_actions": []
    },
    {
      "id": "S8_ChangingSpeed",
      "label": "changing_speed",
      "type": "atomic",
      "entry_actions": [
        "delay = Number(speedRange.value)",
        "speedVal.textContent = delay + ' ms'"
      ],
      "exit_actions": []
    },
    {
      "id": "S9_ChangingPivot",
      "label": "changing_pivot",
      "type": "atomic",
      "entry_actions": [
        "pivotName.textContent = pivotSelect.options[pivotSelect.selectedIndex].text"
      ],
      "exit_actions": []
    },
    {
      "id": "S10_ToggleShowValues",
      "label": "toggle_show_values",
      "type": "atomic",
      "entry_actions": [
        "bars.forEach(b => { if(showValues.checked) b.classList.add('show-value'); else b.classList.remove('show-value'); })"
      ],
      "exit_actions": []
    },
    {
      "id": "S11_Op_PivotHighlight",
      "label": "op_pivot_highlight",
      "type": "atomic",
      "entry_actions": [
        "updateBarStyles({pivotIndex:op.pivotIndex, activeRange:op.activeRange})",
        "stepCount++",
        "stepCountEl.textContent = stepCount"
      ],
      "exit_actions": []
    },
    {
      "id": "S12_Op_Comparing",
      "label": "op_comparing",
      "type": "atomic",
      "entry_actions": [
        "cmpCount++",
        "cmpCountEl.textContent = cmpCount",
        "updateBarStyles({compare:op.compare, pivotIndex:op.pivotIndex, activeRange:op.activeRange})",
        "stepCount++",
        "stepCountEl.textContent = stepCount"
      ],
      "exit_actions": []
    },
    {
      "id": "S13_Op_Swapping",
      "label": "op_swapping",
      "type": "atomic",
      "entry_actions": [
        "swapCount++",
        "swapCountEl.textContent = swapCount",
        "renderHeights()",
        "updateBarStyles({swap:op.swap, activeRange:op.activeRange, markPlaced:op.markPlaced})",
        "stepCount++",
        "stepCountEl.textContent = stepCount"
      ],
      "exit_actions": []
    },
    {
      "id": "S14_Op_MarkPlaced",
      "label": "op_marked_placed",
      "type": "atomic",
      "entry_actions": [
        "if(typeof op.markPlaced === 'number') sortedIndices.add(op.markPlaced)",
        "updateBarStyles({markPlaced:op.markPlaced, activeRange:op.activeRange})",
        "stepCount++",
        "stepCountEl.textContent = stepCount"
      ],
      "exit_actions": []
    },
    {
      "id": "S15_Op_Placed",
      "label": "op_placed",
      "type": "atomic",
      "entry_actions": [
        "if(typeof op.index === 'number') sortedIndices.add(op.index)",
        "updateBarStyles({markPlaced:op.index, activeRange:op.activeRange})",
        "stepCount++",
        "stepCountEl.textContent = stepCount"
      ],
      "exit_actions": []
    },
    {
      "id": "S16_Op_StackUpdate",
      "label": "op_stack_update",
      "type": "atomic",
      "entry_actions": [
        "stackRanges = op.stack.slice()",
        "updateStats()",
        "updateBarStyles({activeRange:op.activeRange})"
      ],
      "exit_actions": []
    },
    {
      "id": "S17_Done",
      "label": "done",
      "type": "final",
      "entry_actions": [
        "running = false",
        "paused = false",
        "for(let i=0;i<array.length;i++) sortedIndices.add(i)",
        "updateBarStyles()",
        "updateStats()",
        "stopTimer()"
      ],
      "exit_actions": []
    }
  ],
  "events": [
    {
      "id": "USER_CLICK_GENERATE",
      "event_type": "user_action",
      "description": "User clicks the Generate button (#generate)",
      "triggers": "#generate"
    },
    {
      "id": "USER_CLICK_SHUFFLE",
      "event_type": "user_action",
      "description": "User clicks the Shuffle button (#shuffle)",
      "triggers": "#shuffle"
    },
    {
      "id": "USER_CLICK_START",
      "event_type": "user_action",
      "description": "User clicks the Start button (#start)",
      "triggers": "#start"
    },
    {
      "id": "USER_CLICK_PAUSE",
      "event_type": "user_action",
      "description": "User clicks the Pause button (#pause)",
      "triggers": "#pause"
    },
    {
      "id": "USER_CLICK_STEP",
      "event_type": "user_action",
      "description": "User clicks the Step button (#step)",
      "triggers": "#step"
    },
    {
      "id": "USER_CLICK_RESET",
      "event_type": "user_action",
      "description": "User clicks the Reset button (#reset)",
      "triggers": "#reset"
    },
    {
      "id": "USER_CHANGE_SIZE",
      "event_type": "user_action",
      "description": "User changes array size slider (input#size)",
      "triggers": "input#size"
    },
    {
      "id": "USER_CHANGE_SPEED",
      "event_type": "user_action",
      "description": "User changes speed slider (input#speed)",
      "triggers": "input#speed"
    },
    {
      "id": "USER_CHANGE_PIVOT",
      "event_type": "user_action",
      "description": "User changes pivot strategy (select#pivot)",
      "triggers": "select#pivot"
    },
    {
      "id": "USER_TOGGLE_SHOWVALUES",
      "event_type": "user_action",
      "description": "User toggles show values checkbox (input#showValues)",
      "triggers": "input#showValues"
    },
    {
      "id": "USER_KEYSPACE",
      "event_type": "user_action",
      "description": "User presses Space to toggle play/pause (keyboard on body)",
      "triggers": "body"
    },
    {
      "id": "USER_KEY_RIGHT",
      "event_type": "user_action",
      "description": "User presses ArrowRight to step (keyboard on body)",
      "triggers": "body"
    },
    {
      "id": "USER_KEY_RESET_R",
      "event_type": "user_action",
      "description": "User presses R to reset (keyboard on body)",
      "triggers": "body"
    },
    {
      "id": "OP_PIVOT",
      "event_type": "system_event",
      "description": "Generator yields pivot selection operation (visualized by .bar.pivot)",
      "triggers": ".bar.pivot"
    },
    {
      "id": "OP_COMPARE",
      "event_type": "system_event",
      "description": "Generator yields compare operation (visualized by .bar.compare)",
      "triggers": ".bar.compare"
    },
    {
      "id": "OP_SWAP",
      "event_type": "system_event",
      "description": "Generator yields swap operation (visualized by .bar.swap)",
      "triggers": ".bar.swap"
    },
    {
      "id": "OP_MARK",
      "event_type": "system_event",
      "description": "Generator yields mark operation (pivot already placed) (visualized by .bar.sorted)",
      "triggers": ".bar.sorted"
    },
    {
      "id": "OP_PLACED",
      "event_type": "system_event",
      "description": "Generator reports final pivot placement (visualized by .bar.sorted)",
      "triggers": ".bar.sorted"
    },
    {
      "id": "OP_STACK",
      "event_type": "system_event",
      "description": "Generator updates stack view (DOM changes in #stackList .stack-item)",
      "triggers": "#stackList .stack-item"
    },
    {
      "id": "OP_DONE",
      "event_type": "system_event",
      "description": "Generator finished sorting (visualized by all bars .bar.sorted and stack empty)",
      "triggers": "#visual .bar, .bar.sorted, #stackList"
    }
  ],
  "transitions": [
    {
      "from": "S0_Idle",
      "to": "S1_Generating",
      "event": "USER_CLICK_GENERATE",
      "guard": "true",
      "actions": [
        "stop()",
        "generateArray(Number(sizeRange.value))",
        "renderArray()",
        "updateStats()"
      ],
      "triggers": "#generate",
      "expected_observables": [
        "dom:#visual .bar",
        "dom:#cmpCount"
      ],
      "timeout": 1000
    },
    {
      "from": "S0_Idle",
      "to": "S2_Shuffling",
      "event": "USER_CLICK_SHUFFLE",
      "guard": "true",
      "actions": [
        "stop()",
        "shuffleArray()",
        "renderArray()",
        "updateStats()"
      ],
      "triggers": "#shuffle",
      "expected_observables": [
        "dom:#visual .bar"
      ],
      "timeout": 800
    },
    {
      "from": "S0_Idle",
      "to": "S3_Running",
      "event": "USER_CLICK_START",
      "guard": "not running",
      "actions": [
        "running = true",
        "paused = false",
        "cmpCount = swapCount = stepCount = 0",
        "sortedIndices.clear()",
        "generator = quickSortGen(array, pivotSelect.value)",
        "runGenerator(true)"
      ],
      "triggers": "#start",
      "expected_observables": [
        "dom:#visual .bar",
        "dom:#cmpCount"
      ],
      "timeout": 200
    },
    {
      "from": "S4_Paused",
      "to": "S3_Running",
      "event": "USER_CLICK_PAUSE",
      "guard": "running && paused",
      "actions": [
        "paused = false",
        "runGenerator(true)"
      ],
      "triggers": "#pause",
      "expected_observables": [
        "dom:timer_running"
      ],
      "timeout": 200
    },
    {
      "from": "S3_Running",
      "to": "S4_Paused",
      "event": "USER_CLICK_PAUSE",
      "guard": "running && !paused",
      "actions": [
        "paused = true",
        "stopTimer()"
      ],
      "triggers": "#pause",
      "expected_observables": [
        "dom:timer_stopped"
      ],
      "timeout": 200
    },
    {
      "from": "S0_Idle",
      "to": "S5_StepMode",
      "event": "USER_CLICK_STEP",
      "guard": "true",
      "actions": [
        "if(!running){ running=true; paused=true; sortedIndices.clear(); generator = quickSortGen(array, pivotSelect.value); }",
        "paused = true",
        "stopTimer()",
        "runGenerator(false)"
      ],
      "triggers": "#step",
      "expected_observables": [
        "dom:#stepCount",
        "dom:#visual .bar"
      ],
      "timeout": 200
    },
    {
      "from": "S5_StepMode",
      "to": "S5_StepMode",
      "event": "USER_CLICK_STEP",
      "guard": "running",
      "actions": [
        "stopTimer()",
        "runGenerator(false)"
      ],
      "triggers": "#step",
      "expected_observables": [
        "dom:#stepCount"
      ],
      "timeout": 200
    },
    {
      "from": "S3_Running",
      "to": "S6_Resetting",
      "event": "USER_CLICK_RESET",
      "guard": "true",
      "actions": [
        "stop()",
        "generateArray(Number(sizeRange.value))",
        "renderArray()",
        "updateStats()"
      ],
      "triggers": "#reset",
      "expected_observables": [
        "dom:#visual .bar",
        "dom:#cmpCount"
      ],
      "timeout": 300
    },
    {
      "from": "S0_Idle",
      "to": "S6_Resetting",
      "event": "USER_CLICK_RESET",
      "guard": "true",
      "actions": [
        "stop()",
        "generateArray(Number(sizeRange.value))",
        "renderArray()",
        "updateStats()"
      ],
      "triggers": "#reset",
      "expected_observables": [
        "dom:#visual .bar"
      ],
      "timeout": 300
    },
    {
      "from": "S0_Idle",
      "to": "S7_ChangingSize",
      "event": "USER_CHANGE_SIZE",
      "guard": "true",
      "actions": [
        "sizeVal.textContent = sizeRange.value"
      ],
      "triggers": "input#size",
      "expected_observables": [
        "dom:#sizeVal"
      ],
      "timeout": 0
    },
    {
      "from": "S0_Idle",
      "to": "S8_ChangingSpeed",
      "event": "USER_CHANGE_SPEED",
      "guard": "true",
      "actions": [
        "delay = Number(speedRange.value)",
        "speedVal.textContent = delay + ' ms'"
      ],
      "triggers": "input#speed",
      "expected_observables": [
        "dom:#speedVal"
      ],
      "timeout": 0
    },
    {
      "from": "S0_Idle",
      "to": "S9_ChangingPivot",
      "event": "USER_CHANGE_PIVOT",
      "guard": "true",
      "actions": [
        "pivotName.textContent = pivotSelect.options[pivotSelect.selectedIndex].text"
      ],
      "triggers": "select#pivot",
      "expected_observables": [
        "dom:#pivotName"
      ],
      "timeout": 0
    },
    {
      "from": "S0_Idle",
      "to": "S10_ToggleShowValues",
      "event": "USER_TOGGLE_SHOWVALUES",
      "guard": "true",
      "actions": [
        "bars.forEach(b => { if(showValues.checked) b.classList.add('show-value'); else b.classList.remove('show-value'); })"
      ],
      "triggers": "input#showValues",
      "expected_observables": [
        "dom:.bar.show-value"
      ],
      "timeout": 0
    },
    {
      "from": "S3_Running",
      "to": "S11_Op_PivotHighlight",
      "event": "OP_PIVOT",
      "guard": "true",
      "actions": [
        "applyOp(op)"
      ],
      "triggers": ".bar.pivot",
      "expected_observables": [
        "dom:.bar.pivot"
      ],
      "timeout": 800
    },
    {
      "from": "S3_Running",
      "to": "S12_Op_Comparing",
      "event": "OP_COMPARE",
      "guard": "true",
      "actions": [
        "applyOp(op)"
      ],
      "triggers": ".bar.compare",
      "expected_observables": [
        "dom:.bar.compare",
        "dom:#cmpCount"
      ],
      "timeout": 500
    },
    {
      "from": "S3_Running",
      "to": "S13_Op_Swapping",
      "event": "OP_SWAP",
      "guard": "true",
      "actions": [
        "applyOp(op)"
      ],
      "triggers": ".bar.swap",
      "expected_observables": [
        "dom:.bar.swap",
        "dom:#swapCount"
      ],
      "timeout": 700
    },
    {
      "from": "S3_Running",
      "to": "S14_Op_MarkPlaced",
      "event": "OP_MARK",
      "guard": "true",
      "actions": [
        "applyOp(op)"
      ],
      "triggers": ".bar.sorted",
      "expected_observables": [
        "dom:.bar.sorted"
      ],
      "timeout": 300
    },
    {
      "from": "S3_Running",
      "to": "S15_Op_Placed",
      "event": "OP_PLACED",
      "guard": "true",
      "actions": [
        "applyOp(op)"
      ],
      "triggers": ".bar.sorted",
      "expected_observables": [
        "dom:.bar.sorted",
        "dom:#stackList"
      ],
      "timeout": 300
    },
    {
      "from": "S3_Running",
      "to": "S16_Op_StackUpdate",
      "event": "OP_STACK",
      "guard": "true",
      "actions": [
        "applyOp(op)"
      ],
      "triggers": "#stackList .stack-item",
      "expected_observables": [
        "dom:#stackList .stack-item"
      ],
      "timeout": 200
    },
    {
      "from": "S3_Running",
      "to": "S17_Done",
      "event": "OP_DONE",
      "guard": "true",
      "actions": [
        "applyOp({type:'done'})"
      ],
      "triggers": "#visual .bar, .bar.sorted, #stackList",
      "expected_observables": [
        "dom:.bar.sorted",
        "dom:#stackList"
      ],
      "timeout": 500
    },
    {
      "from": "S11_Op_PivotHighlight",
      "to": "S3_Running",
      "event": "OP_CONTINUE",
      "guard": "not paused",
      "actions": [
        "continueLoop()"
      ],
      "triggers": ".bar.pivot",
      "expected_observables": [
        "dom:.bar"
      ],
      "timeout": 50
    },
    {
      "from": "S12_Op_Comparing",
      "to": "S3_Running",
      "event": "OP_CONTINUE",
      "guard": "not paused",
      "actions": [
        "continueLoop()"
      ],
      "triggers": ".bar.compare",
      "expected_observables": [
        "dom:.bar"
      ],
      "timeout": 50
    },
    {
      "from": "S13_Op_Swapping",
      "to": "S3_Running",
      "event": "OP_CONTINUE",
      "guard": "not paused",
      "actions": [
        "continueLoop()"
      ],
      "triggers": ".bar.swap",
      "expected_observables": [
        "dom:.bar"
      ],
      "timeout": 50
    },
    {
      "from": "S14_Op_MarkPlaced",
      "to": "S3_Running",
      "event": "OP_CONTINUE",
      "guard": "not paused",
      "actions": [
        "continueLoop()"
      ],
      "triggers": ".bar.sorted",
      "expected_observables": [
        "dom:.bar.sorted"
      ],
      "timeout": 50
    },
    {
      "from": "S15_Op_Placed",
      "to": "S3_Running",
      "event": "OP_CONTINUE",
      "guard": "not paused",
      "actions": [
        "continueLoop()"
      ],
      "triggers": ".bar.sorted",
      "expected_observables": [
        "dom:.bar.sorted"
      ],
      "timeout": 50
    },
    {
      "from": "S16_Op_StackUpdate",
      "to": "S3_Running",
      "event": "OP_CONTINUE",
      "guard": "not paused",
      "actions": [
        "continueLoop()"
      ],
      "triggers": "#stackList .stack-item",
      "expected_observables": [
        "dom:#stackList .stack-item"
      ],
      "timeout": 50
    },
    {
      "from": "S5_StepMode",
      "to": "S11_Op_PivotHighlight",
      "event": "OP_PIVOT",
      "guard": "true",
      "actions": [
        "applyOp(op)"
      ],
      "triggers": ".bar.pivot",
      "expected_observables": [
        "dom:.bar.pivot"
      ],
      "timeout": 0
    },
    {
      "from": "S5_StepMode",
      "to": "S12_Op_Comparing",
      "event": "OP_COMPARE",
      "guard": "true",
      "actions": [
        "applyOp(op)"
      ],
      "triggers": ".bar.compare",
      "expected_observables": [
        "dom:.bar.compare"
      ],
      "timeout": 0
    },
    {
      "from": "S5_StepMode",
      "to": "S13_Op_Swapping",
      "event": "OP_SWAP",
      "guard": "true",
      "actions": [
        "applyOp(op)"
      ],
      "triggers": ".bar.swap",
      "expected_observables": [
        "dom:.bar.swap"
      ],
      "timeout": 0
    },
    {
      "from": "S5_StepMode",
      "to": "S14_Op_MarkPlaced",
      "event": "OP_MARK",
      "guard": "true",
      "actions": [
        "applyOp(op)"
      ],
      "triggers": ".bar.sorted",
      "expected_observables": [
        "dom:.bar.sorted"
      ],
      "timeout": 0
    },
    {
      "from": "S5_StepMode",
      "to": "S15_Op_Placed",
      "event": "OP_PLACED",
      "guard": "true",
      "actions": [
        "applyOp(op)"
      ],
      "triggers": ".bar.sorted",
      "expected_observables": [
        "dom:.bar.sorted"
      ],
      "timeout": 0
    },
    {
      "from": "S5_StepMode",
      "to": "S16_Op_StackUpdate",
      "event": "OP_STACK",
      "guard": "true",
      "actions": [
        "applyOp(op)"
      ],
      "triggers": "#stackList .stack-item",
      "expected_observables": [
        "dom:#stackList .stack-item"
      ],
      "timeout": 0
    },
    {
      "from": "S5_StepMode",
      "to": "S17_Done",
      "event": "OP_DONE",
      "guard": "true",
      "actions": [
        "applyOp({type:'done'})"
      ],
      "triggers": "#visual .bar, .bar.sorted, #stackList",
      "expected_observables": [
        "dom:.bar.sorted",
        "dom:#stackList"
      ],
      "timeout": 0
    },
    {
      "from": "S3_Running",
      "to": "S4_Paused",
      "event": "USER_KEYSPACE",
      "guard": "running && !paused",
      "actions": [
        "paused = true",
        "stopTimer()"
      ],
      "triggers": "body",
      "expected_observables": [
        "dom:timer_stopped"
      ],
      "timeout": 200
    },
    {
      "from": "S4_Paused",
      "to": "S3_Running",
      "event": "USER_KEYSPACE",
      "guard": "running && paused",
      "actions": [
        "paused = false",
        "runGenerator(true)"
      ],
      "triggers": "body",
      "expected_observables": [
        "dom:timer_running"
      ],
      "timeout": 200
    },
    {
      "from": "S0_Idle",
      "to": "S6_Resetting",
      "event": "USER_KEY_RESET_R",
      "guard": "true",
      "actions": [
        "stop()",
        "generateArray(Number(sizeRange.value))",
        "renderArray()",
        "updateStats()"
      ],
      "triggers": "body",
      "expected_observables": [
        "dom:#visual .bar"
      ],
      "timeout": 300
    }
  ],
  "components": [
    "input#size",
    "span#sizeVal",
    "select#pivot",
    "span#pivotName",
    "input#speed",
    "span#speedVal",
    "button#generate",
    "button#shuffle",
    "button#start",
    "button#pause",
    "button#step",
    "button#reset",
    "div#visual",
    "div.bar",
    "div.bar.show-value",
    "div.bar .bar-value",
    "div#stackList",
    "div#pseudocode",
    "div#cmpCount",
    "div#swapCount",
    "div#stepCount",
    "input#showValues",
    ".controls",
    ".control",
    ".btn-small",
    ".ghost",
    ".btn-red",
    ".panel",
    ".stack-item"
  ]
}