{
  "meta": {
    "concept": "MergeSort",
    "topic": "Merge Sort Visualization",
    "educational_goal": "Demonstrate merge sort algorithm via recorded actions and animated visualization of comparisons, writes, and merge ranges",
    "expected_interactions": [
      "start",
      "pause",
      "step",
      "reset",
      "randomize",
      "adjust_size",
      "adjust_speed",
      "toggle_order",
      "keyboard_shortcuts"
    ]
  },
  "states": [
    {
      "id": "S0_Idle",
      "label": "Idle",
      "type": "idle",
      "entry_actions": [
        "renderArray()",
        "updateButtons()",
        "setStatusReady()"
      ],
      "exit_actions": []
    },
    {
      "id": "S1_GeneratingArray",
      "label": "GeneratingArray",
      "type": "atomic",
      "entry_actions": [
        "generateArray(sizeInput.value)",
        "renderArray()",
        "logGeneratedArray()",
        "isStarted=false",
        "actions=[]",
        "actionIndex=0"
      ],
      "exit_actions": [
        "updateButtons()",
        "setStatusArrayGenerated()"
      ]
    },
    {
      "id": "S2_Recording",
      "label": "Recording",
      "type": "atomic",
      "entry_actions": [
        "captureComparator(orderCheckbox.checked)",
        "actions = recordMergeSort(array.slice())",
        "actionIndex = 0",
        "clearVisualHighlights()",
        "isStarted = true"
      ],
      "exit_actions": []
    },
    {
      "id": "S3_Playing",
      "label": "Playing",
      "type": "atomic",
      "entry_actions": [
        "play()",
        "setPlaying(true)",
        "setStatusPlaying()",
        "updateButtons()"
      ],
      "exit_actions": [
        "setPlaying(false)",
        "updateButtons()"
      ]
    },
    {
      "id": "S4_Paused",
      "label": "Paused",
      "type": "atomic",
      "entry_actions": [
        "setPaused(true)",
        "setStatusPaused()",
        "logPlaybackPaused()"
      ],
      "exit_actions": [
        "setPaused(false)"
      ]
    },
    {
      "id": "S5_Stepping",
      "label": "Stepping",
      "type": "atomic",
      "entry_actions": [
        "prepareStepIfNeeded()",
        "processNextAction()",
        "updateStatusAfterStep()"
      ],
      "exit_actions": []
    },
    {
      "id": "S6_Resetting",
      "label": "Resetting",
      "type": "atomic",
      "entry_actions": [
        "stopPlayback()",
        "isPlaying=false",
        "isPaused=false",
        "actions=[]",
        "actionIndex=0",
        "renderArray()",
        "logReset()",
        "setStatusReset()"
      ],
      "exit_actions": [
        "updateButtons()"
      ]
    },
    {
      "id": "S7_Done",
      "label": "Done",
      "type": "atomic",
      "entry_actions": [
        "markAllSorted()",
        "setStatusFinished()",
        "isStarted=false"
      ],
      "exit_actions": []
    },
    {
      "id": "S8_Configuring",
      "label": "Configuring",
      "type": "atomic",
      "entry_actions": [
        "updateSizeDisplay(sizeInput.value)",
        "updateSpeedDisplay(speedInput.value)",
        "toggleComparator(orderCheckbox.checked)"
      ],
      "exit_actions": []
    }
  ],
  "events": [
    {
      "id": "USER_CLICK_START",
      "event_type": "user_action",
      "description": "User clicks the Start button to record actions and begin playback",
      "triggers": "#startBtn"
    },
    {
      "id": "USER_CLICK_PAUSE",
      "event_type": "user_action",
      "description": "User clicks the Pause button to pause or resume playback",
      "triggers": "#pauseBtn"
    },
    {
      "id": "USER_CLICK_STEP",
      "event_type": "user_action",
      "description": "User clicks the Step button to advance one recorded action",
      "triggers": "#stepBtn"
    },
    {
      "id": "USER_CLICK_RESET",
      "event_type": "user_action",
      "description": "User clicks the Reset button to reset the visualization to the current array",
      "triggers": "#resetBtn"
    },
    {
      "id": "USER_CLICK_RANDOMIZE",
      "event_type": "user_action",
      "description": "User clicks the Randomize button to generate a new random array using the current size",
      "triggers": "#randomizeBtn"
    },
    {
      "id": "USER_CHANGE_SIZE",
      "event_type": "user_action",
      "description": "User changes the array size slider",
      "triggers": "#size"
    },
    {
      "id": "USER_CHANGE_SPEED",
      "event_type": "user_action",
      "description": "User changes the speed slider (ms delay)",
      "triggers": "#speed"
    },
    {
      "id": "USER_TOGGLE_ORDER",
      "event_type": "user_action",
      "description": "User toggles descending order checkbox",
      "triggers": "#order"
    },
    {
      "id": "KEY_PRESS_SPACE",
      "event_type": "user_action",
      "description": "Space key toggles pause/resume via synthetic click on pause button",
      "triggers": "window"
    },
    {
      "id": "KEY_PRESS_ENTER",
      "event_type": "user_action",
      "description": "Enter key triggers Start via synthetic click on start button",
      "triggers": "window"
    },
    {
      "id": "KEY_PRESS_ARROW_RIGHT",
      "event_type": "user_action",
      "description": "ArrowRight triggers Step via synthetic click on step button",
      "triggers": "window"
    },
    {
      "id": "ACTIONS_RECORDED",
      "event_type": "system_event",
      "description": "Merge sort recording of actions completed and actions[] populated"
    },
    {
      "id": "ACTION_PROCESSED",
      "event_type": "system_event",
      "description": "A single recorded action has been applied to the visualization (range, compare, write, or done)"
    },
    {
      "id": "PLAYBACK_COMPLETE",
      "event_type": "system_event",
      "description": "Playback finished all recorded actions",
      "triggers": "internal"
    },
    {
      "id": "VISUAL_RESET",
      "event_type": "system_event",
      "description": "Visualization reset completed and array re-rendered"
    },
    {
      "id": "ARRAY_GENERATED",
      "event_type": "system_event",
      "description": "A new array has been generated and rendered"
    }
  ],
  "transitions": [
    {
      "from": "S0_Idle",
      "to": "S2_Recording",
      "event": "USER_CLICK_START",
      "guard": "not isPlaying",
      "actions": [
        "captureComparator(orderCheckbox.checked)",
        "actions = recordMergeSort(array.slice())",
        "actionIndex = 0",
        "clearVisualHighlights()",
        "isStarted = true"
      ],
      "triggers": "#startBtn",
      "expected_observables": [
        "dom:#startBtn.clicked",
        "dom:actions.length>0"
      ],
      "timeout": 500
    },
    {
      "from": "S2_Recording",
      "to": "S3_Playing",
      "event": "ACTIONS_RECORDED",
      "guard": "actions.length > 0",
      "actions": [
        "play()",
        "setPlaying(true)",
        "setStatusPlaying()"
      ],
      "triggers": "internal",
      "expected_observables": [
        "dom:actions array populated"
      ],
      "timeout": 100
    },
    {
      "from": "S3_Playing",
      "to": "S4_Paused",
      "event": "USER_CLICK_PAUSE",
      "guard": "isPlaying",
      "actions": [
        "isPlaying = false",
        "isPaused = true",
        "updateButtons()",
        "setStatusPaused()",
        "logPlaybackPaused()"
      ],
      "triggers": "#pauseBtn, window (Space key)",
      "expected_observables": [
        "dom:#pauseBtn.clicked",
        "dom:status.text contains Paused"
      ],
      "timeout": 200
    },
    {
      "from": "S4_Paused",
      "to": "S3_Playing",
      "event": "USER_CLICK_PAUSE",
      "guard": "actionIndex < actions.length",
      "actions": [
        "play()",
        "setPlaying(true)",
        "setStatusPlaying()",
        "updateButtons()"
      ],
      "triggers": "#pauseBtn, window (Space key)",
      "expected_observables": [
        "dom:#pauseBtn.clicked",
        "dom:status.text contains Playing"
      ],
      "timeout": 200
    },
    {
      "from": "S0_Idle",
      "to": "S5_Stepping",
      "event": "USER_CLICK_STEP",
      "guard": "not isPlaying",
      "actions": [
        "if actions.length == 0 then actions = recordMergeSort(array.slice()); actionIndex = 0; clearVisualHighlights()",
        "processNextAction()",
        "updateStatusAfterStep()"
      ],
      "triggers": "#stepBtn, window (ArrowRight)",
      "expected_observables": [
        "dom:#stepBtn.clicked",
        "dom:#viz .bar.compare or dom:#viz .bar.write or dom:#viz .bar.range changed"
      ],
      "timeout": 500
    },
    {
      "from": "S5_Stepping",
      "to": "S7_Done",
      "event": "ACTION_PROCESSED",
      "guard": "actionIndex >= actions.length",
      "actions": [
        "setStatusFinished()",
        "isStarted = false"
      ],
      "triggers": "internal",
      "expected_observables": [
        "dom:#viz .bar.sorted",
        "dom:status.text contains Finished"
      ],
      "timeout": 200
    },
    {
      "from": "S5_Stepping",
      "to": "S4_Paused",
      "event": "ACTION_PROCESSED",
      "guard": "actionIndex < actions.length",
      "actions": [
        "setStatusPaused()"
      ],
      "triggers": "internal",
      "expected_observables": [
        "dom:status.text contains Paused"
      ],
      "timeout": 200
    },
    {
      "from": "S3_Playing",
      "to": "S3_Playing",
      "event": "ACTION_PROCESSED",
      "guard": "actionIndex < actions.length and isPlaying",
      "actions": [
        "applyAction(actions[actionIndex-1])",
        "await delay(getDelay())"
      ],
      "triggers": "internal timer",
      "expected_observables": [
        "dom:#viz .bar.range",
        "dom:#viz .bar.compare",
        "dom:#viz .bar.write",
        "dom:#viz .bar.sorted"
      ],
      "timeout": 5000
    },
    {
      "from": "S3_Playing",
      "to": "S7_Done",
      "event": "PLAYBACK_COMPLETE",
      "guard": "actionIndex >= actions.length",
      "actions": [
        "setPlaying(false)",
        "updateButtons()",
        "setStatusFinished()",
        "isStarted = false"
      ],
      "triggers": "internal",
      "expected_observables": [
        "dom:#viz .bar.sorted",
        "dom:status.text contains Finished"
      ],
      "timeout": 1000
    },
    {
      "from": "S0_Idle",
      "to": "S6_Resetting",
      "event": "USER_CLICK_RESET",
      "guard": "true",
      "actions": [
        "isPlaying = false",
        "isPaused = false",
        "actions = []",
        "actionIndex = 0",
        "renderArray()",
        "logReset()",
        "setStatusReset()"
      ],
      "triggers": "#resetBtn",
      "expected_observables": [
        "dom:#resetBtn.clicked",
        "dom:#viz re-rendered"
      ],
      "timeout": 300
    },
    {
      "from": "S3_Playing",
      "to": "S6_Resetting",
      "event": "USER_CLICK_RESET",
      "guard": "true",
      "actions": [
        "isPlaying = false",
        "isPaused = false",
        "actions = []",
        "actionIndex = 0",
        "renderArray()",
        "logReset()",
        "setStatusReset()"
      ],
      "triggers": "#resetBtn",
      "expected_observables": [
        "dom:#resetBtn.clicked",
        "dom:#viz re-rendered"
      ],
      "timeout": 300
    },
    {
      "from": "S6_Resetting",
      "to": "S0_Idle",
      "event": "VISUAL_RESET",
      "guard": "true",
      "actions": [
        "updateButtons()",
        "setStatusReady()"
      ],
      "triggers": "internal",
      "expected_observables": [
        "dom:#viz ready",
        "dom:status.text contains Reset"
      ],
      "timeout": 200
    },
    {
      "from": "S0_Idle",
      "to": "S1_GeneratingArray",
      "event": "USER_CLICK_RANDOMIZE",
      "guard": "true",
      "actions": [
        "generateArray(+sizeInput.value)",
        "renderArray()",
        "logGeneratedArray()"
      ],
      "triggers": "#randomizeBtn",
      "expected_observables": [
        "dom:#randomizeBtn.clicked",
        "dom:#viz re-rendered"
      ],
      "timeout": 500
    },
    {
      "from": "S1_GeneratingArray",
      "to": "S0_Idle",
      "event": "ARRAY_GENERATED",
      "guard": "true",
      "actions": [
        "updateButtons()",
        "setStatusArrayGenerated()"
      ],
      "triggers": "internal",
      "expected_observables": [
        "dom:#viz re-rendered",
        "dom:#log entry"
      ],
      "timeout": 200
    },
    {
      "from": "S0_Idle",
      "to": "S8_Configuring",
      "event": "USER_CHANGE_SIZE",
      "guard": "true",
      "actions": [
        "updateSizeDisplay(sizeInput.value)"
      ],
      "triggers": "#size",
      "expected_observables": [
        "dom:#sizeVal.text updated"
      ],
      "timeout": 50
    },
    {
      "from": "S0_Idle",
      "to": "S8_Configuring",
      "event": "USER_CHANGE_SPEED",
      "guard": "true",
      "actions": [
        "updateSpeedDisplay(speedInput.value)"
      ],
      "triggers": "#speed",
      "expected_observables": [
        "dom:#speedVal.text updated"
      ],
      "timeout": 50
    },
    {
      "from": "S0_Idle",
      "to": "S8_Configuring",
      "event": "USER_TOGGLE_ORDER",
      "guard": "true",
      "actions": [
        "toggleComparator(orderCheckbox.checked)"
      ],
      "triggers": "#order",
      "expected_observables": [
        "dom:#order.checked changed"
      ],
      "timeout": 50
    },
    {
      "from": "S4_Paused",
      "to": "S5_Stepping",
      "event": "USER_CLICK_STEP",
      "guard": "not isPlaying",
      "actions": [
        "if actions.length == 0 then actions = recordMergeSort(array.slice()); actionIndex = 0; clearVisualHighlights()",
        "processNextAction()",
        "updateStatusAfterStep()"
      ],
      "triggers": "#stepBtn, window (ArrowRight)",
      "expected_observables": [
        "dom:#stepBtn.clicked",
        "dom:#viz .bar.compare or .bar.write changed"
      ],
      "timeout": 300
    },
    {
      "from": "S3_Playing",
      "to": "S3_Playing",
      "event": "KEY_PRESS_ENTER",
      "guard": "true",
      "actions": [
        "synthesizeClick('#startBtn')"
      ],
      "triggers": "window",
      "expected_observables": [
        "dom:#startBtn.clicked"
      ],
      "timeout": 50
    },
    {
      "from": "S4_Paused",
      "to": "S4_Paused",
      "event": "KEY_PRESS_SPACE",
      "guard": "true",
      "actions": [
        "synthesizeClick('#pauseBtn')"
      ],
      "triggers": "window",
      "expected_observables": [
        "dom:#pauseBtn.clicked"
      ],
      "timeout": 50
    }
  ],
  "components": [
    "button#startBtn",
    "button#pauseBtn",
    "button#stepBtn",
    "button#resetBtn",
    "button#randomizeBtn",
    "input#size",
    "span#sizeVal",
    "input#speed",
    "span#speedVal",
    "input#order",
    "div#viz",
    "div.bar",
    "div.bar.compare",
    "div.bar.write",
    "div.bar.range",
    "div.bar.sorted",
    "pre#pseudocode",
    "div#log",
    "div#status"
  ]
}