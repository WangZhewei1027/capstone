{
  "meta": {
    "concept": "InsertionSort",
    "topic": "Insertion Sort Visualizer",
    "educational_goal": "Demonstrate step-by-step insertion sort with visual highlights, counters, and pseudocode mapping",
    "expected_interactions": [
      "randomize",
      "start",
      "pause",
      "step",
      "reset",
      "change_size",
      "change_speed"
    ]
  },
  "states": [
    {
      "id": "S0_Idle",
      "label": "idle",
      "type": "idle",
      "entry_actions": [
        "toggleButtons()",
        "ensureGeneratorNullIfNotRunning()",
        "render()"
      ],
      "exit_actions": []
    },
    {
      "id": "S1_Running",
      "label": "running",
      "type": "atomic",
      "entry_actions": [
        "running = true",
        "paused = false",
        "toggleButtons()",
        "run()"
      ],
      "exit_actions": [
        "running = false"
      ]
    },
    {
      "id": "S2_Paused",
      "label": "paused",
      "type": "atomic",
      "entry_actions": [
        "paused = true",
        "running = false",
        "toggleButtons()"
      ],
      "exit_actions": [
        "paused = false"
      ]
    },
    {
      "id": "S3_Stepping",
      "label": "stepping_one_action",
      "type": "atomic",
      "entry_actions": [
        "if(!generator) generator = insertionSort(arr)",
        "step()",
        "toggleButtons()"
      ],
      "exit_actions": []
    },
    {
      "id": "S4_BuildingArray",
      "label": "building_array",
      "type": "atomic",
      "entry_actions": [
        "buildArray(parseInt(sizeInput.value), true)",
        "comparisons = 0",
        "moves = 0",
        "updateCounters()",
        "render()"
      ],
      "exit_actions": [
        "generator = null",
        "done = false"
      ]
    },
    {
      "id": "S5_Resetting",
      "label": "resetting",
      "type": "atomic",
      "entry_actions": [
        "stop(true)",
        "buildArray(parseInt(sizeInput.value), true)"
      ],
      "exit_actions": []
    },
    {
      "id": "S6_Done",
      "label": "done",
      "type": "final",
      "entry_actions": [
        "applyAction({type:'done'})",
        "done = true",
        "running = false",
        "toggleButtons()"
      ],
      "exit_actions": []
    },
    {
      "id": "S7_StartI",
      "label": "action_start_i",
      "type": "atomic",
      "entry_actions": [
        "applyAction(res.value)",
        "highlightPseudo('p1')"
      ],
      "exit_actions": []
    },
    {
      "id": "S8_Key",
      "label": "action_key",
      "type": "atomic",
      "entry_actions": [
        "applyAction(res.value)",
        "highlightPseudo('p2')",
        "bars[action.i]?.classList.add('key')"
      ],
      "exit_actions": [
        "removeTransientKeyHighlights()"
      ]
    },
    {
      "id": "S9_SetJ",
      "label": "action_set_j",
      "type": "atomic",
      "entry_actions": [
        "applyAction(res.value)",
        "highlightPseudo('p3')"
      ],
      "exit_actions": []
    },
    {
      "id": "S10_Compare",
      "label": "action_compare",
      "type": "atomic",
      "entry_actions": [
        "applyAction(res.value)",
        "comparisons++",
        "updateCounters()",
        "highlightPseudo('p4')",
        "bars[action.j]?.classList.add('compare')"
      ],
      "exit_actions": []
    },
    {
      "id": "S11_Shift",
      "label": "action_shift",
      "type": "atomic",
      "entry_actions": [
        "applyAction(res.value)",
        "moves++",
        "updateCounters()",
        "highlightPseudo('p5')",
        "bars[action.to].style.height = percentHeight(action.val)",
        "bars[action.to].querySelector('.label').textContent = action.val",
        "bars[action.to].classList.add('shift')"
      ],
      "exit_actions": [
        "bars.forEach(b=>b.classList.remove('key'))"
      ]
    },
    {
      "id": "S12_DecJ",
      "label": "action_dec_j",
      "type": "atomic",
      "entry_actions": [
        "applyAction(res.value)",
        "highlightPseudo('p6')"
      ],
      "exit_actions": []
    },
    {
      "id": "S13_Insert",
      "label": "action_insert",
      "type": "atomic",
      "entry_actions": [
        "applyAction(res.value)",
        "moves++",
        "updateCounters()",
        "highlightPseudo('p7')",
        "bars[action.index].style.height = percentHeight(action.key)",
        "bars[action.index].querySelector('.label').textContent = action.key",
        "bars[action.index].classList.add('key')",
        "bars.forEach(b=>b.classList.remove('compare','shift'))"
      ],
      "exit_actions": []
    },
    {
      "id": "S14_MarkSorted",
      "label": "action_markSorted",
      "type": "atomic",
      "entry_actions": [
        "applyAction(res.value)",
        "for k in 0..action.index: bars[k].classList.add('sorted')"
      ],
      "exit_actions": []
    }
  ],
  "events": [
    {
      "id": "CLICK_RANDOMIZE",
      "event_type": "user_action",
      "description": "User clicks the Randomize button",
      "triggers": "#randomize"
    },
    {
      "id": "CLICK_START",
      "event_type": "user_action",
      "description": "User clicks the Start button",
      "triggers": "#start"
    },
    {
      "id": "CLICK_PAUSE",
      "event_type": "user_action",
      "description": "User clicks the Pause button",
      "triggers": "#pause"
    },
    {
      "id": "CLICK_STEP",
      "event_type": "user_action",
      "description": "User clicks the Step button",
      "triggers": "#step"
    },
    {
      "id": "CLICK_RESET",
      "event_type": "user_action",
      "description": "User clicks the Reset button",
      "triggers": "#reset"
    },
    {
      "id": "INPUT_SIZE",
      "event_type": "user_action",
      "description": "User changes the array size slider",
      "triggers": "#size"
    },
    {
      "id": "INPUT_SPEED",
      "event_type": "user_action",
      "description": "User changes the speed slider",
      "triggers": "#speed"
    },
    {
      "id": "GENERATOR_YIELD",
      "event_type": "system_event",
      "description": "The insertionSort generator yields an action (start_i,key,set_j,compare,shift,dec_j,insert,markSorted)",
      "triggers": "#bars"
    },
    {
      "id": "GENERATOR_DONE",
      "event_type": "system_event",
      "description": "The generator finishes (done)",
      "triggers": "#bars"
    },
    {
      "id": "STEP_COMPLETE",
      "event_type": "system_event",
      "description": "A single step() action completed and applied to DOM",
      "triggers": "#bars"
    },
    {
      "id": "BUILD_COMPLETE",
      "event_type": "system_event",
      "description": "buildArray completed and DOM rendered",
      "triggers": "#bars,#sizeVal"
    }
  ],
  "transitions": [
    {
      "from": "S0_Idle",
      "to": "S4_BuildingArray",
      "event": "CLICK_RANDOMIZE",
      "guard": "true",
      "actions": [
        "stop()",
        "buildArray(parseInt(sizeInput.value), true)"
      ],
      "expected_observables": [
        "dom:#randomize.clicked",
        "dom:#bars.updated"
      ],
      "timeout": 1000,
      "triggers": "#randomize"
    },
    {
      "from": "S0_Idle",
      "to": "S1_Running",
      "event": "CLICK_START",
      "guard": "true",
      "actions": [
        "if(done) buildArray(parseInt(sizeInput.value), true)",
        "if(!generator) generator = insertionSort(arr)",
        "running = true",
        "paused = false",
        "toggleButtons()",
        "run()"
      ],
      "expected_observables": [
        "dom:#start.clicked",
        "dom:generator.started"
      ],
      "timeout": 200,
      "triggers": "#start"
    },
    {
      "from": "S1_Running",
      "to": "S2_Paused",
      "event": "CLICK_PAUSE",
      "guard": "true",
      "actions": [
        "paused = true",
        "running = false",
        "toggleButtons()"
      ],
      "expected_observables": [
        "dom:#pause.clicked"
      ],
      "timeout": 200,
      "triggers": "#pause"
    },
    {
      "from": "S2_Paused",
      "to": "S1_Running",
      "event": "CLICK_START",
      "guard": "true",
      "actions": [
        "running = true",
        "paused = false",
        "toggleButtons()",
        "run()"
      ],
      "expected_observables": [
        "dom:#start.clicked"
      ],
      "timeout": 200,
      "triggers": "#start"
    },
    {
      "from": "S0_Idle",
      "to": "S3_Stepping",
      "event": "CLICK_STEP",
      "guard": "true",
      "actions": [
        "if(!generator) generator = insertionSort(arr)",
        "step()"
      ],
      "expected_observables": [
        "dom:#step.clicked",
        "dom:#bars.updated"
      ],
      "timeout": 200,
      "triggers": "#step"
    },
    {
      "from": "S2_Paused",
      "to": "S3_Stepping",
      "event": "CLICK_STEP",
      "guard": "true",
      "actions": [
        "if(!generator) generator = insertionSort(arr)",
        "step()"
      ],
      "expected_observables": [
        "dom:#step.clicked",
        "dom:#bars.updated"
      ],
      "timeout": 200,
      "triggers": "#step"
    },
    {
      "from": "S3_Stepping",
      "to": "S0_Idle",
      "event": "STEP_COMPLETE",
      "guard": "res.not_done",
      "actions": [
        "applyAction(res.value)"
      ],
      "expected_observables": [
        "dom:#bars.changed",
        "dom:.pseudo.line.active"
      ],
      "timeout": 500,
      "triggers": "#bars"
    },
    {
      "from": "S3_Stepping",
      "to": "S6_Done",
      "event": "STEP_COMPLETE",
      "guard": "res.done",
      "actions": [
        "applyAction({type:'done'})",
        "done = true",
        "running = false",
        "toggleButtons()"
      ],
      "expected_observables": [
        "dom:.bar.sorted",
        "dom:#compCount",
        "dom:#moveCount"
      ],
      "timeout": 500,
      "triggers": "#bars"
    },
    {
      "from": "S0_Idle",
      "to": "S5_Resetting",
      "event": "CLICK_RESET",
      "guard": "true",
      "actions": [
        "stop(true)",
        "buildArray(parseInt(sizeInput.value), true)"
      ],
      "expected_observables": [
        "dom:#reset.clicked",
        "dom:#bars.cleared"
      ],
      "timeout": 500,
      "triggers": "#reset"
    },
    {
      "from": "S4_BuildingArray",
      "to": "S0_Idle",
      "event": "BUILD_COMPLETE",
      "guard": "true",
      "actions": [
        "toggleButtons()",
        "render()"
      ],
      "expected_observables": [
        "dom:#bars.rendered",
        "dom:#sizeVal"
      ],
      "timeout": 200,
      "triggers": "#bars,#size"
    },
    {
      "from": "S1_Running",
      "to": "S7_StartI",
      "event": "GENERATOR_YIELD",
      "guard": "action.type === 'start_i'",
      "actions": [
        "applyAction(res.value)"
      ],
      "expected_observables": [
        "dom:.pseudo .line#p1.active",
        "dom:#bars"
      ],
      "timeout": 50,
      "triggers": "#bars"
    },
    {
      "from": "S1_Running",
      "to": "S8_Key",
      "event": "GENERATOR_YIELD",
      "guard": "action.type === 'key'",
      "actions": [
        "applyAction(res.value)"
      ],
      "expected_observables": [
        "dom:.bar.key",
        "dom:.pseudo .line#p2.active"
      ],
      "timeout": 50,
      "triggers": "#bars"
    },
    {
      "from": "S1_Running",
      "to": "S9_SetJ",
      "event": "GENERATOR_YIELD",
      "guard": "action.type === 'set_j'",
      "actions": [
        "applyAction(res.value)"
      ],
      "expected_observables": [
        "dom:.pseudo .line#p3.active"
      ],
      "timeout": 50,
      "triggers": "#bars"
    },
    {
      "from": "S1_Running",
      "to": "S10_Compare",
      "event": "GENERATOR_YIELD",
      "guard": "action.type === 'compare'",
      "actions": [
        "applyAction(res.value)"
      ],
      "expected_observables": [
        "dom:.bar.compare",
        "dom:#compCount"
      ],
      "timeout": 50,
      "triggers": "#bars"
    },
    {
      "from": "S1_Running",
      "to": "S11_Shift",
      "event": "GENERATOR_YIELD",
      "guard": "action.type === 'shift'",
      "actions": [
        "applyAction(res.value)"
      ],
      "expected_observables": [
        "dom:.bar.shift",
        "dom:#moveCount"
      ],
      "timeout": 50,
      "triggers": "#bars"
    },
    {
      "from": "S1_Running",
      "to": "S12_DecJ",
      "event": "GENERATOR_YIELD",
      "guard": "action.type === 'dec_j'",
      "actions": [
        "applyAction(res.value)"
      ],
      "expected_observables": [
        "dom:.pseudo .line#p6.active"
      ],
      "timeout": 50,
      "triggers": "#bars"
    },
    {
      "from": "S1_Running",
      "to": "S13_Insert",
      "event": "GENERATOR_YIELD",
      "guard": "action.type === 'insert'",
      "actions": [
        "applyAction(res.value)"
      ],
      "expected_observables": [
        "dom:.bar.key",
        "dom:#moveCount"
      ],
      "timeout": 50,
      "triggers": "#bars"
    },
    {
      "from": "S1_Running",
      "to": "S14_MarkSorted",
      "event": "GENERATOR_YIELD",
      "guard": "action.type === 'markSorted'",
      "actions": [
        "applyAction(res.value)"
      ],
      "expected_observables": [
        "dom:.bar.sorted"
      ],
      "timeout": 50,
      "triggers": "#bars"
    },
    {
      "from": "S1_Running",
      "to": "S6_Done",
      "event": "GENERATOR_DONE",
      "guard": "true",
      "actions": [
        "applyAction({type:'done'})",
        "done = true",
        "running = false",
        "toggleButtons()"
      ],
      "expected_observables": [
        "dom:.bar.sorted",
        "dom:#compCount",
        "dom:#moveCount"
      ],
      "timeout": 100,
      "triggers": "#bars"
    },
    {
      "from": "S7_StartI",
      "to": "S1_Running",
      "event": "TIME_DELAY_COMPLETE",
      "guard": "true",
      "actions": [],
      "expected_observables": [
        "dom:#bars"
      ],
      "timeout": 1,
      "triggers": "#bars,#speed"
    },
    {
      "from": "S8_Key",
      "to": "S1_Running",
      "event": "TIME_DELAY_COMPLETE",
      "guard": "true",
      "actions": [],
      "expected_observables": [
        "dom:#bars"
      ],
      "timeout": 1,
      "triggers": "#bars,#speed"
    },
    {
      "from": "S9_SetJ",
      "to": "S1_Running",
      "event": "TIME_DELAY_COMPLETE",
      "guard": "true",
      "actions": [],
      "expected_observables": [
        "dom:#bars"
      ],
      "timeout": 1,
      "triggers": "#bars,#speed"
    },
    {
      "from": "S10_Compare",
      "to": "S1_Running",
      "event": "TIME_DELAY_COMPLETE",
      "guard": "true",
      "actions": [],
      "expected_observables": [
        "dom:#compCount"
      ],
      "timeout": 50,
      "triggers": "#bars,#speed"
    },
    {
      "from": "S11_Shift",
      "to": "S1_Running",
      "event": "TIME_DELAY_COMPLETE",
      "guard": "true",
      "actions": [],
      "expected_observables": [
        "dom:#moveCount"
      ],
      "timeout": 50,
      "triggers": "#bars,#speed"
    },
    {
      "from": "S12_DecJ",
      "to": "S1_Running",
      "event": "TIME_DELAY_COMPLETE",
      "guard": "true",
      "actions": [],
      "expected_observables": [
        "dom:#bars"
      ],
      "timeout": 10,
      "triggers": "#bars,#speed"
    },
    {
      "from": "S13_Insert",
      "to": "S1_Running",
      "event": "TIME_DELAY_COMPLETE",
      "guard": "true",
      "actions": [],
      "expected_observables": [
        "dom:#moveCount"
      ],
      "timeout": 50,
      "triggers": "#bars,#speed"
    },
    {
      "from": "S14_MarkSorted",
      "to": "S1_Running",
      "event": "TIME_DELAY_COMPLETE",
      "guard": "true",
      "actions": [],
      "expected_observables": [
        "dom:.bar.sorted"
      ],
      "timeout": 50,
      "triggers": "#bars,#speed"
    },
    {
      "from": "S0_Idle",
      "to": "S4_BuildingArray",
      "event": "INPUT_SIZE",
      "guard": "true",
      "actions": [
        "sizeVal.textContent = sizeInput.value",
        "buildArray(parseInt(sizeInput.value))"
      ],
      "expected_observables": [
        "dom:#size.input",
        "dom:#sizeVal"
      ],
      "timeout": 200,
      "triggers": "#size"
    },
    {
      "from": "S0_Idle",
      "to": "S0_Idle",
      "event": "INPUT_SPEED",
      "guard": "true",
      "actions": [
        "speedVal.textContent = speedInput.value"
      ],
      "expected_observables": [
        "dom:#speed.input",
        "dom:#speedVal"
      ],
      "timeout": 50,
      "triggers": "#speed"
    }
  ],
  "components": [
    "#size",
    "#sizeVal",
    "#speed",
    "#speedVal",
    "#randomize",
    "#start",
    "#pause",
    "#step",
    "#reset",
    "#bars",
    ".bar",
    ".pseudo .line",
    "#compCount",
    "#moveCount"
  ]
}