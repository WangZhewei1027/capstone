<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Heap Sort Visualization</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f1724;
      --panel:#0b1220;
      --accent:#38bdf8;
      --muted:#94a3b8;
      --bar:#60a5fa;
      --compare:#f59e0b;
      --swap:#ef4444;
      --sorted:#10b981;
      --heap:#7c3aed;
      --text:#e6eef8;
    }
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial;background:var(--bg);color:var(--text)}
    .wrap{display:flex;flex-direction:column;gap:12px;padding:16px;max-width:1100px;margin:8px auto}
    header{display:flex;align-items:center;gap:12px}
    h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{background:linear-gradient(180deg,#1f2937,#111827);color:var(--text);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;cursor:pointer}
    button:active{transform:translateY(1px)}
    input[type=range]{width:160px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px}
    .vis{height:320px;background:linear-gradient(180deg,#071023,#071018);border-radius:10px;padding:12px;display:flex;align-items:end;gap:6px;overflow:hidden}
    .bar{flex:1 1 auto;margin:0 2px;background:var(--bar);border-radius:4px;display:flex;align-items:flex-end;justify-content:center;color:#041025;font-weight:600;transition:height 250ms linear, background-color 150ms}
    .bar.small{font-size:10px;padding-bottom:4px}
    .info{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted);font-size:13px}
    .pcode{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#021226;padding:10px;border-radius:8px;color:var(--muted);font-size:13px;line-height:1.5}
    .pcode .line{display:block;padding:2px 6px;border-radius:6px}
    .pcode .active{background:rgba(56,189,248,0.12);color:var(--accent)}
    .stats{display:flex;gap:12px;align-items:center}
    .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .legend .item{display:flex;gap:6px;align-items:center;color:var(--muted);font-size:13px}
    .swatch{width:14px;height:14px;border-radius:3px}
    footer{color:var(--muted);font-size:13px;margin-top:6px}
    @media (max-width:760px){
      .vis{height:240px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Heap Sort — Interactive Visualization</h1>
      <div class="muted">Build a max-heap, then repeatedly swap the root with the last heap element and reduce heap size.</div>
    </header>

    <div class="controls panel">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <label class="muted">Size
          <input id="size" type="range" min="6" max="80" value="30" />
        </label>
        <label class="muted">Speed
          <input id="speed" type="range" min="10" max="1000" value="220" />
        </label>
        <button id="random">Randomize</button>
        <button id="start">Start</button>
        <button id="step">Step</button>
        <button id="reset">Reset</button>
      </div>

      <div style="margin-left:auto;display:flex;gap:12px;align-items:center">
        <div class="stats muted">Ops: <span id="ops">0</span></div>
        <div class="legend">
          <div class="item"><div class="swatch" style="background:var(--bar)"></div>Unsorted</div>
          <div class="item"><div class="swatch" style="background:var(--heap)"></div>Heap region</div>
          <div class="item"><div class="swatch" style="background:var(--compare)"></div>Comparing</div>
          <div class="item"><div class="swatch" style="background:var(--swap)"></div>Swapping</div>
          <div class="item"><div class="swatch" style="background:var(--sorted)"></div>Sorted</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div id="vis" class="vis" aria-hidden="true"></div>
      <div style="display:flex;gap:12px;margin-top:10px;align-items:center;flex-wrap:wrap">
        <div class="pcode" id="pcode" style="min-width:320px;max-width:760px">
          <span class="line" data-id="1">function heapSort(A):</span>
          <span class="line" data-id="2">  n = A.length</span>
          <span class="line" data-id="3">  for i = floor(n/2)-1 downto 0: // build max-heap</span>
          <span class="line" data-id="4">    siftDown(A, n, i)</span>
          <span class="line" data-id="5">  for end = n-1 downto 1: // extract max</span>
          <span class="line" data-id="6">    swap(A[0], A[end])</span>
          <span class="line" data-id="7">    siftDown(A, end, 0)</span>
          <span class="line" data-id="8"></span>
          <span class="line" data-id="9">function siftDown(A, n, i):</span>
          <span class="line" data-id="10">  while true:</span>
          <span class="line" data-id="11">    l = 2*i + 1; r = 2*i + 2; largest = i</span>
          <span class="line" data-id="12">    if l < n and A[l] > A[largest]: largest = l</span>
          <span class="line" data-id="13">    if r < n and A[r] > A[largest]: largest = r</span>
          <span class="line" data-id="14">    if largest != i: swap(A[i], A[largest]); i = largest</span>
          <span class="line" data-id="15">    else: break</span>
        </div>

        <div style="min-width:200px">
          <div class="muted" style="margin-bottom:6px">Status</div>
          <div id="status" class="panel muted" style="padding:10px;min-height:66px">Idle — generate an array and press Start.</div>
        </div>
      </div>
    </div>

    <footer class="muted">Click "Step" to advance one algorithm action. Speed slider adjusts ms per step (lower = faster).</footer>
  </div>

  <script>
    // Heap Sort Visualizer
    const vis = document.getElementById('vis');
    const sizeInput = document.getElementById('size');
    const speedInput = document.getElementById('speed');
    const randomBtn = document.getElementById('random');
    const startBtn = document.getElementById('start');
    const stepBtn = document.getElementById('step');
    const resetBtn = document.getElementById('reset');
    const opsSpan = document.getElementById('ops');
    const statusBox = document.getElementById('status');
    const pcode = document.getElementById('pcode');

    let array = [];
    let bars = [];
    let gen = null;
    let running = false;
    let timer = null;
    let ops = 0;
    let lastAction = null;
    let heapSize = 0;
    let sortedIndices = new Set();

    function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function createArray(n){
      array = [];
      for(let i=0;i<n;i++) array.push(randInt(5,100));
      sortedIndices = new Set();
      ops = 0; opsSpan.textContent = ops;
      gen = null;
      lastAction = null;
      heapSize = array.length;
      render();
      setStatus('Array generated. Ready.');
    }

    function render(){
      vis.innerHTML = '';
      bars = [];
      const n = array.length;
      // adapt number of bars' width
      for(let i=0;i<n;i++){
        const b = document.createElement('div');
        b.className = 'bar small';
        b.style.height = (array[i])+'%';
        b.style.flex = `0 0 ${Math.max(4, Math.floor(1000/n))}px`;
        b.textContent = ''; // hide numeric for clarity; could show small
        vis.appendChild(b);
        bars.push(b);
      }
      updateColors();
    }

    function updateColors(action){
      const n = array.length;
      for(let i=0;i<n;i++){
        let col = 'var(--bar)';
        if(sortedIndices.has(i)) col = 'var(--sorted)';
        else if(typeof heapSize === 'number' && i < heapSize) col = 'var(--heap)';
        bars[i].style.backgroundColor = col;
      }
      if(action){
        if(action.type === 'compare'){
          if(bars[action.i]) bars[action.i].style.backgroundColor = 'var(--compare)';
          if(bars[action.j]) bars[action.j].style.backgroundColor = 'var(--compare)';
        } else if(action.type === 'swap'){
          if(bars[action.i]) bars[action.i].style.backgroundColor = 'var(--swap)';
          if(bars[action.j]) bars[action.j].style.backgroundColor = 'var(--swap)';
        } else if(action.type === 'build'){
          if(bars[action.i]) bars[action.i].style.backgroundColor = 'var(--heap)';
        } else if(action.type === 'sorted'){
          if(bars[action.idx]) bars[action.idx].style.backgroundColor = 'var(--sorted)';
        }
      }
      // update heights
      for(let i=0;i<n;i++){
        bars[i].style.height = (array[i])+'%';
        bars[i].textContent = '';
      }
    }

    function setStatus(text){
      statusBox.textContent = text;
    }

    // Generator-based heap sort to allow stepping
    function* siftDown(A, n, i){
      // yields actions: {type:'compare',i,j,heapSize}, {type:'swap',i,j,heapSize}
      while(true){
        let l = 2*i + 1;
        let r = 2*i + 2;
        let largest = i;
        if(l < n){
          yield {type:'compare', i:l, j:largest, heapSize:n};
          if(A[l] > A[largest]) largest = l;
        }
        if(r < n){
          yield {type:'compare', i:r, j:largest, heapSize:n};
          if(A[r] > A[largest]) largest = r;
        }
        if(largest !== i){
          // perform swap
          let tmp = A[i]; A[i] = A[largest]; A[largest] = tmp;
          yield {type:'swap', i:i, j:largest, heapSize:n};
          i = largest;
        } else {
          break;
        }
      }
      return;
    }

    function* heapSortGen(A){
      let n = A.length;
      // build max-heap
      for(let i = Math.floor(n/2) - 1; i >= 0; i--){
        yield {type:'build', i:i, heapSize:n, line:3};
        yield* siftDown(A, n, i);
      }
      // extract
      for(let end = n - 1; end > 0; end--){
        // swap root with end
        let tmp = A[0]; A[0] = A[end]; A[end] = tmp;
        yield {type:'swap', i:0, j:end, heapSize:end, line:6};
        // mark end as sorted
        yield {type:'sorted', idx:end, heapSize:end, line:6};
        yield* siftDown(A, end, 0);
      }
      yield {type:'sorted', idx:0, heapSize:0, line:7};
      yield {type:'done'};
    }

    function applyAction(action){
      lastAction = action;
      heapSize = (typeof action.heapSize === 'number') ? action.heapSize : heapSize;
      if(action.type === 'compare'){
        ops++; opsSpan.textContent = ops;
        setStatus(`Comparing indices ${action.i} and ${action.j} (heap size ${action.heapSize}).`);
      } else if(action.type === 'swap'){
        ops++; opsSpan.textContent = ops;
        setStatus(`Swapped index ${action.i} and ${action.j}.`);
      } else if(action.type === 'build'){
        setStatus(`Building heap: siftDown from index ${action.i}.`);
      } else if(action.type === 'sorted'){
        sortedIndices.add(action.idx);
        setStatus(`Index ${action.idx} is now in final position (sorted).`);
      } else if(action.type === 'done'){
        setStatus('Sorting complete!');
        running = false;
        startBtn.textContent = 'Start';
        clearInterval(timer);
      }
      highlightCode(action);
      updateColors(action);
    }

    function highlightCode(action){
      // reset
      pcode.querySelectorAll('.line').forEach(el => el.classList.remove('active'));
      // map actions to line numbers
      if(!action) return;
      let line = null;
      if(action.type === 'build') line = 3;
      else if(action.type === 'compare') line = 11; // comparing children to largest
      else if(action.type === 'swap'){
        // if swapping root with end -> line 6; else inside siftDown -> line 14
        if(action.i === 0 && action.j === array.length-1 - (sortedIndices.size)) line = 6;
        else line = 14;
      } else if(action.type === 'sorted'){
        line = 6;
      } else if(action.type === 'done'){
        line = 7;
      }
      if(line){
        const el = pcode.querySelector(`.line[data-id="${line}"]`);
        if(el) el.classList.add('active');
      }
    }

    function stepOnce(){
      if(!gen){
        // create fresh generator on current array copy
        gen = heapSortGen(array);
      }
      const it = gen.next();
      if(it.done) {
        applyAction({type:'done'});
        return;
      }
      const action = it.value;
      applyAction(action);
      render(); // re-render after applying the action (heights/colors)
    }

    function startLoop(){
      if(running) return;
      running = true;
      startBtn.textContent = 'Pause';
      if(!gen) gen = heapSortGen(array);
      const speed = Math.max(10, 1010 - Number(speedInput.value)); // invert for intuitive slider
      timer = setInterval(()=>{
        const it = gen.next();
        if(it.done){
          applyAction({type:'done'});
          clearInterval(timer);
          return;
        }
        applyAction(it.value);
        render();
      }, speed);
    }

    function pauseLoop(){
      running = false;
      startBtn.textContent = 'Start';
      clearInterval(timer);
    }

    // Event listeners
    sizeInput.addEventListener('input', ()=> {
      createArray(Number(sizeInput.value));
    });

    randomBtn.addEventListener('click', ()=> {
      createArray(Number(sizeInput.value));
    });

    startBtn.addEventListener('click', ()=> {
      if(running){
        pauseLoop();
      } else {
        startLoop();
      }
    });

    stepBtn.addEventListener('click', ()=> {
      if(running) return;
      stepOnce();
    });

    resetBtn.addEventListener('click', ()=> {
      pauseLoop();
      createArray(Number(sizeInput.value));
    });

    // initial
    createArray(Number(sizeInput.value));

    // Resize handling to make bars fill nicely on small screens
    window.addEventListener('resize', ()=> {
      render();
    });

    // Small accessibility: allow space to step/start/pause
    window.addEventListener('keydown', (e)=>{
      if(e.code === 'Space'){
        e.preventDefault();
        if(running) pauseLoop(); else startLoop();
      } else if(e.key === 'ArrowRight'){
        e.preventDefault();
        if(!running) stepOnce();
      }
    });

    // Provide click to toggle showing values
    vis.addEventListener('click', ()=>{
      // show numbers briefly
      bars.forEach((b,i)=> b.textContent = array[i]);
      setTimeout(()=> bars.forEach(b=> b.textContent=''), 800);
    });

  </script>
</body>
</html>