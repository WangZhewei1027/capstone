import { test, expect } from '@playwright/test';

const APP_URL = 'http://127.0.0.1:5500/workspace/batch-test-1205-4o-5/html/39b88a81-d1d5-11f0-b49a-6f458b3a25ef.html';

/**
 * Page Object for the Fibonacci Sequence app
 * Encapsulates selectors and common actions for clarity and reuse across tests.
 */
class FibonacciPage {
  /**
   * @param {import('@playwright/test').Page} page
   */
  constructor(page) {
    this.page = page;
    this.numberInput = page.locator('#number');
    this.generateButton = page.getByRole('button', { name: 'Generate' });
    this.result = page.locator('#result');
    this.heading = page.locator('h1');
  }

  async goto() {
    await this.page.goto(APP_URL);
  }

  async enterNumber(value) {
    // Use fill to replace existing value
    await this.numberInput.fill(String(value));
  }

  async clearNumber() {
    await this.numberInput.fill('');
  }

  async clickGenerate() {
    await this.generateButton.click();
  }

  async getResultText() {
    return (await this.result.innerText()).trim();
  }
}

test.describe('Fibonacci Sequence Generator - E2E', () => {
  // Arrays to capture console messages and page errors per test
  let consoleMessages;
  let pageErrors;

  test.beforeEach(async ({ page }) => {
    consoleMessages = [];
    pageErrors = [];

    // Capture browser console messages
    page.on('console', (msg) => {
      consoleMessages.push({ type: msg.type(), text: msg.text() });
    });

    // Capture uncaught exceptions on the page
    page.on('pageerror', (err) => {
      pageErrors.push(err);
    });
  });

  test.afterEach(async () => {
    // After each test assert that there were no uncaught page errors.
    // This validates that the page did not throw runtime exceptions during interactions.
    expect(pageErrors, `Expected no uncaught page errors, but found: ${pageErrors.map(e => String(e)).join('; ')}`).toHaveLength(0);

    // Also assert that the console did not emit any 'error' level messages.
    const errorConsoleMessages = consoleMessages.filter(m => m.type === 'error' || /error|uncaught/i.test(m.text));
    expect(errorConsoleMessages, `Expected no console.error messages, but found: ${errorConsoleMessages.map(m => m.text).join(' | ')}`).toHaveLength(0);
  });

  // Test initial page load and default state
  test('Initial load: UI elements are visible and default state is correct', async ({ page }) => {
    const app = new FibonacciPage(page);
    await app.goto();

    // Verify main UI elements exist and are visible
    await expect(app.heading).toBeVisible();
    await expect(app.numberInput).toBeVisible();
    await expect(app.generateButton).toBeVisible();
    await expect(app.result).toBeVisible();

    // Input should be empty on load
    await expect(app.numberInput).toHaveValue('');

    // Result should be empty string on load
    const initialResult = await app.getResultText();
    expect(initialResult).toBe('', 'Expected the result area to be empty on initial load');
  });

  // Test valid small inputs
  test('Generate Fibonacci for n = 1', async ({ page }) => {
    const app1 = new FibonacciPage(page);
    await app.goto();

    // Enter 1 and generate
    await app.enterNumber(1);
    await app.clickGenerate();

    // Expect the correct sequence for n = 1
    const result = await app.getResultText();
    expect(result).toBe('Fibonacci Sequence: 0');
  });

  test('Generate Fibonacci for n = 2', async ({ page }) => {
    const app2 = new FibonacciPage(page);
    await app.goto();

    await app.enterNumber(2);
    await app.clickGenerate();

    const result1 = await app.getResultText();
    expect(result).toBe('Fibonacci Sequence: 0, 1');
  });

  test('Generate Fibonacci for n = 6 (longer sequence)', async ({ page }) => {
    const app3 = new FibonacciPage(page);
    await app.goto();

    await app.enterNumber(6);
    await app.clickGenerate();

    const result2 = await app.getResultText();
    expect(result).toBe('Fibonacci Sequence: 0, 1, 1, 2, 3, 5');
  });

  // Edge cases and error handling
  test('Empty input: shows error message', async ({ page }) => {
    const app4 = new FibonacciPage(page);
    await app.goto();

    // Ensure input is empty and click generate
    await app.clearNumber();
    await app.clickGenerate();

    const result3 = await app.getResultText();
    expect(result).toBe('Please enter a positive integer.');
  });

  test('Zero and negative inputs: show error message', async ({ page }) => {
    const app5 = new FibonacciPage(page);
    await app.goto();

    // Zero
    await app.enterNumber(0);
    await app.clickGenerate();
    let result4 = await app.getResultText();
    expect(result).toBe('Please enter a positive integer.');

    // Negative
    await app.enterNumber(-5);
    await app.clickGenerate();
    result = await app.getResultText();
    expect(result).toBe('Please enter a positive integer.');
  });

  test('Decimal input: parseInt behavior (e.g., 5.9 -> treated as 5)', async ({ page }) => {
    const app6 = new FibonacciPage(page);
    await app.goto();

    // Fill with a decimal; HTML input type=number accepts decimals
    await app.enterNumber('5.9');
    await app.clickGenerate();

    // parseInt('5.9') -> 5, so expect first 5 numbers
    const result5 = await app.getResultText();
    expect(result).toBe('Fibonacci Sequence: 0, 1, 1, 2, 3');
  });

  // Accessibility and semantics
  test('Generate button has accessible name and is clickable', async ({ page }) => {
    const app7 = new FibonacciPage(page);
    await app.goto();

    // Button role and name check via Playwright getByRole
    const button = page.getByRole('button', { name: 'Generate' });
    await expect(button).toBeVisible();
    await expect(button).toBeEnabled();

    // Clickability: perform a click and verify no exceptions and result area updates accordingly
    await app.enterNumber(3);
    await button.click();

    const result6 = await app.getResultText();
    expect(result).toBe('Fibonacci Sequence: 0, 1, 1');
  });

  // Data flow and repeated interactions
  test('Multiple sequential generations update the result correctly', async ({ page }) => {
    const app8 = new FibonacciPage(page);
    await app.goto();

    // First generate with 4
    await app.enterNumber(4);
    await app.clickGenerate();
    let result7 = await app.getResultText();
    expect(result).toBe('Fibonacci Sequence: 0, 1, 1, 2');

    // Then generate with 2
    await app.enterNumber(2);
    await app.clickGenerate();
    result = await app.getResultText();
    expect(result).toBe('Fibonacci Sequence: 0, 1');

    // Then invalid input
    await app.enterNumber('');
    await app.clickGenerate();
    result = await app.getResultText();
    expect(result).toBe('Please enter a positive integer.');
  });