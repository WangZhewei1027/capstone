{
  "meta": {
    "concept": "Heap (Min/Max)",
    "topic": "Interactive Heap Visualization",
    "educational_goal": "Demonstrate binary heap operations (insert, pop, build) with step-by-step animation and min/max toggle",
    "expected_interactions": [
      "insert",
      "pop",
      "peek",
      "clear",
      "build_from_array",
      "random_fill",
      "toggle_type",
      "toggle_animate",
      "toggle_indexes"
    ]
  },
  "states": [
    {
      "id": "S0_Idle",
      "label": "idle",
      "type": "idle",
      "entry_actions": [
        "updateStatus()",
        "renderAll()",
        "enableControls()"
      ],
      "exit_actions": []
    },
    {
      "id": "S1_Inserting",
      "label": "inserting",
      "type": "atomic",
      "entry_actions": [
        "captureInput(#valueInput)",
        "disableControls([#insertBtn,#buildBtn,#rndBtn,#popBtn])",
        "call Heap.insert(value, animateToggle.checked)"
      ],
      "exit_actions": [
        "enableControls()",
        "clearInput(#valueInput)",
        "updateStatus()",
        "logOp('Inserted value')"
      ]
    },
    {
      "id": "S2_Popping",
      "label": "popping",
      "type": "atomic",
      "entry_actions": [
        "disableControls([#popBtn,#insertBtn,#buildBtn,#rndBtn])",
        "call Heap.pop(animateToggle.checked)"
      ],
      "exit_actions": [
        "enableControls()",
        "updateStatus()",
        "logOp('Pop operation complete or attempt logged')"
      ]
    },
    {
      "id": "S3_Building",
      "label": "building_from_array",
      "type": "compound",
      "entry_actions": [
        "captureArrayInput(#arrInput)",
        "disableControls([#buildBtn,#rndBtn,#insertBtn,#popBtn])",
        "call Heap.buildFromArray(parsedArray, animateToggle.checked)",
        "logOp('Started building heap from array')"
      ],
      "exit_actions": [
        "enableControls()",
        "updateStatus()",
        "logOp('Build complete')"
      ]
    },
    {
      "id": "S4_RandomFilling",
      "label": "random_filling",
      "type": "atomic",
      "entry_actions": [
        "disableControls([#rndBtn,#buildBtn,#insertBtn,#popBtn])",
        "generateRandomArray(#rndCount)",
        "call Heap.buildFromArray(generatedArray, animateToggle.checked)",
        "logOp('Random fill started')"
      ],
      "exit_actions": [
        "enableControls()",
        "updateStatus()",
        "logOp('Random fill complete')"
      ]
    },
    {
      "id": "S5_TogglingType",
      "label": "toggling_heap_type",
      "type": "atomic",
      "entry_actions": [
        "toggleHeapIsMax(#typeToggle)",
        "updateStatus()",
        "rebuildHeapCopy(animateToggle.checked)",
        "disableControls([#typeToggle])"
      ],
      "exit_actions": [
        "enableControls()",
        "updateStatus()",
        "logOp('Switched heap type')"
      ]
    },
    {
      "id": "S6_TogglingAnimate",
      "label": "toggling_animate",
      "type": "atomic",
      "entry_actions": [
        "setAnimateFlag(#animateToggle.checked)"
      ],
      "exit_actions": []
    },
    {
      "id": "S7_TogglingIndexes",
      "label": "toggling_show_indexes",
      "type": "atomic",
      "entry_actions": [
        "setShowIndexesFlag(#showIndexes.checked)",
        "renderAll()"
      ],
      "exit_actions": []
    },
    {
      "id": "S8_PeekAlert",
      "label": "peek_alert",
      "type": "atomic",
      "entry_actions": [
        "showAlertPeek(heap.size(), heap.peek())",
        "logOp('Peek shown')"
      ],
      "exit_actions": [
        "updateStatus()"
      ]
    },
    {
      "id": "S9_Clearing",
      "label": "clearing",
      "type": "atomic",
      "entry_actions": [
        "heap.data = []",
        "logOp('Cleared heap')",
        "renderAll()"
      ],
      "exit_actions": [
        "updateStatus()"
      ]
    },
    {
      "id": "S10_AnimatingStep",
      "label": "animating_step",
      "type": "atomic",
      "entry_actions": [
        "onStepRender(evt) /* renderArray/highlight & renderTree/highlight called by onStep */",
        "stepDelay(animateToggle.checked)"
      ],
      "exit_actions": [
        "renderArray()",
        "renderTree()",
        "updateStatus()"
      ]
    },
    {
      "id": "S11_SeedInitialization",
      "label": "seed_initialization",
      "type": "atomic",
      "entry_actions": [
        "call Heap.buildFromArray([9,4,7,1,0,6,5,2,3,8], false)",
        "logOp('Initialized sample heap')"
      ],
      "exit_actions": [
        "updateStatus()"
      ]
    },
    {
      "id": "S12_ErrorAlert",
      "label": "error_alert",
      "type": "atomic",
      "entry_actions": [
        "showAlertInvalidInput()",
        "logOp('Invalid input error')"
      ],
      "exit_actions": [
        "focusSelector(#valueInput)",
        "updateStatus()"
      ]
    }
  ],
  "events": [
    {
      "id": "USER_CLICK_INSERT",
      "event_type": "user_action",
      "description": "User clicks the Insert button",
      "triggers": "#insertBtn"
    },
    {
      "id": "USER_CLICK_POP",
      "event_type": "user_action",
      "description": "User clicks the Pop Top button",
      "triggers": "#popBtn"
    },
    {
      "id": "USER_CLICK_PEEK",
      "event_type": "user_action",
      "description": "User clicks the Peek button",
      "triggers": "#peekBtn"
    },
    {
      "id": "USER_CLICK_CLEAR",
      "event_type": "user_action",
      "description": "User clicks the Clear button",
      "triggers": "#clearBtn"
    },
    {
      "id": "USER_CLICK_BUILD",
      "event_type": "user_action",
      "description": "User clicks the Build button to build from input array",
      "triggers": "#buildBtn"
    },
    {
      "id": "USER_CLICK_RANDOM_FILL",
      "event_type": "user_action",
      "description": "User clicks the Random Fill button",
      "triggers": "#rndBtn,#rndCount"
    },
    {
      "id": "USER_TOGGLE_TYPE",
      "event_type": "user_action",
      "description": "User toggles Min/Max heap type",
      "triggers": "#typeToggle"
    },
    {
      "id": "USER_TOGGLE_ANIMATE",
      "event_type": "user_action",
      "description": "User toggles Animate checkbox",
      "triggers": "#animateToggle"
    },
    {
      "id": "USER_TOGGLE_SHOW_INDEXES",
      "event_type": "user_action",
      "description": "User toggles Show indexes checkbox",
      "triggers": "#showIndexes"
    },
    {
      "id": "SYSTEM_OPERATION_STEP",
      "event_type": "system_event",
      "description": "Heap onStep step event emitted during push/swap/pop/build rendering (animation step)",
      "triggers": "#arrayRow,#treeLevels,#lines"
    },
    {
      "id": "SYSTEM_OPERATION_COMPLETE",
      "event_type": "system_event",
      "description": "Heap async operation (insert/pop/build) completed",
      "triggers": "#arrayRow,#treeLevels,#opLog"
    },
    {
      "id": "SYSTEM_INVALID_INPUT",
      "event_type": "system_event",
      "description": "Input parse/validation failed (non-number or empty)",
      "triggers": "#valueInput,#arrInput"
    },
    {
      "id": "SYSTEM_SEED_COMPLETE",
      "event_type": "system_event",
      "description": "Initial seed build complete on page load",
      "triggers": "#arrayRow,#treeLevels,#opLog"
    },
    {
      "id": "USER_DISMISS_ALERT",
      "event_type": "user_action",
      "description": "User dismisses a browser alert/dialog (peek or invalid input)",
      "triggers": "#peekBtn,#valueInput,#arrInput"
    }
  ],
  "transitions": [
    {
      "from": "S0_Idle",
      "to": "S1_Inserting",
      "event": "USER_CLICK_INSERT",
      "guard": "valueInput.trim() !== '' && !Number.isNaN(Number(valueInput.value))",
      "actions": [
        "captureInput(#valueInput)",
        "disableControls([#insertBtn,#buildBtn,#rndBtn,#popBtn])",
        "call Heap.insert(Number(valueInput.value), animateToggle.checked)"
      ],
      "triggers": "#insertBtn,#valueInput",
      "expected_observables": [
        "dom:#insertBtn:disabled",
        "dom:#arrayRow changed"
      ],
      "timeout": 6000
    },
    {
      "from": "S0_Idle",
      "to": "S12_ErrorAlert",
      "event": "USER_CLICK_INSERT",
      "guard": "valueInput.trim() === '' || Number.isNaN(Number(valueInput.value))",
      "actions": [
        "showAlert('Please enter a number')",
        "logOp('Insert aborted: invalid input')"
      ],
      "triggers": "#insertBtn,#valueInput",
      "expected_observables": [
        "dom:alert shown"
      ],
      "timeout": 1000
    },
    {
      "from": "S1_Inserting",
      "to": "S10_AnimatingStep",
      "event": "SYSTEM_OPERATION_STEP",
      "guard": "true",
      "actions": [
        "renderArray(highlight indices from evt)",
        "renderTree(highlight indices from evt)"
      ],
      "triggers": "#arrayRow,#treeLevels,#lines",
      "expected_observables": [
        "dom:.cell.highlight",
        "dom:.node.highlight"
      ],
      "timeout": 2000
    },
    {
      "from": "S10_AnimatingStep",
      "to": "S1_Inserting",
      "event": "SYSTEM_OPERATION_STEP",
      "guard": "animation continues",
      "actions": [
        "stepDelay(animateToggle.checked)",
        "renderArray()",
        "renderTree()"
      ],
      "triggers": "#arrayRow,#treeLevels",
      "expected_observables": [
        "dom:arrayRow updated"
      ],
      "timeout": 2000
    },
    {
      "from": "S1_Inserting",
      "to": "S0_Idle",
      "event": "SYSTEM_OPERATION_COMPLETE",
      "guard": "true",
      "actions": [
        "enableControls()",
        "clearInput(#valueInput)",
        "updateStatus()"
      ],
      "triggers": "#arrayRow,#treeLevels,#opLog",
      "expected_observables": [
        "dom:#sizeLabel updated",
        "dom:#topVal updated"
      ],
      "timeout": 5000
    },
    {
      "from": "S0_Idle",
      "to": "S2_Popping",
      "event": "USER_CLICK_POP",
      "guard": "true",
      "actions": [
        "disableControls([#popBtn,#insertBtn,#buildBtn,#rndBtn])",
        "call Heap.pop(animateToggle.checked)"
      ],
      "triggers": "#popBtn",
      "expected_observables": [
        "dom:#popBtn:disabled",
        "dom:#arrayRow changed"
      ],
      "timeout": 6000
    },
    {
      "from": "S2_Popping",
      "to": "S10_AnimatingStep",
      "event": "SYSTEM_OPERATION_STEP",
      "guard": "true",
      "actions": [
        "renderArray(highlight indices from evt)",
        "renderTree(highlight indices from evt)"
      ],
      "triggers": "#arrayRow,#treeLevels",
      "expected_observables": [
        "dom:.cell.highlight",
        "dom:.node.highlight"
      ],
      "timeout": 2000
    },
    {
      "from": "S2_Popping",
      "to": "S0_Idle",
      "event": "SYSTEM_OPERATION_COMPLETE",
      "guard": "true",
      "actions": [
        "enableControls()",
        "updateStatus()",
        "logOp('Pop operation complete or empty attempt logged')"
      ],
      "triggers": "#arrayRow,#treeLevels,#opLog",
      "expected_observables": [
        "dom:#sizeLabel updated",
        "dom:#opLog updated"
      ],
      "timeout": 5000
    },
    {
      "from": "S0_Idle",
      "to": "S3_Building",
      "event": "USER_CLICK_BUILD",
      "guard": "arrInput.trim() !== '' && allPartsAreNumbers(arrInput.value)",
      "actions": [
        "parseArray(#arrInput)",
        "disableControls([#buildBtn,#rndBtn,#insertBtn,#popBtn])",
        "call Heap.buildFromArray(parsedArray, animateToggle.checked)",
        "logOp('Started building heap from array')"
      ],
      "triggers": "#buildBtn,#arrInput",
      "expected_observables": [
        "dom:#arrayRow changed",
        "dom:#opLog updated"
      ],
      "timeout": 10000
    },
    {
      "from": "S0_Idle",
      "to": "S12_ErrorAlert",
      "event": "USER_CLICK_BUILD",
      "guard": "arrInput.trim() === '' || !allPartsAreNumbers(arrInput.value)",
      "actions": [
        "showAlert('Invalid number in list')",
        "logOp('Build aborted: invalid list')"
      ],
      "triggers": "#buildBtn,#arrInput",
      "expected_observables": [
        "dom:alert shown"
      ],
      "timeout": 1000
    },
    {
      "from": "S3_Building",
      "to": "S10_AnimatingStep",
      "event": "SYSTEM_OPERATION_STEP",
      "guard": "true",
      "actions": [
        "renderArray([] or highlight)",
        "renderTree([] or highlight)"
      ],
      "triggers": "#arrayRow,#treeLevels,#lines",
      "expected_observables": [
        "dom:#arrayRow updated",
        "dom:#treeLevels updated"
      ],
      "timeout": 3000
    },
    {
      "from": "S3_Building",
      "to": "S0_Idle",
      "event": "SYSTEM_OPERATION_COMPLETE",
      "guard": "true",
      "actions": [
        "enableControls()",
        "updateStatus()",
        "logOp('Build complete')"
      ],
      "triggers": "#arrayRow,#treeLevels,#opLog",
      "expected_observables": [
        "dom:#sizeLabel updated",
        "dom:#opLog updated"
      ],
      "timeout": 10000
    },
    {
      "from": "S0_Idle",
      "to": "S4_RandomFilling",
      "event": "USER_CLICK_RANDOM_FILL",
      "guard": "true",
      "actions": [
        "generateRandomArray(#rndCount)",
        "disableControls([#rndBtn,#buildBtn,#insertBtn,#popBtn])",
        "call Heap.buildFromArray(generatedArray, animateToggle.checked)",
        "logOp('Random fill started')"
      ],
      "triggers": "#rndBtn,#rndCount",
      "expected_observables": [
        "dom:#arrayRow changed",
        "dom:#opLog updated"
      ],
      "timeout": 10000
    },
    {
      "from": "S4_RandomFilling",
      "to": "S10_AnimatingStep",
      "event": "SYSTEM_OPERATION_STEP",
      "guard": "true",
      "actions": [
        "renderArray(highlight)",
        "renderTree(highlight)"
      ],
      "triggers": "#arrayRow,#treeLevels,#lines",
      "expected_observables": [
        "dom:.cell.highlight",
        "dom:.node.highlight"
      ],
      "timeout": 3000
    },
    {
      "from": "S4_RandomFilling",
      "to": "S0_Idle",
      "event": "SYSTEM_OPERATION_COMPLETE",
      "guard": "true",
      "actions": [
        "enableControls()",
        "updateStatus()",
        "logOp('Random fill complete')"
      ],
      "triggers": "#arrayRow,#treeLevels,#opLog",
      "expected_observables": [
        "dom:#sizeLabel updated",
        "dom:#opLog updated"
      ],
      "timeout": 10000
    },
    {
      "from": "S0_Idle",
      "to": "S5_TogglingType",
      "event": "USER_TOGGLE_TYPE",
      "guard": "true",
      "actions": [
        "set heap.isMax = typeToggle.checked",
        "disableControls([#typeToggle])",
        "rebuildHeapCopy(animateToggle.checked)",
        "logOp('Toggling heap type')"
      ],
      "triggers": "#typeToggle",
      "expected_observables": [
        "dom:#typeLabel updated",
        "dom:#arrayRow changed"
      ],
      "timeout": 8000
    },
    {
      "from": "S5_TogglingType",
      "to": "S10_AnimatingStep",
      "event": "SYSTEM_OPERATION_STEP",
      "guard": "true",
      "actions": [
        "renderArray(highlight)",
        "renderTree(highlight)"
      ],
      "triggers": "#arrayRow,#treeLevels",
      "expected_observables": [
        "dom:#arrayRow updated"
      ],
      "timeout": 3000
    },
    {
      "from": "S5_TogglingType",
      "to": "S0_Idle",
      "event": "SYSTEM_OPERATION_COMPLETE",
      "guard": "true",
      "actions": [
        "enableControls()",
        "updateStatus()",
        "logOp('Switched heap type')"
      ],
      "triggers": "#typeLabel,#arrayRow,#opLog",
      "expected_observables": [
        "dom:#typeLabel updated"
      ],
      "timeout": 8000
    },
    {
      "from": "S0_Idle",
      "to": "S6_TogglingAnimate",
      "event": "USER_TOGGLE_ANIMATE",
      "guard": "true",
      "actions": [
        "setAnimateFlag(#animateToggle.checked)",
        "logOp('Animate toggled')"
      ],
      "triggers": "#animateToggle",
      "expected_observables": [
        "dom:#opLog updated"
      ],
      "timeout": 200
    },
    {
      "from": "S0_Idle",
      "to": "S7_TogglingIndexes",
      "event": "USER_TOGGLE_SHOW_INDEXES",
      "guard": "true",
      "actions": [
        "setShowIndexesFlag(#showIndexes.checked)",
        "renderAll()",
        "logOp('Show indexes toggled')"
      ],
      "triggers": "#showIndexes",
      "expected_observables": [
        "dom:#treeLevels updated"
      ],
      "timeout": 200
    },
    {
      "from": "S0_Idle",
      "to": "S8_PeekAlert",
      "event": "USER_CLICK_PEEK",
      "guard": "true",
      "actions": [
        "showAlert(heap.size() ? `Top element: ${heap.peek()}` : 'Heap is empty')",
        "logOp('Peek shown')"
      ],
      "triggers": "#peekBtn",
      "expected_observables": [
        "dom:alert shown"
      ],
      "timeout": 1000
    },
    {
      "from": "S8_PeekAlert",
      "to": "S0_Idle",
      "event": "USER_DISMISS_ALERT",
      "guard": "true",
      "actions": [
        "updateStatus()"
      ],
      "triggers": "#peekBtn",
      "expected_observables": [
        "dom:#opLog unchanged or updated"
      ],
      "timeout": 500
    },
    {
      "from": "S0_Idle",
      "to": "S9_Clearing",
      "event": "USER_CLICK_CLEAR",
      "guard": "true",
      "actions": [
        "heap.data = []",
        "logOp('Cleared heap')",
        "renderAll()"
      ],
      "triggers": "#clearBtn",
      "expected_observables": [
        "dom:#arrayRow shows empty",
        "dom:#sizeLabel = 0"
      ],
      "timeout": 500
    },
    {
      "from": "S9_Clearing",
      "to": "S0_Idle",
      "event": "SYSTEM_OPERATION_COMPLETE",
      "guard": "true",
      "actions": [
        "updateStatus()"
      ],
      "triggers": "#arrayRow,#sizeLabel",
      "expected_observables": [
        "dom:#sizeLabel updated"
      ],
      "timeout": 500
    },
    {
      "from": "S0_Idle",
      "to": "S11_SeedInitialization",
      "event": "SYSTEM_SEED_COMPLETE",
      "guard": "on page load and before user interaction",
      "actions": [
        "call Heap.buildFromArray(sample, false)",
        "logOp('Initialized sample heap')"
      ],
      "triggers": "#arrayRow,#treeLevels",
      "expected_observables": [
        "dom:#opLog updated",
        "dom:#arrayRow populated"
      ],
      "timeout": 10000
    },
    {
      "from": "S12_ErrorAlert",
      "to": "S0_Idle",
      "event": "USER_DISMISS_ALERT",
      "guard": "true",
      "actions": [
        "focusSelector(#valueInput)",
        "updateStatus()"
      ],
      "triggers": "#valueInput,#arrInput",
      "expected_observables": [
        "dom:alert closed"
      ],
      "timeout": 500
    }
  ],
  "components": [
    "#valueInput",
    "#insertBtn",
    "#popBtn",
    "#peekBtn",
    "#clearBtn",
    "#arrInput",
    "#buildBtn",
    "#rndBtn",
    "#rndCount",
    "#typeToggle",
    "#animateToggle",
    "#showIndexes",
    "#typeLabel",
    "#sizeLabel",
    "#arrayRow",
    ".cell",
    ".cell.highlight",
    "#treeWrap",
    "#treeLevels",
    ".node",
    ".node.highlight",
    "#lines",
    "#topVal",
    "#opLog",
    "#complexity"
  ]
}