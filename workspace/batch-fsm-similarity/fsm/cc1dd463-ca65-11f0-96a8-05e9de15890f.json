{
  "meta": {
    "concept": "HeapSort",
    "topic": "Heap Sort Visualization",
    "educational_goal": "Demonstrate building a max-heap and extracting max repeatedly to sort an array; visualize comparisons, swaps, heap region and sorted region; allow stepping and autoplay.",
    "expected_interactions": [
      "start/pause",
      "step",
      "randomize",
      "reset",
      "change_size",
      "change_speed",
      "show_values"
    ]
  },
  "states": [
    {
      "id": "S0_Idle",
      "label": "Idle",
      "type": "idle",
      "entry_actions": [
        "render()",
        "setStatus('Array generated. Ready.')",
        "updateColors()"
      ],
      "exit_actions": []
    },
    {
      "id": "S1_Running",
      "label": "Running",
      "type": "active",
      "entry_actions": [
        "running = true",
        "startBtn.textContent = 'Pause'",
        "if(!gen) gen = heapSortGen(array)",
        "timer = setInterval(timerTick, Math.max(10, 1010 - Number(speedInput.value)))"
      ],
      "exit_actions": [
        "clearInterval(timer)",
        "timer = null"
      ]
    },
    {
      "id": "S2_Paused",
      "label": "Paused",
      "type": "idle",
      "entry_actions": [
        "running = false",
        "startBtn.textContent = 'Start'",
        "clearInterval(timer)"
      ],
      "exit_actions": []
    },
    {
      "id": "S3_Stepping",
      "label": "Stepping",
      "type": "atomic",
      "entry_actions": [
        "if(!gen) gen = heapSortGen(array)",
        "const it = gen.next()",
        "if(it.done) applyAction({type:'done'}) else applyAction(it.value)",
        "render()"
      ],
      "exit_actions": []
    },
    {
      "id": "S4_Generating",
      "label": "GeneratingArray",
      "type": "atomic",
      "entry_actions": [
        "createArray(Number(sizeInput.value))",
        "gen = null",
        "ops = 0",
        "opsSpan.textContent = '0'"
      ],
      "exit_actions": []
    },
    {
      "id": "S5_Comparing",
      "label": "Comparing",
      "type": "atomic",
      "entry_actions": [
        "applyAction(action)",
        "highlightCode(action)",
        "updateColors(action)"
      ],
      "exit_actions": []
    },
    {
      "id": "S6_Swapping",
      "label": "Swapping",
      "type": "atomic",
      "entry_actions": [
        "applyAction(action)",
        "render()"
      ],
      "exit_actions": []
    },
    {
      "id": "S7_Building",
      "label": "BuildingHeap",
      "type": "atomic",
      "entry_actions": [
        "applyAction(action)",
        "highlightCode(action)",
        "updateColors(action)"
      ],
      "exit_actions": []
    },
    {
      "id": "S8_SortedMark",
      "label": "MarkSorted",
      "type": "atomic",
      "entry_actions": [
        "applyAction(action)",
        "render()"
      ],
      "exit_actions": []
    },
    {
      "id": "S9_Done",
      "label": "Done",
      "type": "final",
      "entry_actions": [
        "applyAction({type:'done'})",
        "running = false",
        "startBtn.textContent = 'Start'",
        "clearInterval(timer)",
        "setStatus('Sorting complete!')"
      ],
      "exit_actions": []
    },
    {
      "id": "S10_VisShowNumbers",
      "label": "VisShowNumbers",
      "type": "atomic",
      "entry_actions": [
        "bars.forEach((b,i)=> b.textContent = array[i])",
        "setTimeout(()=> bars.forEach(b=> b.textContent=''), 800)"
      ],
      "exit_actions": []
    }
  ],
  "events": [
    {
      "id": "USER_START_CLICK",
      "event_type": "user_action",
      "description": "User clicks the Start/Pause button",
      "triggers": "#start"
    },
    {
      "id": "USER_STEP_CLICK",
      "event_type": "user_action",
      "description": "User clicks the Step button to advance one generator action",
      "triggers": "#step"
    },
    {
      "id": "USER_RANDOM_CLICK",
      "event_type": "user_action",
      "description": "User clicks Randomize to generate a new array",
      "triggers": "#random"
    },
    {
      "id": "USER_RESET_CLICK",
      "event_type": "user_action",
      "description": "User clicks Reset (pauses and generates a new array)",
      "triggers": "#reset"
    },
    {
      "id": "USER_SIZE_CHANGE",
      "event_type": "user_action",
      "description": "User moves the Size range input",
      "triggers": "#size"
    },
    {
      "id": "USER_SPEED_CHANGE",
      "event_type": "user_action",
      "description": "User moves the Speed range input",
      "triggers": "#speed"
    },
    {
      "id": "USER_VIS_CLICK",
      "event_type": "user_action",
      "description": "User clicks the visualization area to show values briefly",
      "triggers": "#vis"
    },
    {
      "id": "KEYBOARD_SPACE",
      "event_type": "user_action",
      "description": "User presses Space to start/pause",
      "triggers": "body"
    },
    {
      "id": "KEYBOARD_ARROWRIGHT",
      "event_type": "user_action",
      "description": "User presses ArrowRight to step once",
      "triggers": "body"
    },
    {
      "id": "SYSTEM_TIMER_TICK",
      "event_type": "system_event",
      "description": "Autoplay timer tick advances the generator",
      "triggers": "#start,#speed"
    },
    {
      "id": "GEN_YIELD_COMPARE",
      "event_type": "system_event",
      "description": "Generator yields a compare action",
      "triggers": "#start,#step"
    },
    {
      "id": "GEN_YIELD_SWAP",
      "event_type": "system_event",
      "description": "Generator yields a swap action",
      "triggers": "#start,#step"
    },
    {
      "id": "GEN_YIELD_BUILD",
      "event_type": "system_event",
      "description": "Generator yields a build (siftDown start) action",
      "triggers": "#start,#step"
    },
    {
      "id": "GEN_YIELD_SORTED",
      "event_type": "system_event",
      "description": "Generator yields an index-marked-sorted action",
      "triggers": "#start,#step"
    },
    {
      "id": "GEN_YIELD_DONE",
      "event_type": "system_event",
      "description": "Generator signals sorting is done",
      "triggers": "#start,#step"
    },
    {
      "id": "WINDOW_RESIZE",
      "event_type": "user_action",
      "description": "Window resized (re-render to adapt bar widths)",
      "triggers": "window"
    }
  ],
  "transitions": [
    {
      "from": "S0_Idle",
      "to": "S1_Running",
      "event": "USER_START_CLICK",
      "guard": "running === false",
      "actions": [
        "startLoop()"
      ],
      "triggers": "#start",
      "expected_observables": [
        "dom:#start[textContent='Pause']",
        "dom:timerStarted"
      ],
      "timeout": 0
    },
    {
      "from": "S1_Running",
      "to": "S2_Paused",
      "event": "USER_START_CLICK",
      "guard": "running === true",
      "actions": [
        "pauseLoop()"
      ],
      "triggers": "#start",
      "expected_observables": [
        "dom:#start[textContent='Start']",
        "dom:timerCleared"
      ],
      "timeout": 0
    },
    {
      "from": "S0_Idle",
      "to": "S3_Stepping",
      "event": "USER_STEP_CLICK",
      "guard": "running === false",
      "actions": [
        "stepOnce()"
      ],
      "triggers": "#step",
      "expected_observables": [
        "dom:generatorAdvanced",
        "dom:#pcode .line.active"
      ],
      "timeout": 0
    },
    {
      "from": "S2_Paused",
      "to": "S3_Stepping",
      "event": "USER_STEP_CLICK",
      "guard": "running === false",
      "actions": [
        "stepOnce()"
      ],
      "triggers": "#step",
      "expected_observables": [
        "dom:generatorAdvanced",
        "dom:#pcode .line.active"
      ],
      "timeout": 0
    },
    {
      "from": "S0_Idle",
      "to": "S4_Generating",
      "event": "USER_RANDOM_CLICK",
      "guard": "true",
      "actions": [
        "createArray(Number(sizeInput.value))"
      ],
      "triggers": "#random",
      "expected_observables": [
        "dom:#vis .bar",
        "dom:#status[textContent*='Ready']"
      ],
      "timeout": 0
    },
    {
      "from": "S0_Idle",
      "to": "S4_Generating",
      "event": "USER_SIZE_CHANGE",
      "guard": "true",
      "actions": [
        "createArray(Number(sizeInput.value))"
      ],
      "triggers": "#size",
      "expected_observables": [
        "dom:#vis .bar",
        "dom:ops[textContent='0']"
      ],
      "timeout": 0
    },
    {
      "from": "S1_Running",
      "to": "S4_Generating",
      "event": "USER_RANDOM_CLICK",
      "guard": "true",
      "actions": [
        "pauseLoop()",
        "createArray(Number(sizeInput.value))"
      ],
      "triggers": "#random",
      "expected_observables": [
        "dom:#status[textContent*='Ready']",
        "dom:timerCleared"
      ],
      "timeout": 0
    },
    {
      "from": "S0_Idle",
      "to": "S4_Generating",
      "event": "USER_RESET_CLICK",
      "guard": "true",
      "actions": [
        "pauseLoop()",
        "createArray(Number(sizeInput.value))"
      ],
      "triggers": "#reset",
      "expected_observables": [
        "dom:#status[textContent*='Ready']",
        "dom:timerCleared"
      ],
      "timeout": 0
    },
    {
      "from": "S1_Running",
      "to": "S5_Comparing",
      "event": "GEN_YIELD_COMPARE",
      "guard": "true",
      "actions": [
        "applyAction(action)",
        "highlightCode(action)",
        "updateColors(action)"
      ],
      "triggers": "#start,#step",
      "expected_observables": [
        "dom:#vis .bar[style*='background-color: var(--compare)']",
        "dom:#pcode .line.active"
      ],
      "timeout": 0
    },
    {
      "from": "S3_Stepping",
      "to": "S5_Comparing",
      "event": "GEN_YIELD_COMPARE",
      "guard": "true",
      "actions": [
        "applyAction(action)",
        "highlightCode(action)",
        "updateColors(action)"
      ],
      "triggers": "#step",
      "expected_observables": [
        "dom:#vis .bar[style*='var(--compare)']",
        "dom:#pcode .line.active"
      ],
      "timeout": 0
    },
    {
      "from": "S1_Running",
      "to": "S6_Swapping",
      "event": "GEN_YIELD_SWAP",
      "guard": "true",
      "actions": [
        "applyAction(action)",
        "render()"
      ],
      "triggers": "#start,#step",
      "expected_observables": [
        "dom:#vis .bar[style*='var(--swap)']",
        "dom:#ops"
      ],
      "timeout": 0
    },
    {
      "from": "S3_Stepping",
      "to": "S6_Swapping",
      "event": "GEN_YIELD_SWAP",
      "guard": "true",
      "actions": [
        "applyAction(action)",
        "render()"
      ],
      "triggers": "#step",
      "expected_observables": [
        "dom:#vis .bar[style*='var(--swap)']",
        "dom:#ops"
      ],
      "timeout": 0
    },
    {
      "from": "S1_Running",
      "to": "S7_Building",
      "event": "GEN_YIELD_BUILD",
      "guard": "true",
      "actions": [
        "applyAction(action)",
        "highlightCode(action)",
        "updateColors(action)"
      ],
      "triggers": "#start,#step",
      "expected_observables": [
        "dom:#vis .bar[style*='var(--heap)']",
        "dom:#pcode .line[data-id='3'].active"
      ],
      "timeout": 0
    },
    {
      "from": "S3_Stepping",
      "to": "S7_Building",
      "event": "GEN_YIELD_BUILD",
      "guard": "true",
      "actions": [
        "applyAction(action)",
        "highlightCode(action)",
        "updateColors(action)"
      ],
      "triggers": "#step",
      "expected_observables": [
        "dom:#vis .bar[style*='var(--heap)']",
        "dom:#pcode .line[data-id='3'].active"
      ],
      "timeout": 0
    },
    {
      "from": "S1_Running",
      "to": "S8_SortedMark",
      "event": "GEN_YIELD_SORTED",
      "guard": "true",
      "actions": [
        "applyAction(action)",
        "render()"
      ],
      "triggers": "#start,#step",
      "expected_observables": [
        "dom:#vis .bar[style*='var(--sorted)']",
        "dom:#ops"
      ],
      "timeout": 0
    },
    {
      "from": "S3_Stepping",
      "to": "S8_SortedMark",
      "event": "GEN_YIELD_SORTED",
      "guard": "true",
      "actions": [
        "applyAction(action)",
        "render()"
      ],
      "triggers": "#step",
      "expected_observables": [
        "dom:#vis .bar[style*='var(--sorted)']",
        "dom:#ops"
      ],
      "timeout": 0
    },
    {
      "from": "S1_Running",
      "to": "S9_Done",
      "event": "GEN_YIELD_DONE",
      "guard": "true",
      "actions": [
        "applyAction({type:'done'})"
      ],
      "triggers": "#start,#step",
      "expected_observables": [
        "dom:#status[textContent='Sorting complete!']",
        "dom:#vis .bar[style*='var(--sorted)']"
      ],
      "timeout": 0
    },
    {
      "from": "S3_Stepping",
      "to": "S9_Done",
      "event": "GEN_YIELD_DONE",
      "guard": "true",
      "actions": [
        "applyAction({type:'done'})"
      ],
      "triggers": "#step",
      "expected_observables": [
        "dom:#status[textContent='Sorting complete!']",
        "dom:#vis .bar[style*='var(--sorted)']"
      ],
      "timeout": 0
    },
    {
      "from": "S0_Idle",
      "to": "S10_VisShowNumbers",
      "event": "USER_VIS_CLICK",
      "guard": "true",
      "actions": [
        "show values briefly (bars textContent set to array values for 800ms)"
      ],
      "triggers": "#vis",
      "expected_observables": [
        "dom:#vis .bar[textContent!='']"
      ],
      "timeout": 800
    },
    {
      "from": "S2_Paused",
      "to": "S1_Running",
      "event": "USER_START_CLICK",
      "guard": "running === false",
      "actions": [
        "startLoop()"
      ],
      "triggers": "#start",
      "expected_observables": [
        "dom:#start[textContent='Pause']",
        "dom:timerStarted"
      ],
      "timeout": 0
    },
    {
      "from": "S0_Idle",
      "to": "S2_Paused",
      "event": "KEYBOARD_SPACE",
      "guard": "running === true",
      "actions": [
        "pauseLoop()"
      ],
      "triggers": "body",
      "expected_observables": [
        "dom:#start[textContent='Start']"
      ],
      "timeout": 0
    },
    {
      "from": "S0_Idle",
      "to": "S1_Running",
      "event": "KEYBOARD_SPACE",
      "guard": "running === false",
      "actions": [
        "startLoop()"
      ],
      "triggers": "body",
      "expected_observables": [
        "dom:#start[textContent='Pause']"
      ],
      "timeout": 0
    },
    {
      "from": "S0_Idle",
      "to": "S3_Stepping",
      "event": "KEYBOARD_ARROWRIGHT",
      "guard": "running === false",
      "actions": [
        "stepOnce()"
      ],
      "triggers": "body",
      "expected_observables": [
        "dom:generatorAdvanced",
        "dom:#pcode .line.active"
      ],
      "timeout": 0
    }
  ],
  "components": [
    "#size",
    "#speed",
    "#random",
    "#start",
    "#step",
    "#reset",
    "#vis",
    ".bar",
    "#ops",
    "#status",
    "#pcode .line",
    ".pcode",
    "body",
    "window"
  ]
}