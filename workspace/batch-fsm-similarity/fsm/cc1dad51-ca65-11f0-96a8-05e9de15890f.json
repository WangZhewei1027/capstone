{
  "meta": {
    "concept": "BubbleSort",
    "topic": "Bubble Sort Visualization",
    "educational_goal": "Visualize bubble sort algorithm showing comparisons, swaps, passes, and completion with control over speed, size and input array",
    "expected_interactions": [
      "start",
      "pause",
      "step",
      "reset",
      "generate_random",
      "shuffle",
      "use_input",
      "change_size",
      "change_speed",
      "toggle_options",
      "keyboard_shortcuts"
    ]
  },
  "states": [
    {
      "id": "S0_Idle",
      "label": "Idle",
      "type": "idle",
      "entry_actions": [
        "render()",
        "setPseudocodeLine(null)",
        "enableControls()",
        "actionEl.textContent='Idle'"
      ],
      "exit_actions": []
    },
    {
      "id": "S1_AutoRunning",
      "label": "AutoRunning",
      "type": "composite",
      "entry_actions": [
        "if(!gen) gen = bubbleSortGen(array.slice(), ascendingCb.checked, optimizedCb.checked)",
        "startAuto()",
        "actionEl.textContent='Running'"
      ],
      "exit_actions": [
        "stopAuto()",
        "timer=null"
      ]
    },
    {
      "id": "S2_Paused",
      "label": "Paused",
      "type": "atomic",
      "entry_actions": [
        "pauseAuto()",
        "actionEl.textContent='Paused'"
      ],
      "exit_actions": []
    },
    {
      "id": "S3_Step",
      "label": "SteppingOne",
      "type": "atomic",
      "entry_actions": [
        "if(!gen) gen = bubbleSortGen(array.slice(), ascendingCb.checked, optimizedCb.checked)",
        "advanceOnce()"
      ],
      "exit_actions": [
        "if(finished) gen=null"
      ]
    },
    {
      "id": "S4_Comparing",
      "label": "Comparing",
      "type": "atomic",
      "entry_actions": [
        "currentHighlight = {i:state.i,j:state.j,type:'compare',sortedIndex:state.sortedIndex||-1}",
        "actionEl.textContent='Comparing'",
        "setPseudocodeLine(4)",
        "render()"
      ],
      "exit_actions": []
    },
    {
      "id": "S5_Swapping",
      "label": "Swapping",
      "type": "atomic",
      "entry_actions": [
        "array = state.arr.slice()",
        "currentHighlight = {i:state.i,j:state.j,type:'swap',sortedIndex:state.sortedIndex||-1}",
        "actionEl.textContent='Swapped'",
        "setPseudocodeLine(5)",
        "render()"
      ],
      "exit_actions": []
    },
    {
      "id": "S6_PassEnd",
      "label": "PassEnd",
      "type": "atomic",
      "entry_actions": [
        "array = state.arr.slice()",
        "passes = state.pass+1",
        "currentHighlight = {i:-1,j:-1,type:'sorted',sortedIndex:state.sortedIndex||-1}",
        "actionEl.textContent='End of pass'",
        "setPseudocodeLine(2)",
        "render()"
      ],
      "exit_actions": []
    },
    {
      "id": "S7_Done",
      "label": "Done",
      "type": "final",
      "entry_actions": [
        "if(state && state.arr) array = state.arr.slice()",
        "comparisons = state.comps !== undefined ? state.comps : comparisons",
        "swaps = state.sw !== undefined ? state.sw : swaps",
        "currentHighlight = {i:-1,j:-1,type:'sorted',sortedIndex:0}",
        "setPseudocodeLine(null)",
        "render()",
        "actionEl.textContent='Finished'",
        "startBtn.disabled=true",
        "pauseBtn.disabled=true",
        "stepBtn.disabled=true"
      ],
      "exit_actions": []
    },
    {
      "id": "S8_GeneratingRandom",
      "label": "GeneratingRandom",
      "type": "atomic",
      "entry_actions": [
        "initialArray = randomArray(parseInt(sizeRange.value,10))",
        "arrayInput.value = initialArray.join(', ')",
        "resetToInitial(false)"
      ],
      "exit_actions": []
    },
    {
      "id": "S9_Shuffling",
      "label": "Shuffling",
      "type": "atomic",
      "entry_actions": [
        "shuffle current array in-place",
        "initialArray = array.slice()",
        "resetToInitial(false)"
      ],
      "exit_actions": []
    },
    {
      "id": "S10_Resetting",
      "label": "Resetting",
      "type": "atomic",
      "entry_actions": [
        "gen = null",
        "resetToInitial(false)"
      ],
      "exit_actions": []
    },
    {
      "id": "S11_InputResetFromUser",
      "label": "InputResetFromUser",
      "type": "atomic",
      "entry_actions": [
        "attempt resetToInitial(true)"
      ],
      "exit_actions": [
        "on invalid input: alert('Invalid input. Please enter comma separated numbers.')"
      ]
    }
  ],
  "events": [
    {
      "id": "USER_CLICK_START",
      "event_type": "user_action",
      "description": "User clicks the Start button",
      "triggers": "#startBtn"
    },
    {
      "id": "USER_CLICK_PAUSE",
      "event_type": "user_action",
      "description": "User clicks the Pause button",
      "triggers": "#pauseBtn"
    },
    {
      "id": "USER_CLICK_STEP",
      "event_type": "user_action",
      "description": "User clicks the Step button",
      "triggers": "#stepBtn, window (ArrowRight key triggers step via stepBtn.click())"
    },
    {
      "id": "USER_CLICK_RESET",
      "event_type": "user_action",
      "description": "User clicks the Reset button",
      "triggers": "#resetBtn"
    },
    {
      "id": "USER_CLICK_RANDOM",
      "event_type": "user_action",
      "description": "User clicks the Generate Random button",
      "triggers": "#randomBtn"
    },
    {
      "id": "USER_CLICK_SHUFFLE",
      "event_type": "user_action",
      "description": "User clicks the Shuffle Current button",
      "triggers": "#shuffleBtn"
    },
    {
      "id": "USER_CLICK_USEINPUT",
      "event_type": "user_action",
      "description": "User clicks the Use Input button",
      "triggers": "#useInputBtn"
    },
    {
      "id": "USER_PRESS_SPACE_OR_CTRL",
      "event_type": "user_action",
      "description": "User presses Space to toggle start/pause (global keydown)",
      "triggers": "window (keydown ' ' )"
    },
    {
      "id": "USER_CHANGE_SIZE",
      "event_type": "user_action",
      "description": "User changes array size via range input",
      "triggers": "#size"
    },
    {
      "id": "USER_CHANGE_SPEED",
      "event_type": "user_action",
      "description": "User changes speed via range input",
      "triggers": "#speed"
    },
    {
      "id": "USER_TOGGLE_ASCENDING",
      "event_type": "user_action",
      "description": "User toggles Ascending checkbox",
      "triggers": "#ascending"
    },
    {
      "id": "USER_TOGGLE_OPTIMIZED",
      "event_type": "user_action",
      "description": "User toggles Optimized checkbox",
      "triggers": "#optimized"
    },
    {
      "id": "USER_ARRAYINPUT_ENTER",
      "event_type": "user_action",
      "description": "User presses Enter in array input (submits custom array)",
      "triggers": "#arrayInput (keydown Enter), #useInputBtn"
    },
    {
      "id": "SYS_GENERATOR_COMPARE",
      "event_type": "system_event",
      "description": "Generator yields a compare step",
      "triggers": "generator.next() -> result.type === 'compare'"
    },
    {
      "id": "SYS_GENERATOR_SWAP",
      "event_type": "system_event",
      "description": "Generator yields a swap step",
      "triggers": "generator.next() -> result.type === 'swap'"
    },
    {
      "id": "SYS_GENERATOR_PASSEND",
      "event_type": "system_event",
      "description": "Generator yields end of pass",
      "triggers": "generator.next() -> result.type === 'passEnd'"
    },
    {
      "id": "SYS_GENERATOR_DONE",
      "event_type": "system_event",
      "description": "Generator finishes (done) - algorithm complete",
      "triggers": "generator.next() -> result.done or result.value.type === 'done'"
    },
    {
      "id": "SYS_TIMER_TICK",
      "event_type": "system_event",
      "description": "Auto-run timer tick triggers next generator step",
      "triggers": "internal timer setTimeout(loop)"
    }
  ],
  "transitions": [
    {
      "from": "S0_Idle",
      "to": "S8_GeneratingRandom",
      "event": "USER_CLICK_RANDOM",
      "guard": "true",
      "actions": [
        "initialArray = randomArray(parseInt(sizeRange.value,10))",
        "arrayInput.value = initialArray.join(', ')",
        "resetToInitial(false)"
      ],
      "expected_observables": [
        "dom:#randomBtn clicked",
        "dom:#arrayInput value updated",
        "dom:#visual .bar"
      ],
      "timeout": 500
    },
    {
      "from": "S8_GeneratingRandom",
      "to": "S0_Idle",
      "event": "SYS_TIMER_TICK",
      "guard": "true",
      "actions": [
        "resetToInitial(false)",
        "render()"
      ],
      "expected_observables": [
        "dom:#visual .bar",
        "dom:#comparisons",
        "dom:#swaps"
      ],
      "timeout": 500
    },
    {
      "from": "S0_Idle",
      "to": "S9_Shuffling",
      "event": "USER_CLICK_SHUFFLE",
      "guard": "array.length>0",
      "actions": [
        "shuffle current array in-place",
        "initialArray = array.slice()",
        "resetToInitial(false)"
      ],
      "expected_observables": [
        "dom:#shuffleBtn clicked",
        "dom:#arrayInput changed",
        "dom:#visual .bar"
      ],
      "timeout": 500
    },
    {
      "from": "S9_Shuffling",
      "to": "S0_Idle",
      "event": "SYS_TIMER_TICK",
      "guard": "true",
      "actions": [
        "resetToInitial(false)",
        "render()"
      ],
      "expected_observables": [
        "dom:#visual .bar"
      ],
      "timeout": 500
    },
    {
      "from": "S0_Idle",
      "to": "S11_InputResetFromUser",
      "event": "USER_CLICK_USEINPUT",
      "guard": "true",
      "actions": [
        "resetToInitial(true)"
      ],
      "expected_observables": [
        "dom:#useInputBtn clicked",
        "dom:#arrayInput value read"
      ],
      "timeout": 1000
    },
    {
      "from": "S11_InputResetFromUser",
      "to": "S0_Idle",
      "event": "USER_ARRAYINPUT_ENTER",
      "guard": "input valid",
      "actions": [
        "array = parsed input array",
        "comparisons=0;swaps=0;passes=0",
        "render()"
      ],
      "expected_observables": [
        "dom:#arrayInput value parsed",
        "dom:#visual .bar"
      ],
      "timeout": 500
    },
    {
      "from": "S11_InputResetFromUser",
      "to": "S0_Idle",
      "event": "USER_ARRAYINPUT_ENTER",
      "guard": "input invalid",
      "actions": [
        "alert('Invalid input. Please enter comma separated numbers.')"
      ],
      "expected_observables": [
        "window:alert shown"
      ],
      "timeout": 200
    },
    {
      "from": "S0_Idle",
      "to": "S1_AutoRunning",
      "event": "USER_CLICK_START",
      "guard": "true",
      "actions": [
        "if(!gen) gen = bubbleSortGen(array.slice(), ascendingCb.checked, optimizedCb.checked)",
        "startAuto()",
        "actionEl.textContent='Running'"
      ],
      "expected_observables": [
        "dom:#startBtn clicked",
        "dom:#pauseBtn disabled === false",
        "dom:#visual .bar"
      ],
      "timeout": 500
    },
    {
      "from": "S2_Paused",
      "to": "S1_AutoRunning",
      "event": "USER_CLICK_START",
      "guard": "true",
      "actions": [
        "startAuto()",
        "actionEl.textContent='Running'"
      ],
      "expected_observables": [
        "dom:#startBtn clicked",
        "dom:#pauseBtn disabled === false"
      ],
      "timeout": 300
    },
    {
      "from": "S1_AutoRunning",
      "to": "S2_Paused",
      "event": "USER_CLICK_PAUSE",
      "guard": "running === true",
      "actions": [
        "pauseAuto()",
        "actionEl.textContent='Paused'"
      ],
      "expected_observables": [
        "dom:#pauseBtn clicked",
        "dom:#action textContent === 'Paused'"
      ],
      "timeout": 200
    },
    {
      "from": "S1_AutoRunning",
      "to": "S4_Comparing",
      "event": "SYS_GENERATOR_COMPARE",
      "guard": "true",
      "actions": [
        "update comparisons from state",
        "currentHighlight set to compare",
        "setPseudocodeLine(4)",
        "render()"
      ],
      "expected_observables": [
        "dom:#visual .bar.compare",
        "dom:#comparisons textContent updated",
        "dom:#action textContent === 'Comparing'"
      ],
      "timeout": 200
    },
    {
      "from": "S4_Comparing",
      "to": "S5_Swapping",
      "event": "SYS_GENERATOR_SWAP",
      "guard": "true",
      "actions": [
        "apply swap to array",
        "update swaps counter",
        "currentHighlight set to swap",
        "setPseudocodeLine(5)",
        "render()"
      ],
      "expected_observables": [
        "dom:#visual .bar.swap",
        "dom:#swaps textContent updated",
        "dom:#action textContent === 'Swapped'"
      ],
      "timeout": 300
    },
    {
      "from": "S4_Comparing",
      "to": "S4_Comparing",
      "event": "SYS_GENERATOR_COMPARE",
      "guard": "no swap after compare",
      "actions": [
        "advance to next compare",
        "update comparisons",
        "currentHighlight updated",
        "render()"
      ],
      "expected_observables": [
        "dom:#visual .bar.compare",
        "dom:#comparisons textContent"
      ],
      "timeout": 200
    },
    {
      "from": "S5_Swapping",
      "to": "S4_Comparing",
      "event": "SYS_TIMER_TICK",
      "guard": "true",
      "actions": [
        "continue generator loop (next step)",
        "render()"
      ],
      "expected_observables": [
        "dom:#visual .bar.compare or .bar.swap"
      ],
      "timeout": 200
    },
    {
      "from": "S1_AutoRunning",
      "to": "S6_PassEnd",
      "event": "SYS_GENERATOR_PASSEND",
      "guard": "true",
      "actions": [
        "array = state.arr.slice()",
        "passes = state.pass+1",
        "currentHighlight set to sorted for suffix",
        "setPseudocodeLine(2)",
        "render()"
      ],
      "expected_observables": [
        "dom:#passes textContent updated",
        "dom:#visual .bar.sorted"
      ],
      "timeout": 300
    },
    {
      "from": "S6_PassEnd",
      "to": "S1_AutoRunning",
      "event": "SYS_TIMER_TICK",
      "guard": "running === true",
      "actions": [
        "continue generator",
        "render()"
      ],
      "expected_observables": [
        "dom:#visual .bar"
      ],
      "timeout": 200
    },
    {
      "from": "S1_AutoRunning",
      "to": "S7_Done",
      "event": "SYS_GENERATOR_DONE",
      "guard": "true",
      "actions": [
        "apply final array if provided",
        "comparisons=state.comps || comparisons",
        "swaps=state.sw || swaps",
        "currentHighlight = sorted",
        "setPseudocodeLine(null)",
        "stopAuto()",
        "actionEl.textContent='Finished'",
        "startBtn.disabled=true; pauseBtn.disabled=true; stepBtn.disabled=true"
      ],
      "expected_observables": [
        "dom:#action textContent === 'Finished'",
        "dom:#visual .bar.sorted",
        "dom:#startBtn.disabled === true"
      ],
      "timeout": 1000
    },
    {
      "from": "S0_Idle",
      "to": "S3_Step",
      "event": "USER_CLICK_STEP",
      "guard": "true",
      "actions": [
        "if(!gen) gen = bubbleSortGen(array.slice(), ascendingCb.checked, optimizedCb.checked)",
        "advanceOnce()"
      ],
      "expected_observables": [
        "dom:#stepBtn clicked",
        "dom:#visual .bar.compare or .bar.swap"
      ],
      "timeout": 400
    },
    {
      "from": "S2_Paused",
      "to": "S3_Step",
      "event": "USER_CLICK_STEP",
      "guard": "true",
      "actions": [
        "advanceOnce()"
      ],
      "expected_observables": [
        "dom:#stepBtn clicked",
        "dom:#visual .bar.compare or .bar.swap"
      ],
      "timeout": 400
    },
    {
      "from": "S1_AutoRunning",
      "to": "S10_Resetting",
      "event": "USER_CLICK_RESET",
      "guard": "true",
      "actions": [
        "gen=null",
        "resetToInitial(false)",
        "stopAuto()"
      ],
      "expected_observables": [
        "dom:#resetBtn clicked",
        "dom:#visual .bar"
      ],
      "timeout": 300
    },
    {
      "from": "S2_Paused",
      "to": "S10_Resetting",
      "event": "USER_CLICK_RESET",
      "guard": "true",
      "actions": [
        "gen=null",
        "resetToInitial(false)"
      ],
      "expected_observables": [
        "dom:#resetBtn clicked",
        "dom:#visual .bar"
      ],
      "timeout": 300
    },
    {
      "from": "S0_Idle",
      "to": "S10_Resetting",
      "event": "USER_CLICK_RESET",
      "guard": "true",
      "actions": [
        "gen=null",
        "resetToInitial(false)"
      ],
      "expected_observables": [
        "dom:#resetBtn clicked",
        "dom:#visual .bar"
      ],
      "timeout": 300
    },
    {
      "from": "S0_Idle",
      "to": "S0_Idle",
      "event": "USER_CHANGE_SIZE",
      "guard": "true",
      "actions": [
        "sizeLabel.textContent = sizeRange.value"
      ],
      "expected_observables": [
        "dom:#size input"
      ],
      "timeout": 100
    },
    {
      "from": "S0_Idle",
      "to": "S0_Idle",
      "event": "USER_CHANGE_SPEED",
      "guard": "true",
      "actions": [
        "speedLabel.textContent = speedRange.value",
        "stepDelay = parseInt(speedRange.value,10)"
      ],
      "expected_observables": [
        "dom:#speed input",
        "dom:#speedLabel textContent updated"
      ],
      "timeout": 100
    },
    {
      "from": "S0_Idle",
      "to": "S0_Idle",
      "event": "USER_TOGGLE_ASCENDING",
      "guard": "true",
      "actions": [
        "ascendingCb.checked toggled (affects new gen creation)"
      ],
      "expected_observables": [
        "dom:#ascending changed"
      ],
      "timeout": 100
    },
    {
      "from": "S0_Idle",
      "to": "S0_Idle",
      "event": "USER_TOGGLE_OPTIMIZED",
      "guard": "true",
      "actions": [
        "optimizedCb.checked toggled (affects new gen creation)"
      ],
      "expected_observables": [
        "dom:#optimized changed"
      ],
      "timeout": 100
    },
    {
      "from": "S0_Idle",
      "to": "S1_AutoRunning",
      "event": "USER_PRESS_SPACE_OR_CTRL",
      "guard": "not running",
      "actions": [
        "startBtn.click()"
      ],
      "expected_observables": [
        "window keydown ' '",
        "dom:#startBtn clicked"
      ],
      "timeout": 200
    },
    {
      "from": "S1_AutoRunning",
      "to": "S2_Paused",
      "event": "USER_PRESS_SPACE_OR_CTRL",
      "guard": "running === true",
      "actions": [
        "pauseAuto()"
      ],
      "expected_observables": [
        "window keydown ' '",
        "dom:#action textContent === 'Paused'"
      ],
      "timeout": 200
    }
  ],
  "components": [
    "#size",
    "#sizeLabel",
    "#speed",
    "#speedLabel",
    "#ascending",
    "#optimized",
    "#randomBtn",
    "#startBtn",
    "#pauseBtn",
    "#stepBtn",
    "#resetBtn",
    "#shuffleBtn",
    "#useInputBtn",
    "#arrayInput",
    "#visual",
    ".visual",
    ".bar",
    ".bar.compare",
    ".bar.swap",
    ".bar.sorted",
    "#comparisons",
    "#swaps",
    "#passes",
    "#action",
    "#lastComp",
    "#pseudocode",
    ".code-line",
    ".code-line.active",
    ".array-input",
    "window"
  ]
}