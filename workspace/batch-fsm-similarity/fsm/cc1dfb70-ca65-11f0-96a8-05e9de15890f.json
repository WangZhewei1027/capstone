{
  "meta": {
    "concept": "CountingSort",
    "topic": "Counting Sort Visualization",
    "educational_goal": "Demonstrate Counting Sort phases (counting, prefix sums, stable/non-stable placement, optional copy-back) with step-by-step animation and playback controls",
    "expected_interactions": [
      "generate_random",
      "use_custom_array",
      "record_steps",
      "play_pause",
      "step_forward",
      "step_backward",
      "jump_to_start",
      "jump_to_end",
      "change_speed",
      "reset"
    ]
  },
  "states": [
    {
      "id": "S0_IDLE",
      "label": "idle",
      "type": "idle",
      "entry_actions": [
        "setStatus('Idle. Enter array and press Record.')",
        "renderInitialView()"
      ],
      "exit_actions": []
    },
    {
      "id": "S1_GENERATING_RANDOM",
      "label": "generating_random",
      "type": "atomic",
      "entry_actions": [
        "const n=clamp(parseInt(nInput.value)||0,1,40); const k=clamp(parseInt(kInput.value)||0,0,100); arr = genRandomArray(n,k); arrInput.value = arr.join(','); setStatus('Random array generated.')"
      ],
      "exit_actions": []
    },
    {
      "id": "S2_USE_CUSTOM",
      "label": "use_custom",
      "type": "atomic",
      "entry_actions": [
        "const parsed = parseArrayInput(arrInput.value)",
        "if(parsed.error) throw 'PARSE_ERROR'",
        "arr = parsed.vals.slice(); nInput.value = arr.length; kInput.value = Math.max(parseInt(kInput.value||0), arr.length?Math.max(...arr):0); setStatus('Using custom array from text.')",
        "renderInitialView()"
      ],
      "exit_actions": []
    },
    {
      "id": "S3_RECORDING",
      "label": "recording",
      "type": "atomic",
      "entry_actions": [
        "parseArrayInput(arrInput.value) // validate",
        "setStatus('Recording steps...')",
        "steps = recordCountingSort(arr, parseInt(kInput.value), {stable: !!stableToggle.checked, copyBack: !!copyBack.checked})"
      ],
      "exit_actions": [
        "setStatus('Steps recorded. Ready.')"
      ]
    },
    {
      "id": "S4_READY",
      "label": "ready",
      "type": "idle",
      "entry_actions": [
        "currentStep = 0",
        "totalStepsLabel.textContent = Math.max(0, steps.length-1)",
        "curStepLabel.textContent = currentStep",
        "renderSnapshot(steps[currentStep])",
        "enablePlaybackControls()"
      ],
      "exit_actions": []
    },
    {
      "id": "S5_PLAYING",
      "label": "playing",
      "type": "atomic",
      "entry_actions": [
        "playBtn.textContent = '❚❚ Pause'",
        "setStatus('Playing...')",
        "playTimer = setInterval(playbackTick, parseInt(speedInput.value))"
      ],
      "exit_actions": [
        "if(playTimer){ clearInterval(playTimer); playTimer = null }",
        "playBtn.textContent = '▶ Play'"
      ]
    },
    {
      "id": "S6_PAUSED",
      "label": "paused",
      "type": "atomic",
      "entry_actions": [
        "setStatus('Paused.')",
        "if(playTimer){ clearInterval(playTimer); playTimer = null }",
        "playBtn.textContent = '▶ Play'"
      ],
      "exit_actions": []
    },
    {
      "id": "S7_FINISHED",
      "label": "finished",
      "type": "atomic",
      "entry_actions": [
        "if(playTimer){ clearInterval(playTimer); playTimer = null }",
        "playBtn.textContent = '▶ Play'",
        "setStatus('Finished.')"
      ],
      "exit_actions": []
    },
    {
      "id": "S8_STEPPING",
      "label": "stepping",
      "type": "atomic",
      "entry_actions": [
        "goToStep(targetStep)",
        "renderSnapshot(steps[currentStep])"
      ],
      "exit_actions": []
    },
    {
      "id": "S9_RESETTING",
      "label": "resetting",
      "type": "atomic",
      "entry_actions": [
        "steps = []",
        "currentStep = 0",
        "inputBoxes.innerHTML = ''",
        "countBoxes.innerHTML = ''",
        "outBoxes.innerHTML = ''",
        "curStepLabel.textContent = 0",
        "totalStepsLabel.textContent = 0",
        "stepDesc.textContent = 'Prepare by recording steps...'",
        "setStatus('Reset.')",
        "playBtn.textContent = '▶ Play'",
        "if(playTimer){ clearInterval(playTimer); playTimer = null }"
      ],
      "exit_actions": [
        "setStatus('Idle. Enter array and press Record.')",
        "renderInitialView()"
      ]
    },
    {
      "id": "S10_ERROR_ALERT",
      "label": "error_alert",
      "type": "atomic",
      "entry_actions": [
        "window.alert(errorMessage)"
      ],
      "exit_actions": []
    }
  ],
  "events": [
    {
      "id": "CLICK_GEN_RND",
      "event_type": "user_action",
      "description": "User clicks Generate Random button",
      "triggers": "#genRnd"
    },
    {
      "id": "CLICK_USE_CUSTOM",
      "event_type": "user_action",
      "description": "User clicks Use From Text button to parse arrInput",
      "triggers": "#useCustom"
    },
    {
      "id": "CLICK_RECORD",
      "event_type": "user_action",
      "description": "User clicks Record (prepare steps)",
      "triggers": "#recordBtn"
    },
    {
      "id": "CLICK_RESET",
      "event_type": "user_action",
      "description": "User clicks Reset View",
      "triggers": "#resetBtn"
    },
    {
      "id": "CLICK_PLAY",
      "event_type": "user_action",
      "description": "User clicks Play / Pause toggle",
      "triggers": "#playBtn"
    },
    {
      "id": "CLICK_STEP_FWD",
      "event_type": "user_action",
      "description": "User clicks Step ▶ (single step forward)",
      "triggers": "#stepFwd"
    },
    {
      "id": "CLICK_STEP_BACK",
      "event_type": "user_action",
      "description": "User clicks ◀ Step (single step backward)",
      "triggers": "#stepBack"
    },
    {
      "id": "CLICK_BACK_TO_START",
      "event_type": "user_action",
      "description": "User clicks ⟲ Back (jump to step 0)",
      "triggers": "#backBtn"
    },
    {
      "id": "CLICK_FORWARD_TO_END",
      "event_type": "user_action",
      "description": "User clicks Forward ⟳ (jump to final step)",
      "triggers": "#fwdBtn"
    },
    {
      "id": "SPEED_INPUT_CHANGE",
      "event_type": "user_action",
      "description": "User changes playback speed slider",
      "triggers": "#speed"
    },
    {
      "id": "ARR_INPUT_CHANGE",
      "event_type": "user_action",
      "description": "User edits array input text (used when recording or using custom)",
      "triggers": "#arrInput"
    },
    {
      "id": "N_INPUT_CHANGE",
      "event_type": "user_action",
      "description": "User edits number of elements (n) input (used for random generation)",
      "triggers": "#nInput"
    },
    {
      "id": "K_INPUT_CHANGE",
      "event_type": "user_action",
      "description": "User edits max value (k) input",
      "triggers": "#kInput"
    },
    {
      "id": "TOGGLE_STABLE",
      "event_type": "user_action",
      "description": "User toggles stable option (checkbox)",
      "triggers": "#stableToggle"
    },
    {
      "id": "TOGGLE_COPYBACK",
      "event_type": "user_action",
      "description": "User toggles copy-back option (checkbox)",
      "triggers": "#copyBack"
    },
    {
      "id": "SYSTEM_RECORD_COMPLETE",
      "event_type": "system_event",
      "description": "Recording steps complete (synchronous return from recordCountingSort)",
      "triggers": ""
    },
    {
      "id": "SYSTEM_PLAYBACK_TICK",
      "event_type": "system_event",
      "description": "Playback timer tick advances currentStep",
      "triggers": "#playBtn,#speed"
    },
    {
      "id": "SYSTEM_PLAYBACK_FINISHED",
      "event_type": "system_event",
      "description": "Playback reaches last step and finishes",
      "triggers": ""
    },
    {
      "id": "SYSTEM_PARSE_ERROR",
      "event_type": "system_event",
      "description": "Parsing array input failed (non-integer or negative)",
      "triggers": "#arrInput"
    },
    {
      "id": "USER_CONFIRMS_INCREASE_K",
      "event_type": "user_action",
      "description": "User confirms dialog to increase k automatically",
      "triggers": ""
    },
    {
      "id": "USER_CANCELS_INCREASE_K",
      "event_type": "user_action",
      "description": "User cancels dialog to increase k",
      "triggers": ""
    },
    {
      "id": "USER_DISMISSES_ALERT",
      "event_type": "user_action",
      "description": "User dismisses an alert dialog (implicit)",
      "triggers": ""
    }
  ],
  "transitions": [
    {
      "from": "S0_IDLE",
      "to": "S1_GENERATING_RANDOM",
      "event": "CLICK_GEN_RND",
      "guard": "true",
      "actions": [
        "genRandomArray(clamp(parseInt(#nInput.value)||0,1,40), clamp(parseInt(#kInput.value)||0,0,100))",
        "arrInput.value = arr.join(',')",
        "setStatus('Random array generated.')",
        "renderInitialView()"
      ],
      "expected_observables": [
        "dom:#genRnd:click",
        "dom:#arrInput:value"
      ],
      "timeout": 0
    },
    {
      "from": "S0_IDLE",
      "to": "S2_USE_CUSTOM",
      "event": "CLICK_USE_CUSTOM",
      "guard": "parseArrayInput(#arrInput.value) is valid",
      "actions": [
        "arr = parseArrayInput(#arrInput.value).vals.slice()",
        "nInput.value = arr.length",
        "kInput.value = Math.max(parseInt(kInput.value||0), arr.length?Math.max(...arr):0)",
        "setStatus('Using custom array from text.')",
        "renderInitialView()"
      ],
      "expected_observables": [
        "dom:#useCustom:click",
        "dom:#arrInput:value"
      ],
      "timeout": 0
    },
    {
      "from": "S0_IDLE",
      "to": "S10_ERROR_ALERT",
      "event": "CLICK_USE_CUSTOM",
      "guard": "parseArrayInput(#arrInput.value) returns error",
      "actions": [
        "errorMessage = parseArrayInput(#arrInput.value).error",
        "window.alert(errorMessage)"
      ],
      "expected_observables": [
        "dom:#useCustom:click",
        "dom:window:alert"
      ],
      "timeout": 0
    },
    {
      "from": "S0_IDLE",
      "to": "S3_RECORDING",
      "event": "CLICK_RECORD",
      "guard": "parseArrayInput(#arrInput.value) is valid AND (no k-conflict OR user confirms increase)",
      "actions": [
        "arr = parseArrayInput(#arrInput.value).vals.slice()",
        "if (arr.some(v => v > parseInt(#kInput.value||0))){ if(!confirm('Some values are greater than k. Increase k automatically?')) throw 'USER_CANCELS_INCREASE_K'; else kInput.value = Math.max(...arr) }",
        "setStatus('Recording steps...')",
        "steps = recordCountingSort(arr, parseInt(#kInput.value), {stable: !!document.querySelector('#stableToggle').checked, copyBack: !!document.querySelector('#copyBack').checked})",
        "dispatch SYSTEM_RECORD_COMPLETE"
      ],
      "expected_observables": [
        "dom:#recordBtn:click",
        "dom:#arrInput:value",
        "dom:#kInput:value",
        "dom:#stableToggle:checked",
        "dom:#copyBack:checked"
      ],
      "timeout": 5000
    },
    {
      "from": "S3_RECORDING",
      "to": "S10_ERROR_ALERT",
      "event": "CLICK_RECORD",
      "guard": "parseArrayInput(#arrInput.value) returns error",
      "actions": [
        "errorMessage = parseArrayInput(#arrInput.value).error",
        "window.alert(errorMessage)"
      ],
      "expected_observables": [
        "dom:#recordBtn:click",
        "dom:window:alert"
      ],
      "timeout": 0
    },
    {
      "from": "S3_RECORDING",
      "to": "S4_READY",
      "event": "SYSTEM_RECORD_COMPLETE",
      "guard": "steps && steps.length > 0",
      "actions": [
        "currentStep = 0",
        "totalStepsLabel.textContent = Math.max(0, steps.length-1)",
        "curStepLabel.textContent = currentStep",
        "setStatus('Steps recorded. Ready.')",
        "renderSnapshot(steps[currentStep])"
      ],
      "expected_observables": [
        "dom:#recordBtn:click",
        "dom:#totalSteps:textContent",
        "dom:#curStep:textContent",
        "dom:#stepDesc:innerHTML"
      ],
      "timeout": 2000
    },
    {
      "from": "S4_READY",
      "to": "S5_PLAYING",
      "event": "CLICK_PLAY",
      "guard": "steps && steps.length > 0",
      "actions": [
        "playBtn.textContent = '❚❚ Pause'",
        "setStatus('Playing...')",
        "playTimer = setInterval(()=>dispatch SYSTEM_PLAYBACK_TICK, parseInt(#speed.value))"
      ],
      "expected_observables": [
        "dom:#playBtn:click",
        "dom:#speed:value",
        "dom:#curStep:textContent"
      ],
      "timeout": 0
    },
    {
      "from": "S5_PLAYING",
      "to": "S6_PAUSED",
      "event": "CLICK_PLAY",
      "guard": "playTimer active",
      "actions": [
        "clearInterval(playTimer)",
        "playTimer = null",
        "playBtn.textContent = '▶ Play'",
        "setStatus('Paused.')"
      ],
      "expected_observables": [
        "dom:#playBtn:click"
      ],
      "timeout": 0
    },
    {
      "from": "S5_PLAYING",
      "to": "S6_PAUSED",
      "event": "SPEED_INPUT_CHANGE",
      "guard": "playTimer active",
      "actions": [
        "clearInterval(playTimer)",
        "playTimer = null",
        "playBtn.textContent = '▶ Play'",
        "setStatus('Speed changed; playback stopped. Press Play again.')"
      ],
      "expected_observables": [
        "dom:#speed:input",
        "dom:#playBtn:textContent"
      ],
      "timeout": 0
    },
    {
      "from": "S5_PLAYING",
      "to": "S5_PLAYING",
      "event": "SYSTEM_PLAYBACK_TICK",
      "guard": "currentStep < steps.length-1",
      "actions": [
        "currentStep++",
        "renderSnapshot(steps[currentStep])"
      ],
      "expected_observables": [
        "dom:#curStep:textContent",
        "dom:#stepDesc:innerHTML"
      ],
      "timeout": "dynamic (#speed.value)"
    },
    {
      "from": "S5_PLAYING",
      "to": "S7_FINISHED",
      "event": "SYSTEM_PLAYBACK_TICK",
      "guard": "currentStep >= steps.length-1",
      "actions": [
        "clearInterval(playTimer)",
        "playTimer = null",
        "playBtn.textContent = '▶ Play'",
        "setStatus('Finished.')"
      ],
      "expected_observables": [
        "dom:#curStep:textContent",
        "dom:#totalSteps:textContent",
        "dom:#playBtn:textContent"
      ],
      "timeout": 0
    },
    {
      "from": "S4_READY",
      "to": "S8_STEPPING",
      "event": "CLICK_STEP_FWD",
      "guard": "steps && currentStep < steps.length-1",
      "actions": [
        "targetStep = currentStep+1",
        "goToStep(targetStep)",
        "renderSnapshot(steps[currentStep])"
      ],
      "expected_observables": [
        "dom:#stepFwd:click",
        "dom:#curStep:textContent"
      ],
      "timeout": 0
    },
    {
      "from": "S4_READY",
      "to": "S8_STEPPING",
      "event": "CLICK_STEP_BACK",
      "guard": "steps && currentStep > 0",
      "actions": [
        "targetStep = currentStep-1",
        "goToStep(targetStep)",
        "renderSnapshot(steps[currentStep])"
      ],
      "expected_observables": [
        "dom:#stepBack:click",
        "dom:#curStep:textContent"
      ],
      "timeout": 0
    },
    {
      "from": "S4_READY",
      "to": "S8_STEPPING",
      "event": "CLICK_BACK_TO_START",
      "guard": "steps && steps.length > 0",
      "actions": [
        "targetStep = 0",
        "goToStep(0)",
        "renderSnapshot(steps[currentStep])"
      ],
      "expected_observables": [
        "dom:#backBtn:click",
        "dom:#curStep:textContent"
      ],
      "timeout": 0
    },
    {
      "from": "S4_READY",
      "to": "S8_STEPPING",
      "event": "CLICK_FORWARD_TO_END",
      "guard": "steps && steps.length > 0",
      "actions": [
        "targetStep = steps.length-1",
        "goToStep(steps.length-1)",
        "renderSnapshot(steps[currentStep])"
      ],
      "expected_observables": [
        "dom:#fwdBtn:click",
        "dom:#curStep:textContent",
        "dom:#totalSteps:textContent"
      ],
      "timeout": 0
    },
    {
      "from": "S6_PAUSED",
      "to": "S8_STEPPING",
      "event": "CLICK_STEP_FWD",
      "guard": "steps && currentStep < steps.length-1",
      "actions": [
        "targetStep = currentStep+1",
        "goToStep(targetStep)",
        "renderSnapshot(steps[currentStep])"
      ],
      "expected_observables": [
        "dom:#stepFwd:click",
        "dom:#curStep:textContent"
      ],
      "timeout": 0
    },
    {
      "from": "S6_PAUSED",
      "to": "S8_STEPPING",
      "event": "CLICK_STEP_BACK",
      "guard": "steps && currentStep > 0",
      "actions": [
        "targetStep = currentStep-1",
        "goToStep(targetStep)",
        "renderSnapshot(steps[currentStep])"
      ],
      "expected_observables": [
        "dom:#stepBack:click"
      ],
      "timeout": 0
    },
    {
      "from": "S8_STEPPING",
      "to": "S4_READY",
      "event": "USER_DISMISSES_ALERT",
      "guard": "true",
      "actions": [
        "clear temporary targetStep",
        "update UI labels if needed"
      ],
      "expected_observables": [
        "dom:#curStep:textContent",
        "dom:#stepDesc:innerHTML"
      ],
      "timeout": 0
    },
    {
      "from": "S0_IDLE",
      "to": "S9_RESETTING",
      "event": "CLICK_RESET",
      "guard": "true",
      "actions": [
        "steps = []",
        "currentStep = 0",
        "inputBoxes.innerHTML = ''",
        "countBoxes.innerHTML = ''",
        "outBoxes.innerHTML = ''",
        "curStepLabel.textContent = 0",
        "totalStepsLabel.textContent = 0",
        "stepDesc.textContent = 'Prepare by recording steps...'",
        "setStatus('Reset.')",
        "playBtn.textContent = '▶ Play'",
        "if(playTimer){ clearInterval(playTimer); playTimer = null }"
      ],
      "expected_observables": [
        "dom:#resetBtn:click",
        "dom:#inputBoxes:innerHTML",
        "dom:#countBoxes:innerHTML",
        "dom:#outBoxes:innerHTML"
      ],
      "timeout": 0
    },
    {
      "from": "S4_READY",
      "to": "S9_RESETTING",
      "event": "CLICK_RESET",
      "guard": "true",
      "actions": [
        "same reset actions as above"
      ],
      "expected_observables": [
        "dom:#resetBtn:click"
      ],
      "timeout": 0
    },
    {
      "from": "S3_RECORDING",
      "to": "S0_IDLE",
      "event": "USER_CANCELS_INCREASE_K",
      "guard": "true",
      "actions": [
        "setStatus('Recording cancelled by user.')"
      ],
      "expected_observables": [
        "dom:#recordBtn:click",
        "dom:window:confirm"
      ],
      "timeout": 0
    },
    {
      "from": "S10_ERROR_ALERT",
      "to": "S0_IDLE",
      "event": "USER_DISMISSES_ALERT",
      "guard": "true",
      "actions": [
        "errorMessage = null",
        "setStatus('Idle. Enter array and press Record.')"
      ],
      "expected_observables": [
        "dom:window:alert"
      ],
      "timeout": 0
    },
    {
      "from": "S5_PLAYING",
      "to": "S5_PLAYING",
      "event": "SYSTEM_PLAYBACK_TICK",
      "guard": "steps is empty",
      "actions": [
        "clearInterval(playTimer)",
        "playTimer = null",
        "setStatus('Finished.')"
      ],
      "expected_observables": [
        "dom:#playBtn:textContent"
      ],
      "timeout": 0
    }
  ],
  "components": [
    "#arrInput",
    "#nInput",
    "#kInput",
    "#genRnd",
    "#useCustom",
    "#recordBtn",
    "#resetBtn",
    "#stableToggle",
    "#copyBack",
    "#inputBoxes",
    "#countBoxes",
    "#outBoxes",
    "#status",
    "#stepDesc",
    "#curStep",
    "#totalSteps",
    "#playBtn",
    "#backBtn",
    "#fwdBtn",
    "#stepBack",
    "#stepFwd",
    "#speed",
    ".cell",
    ".cell.small",
    ".highlight",
    ".placed",
    ".muted-cell",
    ".dot.current",
    ".dot.placed"
  ]
}