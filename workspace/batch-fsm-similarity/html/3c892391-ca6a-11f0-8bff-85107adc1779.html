<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Heap Sort Visualization</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f0f4f8;
    color: #222;
  }
  h1 {
    text-align: center;
  }
  #controls {
    margin-bottom: 15px;
    text-align: center;
  }
  input[type="text"] {
    width: 300px;
    padding: 6px;
    font-size: 16px;
  }
  button {
    padding: 8px 15px;
    font-size: 16px;
    margin-left: 10px;
    cursor: pointer;
  }
  #array {
    margin: 20px auto;
    max-width: 800px;
    height: 150px;
    display: flex;
    justify-content: center;
    align-items: flex-end;
    gap: 8px;
  }
  .bar {
    background-color: #4a90e2;
    color: white;
    font-weight: bold;
    text-align: center;
    border-radius: 4px 4px 0 0;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .bar.comparing {
    background-color: #f39c12;
  }
  .bar.swapping {
    background-color: #e74c3c;
  }
  .bar.sorted {
    background-color: #2ecc71;
  }
  #log {
    max-width: 800px;
    margin: 10px auto;
    height: 180px;
    overflow-y: auto;
    background: #fff;
    border-radius: 5px;
    border: 1px solid #ddd;
    padding: 10px;
    font-family: monospace;
    font-size: 14px;
  }
  #speedLabel {
    margin-left: 20px;
    font-weight: 600;
  }
  #speed {
    vertical-align: middle;
  }
  footer {
    text-align: center;
    margin-top: 40px;
    font-size: 14px;
    color: #777;
  }
  @media (max-width: 600px) {
    #array {
      height: 120px;
    }
    input[type="text"] {
      width: 90%;
    }
  }
</style>
</head>
<body>
  <h1>Heap Sort Visualization</h1>
  <div id="controls">
    <input id="inputArray" placeholder="Enter numbers separated by commas" value="20, 3, 15, 7, 6, 2, 9, 12" />
    <button id="startBtn">Start Sort</button>
    <label id="speedLabel" for="speed">Speed:</label>
    <input type="range" id="speed" min="50" max="2000" value="500" />
  </div>
  <div id="array"></div>
  <div id="log"></div>

<script>
(() => {
  const arrayContainer = document.getElementById('array');
  const logContainer = document.getElementById('log');
  const startBtn = document.getElementById('startBtn');
  const inputArray = document.getElementById('inputArray');
  const speedControl = document.getElementById('speed');

  let array = [];
  let speed = 500; // delay in ms between steps

  function log(message) {
    const entry = document.createElement('div');
    entry.textContent = message;
    logContainer.appendChild(entry);
    logContainer.scrollTop = logContainer.scrollHeight;
  }

  function clearLog() {
    logContainer.innerHTML = '';
  }

  // Render bars reflecting the current array
  function renderArray(highlight = {}, sortedIndices = []) {
    // highlight: {comparing: [i,j], swapping: [i,j]}
    arrayContainer.innerHTML = '';

    const maxVal = Math.max(...array);
    array.forEach((val, idx) => {
      const bar = document.createElement('div');
      bar.classList.add('bar');
      const heightPercent = (val / maxVal) * 100;
      bar.style.height = `${heightPercent}%`;
      bar.textContent = val;

      if (highlight.swapping && highlight.swapping.includes(idx)) {
        bar.classList.add('swapping');
      } else if (highlight.comparing && highlight.comparing.includes(idx)) {
        bar.classList.add('comparing');
      } else if (sortedIndices.includes(idx)) {
        bar.classList.add('sorted');
      }

      // Width depends on array length
      const widthPercent = Math.min(100 / array.length - 1, 10);
      bar.style.width = `${widthPercent}%`;

      arrayContainer.appendChild(bar);
    });
  }

  // Utility delay function (returns a Promise resolved after ms milliseconds)
  function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function heapSort(arr) {
    const n = arr.length;
    const sortedIndices = [];

    log(`Building max heap...`);
    // Build max heap
    for (let i = Math.floor(n / 2) - 1; i >= 0; i--) {
      await heapify(arr, n, i, sortedIndices);
    }

    log(`Max heap built. Starting sort...`);
    // One by one extract elements
    for (let i = n - 1; i > 0; i--) {
      log(`Swap root (index 0, value ${arr[0]}) with element at index ${i}, value ${arr[i]}`);
      renderArray({ swapping: [0, i] }, sortedIndices);
      await delay(speed);

      [arr[0], arr[i]] = [arr[i], arr[0]];
      renderArray({ swapping: [0, i] }, sortedIndices);
      await delay(speed);

      sortedIndices.push(i);
      log(`Heapify root after swap, heap size: ${i}`);
      await heapify(arr, i, 0, sortedIndices);
    }
    sortedIndices.push(0);
    renderArray({}, sortedIndices);
    log(`Array is fully sorted.`);
  }

  // Heapify subtree rooted at index i in array of size n
  async function heapify(arr, n, i, sortedIndices) {
    let largest = i;
    const left = 2 * i + 1;
    const right = 2 * i + 2;

    if (left < n) {
      log(`Compare arr[${left}] (${arr[left]}) with arr[${largest}] (${arr[largest]})`);
      renderArray({ comparing: [left, largest] }, sortedIndices);
      await delay(speed);
      if (arr[left] > arr[largest]) {
        largest = left;
      }
    }

    if (right < n) {
      log(`Compare arr[${right}] (${arr[right]}) with arr[${largest}] (${arr[largest]})`);
      renderArray({ comparing: [right, largest] }, sortedIndices);
      await delay(speed);
      if (arr[right] > arr[largest]) {
        largest = right;
      }
    }

    if (largest !== i) {
      log(`Swap arr[${i}] (${arr[i]}) with arr[${largest}] (${arr[largest]})`);
      renderArray({ swapping: [i, largest] }, sortedIndices);
      await delay(speed);

      [arr[i], arr[largest]] = [arr[largest], arr[i]];
      renderArray({ swapping: [i, largest] }, sortedIndices);
      await delay(speed);

      await heapify(arr, n, largest, sortedIndices);
    }
  }

  function parseInput(input) {
    let numbers = input.split(',').map(s => s.trim()).filter(s => s.length);
    let parsed = [];
    for (let numStr of numbers) {
      let num = Number(numStr);
      if (Number.isNaN(num)) return null;
      parsed.push(num);
    }
    return parsed;
  }

  // Start sorting process
  async function startSort() {
    const input = inputArray.value;
    const parsed = parseInput(input);
    if (!parsed || parsed.length === 0) {
      alert('Please enter a valid list of numbers separated by commas.');
      return;
    }
    array = parsed;
    clearLog();
    renderArray();
    startBtn.disabled = true;
    inputArray.disabled = true;
    speedControl.disabled = true;

    log(`Starting heap sort on array: [${array.join(', ')}]`);
    await heapSort(array);
    log(`Final sorted array: [${array.join(', ')}]`);

    startBtn.disabled = false;
    inputArray.disabled = false;
    speedControl.disabled = false;
  }

  speedControl.addEventListener('input', () => {
    speed = Number(speedControl.value);
  });

  startBtn.addEventListener('click', () => {
    startSort();
  });

  // Initial render
  array = parseInput(inputArray.value) || [];
  renderArray();
})();
</script>
<footer>
  &copy; Heap Sort Visualization Demo
</footer>
</body>
</html>