<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bubble Sort Visualizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bar-gap: 4px;
      --bar-color: #3b82f6; /* blue-500 */
      --compare-color: #f59e0b; /* amber-500 */
      --swap-color: #ef4444; /* red-500 */
      --sorted-color: #10b981; /* emerald-500 */
      --bg: #0f172a; /* slate-900 */
      --panel: #111827; /* gray-900 */
      --text: #e5e7eb; /* gray-200 */
      --muted: #9ca3af; /* gray-400 */
      --accent: #6366f1; /* indigo-500 */
      --border: #374151; /* gray-700 */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    header {
      padding: 16px;
      background: linear-gradient(90deg, #0b1221, #121a2c);
      border-bottom: 1px solid var(--border);
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      display: flex; align-items: center; gap: 10px;
    }
    header h1 .tag {
      font-size: 12px;
      padding: 2px 8px;
      border: 1px solid var(--border);
      border-radius: 100px;
      color: var(--muted);
    }
    main { padding: 16px; display: grid; gap: 16px; grid-template-columns: 1fr; }
    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.05), 0 8px 20px rgba(0,0,0,0.2) inset;
    }
    .controls { display: grid; gap: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-items: center; }
    .row label { font-size: 12px; color: var(--muted); }
    .row .value { justify-self: end; font-variant-numeric: tabular-nums; color: #cbd5e1; }
    .buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    button {
      appearance: none; border: 1px solid var(--border); background: #0b1221; color: var(--text);
      padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: 120ms ease;
    }
    button:hover { border-color: #4b5563; background: #0f172a; }
    button.primary { background: #1f2937; border-color: #475569; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .status {
      display: flex; align-items: center; gap: 8px; font-size: 14px; color: #cbd5e1;
    }
    .badge {
      padding: 2px 8px; border-radius: 999px;
      border: 1px solid var(--border);
      color: #e5e7eb; background: #0b1221;
      font-size: 12px;
    }
    .badge.idle { color: #cbd5e1; }
    .badge.running { color: #f59e0b; border-color: #8b5cf6; }
    .badge.paused { color: #93c5fd; }
    .badge.done { color: #10b981; }
    .viz {
      display: grid; gap: 12px;
      grid-template-rows: auto 1fr auto;
      min-height: 360px;
    }
    .bars {
      position: relative;
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 12px 12px 28px 12px;
      background: radial-gradient(1200px 300px at 50% 120%, rgba(99,102,241,0.06), transparent), #0b1221;
      min-height: 260px;
    }
    .bars-inner {
      position: absolute; left: 12px; right: 12px; top: 12px; bottom: 40px;
      display: flex; align-items: end; gap: var(--bar-gap);
    }
    .bar {
      flex: 1 1 0;
      background: var(--bar-color);
      border-radius: 6px 6px 0 0;
      position: relative;
      transition: height 120ms ease, transform 120ms ease, background 120ms ease, box-shadow 120ms ease;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
    }
    .bar::after {
      content: attr(data-value);
      position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%);
      font-size: 10px; color: var(--muted);
    }
    .bar.comparing { background: var(--compare-color); box-shadow: 0 0 0 2px rgba(245,158,11,0.15); }
    .bar.sorted { background: var(--sorted-color); }
    .bar.swapped { animation: flash 250ms ease; }
    @keyframes flash {
      0% { background: var(--swap-color); }
      100% { background: var(--bar-color); }
    }
    .legend { display: flex; flex-wrap: wrap; gap: 8px; font-size: 12px; color: var(--muted); }
    .legend span { display: inline-flex; align-items: center; gap: 6px; }
    .dot { width: 12px; height: 8px; border-radius: 2px; display: inline-block; }
    .dot.compare { background: var(--compare-color); }
    .dot.swap { background: var(--swap-color); }
    .dot.sorted { background: var(--sorted-color); }
    .metrics {
      display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px; margin-top: 8px;
    }
    .metric {
      background: #0b1221; border: 1px solid var(--border); border-radius: 8px; padding: 8px;
      display: grid; gap: 2px;
    }
    .metric small { color: var(--muted); }
    .metric strong { font-variant-numeric: tabular-nums; }
    .desc { color: #cbd5e1; font-size: 14px; line-height: 1.5; }
    .footer {
      color: var(--muted); font-size: 12px;
    }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body>
  <header>
    <h1>
      Bubble Sort Visualizer
      <span class="tag">Stable • In-place • O(n²)</span>
    </h1>
  </header>

  <main>
    <div class="layout">
      <section class="panel controls" aria-label="Controls">
        <div class="status" aria-live="polite">
          <span>Status:</span>
          <span class="badge idle" data-testid="status" aria-label="Status" data-state="idle">Idle</span>
        </div>

        <div class="buttons">
          <button class="primary" data-testid="generate-btn" aria-label="Generate new array">Generate</button>
          <button class="primary" data-testid="start-btn" aria-label="Start or resume sorting">Start</button>
          <button data-testid="pause-btn" aria-label="Pause sorting" disabled>Pause</button>
          <button data-testid="step-btn" aria-label="Step one operation">Step</button>
        </div>

        <div class="row">
          <label for="size">Size</label>
          <div class="value"><span data-testid="total-count">20</span></div>
        </div>
        <input id="size" type="range" min="5" max="80" value="20" step="1" data-testid="size-input" aria-label="Array size">

        <div class="row">
          <label for="speed">Speed (ms/step)</label>
          <div class="value"><span data-testid="speed-value">200</span> ms</div>
        </div>
        <input id="speed" type="range" min="20" max="1000" value="200" step="10" data-testid="speed-input" aria-label="Speed in milliseconds per step">

        <div class="metrics" role="status" aria-live="polite">
          <div class="metric">
            <small>Comparisons</small>
            <strong data-testid="comparisons">0</strong>
          </div>
          <div class="metric">
            <small>Swaps</small>
            <strong data-testid="swaps">0</strong>
          </div>
          <div class="metric">
            <small>Sorted</small>
            <strong><span data-testid="sorted-count">0</span>/<span data-testid="total-count-dup">20</span></strong>
          </div>
          <div class="metric">
            <small>Current i, j</small>
            <strong><span data-testid="i-index">-</span>, <span data-testid="j-index">-</span></strong>
          </div>
        </div>

        <div class="desc">
          Bubble sort repeatedly steps through the list, compares adjacent pairs, and swaps them if they are in the wrong order.
          After each pass, the largest remaining element “bubbles” to its correct position at the end, shrinking the unsorted region.
        </div>
        <div class="legend">
          <span><i class="dot compare"></i> Comparing</span>
          <span><i class="dot swap"></i> Swapped</span>
          <span><i class="dot sorted"></i> Sorted</span>
        </div>
        <div class="footer">
          Tip: Use Step to observe individual operations. You can change size and regenerate at any time.
        </div>
      </section>

      <section class="panel viz" aria-label="Visualization">
        <div class="bars" aria-label="Array bars">
          <div class="bars-inner" data-testid="bars"></div>
          <div class="sr-only" aria-live="polite" data-testid="sr-announce"></div>
        </div>
      </section>
    </div>
  </main>

  <script>
    (function() {
      const ui = {
        status: document.querySelector('[data-testid="status"]'),
        generateBtn: document.querySelector('[data-testid="generate-btn"]'),
        startBtn: document.querySelector('[data-testid="start-btn"]'),
        pauseBtn: document.querySelector('[data-testid="pause-btn"]'),
        stepBtn: document.querySelector('[data-testid="step-btn"]'),
        sizeInput: document.querySelector('[data-testid="size-input"]'),
        speedInput: document.querySelector('[data-testid="speed-input"]'),
        speedValue: document.querySelector('[data-testid="speed-value"]'),
        bars: document.querySelector('[data-testid="bars"]'),
        comparisons: document.querySelector('[data-testid="comparisons"]'),
        swaps: document.querySelector('[data-testid="swaps"]'),
        sortedCount: document.querySelector('[data-testid="sorted-count"]'),
        totalCount: document.querySelector('[data-testid="total-count"]'),
        totalCountDup: document.querySelector('[data-testid="total-count-dup"]'),
        iIndex: document.querySelector('[data-testid="i-index"]'),
        jIndex: document.querySelector('[data-testid="j-index"]'),
        srAnnounce: document.querySelector('[data-testid="sr-announce"]'),
      };

      const app = {
        fsmState: 'idle',
        arr: [],
        gen: null,
        timer: null,
        speed: parseInt(ui.speedInput.value, 10),
        compares: 0,
        swaps: 0,
        sorted: new Set(),
        comparing: [-1, -1],
        lastSwap: [-1, -1],
        n: parseInt(ui.sizeInput.value, 10),
      };

      function setState(next) {
        app.fsmState = next;
        const label = next[0].toUpperCase() + next.slice(1);
        ui.status.textContent = label;
        ui.status.dataset.state = next;
        ui.status.className = `badge ${next}`;
        ui.startBtn.disabled = !(next === 'idle' || next === 'paused');
        ui.pauseBtn.disabled = !(next === 'running');
        ui.stepBtn.disabled = !(next === 'idle' || next === 'paused');
        ui.generateBtn.disabled = false;
        announce(`State ${label}`);
      }

      function randomArray(n) {
        const arr = Array.from({length: n}, () => Math.floor(Math.random() * 96) + 5); // 5..100
        return arr;
      }

      function renderBars() {
        ui.bars.innerHTML = '';
        const maxVal = Math.max(100, ...app.arr);
        const frag = document.createDocumentFragment();
        app.arr.forEach((v, idx) => {
          const div = document.createElement('div');
          const pct = Math.max(2, Math.round((v / maxVal) * 100));
          div.className = 'bar';
          if (app.sorted.has(idx)) div.classList.add('sorted');
          if (idx === app.comparing[0] || idx === app.comparing[1]) div.classList.add('comparing');
          if (idx === app.lastSwap[0] || idx === app.lastSwap[1]) div.classList.add('swapped');
          div.style.height = pct + '%';
          div.setAttribute('data-value', v);
          div.setAttribute('data-testid', 'bar');
          div.setAttribute('aria-label', `Index ${idx}, value ${v}${app.sorted.has(idx) ? ', sorted' : ''}`);
          div.dataset.index = idx;
          frag.appendChild(div);
        });
        ui.bars.appendChild(frag);
        ui.sortedCount.textContent = String(app.sorted.size);
        ui.totalCount.textContent = String(app.arr.length);
        ui.totalCountDup.textContent = String(app.arr.length);
      }

      function resetStats() {
        app.compares = 0;
        app.swaps = 0;
        ui.comparisons.textContent = '0';
        ui.swaps.textContent = '0';
        app.sorted.clear();
        app.comparing = [-1, -1];
        app.lastSwap = [-1, -1];
        ui.iIndex.textContent = '-';
        ui.jIndex.textContent = '-';
      }

      function generate() {
        if (app.timer) { clearTimeout(app.timer); app.timer = null; }
        app.n = parseInt(ui.sizeInput.value, 10);
        app.arr = randomArray(app.n);
        app.gen = null;
        resetStats();
        renderBars();
        setState('idle');
      }

      function announce(msg) {
        ui.srAnnounce.textContent = msg;
      }

      function* bubbleSort(a) {
        const n = a.length;
        for (let i = 0; i < n - 1; i++) {
          let swapped = false;
          for (let j = 0; j < n - i - 1; j++) {
            yield { type: 'compare', i: j, j: j + 1 };
            if (a[j] > a[j + 1]) {
              yield { type: 'swap', i: j, j: j + 1 };
              const tmp = a[j];
              a[j] = a[j + 1];
              a[j + 1] = tmp;
              swapped = true;
            }
          }
          yield { type: 'markSorted', idx: n - i - 1 };
          if (!swapped) {
            for (let k = 0; k < n - i - 1; k++) {
              if (!app.sorted.has(k)) yield { type: 'markSorted', idx: k };
            }
            return;
          }
        }
        yield { type: 'markSorted', idx: 0 };
      }

      function applyOp(op) {
        if (!op) return;
        switch (op.type) {
          case 'compare':
            app.compares++;
            ui.comparisons.textContent = String(app.compares);
            app.comparing = [op.i, op.j];
            ui.iIndex.textContent = String(op.i);
            ui.jIndex.textContent = String(op.j);
            announce(`Compare indices ${op.i} and ${op.j}`);
            break;
          case 'swap':
            app.swaps++;
            ui.swaps.textContent = String(app.swaps);
            app.lastSwap = [op.i, op.j];
            announce(`Swap indices ${op.i} and ${op.j}`);
            break;
          case 'markSorted':
            app.sorted.add(op.idx);
            announce(`Index ${op.idx} is in final position`);
            break;
        }
        renderBars();
      }

      function finishIfDone(done) {
        if (done) {
          // Ensure all indices marked as sorted
          for (let i = 0; i < app.arr.length; i++) app.sorted.add(i);
          renderBars();
          setState('done');
          return true;
        }
        return false;
      }

      function stepOnce() {
        if (!app.gen) app.gen = bubbleSort(app.arr);
        const res = app.gen.next();
        if (finishIfDone(res.done)) return;
        applyOp(res.value);
      }

      function loop() {
        if (app.fsmState !== 'running') return;
        stepOnce();
        app.timer = setTimeout(loop, app.speed);
      }

      // Wire up UI
      ui.generateBtn.addEventListener('click', () => {
        generate();
      });

      ui.startBtn.addEventListener('click', () => {
        if (app.fsmState === 'idle' && !app.gen) {
          app.gen = bubbleSort(app.arr);
        }
        if (app.fsmState === 'done') return;
        setState('running');
        if (app.timer) clearTimeout(app.timer);
        loop();
      });

      ui.pauseBtn.addEventListener('click', () => {
        if (app.timer) { clearTimeout(app.timer); app.timer = null; }
        if (app.fsmState === 'running') setState('paused');
      });

      ui.stepBtn.addEventListener('click', () => {
        const prev = app.fsmState;
        stepOnce();
        if (app.fsmState !== 'done') setState('paused');
        if (prev === 'running' && app.timer) { clearTimeout(app.timer); app.timer = null; }
      });

      ui.sizeInput.addEventListener('input', () => {
        const n = parseInt(ui.sizeInput.value, 10);
        ui.totalCount.textContent = String(n);
        ui.totalCountDup.textContent = String(n);
      });
      ui.sizeInput.addEventListener('change', () => {
        generate();
      });

      ui.speedInput.addEventListener('input', () => {
        app.speed = parseInt(ui.speedInput.value, 10);
        ui.speedValue.textContent = String(app.speed);
      });

      // Init
      generate();
    })();
  </script>

  <script id="fsm" type="application/json">
{
  "concept": "bubble sort",
  "machine": {
    "id": "bubbleSortUI",
    "initial": "idle",
    "states": {
      "idle": {
        "on": {
          "START": "running",
          "STEP": "paused",
          "GENERATE": "idle"
        },
        "meta": { "statusText": "Idle" }
      },
      "running": {
        "on": {
          "PAUSE": "paused",
          "FINISH": "done",
          "GENERATE": "idle"
        },
        "meta": { "statusText": "Running" }
      },
      "paused": {
        "on": {
          "START": "running",
          "STEP": "paused",
          "FINISH": "done",
          "GENERATE": "idle"
        },
        "meta": { "statusText": "Paused" }
      },
      "done": {
        "on": {
          "GENERATE": "idle"
        },
        "meta": { "statusText": "Done" }
      }
    }
  },
  "playwright": {
    "selectors": {
      "start": "[data-testid=\"start-btn\"]",
      "pause": "[data-testid=\"pause-btn\"]",
      "step": "[data-testid=\"step-btn\"]",
      "generate": "[data-testid=\"generate-btn\"]",
      "status": "[data-testid=\"status\"]",
      "bars": "[data-testid=\"bars\"]",
      "bar": "[data-testid=\"bars\"] [data-testid=\"bar\"]",
      "sortedCount": "[data-testid=\"sorted-count\"]",
      "totalCount": "[data-testid=\"total-count\"]",
      "totalCountDup": "[data-testid=\"total-count-dup\"]",
      "comparisons": "[data-testid=\"comparisons\"]",
      "swaps": "[data-testid=\"swaps\"]"
    },
    "events": {
      "GENERATE": { "type": "click", "selector": "[data-testid=\"generate-btn\"]" },
      "START": { "type": "click", "selector": "[data-testid=\"start-btn\"]" },
      "PAUSE": { "type": "click", "selector": "[data-testid=\"pause-btn\"]" },
      "STEP": { "type": "click", "selector": "[data-testid=\"step-btn\"]" }
    },
    "assertions": {
      "idle": [
        { "type": "hasAttribute", "selector": "[data-testid=\"status\"]", "name": "data-state", "value": "idle" },
        { "type": "textEquals", "selector": "[data-testid=\"status\"]", "value": "Idle" }
      ],
      "running": [
        { "type": "hasAttribute", "selector": "[data-testid=\"status\"]", "name": "data-state", "value": "running" },
        { "type": "textEquals", "selector": "[data-testid=\"status\"]", "value": "Running" }
      ],
      "paused": [
        { "type": "hasAttribute", "selector": "[data-testid=\"status\"]", "name": "data-state", "value": "paused" },
        { "type": "textEquals", "selector": "[data-testid=\"status\"]", "value": "Paused" }
      ],
      "done": [
        { "type": "hasAttribute", "selector": "[data-testid=\"status\"]", "name": "data-state", "value": "done" },
        { "type": "textEquals", "selector": "[data-testid=\"status\"]", "value": "Done" },
        { "type": "textEqualsSelector", "selectorA": "[data-testid=\"sorted-count\"]", "selectorB": "[data-testid=\"total-count-dup\"]" }
      ]
    },
    "scenarios": [
      {
        "name": "generate_and_sort_to_completion",
        "steps": [
          { "event": "GENERATE" },
          { "expect": "idle" },
          { "event": "START" },
          { "expect": "running" },
          { "waitForState": "done" },
          { "expect": "done" }
        ]
      },
      {
        "name": "step_then_pause_then_resume",
        "steps": [
          { "event": "GENERATE" },
          { "event": "STEP" },
          { "expect": "paused" },
          { "event": "START" },
          { "expect": "running" },
          { "event": "PAUSE" },
          { "expect": "paused" }
        ]
      }
    ]
  }
}
  </script>
</body>
</html>