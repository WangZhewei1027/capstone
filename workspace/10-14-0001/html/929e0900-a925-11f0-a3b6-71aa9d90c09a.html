<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bubble Sort — Interactive Modules</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --safe:24px;
      --gap:16px;
      --radius:12px;
      --bg:#0f172a;
      --panel:#111827;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --accent:#60a5fa;
      --accent-2:#f59e0b;
      --good:#10b981;
      --bad:#ef4444;
      --warn:#f59e0b;
      --grid:#1f2937;
      --chip:#1f2937;
      --card-border:#1f2937;
      --focus:#8b5cf6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .app{
      padding:var(--safe);
      max-width:1200px;
      margin:0 auto;
    }
    header{
      margin-bottom:24px;
    }
    h1{
      font-size:28px;
      line-height:1.2;
      margin:0 0 8px 0;
    }
    .subtitle{
      color:var(--muted);
      font-size:14px;
      margin-bottom:8px;
    }
    .note{
      color:var(--muted);
      font-size:13px;
    }
    .module{
      background:var(--panel);
      border:1px solid var(--card-border);
      border-radius:var(--radius);
      padding:24px;
      margin-bottom:24px;
      box-shadow:0 0 0 1px rgba(255,255,255,0.02) inset, 0 6px 24px rgba(0,0,0,0.2);
    }
    .module h2{
      font-size:20px;
      margin:0 0 8px 0;
    }
    .meta{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border:1px dashed #243244;
      border-radius:10px;
      padding:16px;
      margin-bottom:16px;
    }
    .meta .row{
      margin-bottom:10px;
    }
    .meta .row:last-child{margin-bottom:0}
    .meta b{
      display:inline-block;
      min-width:160px;
      color:#cbd5e1;
    }
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:var(--gap);
      align-items:flex-end;
      margin:16px 0;
    }
    .control{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:180px;
    }
    .control.inline{
      min-width:auto;
    }
    label{
      font-size:13px;
      color:#cbd5e1;
    }
    input[type="range"]{
      width:220px;
      accent-color:var(--accent);
    }
    input[type="number"], select{
      background:#0b1220;
      border:1px solid #202b3c;
      color:var(--ink);
      padding:10px 12px;
      border-radius:10px;
      min-width:120px;
      outline:none;
    }
    button{
      background:linear-gradient(180deg, #1e293b, #0f172a);
      border:1px solid #1f2a3c;
      color:var(--ink);
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      transition:transform .08s ease, background .2s ease, border-color .2s ease;
      min-width:120px;
    }
    button:hover{transform:translateY(-1px)}
    button:active{transform:translateY(0)}
    button[disabled]{
      opacity:.5;
      cursor:not-allowed;
      transform:none;
    }
    .btn-accent{
      background:linear-gradient(180deg, #2563eb, #1d4ed8);
      border-color:#1e40af;
    }
    .btn-ghost{
      background:transparent;
      border-color:#253246;
    }
    .btn-warn{
      background:linear-gradient(180deg, #f59e0b, #d97706);
      border-color:#b45309;
      color:#0b1220;
    }
    .btn-bad{
      background:linear-gradient(180deg, #ef4444, #dc2626);
      border-color:#991b1b;
    }
    .btn-good{
      background:linear-gradient(180deg, #10b981, #059669);
      border-color:#065f46;
      color:#072113;
    }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:var(--gap);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding:6px 10px;
      background:var(--chip);
      border:1px solid #243244;
      font-size:12px;
      color:#cbd5e1;
    }
    .stat{
      background:#0b1220;
      border:1px solid #202b3c;
      border-radius:10px;
      padding:10px 12px;
      min-width:140px;
    }
    .stat .v{
      font-weight:700;
      font-size:18px;
    }
    .vis{
      width:100%;
      background:#0b1220;
      border:1px solid #202b3c;
      border-radius:12px;
      padding:12px;
      overflow:hidden;
    }
    svg{
      display:block;
      width:100%;
      height:240px;
      background:
        linear-gradient(0deg, rgba(255,255,255,0.02), transparent),
        repeating-linear-gradient(0deg, transparent, transparent 24px, rgba(255,255,255,0.03) 24px, rgba(255,255,255,0.03) 25px);
      border-radius:8px;
    }
    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
      color:#cbd5e1;
      font-size:12px;
    }
    .legend .key{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-right:8px;
    }
    .dot{
      width:12px;height:12px;border-radius:3px;display:inline-block;border:1px solid rgba(255,255,255,0.2);
    }
    .k-compare{background:linear-gradient(180deg, #f59e0b, #d97706)}
    .k-swap{background:linear-gradient(180deg, #ef4444, #dc2626)}
    .k-sorted{background:linear-gradient(180deg, #10b981, #059669)}
    .k-normal{background:linear-gradient(180deg, #60a5fa, #3b82f6)}
    .aria-live{
      position:relative;
      margin-top:8px;
      color:#cbd5e1;
      font-size:13px;
    }
    .gbar{transition:transform .28s ease}
    .bar{rx:4; ry:4; fill:url(#gradBar); stroke:#1b2840; stroke-width:1}
    .bar-label{font-size:10px; fill:#d1d5db; text-anchor:middle}
    .bar-tag{font-size:12px; fill:#94a3b8; text-anchor:middle}
    .bar.compare{filter:drop-shadow(0 0 8px rgba(245,158,11,.6))}
    .bar.swap{filter:drop-shadow(0 0 8px rgba(239,68,68,.6))}
    .bar.sorted{filter:drop-shadow(0 0 6px rgba(16,185,129,.6))}
    .ptr{
      fill:none; stroke:#8b5cf6; stroke-width:2; stroke-dasharray:6 6
    }
    .ptr-tip{
      fill:#8b5cf6;
    }
    .hl{
      background:rgba(139,92,246,0.12);
      border:1px solid rgba(139,92,246,0.3);
      padding:8px 10px;
      border-radius:8px;
      font-size:13px;
      color:#d1d5db;
    }
    .timeline{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;
    }
    .tick{
      height:10px; width:14px; border-radius:4px; background:#122;
      border:1px solid #223147;
    }
    .tick.on{background:#10b981}
    .chart{
      width:100%; height:260px; background:#0b1220; border:1px solid #202b3c; border-radius:12px; padding:8px;
    }
    canvas{width:100%; height:240px; display:block; background:
      linear-gradient(0deg, rgba(255,255,255,0.02), transparent),
      repeating-linear-gradient(0deg, transparent, transparent 24px, rgba(255,255,255,0.03) 24px, rgba(255,255,255,0.03) 25px);
      border-radius:8px;
    }
    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:var(--gap);
    }
    @media (max-width: 900px){
      .grid-2{grid-template-columns:1fr}
      input[type="range"]{width:160px}
    }
    .sr-only{
      position:absolute !important;
      width:1px;height:1px;
      margin:-1px; border:0; padding:0;
      white-space:nowrap; clip-path:inset(100%); clip:rect(0 0 0 0); overflow:hidden;
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Bubble Sort Interactive Modules">
    <header>
      <h1>Bubble Sort — Hands‑on Exploration</h1>
      <div class="subtitle">Progressive, interactive modules that build intuition from adjacent comparisons to full algorithm behavior, stability, and complexity.</div>
      <div class="note">Spatial constraints: all content is contained within a 24 px safe area on all sides. A minimum of 16 px spacing is enforced between interactive elements to prevent overlap or accidental taps.</div>
    </header>

    <section class="module" id="m1">
      <h2>1. Compare & Swap</h2>
      <div class="meta" aria-label="Module overview">
        <div class="row">
          <div class="hl">Module Title: Compare & Swap</div>
        </div>
        <div class="row">
          <b>Module Purpose:</b>
          <div>Understand the fundamental operation of Bubble Sort: comparing adjacent elements and swapping when out of order. This initializes the shared array used by subsequent modules.</div>
        </div>
        <div class="row">
          <b>Module Description:</b>
          <div>Generate an array, then select an adjacent pair. Click Compare to highlight the pair. If out of order, the interface prompts a Swap, animating the exchange and updating counters. This tactile compare-then-swap loop underpins the full algorithm.</div>
        </div>
        <div class="row">
          <b>Module Layout:</b>
          <div>
            Controls appear above a responsive SVG bar visualization. Controls are grouped in rows with at least 16 px gaps between inputs and buttons. The entire module sits within the 24 px safe area margins. On small screens, controls wrap to new lines to maintain spacing. Interactive elements (buttons, sliders, selectors) maintain a minimum of 16 px separation.
          </div>
        </div>
      </div>

      <div class="controls" aria-label="Array setup and comparison controls">
        <div class="control">
          <label for="m1-size">Array size</label>
          <input type="range" id="m1-size" min="5" max="20" value="10" />
        </div>
        <div class="control">
          <label for="m1-dist">Preset</label>
          <select id="m1-dist">
            <option value="random">Random</option>
            <option value="reversed">Reversed</option>
            <option value="sorted">Already sorted</option>
            <option value="nearly">Nearly sorted</option>
          </select>
        </div>
        <div class="control inline">
          <button id="m1-generate" class="btn-accent" aria-label="Generate array">Generate</button>
        </div>
        <div class="control">
          <label for="m1-pair">Pair start index (j)</label>
          <input type="range" id="m1-pair" min="0" max="8" value="0" />
        </div>
        <div class="control inline">
          <button id="m1-compare" class="btn-ghost" aria-label="Compare selected pair">Compare</button>
        </div>
        <div class="control inline">
          <button id="m1-swap" class="btn-bad" aria-label="Swap selected pair if out of order" disabled>Swap</button>
        </div>
        <div class="control inline">
          <button id="m1-broadcast" class="btn-good" aria-label="Share this array with subsequent modules">Share Array →</button>
        </div>
      </div>

      <div class="row" style="margin-bottom:var(--gap)">
        <div class="stat"><div>Comparisons</div><div class="v" id="m1-cmp">0</div></div>
        <div class="stat"><div>Swaps</div><div class="v" id="m1-swp">0</div></div>
      </div>

      <div class="vis">
        <svg id="m1-svg" viewBox="0 0 1000 240" preserveAspectRatio="none" aria-label="Array bars visualization">
          <defs>
            <linearGradient id="gradBar" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0" stop-color="#60a5fa"/>
              <stop offset="1" stop-color="#3b82f6"/>
            </linearGradient>
          </defs>
        </svg>
        <div class="legend" aria-hidden="true">
          <div class="key"><span class="dot k-normal"></span> normal</div>
          <div class="key"><span class="dot k-compare"></span> compare</div>
          <div class="key"><span class="dot k-swap"></span> swap</div>
        </div>
        <div class="aria-live" id="m1-live" aria-live="polite"></div>
      </div>
    </section>

    <section class="module" id="m2">
      <h2>2. One Pass Sweep</h2>
      <div class="meta" aria-label="Module overview">
        <div class="row">
          <div class="hl">Module Title: One Pass Sweep</div>
        </div>
        <div class="row">
          <b>Module Purpose:</b>
          <div>Experience how a single pass bubbles the largest remaining element to the end. Builds directly on the compare-and-swap primitive.</div>
        </div>
        <div class="row">
          <b>Module Description:</b>
          <div>Step through or play a left-to-right sweep comparing adjacent pairs. Swaps occur automatically when needed. The final element of the pass is marked sorted.</div>
        </div>
        <div class="row">
          <b>Module Layout:</b>
          <div>Controls are placed above the SVG timeline and bar visualization, maintaining at least 16 px spacing between each interactive item. The module respects the 24 px safe area. On narrow screens, controls wrap without overlap.</div>
        </div>
      </div>

      <div class="controls" aria-label="Single pass controls">
        <div class="control">
          <label for="m2-speed">Animation speed (ms)</label>
          <input type="range" id="m2-speed" min="80" max="800" value="280" />
        </div>
        <div class="control inline">
          <button id="m2-use-shared" class="btn-ghost">Use Shared Array</button>
        </div>
        <div class="control inline">
          <button id="m2-step" class="btn-accent">Step</button>
        </div>
        <div class="control inline">
          <button id="m2-play" class="btn-accent">Play Pass</button>
        </div>
        <div class="control inline">
          <button id="m2-reset" class="btn-ghost">Reset Pass</button>
        </div>
      </div>

      <div class="row" style="margin-bottom:var(--gap)">
        <div class="stat"><div>j index</div><div class="v" id="m2-j">0</div></div>
        <div class="stat"><div>Comparisons</div><div class="v" id="m2-cmp">0</div></div>
        <div class="stat"><div>Swaps</div><div class="v" id="m2-swp">0</div></div>
      </div>

      <div class="vis">
        <svg id="m2-svg" viewBox="0 0 1000 240" preserveAspectRatio="none" aria-label="One pass visualization"></svg>
        <div class="legend" aria-hidden="true">
          <div class="key"><span class="dot k-compare"></span> current pair (j, j+1)</div>
          <div class="key"><span class="dot k-swap"></span> swapping</div>
          <div class="key"><span class="dot k-sorted"></span> bubbled element</div>
        </div>
        <div class="aria-live" id="m2-live" aria-live="polite"></div>
      </div>
    </section>

    <section class="module" id="m3">
      <h2>3. Full Algorithm Explorer</h2>
      <div class="meta" aria-label="Module overview">
        <div class="row">
          <div class="hl">Module Title: Full Algorithm Explorer</div>
        </div>
        <div class="row">
          <b>Module Purpose:</b>
          <div>Run Bubble Sort end-to-end with step and play controls. Observe passes, counters, and the shrinking unsorted window.</div>
        </div>
        <div class="row">
          <b>Module Description:</b>
          <div>Control the sorting process: step through individual comparisons or play continuously. After each pass, the rightmost segment is marked sorted. Counters update in real time.</div>
        </div>
        <div class="row">
          <b>Module Layout:</b>
          <div>Controls are arranged above the visualization with 16 px spacing; indicators are grouped as stats. All content remains within the 24 px safe area. The visualization scales to available width.</div>
        </div>
      </div>

      <div class="controls" aria-label="Full sort controls">
        <div class="control">
          <label for="m3-speed">Animation speed (ms)</label>
          <input type="range" id="m3-speed" min="60" max="800" value="220" />
        </div>
        <div class="control inline">
          <button id="m3-use-shared" class="btn-ghost">Use Shared Array</button>
        </div>
        <div class="control inline">
          <button id="m3-step" class="btn-accent">Step</button>
        </div>
        <div class="control inline">
          <button id="m3-play" class="btn-accent">Play</button>
        </div>
        <div class="control inline">
          <button id="m3-pause" class="btn-ghost" disabled>Pause</button>
        </div>
        <div class="control inline">
          <button id="m3-reset" class="btn-ghost">Reset</button>
        </div>
      </div>

      <div class="row" style="margin-bottom:var(--gap)">
        <div class="stat"><div>Pass</div><div class="v" id="m3-pass">1</div></div>
        <div class="stat"><div>j index</div><div class="v" id="m3-j">0</div></div>
        <div class="stat"><div>Comparisons</div><div class="v" id="m3-cmp">0</div></div>
        <div class="stat"><div>Swaps</div><div class="v" id="m3-swp">0</div></div>
      </div>

      <div class="vis">
        <svg id="m3-svg" viewBox="0 0 1000 240" preserveAspectRatio="none" aria-label="Full sort visualization"></svg>
        <div class="legend" aria-hidden="true">
          <div class="key"><span class="dot k-compare"></span> comparing</div>
          <div class="key"><span class="dot k-swap"></span> swapping</div>
          <div class="key"><span class="dot k-sorted"></span> sorted region</div>
        </div>
        <div class="aria-live" id="m3-live" aria-live="polite"></div>
      </div>
    </section>

    <section class="module" id="m4">
      <h2>4. Early Exit Optimization</h2>
      <div class="meta" aria-label="Module overview">
        <div class="row">
          <div class="hl">Module Title: Early Exit Optimization</div>
        </div>
        <div class="row">
          <b>Module Purpose:</b>
          <div>See how tracking swaps per pass allows Bubble Sort to stop early when the array is already sorted, improving best-case complexity.</div>
        </div>
        <div class="row">
          <b>Module Description:</b>
          <div>Toggle early exit on/off, pick a preset (e.g., Already sorted or Nearly sorted), then run. The run stops immediately after a pass with no swaps if early exit is enabled.</div>
        </div>
        <div class="row">
          <b>Module Layout:</b>
          <div>Two-column layout on wide screens: controls and stats on the left, visualization on the right; stacked on narrow screens. Controls maintain 16 px spacing; all content sits within 24 px margins.</div>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <div class="controls" aria-label="Early exit controls">
            <div class="control">
              <label for="m4-speed">Animation speed (ms)</label>
              <input type="range" id="m4-speed" min="60" max="800" value="220" />
            </div>
            <div class="control">
              <label for="m4-early">Early exit</label>
              <select id="m4-early">
                <option value="on">On</option>
                <option value="off">Off</option>
              </select>
            </div>
            <div class="control">
              <label for="m4-preset">Preset</label>
              <select id="m4-preset">
                <option value="shared">Use Shared Array</option>
                <option value="sorted">Already sorted</option>
                <option value="nearly">Nearly sorted</option>
                <option value="reversed">Reversed</option>
                <option value="random">Random</option>
              </select>
            </div>
            <div class="control inline">
              <button id="m4-run" class="btn-accent">Run</button>
            </div>
            <div class="control inline">
              <button id="m4-reset" class="btn-ghost">Reset</button>
            </div>
          </div>

          <div class="row">
            <div class="stat"><div>Passes</div><div class="v" id="m4-pass">0</div></div>
            <div class="stat"><div>Comparisons</div><div class="v" id="m4-cmp">0</div></div>
            <div class="stat"><div>Swaps</div><div class="v" id="m4-swp">0</div></div>
            <div class="stat"><div>Early exit</div><div class="v" id="m4-exit">—</div></div>
          </div>
          <div class="timeline" id="m4-timeline" aria-label="Pass activity timeline"></div>
          <div class="aria-live" id="m4-live" aria-live="polite"></div>
        </div>
        <div>
          <div class="vis">
            <svg id="m4-svg" viewBox="0 0 1000 240" preserveAspectRatio="none" aria-label="Early exit visualization"></svg>
            <div class="legend" aria-hidden="true">
              <div class="key"><span class="dot k-sorted"></span> sorted region</div>
              <div class="key"><span class="dot k-compare"></span> comparing</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="module" id="m5">
      <h2>5. Stability with Duplicates</h2>
      <div class="meta" aria-label="Module overview">
        <div class="row">
          <div class="hl">Module Title: Stability with Duplicates</div>
        </div>
        <div class="row">
          <b>Module Purpose:</b>
          <div>Visualize Bubble Sort’s stability: equal-valued items preserve their original relative order when the algorithm only swaps on greater-than.</div>
        </div>
        <div class="row">
          <b>Module Description:</b>
          <div>Generate pairs of equal values marked with tags (A1, A2, …). Run the stable version (swap only if left > right) and an unstable variant (swap if left ≥ right) to compare outcomes.</div>
        </div>
        <div class="row">
          <b>Module Layout:</b>
          <div>Two runs side-by-side on wide screens: left shows stable behavior, right shows unstable. On small screens, they stack. Controls maintain a minimum of 16 px spacing. Everything remains within 24 px margins.</div>
        </div>
      </div>

      <div class="controls" aria-label="Stability controls">
        <div class="control">
          <label for="m5-pairs">Duplicate pairs</label>
          <input type="range" id="m5-pairs" min="2" max="6" value="3" />
        </div>
        <div class="control inline">
          <button id="m5-generate" class="btn-accent">Generate Duplicates</button>
        </div>
        <div class="control inline">
          <button id="m5-run" class="btn-accent">Run Both</button>
        </div>
        <div class="control inline">
          <button id="m5-reset" class="btn-ghost">Reset</button>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <div class="badge">Stable (swap if > only)</div>
          <div class="vis">
            <svg id="m5-stable" viewBox="0 0 1000 240" preserveAspectRatio="none" aria-label="Stable sort visualization"></svg>
            <div class="aria-live" id="m5-live-stable" aria-live="polite"></div>
          </div>
        </div>
        <div>
          <div class="badge">Unstable variant (swap if ≥)</div>
          <div class="vis">
            <svg id="m5-unstable" viewBox="0 0 1000 240" preserveAspectRatio="none" aria-label="Unstable variant visualization"></svg>
            <div class="aria-live" id="m5-live-unstable" aria-live="polite"></div>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:var(--gap)">
        <div class="stat"><div>Stable preserved?</div><div class="v" id="m5-stable-ok">—</div></div>
        <div class="stat"><div>Unstable changed?</div><div class="v" id="m5-unstable-change">—</div></div>
      </div>
    </section>

    <section class="module" id="m6">
      <h2>6. Complexity Explorer</h2>
      <div class="meta" aria-label="Module overview">
        <div class="row">
          <div class="hl">Module Title: Complexity Explorer</div>
        </div>
        <div class="row">
          <b>Module Purpose:</b>
          <div>Relate hands-on observations to time complexity. Contrast best/worst/average cases and the effect of early exit.</div>
        </div>
        <div class="row">
          <b>Module Description:</b>
          <div>Adjust N to see how comparison and swap counts grow. Without early exit, comparisons are always N(N−1)/2. With early exit, best-case comparisons drop to N−1.</div>
        </div>
        <div class="row">
          <b>Module Layout:</b>
          <div>Controls sit above a responsive canvas line chart. Spacing between inputs is 16 px or more. All elements are contained within the 24 px safe area.</div>
        </div>
      </div>

      <div class="controls" aria-label="Complexity controls">
        <div class="control">
          <label for="m6-n">N (array size)</label>
          <input type="range" id="m6-n" min="3" max="80" value="20" />
        </div>
        <div class="control">
          <label for="m6-exit-mode">Show best-case (early exit)</label>
          <select id="m6-exit-mode">
            <option value="with">With early exit best-case</option>
            <option value="without">Without early exit</option>
            <option value="both">Compare both</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-bottom:var(--gap)">
        <div class="stat"><div>Worst comps</div><div class="v" id="m6-worst-c">—</div></div>
        <div class="stat"><div>Best comps</div><div class="v" id="m6-best-c">—</div></div>
        <div class="stat"><div>Avg swaps (≈)</div><div class="v" id="m6-avg-s">—</div></div>
      </div>

      <div class="chart">
        <canvas id="m6-canvas" width="1000" height="240" aria-label="Complexity line chart"></canvas>
      </div>
    </section>

    <footer class="note" style="margin-top:24px">
      Interaction guidance: All modules maintain minimum 16 px spacing between interactive elements and stay inside a 24 px safe area margin. Visualizations are dynamic, responsive, and keyboard-operable via buttons and sliders.
    </footer>
  </div>

  <script>
    (function(){
      const clamp = (n, a, b)=> Math.max(a, Math.min(b, n));
      const randInt = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;
      const copy = x => JSON.parse(JSON.stringify(x));
      const uid = (()=>{let i=0; return ()=>++i})();
      const dispatch = (name, detail)=> document.dispatchEvent(new CustomEvent(name, {detail}));

      function genArray(n, preset='random'){
        const arr = Array.from({length:n}, (_,i)=>({ id: uid(), value: randInt(10, 99), tag: null, baseIndex: i }));
        if(preset==='sorted'){
          arr.sort((a,b)=>a.value-b.value);
        }else if(preset==='reversed'){
          arr.sort((a,b)=>b.value-a.value);
        }else if(preset==='nearly'){
          arr.sort((a,b)=>a.value-b.value);
          // introduce a few local inversions
          for(let k=0;k<Math.max(1, Math.floor(n/6));k++){
            const i = randInt(0, n-2);
            [arr[i], arr[i+1]] = [arr[i+1], arr[i]];
          }
        }
        // reset baseIndex to record initial order for stability checks
        arr.forEach((x, i)=> x.baseIndex = i);
        return arr;
      }

      // Shared array state (originated in Module 1)
      let sharedArray = genArray(10, 'random');

      // Generic bar renderer for SVG
      function BarViz(svg){
        const api = {};
        let data = [];
        let sortedRight = 0;
        let comparePair = null; // [i, j]
        let labels = false;
        let showTags = false;

        function clearSVG(){
          while(svg.firstChild) svg.removeChild(svg.firstChild);
          const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
          const lg = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
          lg.setAttribute("id","gradBar");
          lg.setAttribute("x1","0"); lg.setAttribute("y1","0"); lg.setAttribute("x2","0"); lg.setAttribute("y2","1");
          const s1 = document.createElementNS("http://www.w3.org/2000/svg", "stop"); s1.setAttribute("offset","0"); s1.setAttribute("stop-color", "#60a5fa");
          const s2 = document.createElementNS("http://www.w3.org/2000/svg", "stop"); s2.setAttribute("offset","1"); s2.setAttribute("stop-color", "#3b82f6");
          lg.appendChild(s1); lg.appendChild(s2); defs.appendChild(lg);
          svg.appendChild(defs);
        }

        function layout(){
          const W = 1000, H = 240, P = 16, base = 220;
          const n = data.length;
          const gap = Math.max(4, 1000/(n*8));
          const barW = (W - 2*P - (n-1)*gap)/n;
          const maxV = Math.max(...data.map(d=>d.value), 1);
          const scale = (v)=> (v/maxV)*180 + 12;
          return {W,H,P,base,barW,gap,scale};
        }

        function render(){
          clearSVG();
          const {W,H,P,base,barW,gap,scale} = layout();
          const gRoot = document.createElementNS("http://www.w3.org/2000/svg","g");
          gRoot.setAttribute("transform", `translate(${P},0)`);
          svg.appendChild(gRoot);

          data.forEach((d, i)=>{
            const g = document.createElementNS("http://www.w3.org/2000/svg","g");
            g.classList.add("gbar");
            g.dataset.id = d.id;
            const x = i*(barW+gap);
            const h = scale(d.value);
            g.setAttribute("transform", `translate(${x}, ${base-h})`);

            const r = document.createElementNS("http://www.w3.org/2000/svg","rect");
            r.setAttribute("class", "bar");
            r.setAttribute("width", barW);
            r.setAttribute("height", h);
            r.setAttribute("rx","4"); r.setAttribute("ry","4");

            if (sortedRight && i >= data.length - sortedRight) r.classList.add("sorted");

            const text = document.createElementNS("http://www.w3.org/2000/svg","text");
            text.setAttribute("x", barW/2);
            text.setAttribute("y", h-8);
            text.setAttribute("class","bar-label");
            text.textContent = d.value;

            g.appendChild(r);
            g.appendChild(text);

            if(showTags && d.tag){
              const tag = document.createElementNS("http://www.w3.org/2000/svg","text");
              tag.setAttribute("x", barW/2);
              tag.setAttribute("y", h+14);
              tag.setAttribute("class","bar-tag");
              tag.textContent = d.tag;
              g.appendChild(tag);
            }

            gRoot.appendChild(g);
          });
        }

        function updatePositions(hl = {}){
          const {P,base,barW,gap,scale} = layout();
          const groups = [...svg.querySelectorAll(".gbar")];
          groups.forEach((g, i)=>{
            const d = data[i];
            const x = i*(barW+gap);
            const h = scale(d.value);
            g.style.transform = `translate(${P + x}px, ${base-h}px)`;
            const rect = g.querySelector("rect");
            rect.classList.remove("compare","swap","sorted");
            if(hl.compare && hl.compare.has(i)) rect.classList.add("compare");
            if(hl.swap && hl.swap.has(i)) rect.classList.add("swap");
            if(sortedRight && i >= data.length - sortedRight) rect.classList.add("sorted");
            const lbl = g.querySelector(".bar-label");
            lbl.setAttribute("y", h-8);
            lbl.textContent = d.value;
            const tag = g.querySelector(".bar-tag");
            if(tag){ tag.setAttribute("y", h+14); tag.textContent = d.tag || ""; }
          });
        }

        function setData(arr, opts={}){
          data = copy(arr);
          sortedRight = 0;
          showTags = !!opts.showTags;
          render();
        }

        function setSortedRight(k){
          sortedRight = k;
          updatePositions();
        }

        function swap(i, j){
          [data[i], data[j]] = [data[j], data[i]];
          updatePositions({swap:new Set([i,j])});
        }

        function highlight(i, j, kind='compare'){
          const s = {}; s[kind] = new Set([i,j]);
          updatePositions(s);
        }

        function clearHighlight(){
          updatePositions();
        }

        function getData(){ return data; }

        api.setData = setData;
        api.getData = getData;
        api.setSortedRight = setSortedRight;
        api.swap = swap;
        api.highlight = highlight;
        api.clearHighlight = clearHighlight;
        api.update = ()=> updatePositions();
        api.enableTags = (flag)=> { showTags = !!flag; render(); };
        return api;
      }

      // Module 1: Compare & Swap
      const m1 = (function(){
        const svg = document.getElementById("m1-svg");
        const viz = BarViz(svg);
        const sz = document.getElementById("m1-size");
        const dist = document.getElementById("m1-dist");
        const generate = document.getElementById("m1-generate");
        const pair = document.getElementById("m1-pair");
        const btnCompare = document.getElementById("m1-compare");
        const btnSwap = document.getElementById("m1-swap");
        const btnShare = document.getElementById("m1-broadcast");
        const live = document.getElementById("m1-live");
        const cmpEl = document.getElementById("m1-cmp");
        const swpEl = document.getElementById("m1-swp");

        let arr = copy(sharedArray);
        let comparisons = 0, swaps = 0;
        let lastCompareOutOfOrder = false;

        function updatePairRange(){
          pair.max = Math.max(0, arr.length - 2);
          pair.value = Math.min(pair.value, pair.max);
        }
        function render(){
          viz.setData(arr);
          viz.update();
          updatePairRange();
          cmpEl.textContent = comparisons;
          swpEl.textContent = swaps;
        }
        function announce(msg){
          live.textContent = msg;
        }
        function regen(){
          arr = genArray(+sz.value, dist.value);
          comparisons = 0; swaps = 0;
          lastCompareOutOfOrder = false;
          btnSwap.disabled = true;
          render();
          announce("New array generated.");
        }
        function compare(){
          const j = +pair.value;
          const a = arr[j], b = arr[j+1];
          viz.highlight(j, j+1, 'compare');
          comparisons++;
          cmpEl.textContent = comparisons;
          if(a.value > b.value){
            lastCompareOutOfOrder = true;
            btnSwap.disabled = false;
            announce(`Out of order: ${a.value} > ${b.value}. Swap suggested.`);
          }else{
            lastCompareOutOfOrder = false;
            btnSwap.disabled = true;
            announce(`In order: ${a.value} ≤ ${b.value}. No swap needed.`);
          }
        }
        function doSwap(){
          const j = +pair.value;
          [arr[j], arr[j+1]] = [arr[j+1], arr[j]];
          viz.swap(j, j+1);
          swaps++;
          swpEl.textContent = swaps;
          btnSwap.disabled = true;
          announce(`Swapped positions ${j} and ${j+1}.`);
          setTimeout(()=>viz.clearHighlight(), 300);
        }

        generate.addEventListener("click", regen);
        btnCompare.addEventListener("click", compare);
        btnSwap.addEventListener("click", doSwap);
        sz.addEventListener("input", regen);
        dist.addEventListener("change", regen);
        btnShare.addEventListener("click", ()=>{
          sharedArray = copy(arr);
          dispatch("baseArrayChanged", { array: copy(sharedArray) });
          announce("Shared array broadcast to subsequent modules.");
        });

        // init
        arr = genArray(+sz.value, dist.value);
        render();
      })();

      // Module 2: One Pass
      const m2 = (function(){
        const svg = document.getElementById("m2-svg");
        const viz = BarViz(svg);
        const live = document.getElementById("m2-live");
        const speed = document.getElementById("m2-speed");
        const btnUse = document.getElementById("m2-use-shared");
        const btnStep = document.getElementById("m2-step");
        const btnPlay = document.getElementById("m2-play");
        const btnReset = document.getElementById("m2-reset");

        const jEl = document.getElementById("m2-j");
        const cmpEl = document.getElementById("m2-cmp");
        const swpEl = document.getElementById("m2-swp");

        let arr = copy(sharedArray);
        let j = 0, n = arr.length, cmps=0, swps=0, playing=false;

        function announce(msg){ live.textContent = msg; }
        function reset(){
          arr = copy(sharedArray);
          viz.setData(arr);
          viz.setSortedRight(0);
          j=0; n=arr.length; cmps=0; swps=0; playing=false;
          jEl.textContent = j; cmpEl.textContent = cmps; swpEl.textContent = swps;
          announce("Pass reset.");
        }
        function step(){
          if(j >= n-1){
            viz.setSortedRight(1);
            announce("Pass complete. Rightmost element is now sorted.");
            return;
          }
          viz.highlight(j, j+1, 'compare');
          cmps++; cmpEl.textContent = cmps;
          if(arr[j].value > arr[j+1].value){
            [arr[j], arr[j+1]] = [arr[j+1], arr[j]];
            viz.swap(j, j+1);
            swps++; swpEl.textContent = swps;
            announce(`Swap at j=${j}: ${arr[j+1].value} moved right.`);
          }else{
            announce(`No swap at j=${j}.`);
          }
          j++;
          jEl.textContent = j;
          if(j === n-1) {
            viz.setSortedRight(1);
            announce("Pass complete. Largest bubbled to the end.");
          }
        }
        function playLoop(){
          if(playing===false) return;
          if(j >= n-1){
            playing=false;
            btnPlay.disabled=false;
            announce("Pass complete.");
            return;
          }
          step();
          setTimeout(playLoop, +speed.value);
        }

        btnUse.addEventListener("click", ()=>{
          reset();
          announce("Loaded shared array for a new single pass.");
        });
        btnStep.addEventListener("click", step);
        btnPlay.addEventListener("click", ()=>{
          if(j>=n-1){ announce("Pass already complete."); return; }
          playing = true; btnPlay.disabled=true;
          playLoop();
        });
        btnReset.addEventListener("click", reset);

        document.addEventListener("baseArrayChanged", (e)=>{
          // preserve if user wishes to use
          // no auto reset; provide a hint
          announce("Shared array updated. Click 'Use Shared Array' to load.");
        });

        // init
        viz.setData(arr);
        reset();
      })();

      // Module 3: Full Algorithm Explorer
      const m3 = (function(){
        const svg = document.getElementById("m3-svg");
        const viz = BarViz(svg);
        const live = document.getElementById("m3-live");
        const speed = document.getElementById("m3-speed");
        const btnUse = document.getElementById("m3-use-shared");
        const btnStep = document.getElementById("m3-step");
        const btnPlay = document.getElementById("m3-play");
        const btnPause = document.getElementById("m3-pause");
        const btnReset = document.getElementById("m3-reset");
        const passEl = document.getElementById("m3-pass");
        const jEl = document.getElementById("m3-j");
        const cmpEl = document.getElementById("m3-cmp");
        const swpEl = document.getElementById("m3-swp");

        let arr = copy(sharedArray);
        let n = arr.length, pass=1, j=0, sortedRight=0, cmps=0, swps=0, playing=false;

        function announce(msg){ live.textContent = msg; }

        function render(){
          viz.setData(arr);
          viz.setSortedRight(sortedRight);
          passEl.textContent = pass;
          jEl.textContent = j;
          cmpEl.textContent = cmps;
          swpEl.textContent = swps;
        }

        function reset(){
          arr = copy(sharedArray);
          n = arr.length;
          pass=1; j=0; sortedRight=0; cmps=0; swps=0; playing=false;
          btnPause.disabled=true; btnPlay.disabled=false;
          render();
          announce("Sorting state reset.");
        }

        function step(){
          if(sortedRight >= n-1){
            announce("Array already sorted.");
            return true;
          }
          if(j >= n-1-sortedRight){
            // pass complete
            sortedRight++;
            pass++;
            j=0;
            viz.setSortedRight(sortedRight);
            passEl.textContent = pass;
            jEl.textContent = j;
            announce("Pass complete. Sorted region expanded.");
            return false;
          }
          viz.highlight(j, j+1, 'compare');
          cmps++; cmpEl.textContent = cmps;
          if(arr[j].value > arr[j+1].value){
            [arr[j], arr[j+1]] = [arr[j+1], arr[j]];
            viz.swap(j, j+1);
            swps++; swpEl.textContent = swps;
            announce(`Swap at j=${j}.`);
          }else{
            announce(`No swap at j=${j}.`);
          }
          j++;
          jEl.textContent = j;
          if(sortedRight >= n-1) {
            announce("Sorting complete.");
            return true;
          }
          return false;
        }

        function playLoop(){
          if(!playing) return;
          const done = step();
          if(done){ playing=false; btnPause.disabled=true; btnPlay.disabled=false; announce("Done."); return; }
          setTimeout(playLoop, +speed.value);
        }

        btnUse.addEventListener("click", ()=>{
          reset();
          announce("Loaded shared array for full sort.");
        });
        btnStep.addEventListener("click", step);
        btnPlay.addEventListener("click", ()=>{
          if(playing) return;
          playing=true; btnPlay.disabled=true; btnPause.disabled=false;
          playLoop();
        });
        btnPause.addEventListener("click", ()=>{
          playing=false; btnPause.disabled=true; btnPlay.disabled=false;
          announce("Paused.");
        });
        btnReset.addEventListener("click", reset);

        document.addEventListener("baseArrayChanged", ()=>{
          announce("Shared array updated. Click 'Use Shared Array' to load.");
        });

        viz.setData(arr);
        reset();
      })();

      // Module 4: Early Exit
      const m4 = (function(){
        const svg = document.getElementById("m4-svg");
        const viz = BarViz(svg);
        const live = document.getElementById("m4-live");
        const speed = document.getElementById("m4-speed");
        const selEarly = document.getElementById("m4-early");
        const selPreset = document.getElementById("m4-preset");
        const btnRun = document.getElementById("m4-run");
        const btnReset = document.getElementById("m4-reset");

        const passEl = document.getElementById("m4-pass");
        const cmpEl = document.getElementById("m4-cmp");
        const swpEl = document.getElementById("m4-swp");
        const exitEl = document.getElementById("m4-exit");
        const timeline = document.getElementById("m4-timeline");

        let arr = copy(sharedArray), n = arr.length;
        let cmps=0, swps=0, pass=0, sortedRight=0, running=false;

        function announce(msg){ live.textContent = msg; }

        function loadPreset(){
          const p = selPreset.value;
          if(p === 'shared') arr = copy(sharedArray);
          else arr = genArray(Math.max(5, Math.min(20, sharedArray.length)), p);
          n = arr.length;
          viz.setData(arr);
          viz.setSortedRight(0);
          clearStats();
        }

        function clearStats(){
          cmps=0; swps=0; pass=0; sortedRight=0;
          passEl.textContent = pass;
          cmpEl.textContent = cmps;
          swpEl.textContent = swps;
          exitEl.textContent = "—";
          timeline.innerHTML = "";
        }
        function addTick(on){
          const t = document.createElement("div");
          t.className = "tick" + (on ? " on" : "");
          timeline.appendChild(t);
        }

        async function run(){
          if(running) return;
          running = true;
          btnRun.disabled = true;
          btnReset.disabled = true;
          const early = selEarly.value === 'on';
          let swapped = false;
          pass = 0; sortedRight = 0;
          outer: for(pass=1; pass<=n-1; pass++){
            swapped = false;
            for(let j=0; j<n-pass; j++){
              viz.highlight(j, j+1, 'compare');
              cmps++; cmpEl.textContent = cmps;
              if(arr[j].value > arr[j+1].value){
                [arr[j], arr[j+1]] = [arr[j+1], arr[j]];
                viz.swap(j, j+1);
                swps++; swpEl.textContent = swps;
                swapped = true;
                announce(`Pass ${pass}: swapped at j=${j}`);
              }else{
                announce(`Pass ${pass}: no swap at j=${j}`);
              }
              await new Promise(r=> setTimeout(r, +speed.value));
            }
            viz.setSortedRight(pass);
            addTick(swapped);
            if(early && !swapped){
              exitEl.textContent = `Exited after pass ${pass}`;
              announce(`Early exit at pass ${pass} (no swaps).`);
              break outer;
            }
            await new Promise(r=> setTimeout(r, Math.max(60, +speed.value*0.6)));
          }
          btnRun.disabled = false;
          btnReset.disabled = false;
          running = false;
        }

        btnRun.addEventListener("click", run);
        btnReset.addEventListener("click", ()=>{
          loadPreset();
          announce("Reset visualization.");
        });
        selPreset.addEventListener("change", loadPreset);

        document.addEventListener("baseArrayChanged", ()=>{
          if(selPreset.value==='shared'){
            arr = copy(sharedArray);
            loadPreset();
            announce("Shared array updated.");
          }
        });

        // init
        loadPreset();
      })();

      // Module 5: Stability
      const m5 = (function(){
        const svgStable = document.getElementById("m5-stable");
        const svgUnstable = document.getElementById("m5-unstable");
        const vizStable = BarViz(svgStable);
        const vizUnstable = BarViz(svgUnstable);
        const pairs = document.getElementById("m5-pairs");
        const btnGen = document.getElementById("m5-generate");
        const btnRun = document.getElementById("m5-run");
        const btnReset = document.getElementById("m5-reset");
        const liveS = document.getElementById("m5-live-stable");
        const liveU = document.getElementById("m5-live-unstable");
        const resStable = document.getElementById("m5-stable-ok");
        const resUnstable = document.getElementById("m5-unstable-change");

        let arr = [];

        function makeDuplicates(k){
          const items = [];
          const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
          let idx=0;
          for(let i=0;i<k;i++){
            const v = randInt(20, 80);
            const tag1 = letters[i%letters.length] + "1";
            const tag2 = letters[i%letters.length] + "2";
            items.push({ id: uid(), value: v, tag: tag1, baseIndex: idx++ });
            items.push({ id: uid(), value: v, tag: tag2, baseIndex: idx++ });
            // sprinkle some singles
            if(randInt(0,1)===1){
              items.push({ id: uid(), value: randInt(10,99), tag: null, baseIndex: idx++ });
            }
          }
          // shuffle for randomness
          for(let i=items.length-1;i>0;i--){
            const j = randInt(0, i);
            [items[i], items[j]] = [items[j], items[i]];
          }
          // normalize baseIndex after shuffle
          items.forEach((d,i)=> d.baseIndex=i);
          return items;
        }

        function render(){
          vizStable.enableTags(true);
          vizUnstable.enableTags(true);
          vizStable.setData(arr, {showTags: true});
          vizUnstable.setData(arr, {showTags: true});
          vizStable.update();
          vizUnstable.update();
          resStable.textContent = "—";
          resUnstable.textContent = "—";
        }

        async function sortVariant(viz, swapOnEqual=false){
          const a = copy(arr);
          const n = a.length;
          let sortedRight = 0;
          for(let pass=1; pass<=n-1; pass++){
            let swapped = false;
            for(let j=0; j<n-pass; j++){
              viz.highlight(j, j+1, 'compare');
              await new Promise(r=> setTimeout(r, 150));
              const cond = swapOnEqual ? (a[j].value >= a[j+1].value) : (a[j].value > a[j+1].value);
              if(cond){
                [a[j], a[j+1]] = [a[j+1], a[j]];
                viz.swap(j, j+1);
                swapped = true;
              }
              await new Promise(r=> setTimeout(r, 120));
            }
            sortedRight++;
            viz.setSortedRight(sortedRight);
            if(!swapped) break;
            await new Promise(r=> setTimeout(r, 120));
          }
          return a;
        }

        function isStable(original, sorted){
          // For each equal-valued group, verify original relative order (by baseIndex) preserved
          const groups = {};
          original.forEach((d, i)=>{
            groups[d.value] = groups[d.value] || [];
            groups[d.value].push({ tag: d.tag, baseIndex: d.baseIndex });
          });
          // Map tag -> original order index among equals
          const orderMap = {};
          Object.keys(groups).forEach(v=>{
            groups[v].forEach((g, idx)=>{
              orderMap[g.tag||("id"+v+"-"+idx)] = idx;
            });
          });
          // Build sorted order among equals and check non-decreasing
          const lastSeen = {};
          for(const d of sorted){
            if(d.tag){
              const groupKey = d.value;
              const rank = orderMap[d.tag];
              if(lastSeen[groupKey] == null) lastSeen[groupKey] = -1;
              if(rank < lastSeen[groupKey]) return false;
              lastSeen[groupKey] = rank;
            }
          }
          return true;
        }

        btnGen.addEventListener("click", ()=>{
          arr = makeDuplicates(+pairs.value);
          render();
          liveS.textContent = "Generated duplicate pairs.";
          liveU.textContent = "Generated duplicate pairs.";
        });

        btnRun.addEventListener("click", async ()=>{
          liveS.textContent = "Running stable variant…";
          liveU.textContent = "Running unstable variant…";
          const outS = await sortVariant(vizStable, false);
          const outU = await sortVariant(vizUnstable, true);
          const stableOk = isStable(arr, outS);
          const unstableChanged = !isStable(arr, outU);
          resStable.textContent = stableOk ? "Yes" : "No";
          resUnstable.textContent = unstableChanged ? "Yes" : "No";
          liveS.textContent = stableOk ? "Stable: duplicate tags preserved order." : "Unexpected: order changed.";
          liveU.textContent = unstableChanged ? "Unstable variant changed duplicate order." : "Unstable variant did not alter order (rare input).";
        });

        btnReset.addEventListener("click", ()=>{
          render();
          liveS.textContent = "Reset.";
          liveU.textContent = "Reset.";
        });

        // init
        arr = makeDuplicates(+pairs.value);
        render();
      })();

      // Module 6: Complexity
      const m6 = (function(){
        const canvas = document.getElementById("m6-canvas");
        const ctx = canvas.getContext("2d");
        const nEl = document.getElementById("m6-n");
        const modeEl = document.getElementById("m6-exit-mode");
        const worstC = document.getElementById("m6-worst-c");
        const bestC = document.getElementById("m6-best-c");
        const avgS = document.getElementById("m6-avg-s");

        function compsWorst(n){ return n*(n-1)/2; }
        function compsBestEarly(n){ return Math.max(0, n-1); }
        function swapsWorst(n){ return n*(n-1)/2; } // reversed
        function swapsAvg(n){ return n*(n-1)/4; }   // approx random
        function px(v, maxV, H, P){ return H - P - (v/maxV)*(H-2*P); }

        function draw(){
          const W = canvas.width, H = canvas.height;
          const P = 28;
          ctx.clearRect(0,0,W,H);
          ctx.save();
          // axes
          ctx.strokeStyle = "#223147";
          ctx.lineWidth = 1;
          ctx.strokeRect(P, P, W-2*P, H-2*P);
          // grid
          ctx.setLineDash([4,4]);
          ctx.beginPath();
          for(let i=1;i<=4;i++){
            const y = P + i*(H-2*P)/5;
            ctx.moveTo(P, y); ctx.lineTo(W-P, y);
          }
          ctx.stroke();
          ctx.setLineDash([]);

          const n = +nEl.value;
          const mode = modeEl.value;

          const xs = Array.from({length:n-2}, (_,i)=> i+3); // from 3..n
          const worstCData = xs.map(x=> compsWorst(x));
          const bestCData = xs.map(x=> compsBestEarly(x));
          const avgSData = xs.map(x=> swapsAvg(x));

          const maxY = Math.max(...worstCData, ...avgSData, ...(mode==='both' ? bestCData : [0]))*1.1;

          function plot(data, color){
            ctx.beginPath();
            data.forEach((y,i)=>{
              const x = P + (i/(data.length-1))*(W-2*P);
              const yy = px(y, maxY, H, P);
              if(i===0) ctx.moveTo(x, yy); else ctx.lineTo(x, yy);
            });
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.stroke();
          }

          // draw series
          plot(worstCData, "#ef4444"); // worst comps
          plot(avgSData, "#60a5fa");   // avg swaps
          if(mode !== 'without'){
            plot(bestCData, "#10b981"); // best comps with early exit
          }

          // labels
          ctx.fillStyle = "#cbd5e1";
          ctx.font = "12px system-ui";
          ctx.fillText("N", W-P-12, H-P+16);
          ctx.fillText("Operations", P-4, P-8);
          ctx.fillStyle = "#ef4444"; ctx.fillText("Worst comps: n(n-1)/2", P+6, P+14);
          ctx.fillStyle = "#60a5fa"; ctx.fillText("Avg swaps ≈ n(n-1)/4", P+6, P+30);
          if(mode !== 'without'){
            ctx.fillStyle = "#10b981"; ctx.fillText("Best comps (early exit): n−1", P+6, P+46);
          }

          // stats for current n
          worstC.textContent = compsWorst(n).toLocaleString();
          bestC.textContent = (mode==='without' ? compsWorst(n) : compsBestEarly(n)).toLocaleString();
          avgS.textContent = Math.round(swapsAvg(n)).toLocaleString();

          ctx.restore();
        }

        nEl.addEventListener("input", draw);
        modeEl.addEventListener("change", draw);
        draw();
      })();

      // Ensure keyboard focus styles are visible for accessibility
      document.addEventListener("keydown", (e)=>{
        if(e.key === "Tab") document.body.classList.add("show-focus");
      });

    })();
  </script>

  <script id="fsm" type="application/json">
    {
      "topic": "Bubble Sort",
      "description": "Finite-state outline for interactive bubble sort steps used across modules.",
      "states": [
        {
          "name": "idle",
          "on": { "GENERATE": "ready", "LOAD_SHARED": "ready" }
        },
        {
          "name": "ready",
          "on": { "COMPARE": "comparing", "PLAY": "playing", "RESET": "ready", "STEP": "step" }
        },
        {
          "name": "comparing",
          "onEnter": "highlightPair",
          "on": { "DECIDE": "swapDecision" }
        },
        {
          "name": "swapDecision",
          "on": { "SWAP_NEEDED": "swapping", "NO_SWAP": "advance" }
        },
        {
          "name": "swapping",
          "onEnter": "animateSwap",
          "on": { "SWAP_DONE": "advance" }
        },
        {
          "name": "advance",
          "onEnter": "incrementIndex",
          "on": { "PASS_END": "passComplete", "CONTINUE": "ready" }
        },
        {
          "name": "passComplete",
          "onEnter": "markSortedRight",
          "on": { "NO_SWAPS_AND_EARLY": "done", "MORE_PASSES": "ready" }
        },
        {
          "name": "playing",
          "onEnter": "loopUntilDoneOrPaused",
          "on": { "PAUSE": "ready", "DONE": "done" }
        },
        {
          "name": "done",
          "onEnter": "announceDone",
          "on": { "RESET": "ready" }
        }
      ],
      "events": [
        "GENERATE", "LOAD_SHARED", "COMPARE", "DECIDE",
        "SWAP_NEEDED", "NO_SWAP", "SWAP_DONE", "STEP",
        "PASS_END", "MORE_PASSES", "NO_SWAPS_AND_EARLY",
        "PLAY", "PAUSE", "DONE", "RESET"
      ],
      "notes": "This abstract FSM informs UI behavior in Modules 1–4: idle -> ready -> comparing -> swapDecision -> swapping -> advance -> passComplete -> done. Early-exit triggers NO_SWAPS_AND_EARLY at passComplete."
    }
  </script>
</body>
</html>